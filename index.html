<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>basspace - Music Platform</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// Initialize Supabase immediately
const SUPABASE_URL = 'https://xysvtylivtnkykusreln.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5c3Z0eWxpdnRua3lrdXNyZWxuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMzA0NzEsImV4cCI6MjA4MTYwNjQ3MX0.Y3wXBhtyM79fg6sLenv6rGDwpPauCkSd0vMokYw65fA';
var supabase;
var currentUser = null;

// Wait for Supabase library to load
window.addEventListener('DOMContentLoaded', function() {
  if (window.supabase) {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    console.log('Supabase initialized');
  }
});

// Modal functions defined globally
function openAuthModal() {
  const modal = document.getElementById('authModal');
  if (modal) {
    modal.style.display = 'flex';
  }
}

function closeAuthModal() {
  const modal = document.getElementById('authModal');
  if (modal) {
    modal.style.display = 'none';
  }
  // Clear message when closing
  clearAuthMessage();
}

// Show message in auth modal
function showAuthMessage(message, type = 'info') {
  const messageEl = document.getElementById('authMessage');
  if (messageEl) {
    messageEl.textContent = message;
    messageEl.style.display = 'block';
    
    // Style based on type
    if (type === 'success') {
      messageEl.style.background = 'rgba(34, 197, 94, 0.2)';
      messageEl.style.border = '1px solid rgba(34, 197, 94, 0.4)';
      messageEl.style.color = '#86efac';
    } else if (type === 'error') {
      messageEl.style.background = 'rgba(239, 68, 68, 0.2)';
      messageEl.style.border = '1px solid rgba(239, 68, 68, 0.4)';
      messageEl.style.color = '#fca5a5';
    } else {
      messageEl.style.background = 'rgba(59, 130, 246, 0.2)';
      messageEl.style.border = '1px solid rgba(59, 130, 246, 0.4)';
      messageEl.style.color = '#93c5fd';
    }
  }
}

// Clear message
function clearAuthMessage() {
  const messageEl = document.getElementById('authMessage');
  if (messageEl) {
    messageEl.style.display = 'none';
    messageEl.textContent = '';
  }
}

</script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--bg-primary:#050d1a;--bg-secondary:#0a1929;--bg-tertiary:#132f4c;--accent:#5090d3;--text-primary:#fff;--text-secondary:#8ba3bf;--border-color:rgba(176,196,222,0.12);--border-dark:rgba(0,0,0,0.3);--nav-hue:210;--nav-sat:40%;--nav-light:20%}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;transition:all .3s ease}
.top-nav{background:hsla(var(--nav-hue, 210),var(--nav-sat, 40%),var(--nav-light, 20%),0.7);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border-bottom:1px solid var(--border-color);padding:.75rem 2rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;height:64px;transition:all .3s ease}
.logo{font-size:1.5rem;font-weight:800;cursor:pointer;letter-spacing:-.8px;background:linear-gradient(135deg,var(--accent-light) 0%,var(--text-primary) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 20px var(--accent-light)) drop-shadow(0 0 40px var(--accent-light)) drop-shadow(0 0 60px var(--accent-light))}
.nav-center{display:flex;align-items:center;gap:1rem;flex:1;max-width:600px;margin:0 2rem}
.nav-links{display:flex;gap:2rem;align-items:center}
.nav-link{color:#ffffff;text-decoration:none;font-size:.9rem;font-weight:500;transition:all .3s;cursor:pointer}
.nav-link:hover{color:#ffffff;text-shadow:0 0 20px var(--accent-light),0 0 40px var(--accent-light),0 0 60px var(--accent-light)}
.nav-link.active{color:#ffffff;text-shadow:0 0 30px var(--accent-light),0 0 60px var(--accent-light),0 0 90px var(--accent-light)}
.search-bar{flex:1;position:relative}
.search-icon{position:absolute;left:1rem;top:50%;transform:translateY(-50%);color:var(--text-secondary);font-size:.9rem}
.search-input{width:100%;padding:.6rem 1rem .6rem 2.75rem;background:var(--bg-secondary);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border:1px solid var(--border-color);border-radius:500px;color:var(--text-primary);font-size:.875rem;font-family:'Inter',sans-serif;transition:all .2s}
.search-input:focus{outline:0;background:var(--bg-tertiary);border-color:var(--accent)}
.search-input::placeholder{color:var(--text-secondary);opacity:.6}
.profile-menu{position:relative}
.profile-btn{background:rgba(255,255,255,.08);border:1px solid var(--border-color);border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.75rem;transition:all .2s;font-weight:600}
.profile-btn:hover{background:rgba(255,255,255,.12);border-color:var(--accent)}
.dropdown{position:absolute;top:50px;right:0;background:hsla(var(--nav-hue, 210),var(--nav-sat, 40%),var(--nav-light, 20%),0.95);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid var(--border-color);border-radius:8px;min-width:200px;display:none;box-shadow:0 8px 24px rgba(0,0,0,.4);overflow:hidden}
.dropdown.show{display:block}
.dropdown-item{padding:.875rem 1rem;cursor:pointer;transition:background .2s;font-size:.875rem;font-weight:500;color:var(--text-secondary)}
.dropdown-item:hover{background:rgba(255,255,255,.08);color:var(--text-primary)}
.container{max-width:1600px;margin:0 auto;padding:2rem 2rem 140px 2rem}
.screen{display:none}
.screen.active{display:block}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
.section-title{font-size:1.75rem;font-weight:700;letter-spacing:-.5px;text-shadow:0 0 20px var(--accent),0 0 40px var(--accent)}
.recently-played{margin-bottom:3rem}
.horizontal-scroll{display:flex;gap:1rem;overflow-x:auto;padding-bottom:1rem;scrollbar-width:thin;scrollbar-color:var(--accent) transparent}
.horizontal-scroll::-webkit-scrollbar{height:8px}
.horizontal-scroll::-webkit-scrollbar-track{background:0 0}
.horizontal-scroll::-webkit-scrollbar-thumb{background:var(--accent);border-radius:4px}
.album-card{min-width:180px;background:var(--bg-primary);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:1rem;cursor:pointer;transition:all .3s;box-shadow:0 0 10px rgba(255,255,255,0.04),inset 0 0 20px rgba(255,255,255,0.02)}
.album-card:hover{border-color:rgba(255,255,255,0.12);box-shadow:0 0 20px var(--accent),0 10px 25px rgba(0,0,0,.5);transform:translateY(-4px)}
.album-art-large{width:100%;aspect-ratio:1;background:rgba(255,255,255,.08);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:2rem;margin-bottom:1rem;background-size:cover;background-position:center;position:relative}
.play-overlay{position:absolute;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s;border-radius:6px}
.album-card:hover .play-overlay{opacity:1}
.play-overlay-btn{width:48px;height:48px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:#fff;border:none;cursor:pointer;transform:scale(.9);transition:transform .2s}
.album-card:hover .play-overlay-btn{transform:scale(1)}
.album-title{font-weight:600;font-size:.875rem;margin-bottom:.25rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 15px var(--accent)}
.album-artist{color:var(--text-secondary);font-size:.8rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 8px var(--accent)}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:3rem}
.stat-card{background:var(--bg-primary);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:2rem;text-align:center;transition:all .3s;cursor:pointer;box-shadow:0 0 10px rgba(255,255,255,0.04),inset 0 0 20px rgba(255,255,255,0.02)}
.stat-card:hover{border-color:rgba(255,255,255,0.12);box-shadow:0 0 20px var(--accent),0 12px 30px rgba(0,0,0,.5);transform:translateY(-6px)}
.stat-number{font-size:3rem;font-weight:800;margin-bottom:.5rem;letter-spacing:-1px;color:var(--text-primary);text-shadow:0 0 20px var(--accent),0 0 40px var(--accent)}
.stat-label{color:var(--text-secondary);font-size:.875rem;text-transform:uppercase;letter-spacing:1px;font-weight:600;text-shadow:0 0 8px var(--accent)}
.profile-header{position:relative;margin-bottom:3rem}
.profile-banner{height:240px;background:linear-gradient(135deg,var(--bg-secondary),var(--bg-tertiary));border-radius:12px;overflow:hidden;backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%)}
.profile-info{padding:0 2rem;margin-top:-60px;position:relative}
.profile-avatar-container{display:flex;align-items:flex-end;gap:2rem;margin-bottom:1.5rem}
.profile-avatar{width:140px;height:140px;background:var(--bg-secondary);border:4px solid var(--bg-primary);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:2.5rem;font-weight:800;box-shadow:0 8px 24px rgba(0,0,0,.4)}
.profile-details h1{font-size:2.5rem;font-weight:800;margin-bottom:.5rem;letter-spacing:-1px;text-shadow:0 0 25px var(--accent),0 0 50px var(--accent)}
.profile-username{color:var(--text-secondary);font-size:.9rem;font-weight:500}
.profile-bio{color:var(--text-secondary);margin-bottom:2rem;font-size:.95rem;line-height:1.6}
.profile-tabs{display:flex;gap:2.5rem;border-bottom:1px solid var(--border-color);margin-bottom:2rem}
.profile-tab{background:0 0;border:none;color:var(--text-secondary);font-size:.95rem;font-weight:600;padding:1rem 0;cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;font-family:'Inter',sans-serif}
.profile-tab.active{color:var(--text-primary);border-bottom-color:var(--accent)}
.settings-section{background:var(--bg-primary);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:2rem;margin-bottom:1.5rem;transition:all .3s;box-shadow:0 0 10px rgba(255,255,255,0.04),inset 0 0 20px rgba(255,255,255,0.02)}
.settings-section:hover{border-color:rgba(255,255,255,0.12);box-shadow:0 0 18px var(--accent),0 8px 25px rgba(0,0,0,.4)}
.settings-section h3{font-size:1.25rem;margin-bottom:2rem;font-weight:700;text-shadow:0 0 15px var(--accent),0 0 30px var(--accent)}
.setting-item{display:flex;justify-content:space-between;align-items:center;padding:1.25rem 0;border-bottom:1px solid var(--border-color)}
.setting-item:last-child{border-bottom:none}
.setting-label h4{margin-bottom:.25rem;font-weight:600;font-size:.95rem}
.setting-label p{color:var(--text-secondary);font-size:.85rem}
.toggle{width:50px;height:28px;background:rgba(255,255,255,.1);border-radius:14px;position:relative;cursor:pointer;transition:background .2s}
.toggle.active{background:var(--accent)}
.toggle-slider{width:24px;height:24px;background:#fff;border-radius:50%;position:absolute;top:2px;left:2px;transition:all .2s;box-shadow:0 2px 4px rgba(0,0,0,.2)}
.toggle.active .toggle-slider{left:24px}
.input-group{margin-bottom:1.5rem}
.input-group label{display:block;margin-bottom:.75rem;color:var(--text-secondary);font-size:.875rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.btn{padding:.875rem 2rem;border:none;border-radius:500px;font-weight:700;cursor:pointer;transition:all .2s;font-size:.95rem;font-family:'Inter',sans-serif;letter-spacing:.3px}
.btn-primary{background:var(--accent);color:#fff}
.btn-primary:hover{transform:scale(1.05);filter:brightness(1.1)}
.btn-secondary{background:rgba(255,255,255,.08);color:var(--text-primary);border:1px solid var(--border-color)}
.btn-secondary:hover{background:rgba(255,255,255,.12)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.9);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:1000}
.modal-overlay.show{display:flex}
.modal{background:hsla(var(--nav-hue, 210),var(--nav-sat, 40%),var(--nav-light, 20%),0.92);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid var(--border-color);border-radius:12px;padding:2.5rem;width:90%;max-width:500px;max-height:90vh;overflow-y:auto;position:relative}
.modal h3{font-size:1.75rem;margin-bottom:2rem;font-weight:700;text-shadow:0 0 20px var(--accent),0 0 40px var(--accent)}
.input{width:100%;padding:.875rem 1.25rem;background:rgba(255,255,255,.05);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:.95rem;margin-bottom:1rem;font-family:'Inter',sans-serif;transition:all .2s}
.input:focus{outline:0;border-color:var(--accent);background:rgba(255,255,255,.08)}
.input::placeholder{color:var(--text-secondary);opacity:.6}
textarea.input{resize:vertical;font-family:'Inter',sans-serif}
.modal-buttons{display:flex;gap:1rem;margin-top:2rem}
.modal-buttons .btn{flex:1}
.upload-area{border:2px dashed var(--border-color);border-radius:12px;padding:4rem;text-align:center;cursor:pointer;transition:all .3s;background:rgba(255,255,255,.02);margin-bottom:2rem}
.upload-area:hover{border-color:var(--accent);background:rgba(255,255,255,.05)}
.upload-area.drag-active{border-color:var(--accent);background:rgba(80,144,211,.1)}
.upload-icon{font-size:3.5rem;margin-bottom:1.5rem;color:var(--text-secondary);font-weight:300;text-shadow:0 0 30px var(--accent),0 0 60px var(--accent)}
.upload-area h2{font-size:1.5rem;margin-bottom:.75rem;font-weight:700}
.upload-area p{color:var(--text-secondary);font-size:1rem}
.track-list{display:flex;flex-direction:column;gap:.5rem}
.track{background:var(--bg-primary);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:.75rem 1rem;transition:all .3s;cursor:pointer;box-shadow:0 0 8px rgba(255,255,255,0.04),inset 0 0 20px rgba(255,255,255,0.02)}
.track:hover{border-color:rgba(255,255,255,0.12);box-shadow:0 0 15px var(--accent),0 6px 20px rgba(0,0,0,.4);transform:translateY(-2px)}
.track-content{display:flex;align-items:center;gap:1rem}
.track-number{width:2rem;text-align:center;color:var(--text-secondary);font-family:'Space Mono',monospace;font-size:.85rem;font-weight:600}
.track-art{width:48px;height:48px;background:rgba(255,255,255,.08);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;background-size:cover;background-position:center;color:var(--text-secondary);font-weight:600}
.play-btn{width:40px;height:40px;background:var(--accent);color:#fff;border:none;border-radius:50%;font-size:.9rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;font-weight:900;flex-shrink:0}
.play-btn:hover{transform:scale(1.1);filter:brightness(1.1)}
.track-info{flex:1;min-width:0}
.track-title{font-size:.95rem;font-weight:600;margin-bottom:.25rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 15px var(--accent)}
.track-artist{font-size:.85rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 8px var(--accent)}
.track-duration{font-size:.8rem;color:var(--text-secondary);margin-top:.25rem;font-family:'Space Mono',monospace}
.track-actions{display:flex;gap:.5rem;flex-shrink:0}
.btn-small{padding:.5rem .875rem;background:rgba(255,255,255,.05);border:1px solid var(--border-color);border-radius:500px;color:var(--text-secondary);font-weight:600;cursor:pointer;transition:all .2s;font-size:.8rem}
.btn-small:hover{background:rgba(255,255,255,.1);color:var(--text-primary);border-color:var(--accent)}
.empty-state{text-align:center;padding:5rem 2rem}
.empty-state-icon{font-size:3rem;opacity:.4;margin-bottom:1.5rem;color:var(--text-primary);font-weight:300}
.empty-state h2{font-size:1.5rem;font-weight:700;margin-bottom:.5rem;text-shadow:0 0 20px var(--accent),0 0 40px var(--accent)}
.empty-state p{color:var(--text-secondary);font-size:.95rem;text-shadow:0 0 8px var(--accent)}
.page-header{margin-bottom:2.5rem}
.page-header h1{font-size:3rem;margin-bottom:.75rem;font-weight:900;letter-spacing:-1px;text-shadow:0 0 25px var(--accent),0 0 50px var(--accent)}
.page-header p{color:var(--text-secondary);font-size:1rem;text-shadow:0 0 8px var(--accent)}
.image-upload-box{border:2px dashed var(--border-color);border-radius:8px;padding:2rem;text-align:center;cursor:pointer;transition:all .2s;background:rgba(255,255,255,.02);margin-top:.75rem;position:relative;overflow:hidden}
.image-upload-box:hover{border-color:var(--accent);background:rgba(255,255,255,.05)}
.image-upload-box.has-image{border-style:solid;border-color:var(--accent)}
.image-preview{width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0}
.color-picker-group{display:flex;gap:.75rem;margin-top:.75rem;flex-wrap:wrap}
.color-option{width:56px;height:56px;border:2px solid var(--border-color);border-radius:8px;cursor:pointer;transition:all .2s;position:relative}
.color-option:hover{border-color:var(--accent);transform:scale(1.05)}
.color-option.selected{border-color:var(--accent);border-width:3px}
.color-option.selected::after{content:'‚úì';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:1.5rem;font-weight:700;text-shadow:0 0 4px rgba(0,0,0,.8)}
.album-art-upload{width:160px;height:160px;border:2px dashed var(--border-color);background:rgba(255,255,255,.02);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;margin:0 auto 1.5rem;position:relative;overflow:hidden;font-size:2rem;color:var(--text-secondary);font-weight:600}
.album-art-upload:hover{border-color:var(--accent);background:rgba(255,255,255,.05)}
.album-art-upload.has-image{border-style:solid;border-color:var(--accent)}
.player-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.3);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border-top:2px solid var(--border-dark);padding:.75rem 2rem;display:none;z-index:200;height:90px;transition:all .3s ease}
.player-bar.active{display:flex}
.player-content{max-width:1600px;margin:0 auto;width:100%;display:grid;grid-template-columns:1fr 2fr 1fr;align-items:center;gap:2rem}
.player-track-info{display:flex;align-items:center;gap:1rem;min-width:0}
.player-track-art{width:56px;height:56px;background:rgba(255,255,255,.08);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;background-size:cover;background-position:center;color:var(--text-secondary);font-weight:600}
.player-text{min-width:0}
.player-title{font-weight:600;font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 15px var(--accent)}
.player-artist{color:var(--text-secondary);font-size:.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 8px var(--accent)}
.player-center{display:flex;flex-direction:column;gap:.5rem}
.player-controls{display:flex;align-items:center;justify-content:center;gap:1rem}
.player-btn{background:rgba(255,255,255,.08);border:1px solid var(--border-color);width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background .2s,border-color .2s;color:var(--text-primary);font-size:.85rem}
.player-btn:hover{background:rgba(255,255,255,.15);border-color:var(--accent)}
.player-btn.repeat.active{background:var(--accent);color:#fff}
.player-btn-main{width:40px;height:40px;background:var(--accent);color:#fff;font-size:1rem;border:none}
.player-btn-main:hover{filter:brightness(1.1)}
.player-btn-main span{display:flex;align-items:center;justify-content:center;width:100%;height:100%;padding-left:2px}
.progress-container{display:flex;align-items:center;gap:.75rem}
.progress-time{font-size:.75rem;color:var(--text-secondary);font-family:'Space Mono',monospace;min-width:40px}
.progress-bar{flex:1;height:6px;background:rgba(255,255,255,.1);border-radius:3px;cursor:pointer;position:relative}
.progress-bar:hover .progress-fill::after{opacity:1}
.progress-fill{height:100%;background:var(--accent);border-radius:3px;position:relative;transition:width .1s linear}
.progress-fill::after{content:'';position:absolute;right:-6px;top:50%;transform:translateY(-50%);width:12px;height:12px;background:#fff;border-radius:50%;opacity:0;transition:opacity .2s}
.player-right{display:flex;align-items:center;justify-content:flex-end;gap:1rem}
.volume-control{display:flex;align-items:center;gap:.75rem}
.volume-icon{font-size:.85rem;cursor:pointer;color:var(--text-secondary);font-weight:600;transition:color .2s}
.volume-icon:hover{color:var(--text-primary)}
.volume-slider{-webkit-appearance:none;appearance:none;width:100px;height:4px;background:rgba(255,255,255,.1);outline:0;cursor:pointer;border-radius:2px}
.volume-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:12px;height:12px;background:#fff;cursor:pointer;border-radius:50%}
.volume-slider::-moz-range-thumb{width:12px;height:12px;background:#fff;cursor:pointer;border:none;border-radius:50%}
.player-menu{position:relative}
.player-menu-btn{background:0 0;border:none;color:var(--text-secondary);font-size:1.2rem;cursor:pointer;padding:.5rem;transition:color .2s}
.player-menu-btn:hover{color:var(--text-primary)}
.player-menu-dropdown{position:absolute;bottom:100%;right:0;margin-bottom:.5rem;background:hsla(var(--nav-hue, 210),var(--nav-sat, 40%),var(--nav-light, 20%),0.95);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid var(--border-color);border-radius:8px;min-width:200px;display:none;box-shadow:0 8px 24px rgba(0,0,0,.4)}
.player-menu-dropdown.show{display:block}
.player-menu-item{padding:.875rem 1rem;cursor:pointer;transition:background .2s;font-size:.875rem;color:var(--text-secondary);display:flex;align-items:center;gap:.75rem}
.player-menu-item:hover{background:rgba(255,255,255,.08);color:var(--text-primary)}
.player-menu-item:first-child{border-radius:8px 8px 0 0}
.player-menu-item:last-child{border-radius:0 0 8px 8px}
.upload-progress{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:hsla(var(--nav-hue, 210),var(--nav-sat, 40%),var(--nav-light, 20%),0.95);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid var(--border-color);border-radius:12px;padding:2.5rem;z-index:2000;display:none;text-align:center;min-width:320px}
.upload-progress.show{display:block}
.spinner{border:3px solid rgba(255,255,255,.1);border-top:3px solid var(--accent);border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 1.5rem}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.playlist-card{background:var(--bg-primary);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:1.5rem;cursor:pointer;transition:all .3s;height:160px;display:flex;flex-direction:column;justify-content:center;box-shadow:0 0 10px rgba(255,255,255,0.04),inset 0 0 20px rgba(255,255,255,0.02)}
.playlist-card:hover{border-color:rgba(255,255,255,0.12);transform:translateY(-6px);box-shadow:0 0 20px var(--accent),0 12px 30px rgba(0,0,0,.5)}
.playlist-icon{font-size:2rem;margin-bottom:1rem;color:var(--text-secondary);font-weight:600;text-shadow:0 0 15px var(--accent),0 0 30px var(--accent)}
.playlist-name{font-weight:700;font-size:1.1rem;margin-bottom:.5rem;text-shadow:0 0 12px var(--accent),0 0 24px var(--accent)}
.playlist-count{color:var(--text-secondary);font-size:.875rem;text-shadow:0 0 8px var(--accent)}
.color-input-group{display:flex;gap:1rem;align-items:center;margin-top:1rem}
.color-picker-input{width:60px;height:60px;border:2px solid var(--border-color);border-radius:8px;cursor:pointer;background:0 0}
.color-picker-input::-webkit-color-swatch-wrapper{padding:0}
.color-picker-input::-webkit-color-swatch{border:none;border-radius:6px}
.auth-tab{background:transparent;border:none;color:var(--text-secondary);padding:.75rem 1.5rem;cursor:pointer;font-size:.95rem;font-weight:600;border-bottom:2px solid transparent;transition:all .2s}
.auth-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.auth-tab:hover{color:var(--text-primary)}
.input{width:100%;padding:.75rem 1rem;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:.95rem;transition:all .2s}
.input:focus{outline:none;border-color:var(--accent);background:var(--bg-tertiary)}
.input::placeholder{color:var(--text-secondary);opacity:.6}
.modal.show{display:flex !important}

/* Mobile Responsive Styles */
@media (max-width: 768px) {
  /* Typography - smaller, cleaner */
  .section-title{font-size:1.3rem}
  .page-header h1{font-size:2rem}
  .stat-number{font-size:2rem}
  
  /* Container - tighter padding */
  .container{padding:1rem}
  
  /* Header - compact, centered */
  .header{padding:1rem;flex-direction:column;gap:1rem}
  .logo{font-size:1.3rem}
  .nav-links{gap:1rem;width:100%;justify-content:space-around}
  .nav-link{font-size:.85rem}
  .search-container{width:100%;order:3}
  .profile-menu{position:absolute;top:1rem;right:1rem}
  
  /* Stats grid - 2 columns, symmetrical */
  .stats-grid{grid-template-columns:1fr 1fr;gap:.75rem}
  .stat-card{padding:1.25rem}
  
  /* Track list - streamlined */
  .track{padding:.5rem}
  .track-content{gap:.5rem}
  .track-number{min-width:24px;font-size:.8rem}
  .track-art{width:40px;height:40px;font-size:.8rem}
  .play-btn{width:32px;height:32px;font-size:.7rem}
  .track-info{flex:1;min-width:0}
  .track-title{font-size:.85rem}
  .track-artist{font-size:.75rem}
  .track-duration{font-size:.7rem}
  .track-actions{flex-direction:column;gap:.25rem;width:auto}
  .btn-small{padding:.4rem .6rem;font-size:.7rem;white-space:nowrap}
  
  /* Albums - 2 columns, symmetrical */
  .albums-scroll{gap:.75rem;padding:.5rem 0}
  .album-card{min-width:calc(50% - .375rem);max-width:calc(50% - .375rem)}
  .album-art-large{height:120px}
  
  /* Player bar - compact, stacked */
  .player-bar{padding:.75rem 1rem;height:auto}
  .player-content{grid-template-columns:1fr;gap:1rem}
  .player-track-info{order:1}
  .player-track-art{width:48px;height:48px}
  .player-title{font-size:.85rem}
  .player-artist{font-size:.75rem}
  .player-center{order:2}
  .player-controls{gap:.75rem;justify-content:center}
  .player-btn{width:36px;height:36px;font-size:.9rem}
  .player-btn-main{width:44px;height:44px;font-size:1.1rem}
  .progress-container{order:3}
  .player-right{display:none}
  
  /* Modals - full screen on mobile */
  .modal-content{width:100%;height:100vh;max-width:100%;margin:0;border-radius:0;padding:1.5rem}
  
  /* Settings - single column */
  .settings-section{padding:1.25rem}
  .setting-item{flex-direction:column;align-items:flex-start;gap:.5rem}
  .color-picker-group{gap:.5rem}
  .color-option{width:48px;height:48px}
  
  /* Profile - streamlined */
  .profile-banner{height:120px}
  .profile-header{padding:1rem;margin-top:-40px}
  .profile-avatar{width:80px;height:80px;font-size:1.8rem}
  .profile-stats{flex-direction:column;gap:.75rem;width:100%}
  .profile-stat{text-align:center;padding:.75rem}
  
  /* Playlists - 2 columns symmetrical */
  .playlists-grid{grid-template-columns:1fr 1fr;gap:.75rem}
  .playlist-card{padding:1rem;height:140px}
  .playlist-icon{font-size:1.5rem;margin-bottom:.5rem}
  .playlist-name{font-size:.95rem}
  
  /* Hide unnecessary elements */
  .empty-state{padding:3rem 1rem}
  .empty-state-icon{font-size:2rem}
  
  /* Upload area - compact */
  .upload-area{padding:2rem 1rem}
  .upload-icon{font-size:2.5rem}
}

/* Extra small devices */
@media (max-width: 480px) {
  .stats-grid{grid-template-columns:1fr;gap:.5rem}
  .albums-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch;display:flex;flex-wrap:nowrap}
  .album-card{min-width:140px;max-width:140px}
  .playlists-grid{grid-template-columns:1fr;gap:.5rem}
  .track-actions{position:static;margin-top:.5rem;flex-direction:row;justify-content:flex-start}
}
</style>
</head>
<body>

<!-- Auth Modal -->
<div id="authModal" class="modal-overlay" style="display:none">
<div class="modal" style="max-width:400px;position:relative">
<button id="authModalCloseBtn" style="position:absolute;top:1rem;right:1rem;background:transparent;border:none;color:var(--text-secondary);font-size:1.5rem;cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">√ó</button>
<h3 style="margin-bottom:2rem;text-align:center">welcome to basspace</h3>
<div id="authMessage" style="display:none;padding:1rem;border-radius:8px;margin-bottom:1.5rem;text-align:center;font-size:.95rem"></div>
<div id="authTabs" style="display:flex;gap:1rem;margin-bottom:2rem;border-bottom:2px solid var(--border-color)">
<button class="auth-tab active" data-tab="login">Login</button>
<button class="auth-tab" data-tab="signup">Sign Up</button>
</div>
<div id="loginForm">
<div class="input-group" style="margin-bottom:1rem">
<label>Email</label>
<input type="email" id="loginEmail" class="input" placeholder="your@email.com" onkeypress="if(event.key==='Enter')handleLogin()">
</div>
<div class="input-group" style="margin-bottom:1.5rem">
<label>Password</label>
<input type="password" id="loginPassword" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key==='Enter')handleLogin()">
</div>
<button type="button" class="btn" id="loginSubmitBtn" style="width:100%">Login</button>
</div>
<div id="signupForm" style="display:none">
<div class="input-group" style="margin-bottom:1rem">
<label>Email</label>
<input type="email" id="signupEmail" class="input" placeholder="your@email.com" onkeypress="if(event.key==='Enter')handleSignup()">
</div>
<div class="input-group" style="margin-bottom:1rem">
<label>Password</label>
<input type="password" id="signupPassword" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key==='Enter')handleSignup()">
</div>
<div class="input-group" style="margin-bottom:1.5rem">
<label>Confirm Password</label>
<input type="password" id="signupPasswordConfirm" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key==='Enter')handleSignup()">
</div>
<button type="button" class="btn" id="signupSubmitBtn" style="width:100%">Create Account</button>
</div>
<p style="color:var(--text-secondary);font-size:.875rem;text-align:center;margin-top:1rem">Your music will be saved to the cloud and accessible from any device</p>
</div>
</div>

<div class="top-nav">
<div class="logo" onclick="showScreen('home')">basspace</div>
<div class="nav-center">
<div class="search-bar"><span class="search-icon">üîç</span>
<input type="text" id="searchInput" class="search-input" placeholder="Search songs, artists, albums">
</div>
</div>
<div style="display:flex;align-items:center;gap:2rem">
<div class="nav-links">
<div class="nav-link active" onclick="showScreen('home')">Home</div>
<div class="nav-link" onclick="showScreen('library')">Library</div>
<div class="nav-link" onclick="showScreen('upload')">Upload</div>
</div>
<button id="loginBtn" class="btn" style="padding:.5rem 1.5rem;display:block" onclick="if(typeof openAuthModal === 'function') openAuthModal(); else alert('Function not loaded yet');">Login / Sign Up</button>
<div class="profile-menu" id="profileMenuContainer" style="display:none">
<div class="profile-btn" id="profileBtn">ML</div>
<div id="dropdown" class="dropdown">
<div class="dropdown-item" onclick="showScreen('profile')">Profile</div>
<div class="dropdown-item" onclick="openCreatePlaylist()">Create Playlist</div>
<div class="dropdown-item" onclick="showScreen('settings')">Settings</div>
<div class="dropdown-item" onclick="handleLogout()" style="color:#ff6b6b;border-top:1px solid var(--border-color);margin-top:.5rem;padding-top:.75rem">Logout</div>
</div>
</div>
</div>
</div>

<div class="container">
<div id="homeScreen" class="screen active">
<div class="recently-played" id="recentlyPlayedSection" style="display:none">
<div class="section-header"><h2 class="section-title">Recently Played</h2></div>
<div class="horizontal-scroll" id="recentlyPlayedList"></div>
</div>

<div style="margin-bottom:3rem">
<div class="section-header"><h2 class="section-title">Trending Tracks</h2></div>
<div id="popularTracks" class="track-list"></div>
<div id="noResults" class="empty-state" style="display:none">
<div class="empty-state-icon">‚àÖ</div><h2>No results found</h2><p>Try searching for something else</p>
</div>
<div id="noMusic" class="empty-state">
<div class="empty-state-icon">‚ô™</div><h2>welcome to basspace</h2><p>Upload your first track or create a playlist to get started</p>
</div>
</div>

<div class="stats">
<div class="stat-card"><div class="stat-number" id="totalTracks">0</div><div class="stat-label">Tracks</div></div>
<div class="stat-card"><div class="stat-number" id="totalArtists">0</div><div class="stat-label">Artists</div></div>
<div class="stat-card"><div class="stat-number" id="totalPlays">0</div><div class="stat-label">Plays</div></div>
</div>
</div>

<div id="profileScreen" class="screen">
<div class="profile-header">
<div class="profile-banner" id="profileBannerEl"></div>
<div class="profile-info">
<div class="profile-avatar-container">
<div class="profile-avatar" id="profileAvatarEl">ML</div>
<div class="profile-details">
<h1 id="profileUsername">Music Lover</h1>
<p class="profile-username">@musiclover</p>
</div>
</div>
<p class="profile-bio" id="profileBio">Music enthusiast and creator</p>
<div class="profile-tabs">
<button class="profile-tab active" onclick="showProfileTab('tracks')">Tracks <span id="profileTrackCount">0</span></button>
<button class="profile-tab" onclick="showProfileTab('playlists')" id="playlistTabBtn">Playlists <span id="profilePlaylistCount">0</span></button>
</div>
</div>
</div>

<div id="profileTracksSection">
<div id="profileTrackList" class="track-list"></div>
<div id="profileEmptyTracks" class="empty-state">
<div class="empty-state-icon">‚ô™</div><h2>No tracks uploaded</h2><p>Share your music with the world</p>
</div>
</div>

<div id="profilePlaylistsSection" style="display:none">
<div id="profilePlaylistList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem"></div>
<div id="profileEmptyPlaylists" class="empty-state">
<div class="empty-state-icon">‚ô™</div><h2>No playlists created</h2><p>Organize your favorite tracks</p>
</div>
</div>
</div>

<div id="settingsScreen" class="screen">
<div class="page-header"><h1>Settings</h1><p>Manage your account and preferences</p></div>

<div class="settings-section">
<h3>Account Information</h3>
<div class="input-group"><label>Display Name</label><input type="text" class="input" id="displayName" value="Music Lover"></div>
<div class="input-group"><label>Username</label><input type="text" class="input" id="usernameInput" value="musiclover"></div>
<div class="input-group"><label>Email</label><input type="email" class="input" id="emailInput" value="user@basspace.com"></div>
<div class="input-group"><label>Bio</label><textarea class="input" id="bioInput" rows="3">Music enthusiast and creator</textarea></div>
<button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
</div>

<div class="settings-section">
<h3>Profile Customization</h3>
<div class="input-group">
<label>Profile Picture</label>
<input type="file" id="profilePicInput" accept="image/*" style="display:none" onchange="uploadProfilePic(this)">
<div class="image-upload-box" id="profilePicPreview" onclick="document.getElementById('profilePicInput').click()" style="height:150px">
<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600">PROFILE IMAGE</div>
<p style="color:var(--text-secondary);font-size:.875rem">Click to upload</p>
</div>
</div>

<div class="input-group">
<label>Profile Banner</label>
<input type="file" id="bannerInput" accept="image/*" style="display:none" onchange="uploadBanner(this)">
<div class="image-upload-box" id="bannerPreview" onclick="document.getElementById('bannerInput').click()" style="height:120px">
<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600">BANNER IMAGE</div>
<p style="color:var(--text-secondary);font-size:.875rem">Click to upload</p>
</div>
</div>

<div class="input-group">
<label>Background Color</label>
<div class="color-input-group">
<input type="color" id="customColorPicker" class="color-picker-input" value="#050d1a">
<button class="btn" onclick="changeBackground(document.getElementById('customColorPicker').value)" style="margin-top:.5rem">Save Color</button>
<p style="color:var(--text-secondary);font-size:.875rem">Pick any color - theme adapts automatically</p>
</div>
<div class="color-picker-group" style="margin-top:1rem">
<div class="color-option" style="background:#050d1a" onclick="changeBackground('#050d1a')" data-color="#050d1a"></div>
<div class="color-option" style="background:#1a0a29" onclick="changeBackground('#1a0a29')" data-color="#1a0a29"></div>
<div class="color-option" style="background:#0a2914" onclick="changeBackground('#0a2914')" data-color="#0a2914"></div>
<div class="color-option" style="background:#290a0a" onclick="changeBackground('#290a0a')" data-color="#290a0a"></div>
<div class="color-option" style="background:#000000" onclick="changeBackground('#000000')" data-color="#000000"></div>
<div class="color-option" style="background:#1c1c1c" onclick="changeBackground('#1c1c1c')" data-color="#1c1c1c"></div>
</div>
<input type="file" id="backgroundInput" accept="image/*" style="display:none" onchange="uploadBackground(this)">
<div class="image-upload-box" id="backgroundPreview" onclick="document.getElementById('backgroundInput').click()" style="height:100px;margin-top:1rem">
<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600">BACKGROUND IMAGE</div>
<p style="color:var(--text-secondary);font-size:.875rem">Click to upload</p>
</div>
</div>
<button class="btn btn-secondary" onclick="resetCustomization()" style="margin-top:1rem">Reset to Defaults</button>
</div>

<div class="settings-section">
<h3>Glow Color (Optional)</h3>
<div class="input-group">
<label>Custom Glow Color</label>
<div class="color-input-group">
<input type="color" id="customGlowPicker" class="color-picker-input" value="">
<button class="btn" onclick="changeGlowColor(document.getElementById('customGlowPicker').value)" style="margin-top:.5rem">Set Glow Color</button>
<p style="color:var(--text-secondary);font-size:.875rem">Leave empty to use auto-generated glow, or pick a custom color</p>
</div>
<button class="btn btn-secondary" onclick="resetGlowColor()" style="margin-top:.5rem">Reset to Auto</button>
</div>
</div>
<div class="settings-section">
<h3>Playback</h3>
<div class="setting-item">
<div class="setting-label"><h4>Autoplay</h4><p>Automatically play next track</p></div>
<div class="toggle" onclick="this.classList.toggle('active')"><div class="toggle-slider"></div></div>
</div>
</div>
</div>

<div id="uploadScreen" class="screen">
<div class="page-header"><h1>Upload Music</h1><p>Share your tracks with the world</p></div>
<div id="uploadArea" class="upload-area">
<input id="fileInput" type="file" multiple accept="audio/*,.mp3,.m4a" style="display:none">
<div class="upload-icon">‚ô™</div>
<h2>Drop your audio files here</h2>
<p>or click to browse your files</p>
</div>
<div id="uploadedTracks" style="display:none">
<div class="section-header"><h2 class="section-title">Recently Uploaded</h2></div>
<div id="recentTrackList" class="track-list"></div>
</div>
</div>

<div id="libraryScreen" class="screen">
<div class="page-header"><h1>Your Library</h1><p>All your music in one place</p></div>
<div class="section-header"><h2 class="section-title">My Tracks (<span id="trackCount">0</span>)</h2></div>
<div id="trackList" class="track-list"></div>
<div id="emptyState" class="empty-state">
<div class="empty-state-icon">‚ô™</div><h2>Your library is empty</h2><p>Upload some tracks to get started</p>
</div>
</div>
</div>

<div id="createPlaylistModal" class="modal-overlay">
<div class="modal">
<h3>Create Playlist</h3>
<input id="playlistNameInput" type="text" class="input" placeholder="My Playlist">
<div class="modal-buttons">
<button class="btn btn-primary" onclick="confirmCreatePlaylist()">Create</button>
<button class="btn btn-secondary" onclick="closeCreatePlaylist()">Cancel</button>
</div>
</div>
</div>

<div id="editTrackModal" class="modal-overlay">
<div class="modal">
<h3>Edit Track</h3>
<input type="file" id="albumArtInput" accept="image/*" style="display:none">
<div class="album-art-upload" id="albumArtPreview" onclick="document.getElementById('albumArtInput').click()">
<div>‚ô™</div>
</div>
<p style="text-align:center;color:var(--text-secondary);font-size:.875rem;margin-bottom:1.5rem">Click to add album artwork</p>
<div class="input-group"><label>Track Title</label><input type="text" class="input" id="editTrackTitle" placeholder="Enter track title"></div>
<div class="input-group"><label>Artist</label><input type="text" class="input" id="editTrackArtist" placeholder="Enter artist name"></div>
<div class="input-group"><label>Album</label><input type="text" class="input" id="editTrackAlbum" placeholder="Enter album name"></div>
<div class="modal-buttons">
<button class="btn btn-primary" onclick="saveTrackEdit()">Save Changes</button>
<button class="btn btn-secondary" onclick="closeEditTrack()">Cancel</button>
</div>
</div>
</div>

<div class="upload-progress" id="uploadProgress">
<div class="spinner"></div>
<h3 style="margin-bottom:.5rem;font-weight:700">Processing Audio</h3>
<p style="color:var(--text-secondary);font-size:.875rem">This may take a moment...</p>
</div>

<div class="player-bar" id="playerBar">
<div class="player-content">
<div class="player-track-info">
<div class="player-track-art" id="playerArt">‚ô™</div>
<div class="player-text">
<div class="player-title" id="playerTitle">No track playing</div>
<div class="player-artist" id="playerArtist">Select a track to begin</div>
</div>
</div>

<div class="player-center">
<div class="player-controls">
<button class="player-btn" id="repeatBtn" onclick="toggleRepeat()">‚Üª</button>
<button class="player-btn" id="prevBtn" onclick="playPrevious()">‚èÆ</button>
<button class="player-btn player-btn-main" id="playPauseBtn" onclick="togglePlayPause()"><span id="playerPlayIcon">‚ñ∂</span></button>
<button class="player-btn" id="nextBtn" onclick="playNext()">‚è≠</button>
<button class="player-btn player-menu-btn" id="playerMenuBtn" onclick="togglePlayerMenu()">‚ãÆ</button>
</div>
<div class="progress-container">
<div class="progress-time" id="currentTime">0:00</div>
<div class="progress-bar" id="progressBar" onclick="seekTrack(event)">
<div class="progress-fill" id="progressFill"></div>
</div>
<div class="progress-time" id="totalTime">0:00</div>
</div>
</div>

<div class="player-right">
<div class="volume-control">
<div class="volume-icon" onclick="toggleMute()">VOL</div>
<input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70">
</div>
<div class="player-menu">
<button class="player-menu-btn" onclick="togglePlayerMenu()">‚ãØ</button>
<div class="player-menu-dropdown" id="playerMenuDropdown">
<div class="player-menu-item" onclick="addToPlaylist()">+ Add to Playlist</div>
<div class="player-menu-item" onclick="addToLibrary()">+ Add to Library</div>
<div class="player-menu-item" onclick="downloadCurrentTrack()">‚Üì Download</div>
</div>
</div>
</div>
</div>
</div>

<audio id="audioPlayer" style="display:none"></audio>
<script>
let tracks=[],allUserTracks=[],totalPlays=0,currentPlayingId=null,playlists=[],currentProfileTab='tracks',profilePicture='ML',profileBanner='linear-gradient(135deg,#0a1929,#132f4c)',profileBackground='#050d1a',customGlowColor=null,currentEditingTrack=null,currentEditingAlbumArt=null,recentlyPlayed=[],isRepeat=!1,currentTrack=null;const audioPlayer=document.getElementById('audioPlayer'),fileInput=document.getElementById('fileInput'),uploadArea=document.getElementById('uploadArea'),trackList=document.getElementById('trackList'),emptyState=document.getElementById('emptyState'),searchInput=document.getElementById('searchInput'),profileBtn=document.getElementById('profileBtn'),dropdown=document.getElementById('dropdown'),volumeSlider=document.getElementById('volumeSlider'),albumArtInput=document.getElementById('albumArtInput');function generateCompleteTheme(e){const t=hexToRgb(e),baseHsl=rgbToHsl(t.r,t.g,t.b),n=(299*t.r+587*t.g+114*t.b)/1e3<128,r=Math.abs(t.r-t.g)<10&&Math.abs(t.g-t.b)<10&&Math.abs(t.r-t.b)<10;let o,a,c;if(r){const r=Math.round((t.r+t.g+t.b)/3);o=rgbToHex(Math.min(255,Math.round(r*1.4)),Math.min(255,Math.round(r*1.4)),Math.min(255,Math.round(r*1.4))),a=rgbToHex(Math.min(255,Math.round(r*1.8)),Math.min(255,Math.round(r*1.8)),Math.min(255,Math.round(r*1.8))),c=n?"#5090d3":"#2d5a8c"}else{o=hslToHex(baseHsl.h,baseHsl.s,n?Math.min(baseHsl.l*1.4,35):Math.max(baseHsl.l*0.85,5)),a=hslToHex(baseHsl.h,baseHsl.s,n?Math.min(baseHsl.l*1.8,45):Math.max(baseHsl.l*0.7,3)),c=hslToHex(baseHsl.h,Math.min(baseHsl.s*1.1,100),n?Math.min(baseHsl.l*3,65):Math.min(baseHsl.l*1.5,50))}const isVeryLight=baseHsl.l>85;const i="#ffffff",l="#ffffff",s=isVeryLight?"rgba(0, 0, 0, 0.12)":"rgba(255, 255, 255, 0.12)";const navHsl=rgbToHsl(t.r,t.g,t.b);const panelBorder=baseHsl.l>50?"rgba(0,0,0,0.3)":"rgba(255,255,255,0.3)";const lightBorder=hslToHex(baseHsl.h,Math.max(baseHsl.s*0.8,40),75);const lightGlow=hslToHex(baseHsl.h,Math.min(baseHsl.s*1.3,100),Math.min(baseHsl.l*5,90));const finalAccent=customGlowColor||c;document.documentElement.style.setProperty('--bg-primary',e),document.documentElement.style.setProperty('--bg-secondary',o),document.documentElement.style.setProperty('--bg-tertiary',a),document.documentElement.style.setProperty('--accent',finalAccent),document.documentElement.style.setProperty('--border-light',lightBorder),document.documentElement.style.setProperty('--accent-light',lightGlow),document.documentElement.style.setProperty('--text-primary',i),document.documentElement.style.setProperty('--text-secondary',l),document.documentElement.style.setProperty('--border-color',s),document.documentElement.style.setProperty('--border-dark',panelBorder),document.documentElement.style.setProperty('--nav-hue',navHsl.h),document.documentElement.style.setProperty('--nav-sat',navHsl.s+'%'),document.documentElement.style.setProperty('--nav-light',Math.min(navHsl.l*1.3,30)+'%')}function hexToRgb(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:5,g:13,b:26}}function rgbToHex(e,t,n){return"#"+((1<<24)+(e<<16)+(t<<8)+n).toString(16).slice(1)}function rgbToHsl(r,g,b){r/=255,g/=255,b/=255;const max=Math.max(r,g,b),min=Math.min(r,g,b);let h,s,l=(max+min)/2;if(max===min){h=s=0}else{const d=max-min;s=l>.5?d/(2-max-min):d/(max+min);switch(max){case r:h=((g-b)/d+(g<b?6:0))/6;break;case g:h=((b-r)/d+2)/6;break;case b:h=((r-g)/d+4)/6;break}}return{h:Math.round(h*360),s:Math.round(s*100),l:Math.round(l*100)}}function hslToHex(h,s,l){s/=100,l/=100;const c=(1-Math.abs(2*l-1))*s,x=c*(1-Math.abs((h/60)%2-1)),m=l-c/2;let r=0,g=0,b=0;if(h>=0&&h<60){r=c,g=x,b=0}else if(h>=60&&h<120){r=x,g=c,b=0}else if(h>=120&&h<180){r=0,g=c,b=x}else if(h>=180&&h<240){r=0,g=x,b=c}else if(h>=240&&h<300){r=x,g=0,b=c}else if(h>=300&&h<360){r=c,g=0,b=x}r=Math.round((r+m)*255),g=Math.round((g+m)*255),b=Math.round((b+m)*255);return rgbToHex(r,g,b)}function adjustBrightness(e,t){const n=hexToRgb(e);return rgbToHex(Math.min(255,Math.max(0,Math.round(n.r*t))),Math.min(255,Math.max(0,Math.round(n.g*t))),Math.min(255,Math.max(0,Math.round(n.b*t))))}function generateAccentColor(e,t){if(t){const t=Math.max(e.r,e.g,e.b);if(t<80)return rgbToHex(Math.min(255,Math.round(e.r*3.5)),Math.min(255,Math.round(e.g*3.5)),Math.min(255,Math.round(e.b*3.5)));const n=t<150?300/t:2.2;return rgbToHex(Math.min(255,Math.round(e.r*n)),Math.min(255,Math.round(e.g*n)),Math.min(255,Math.round(e.b*n)))}const n=Math.max(e.r,e.g,e.b);return n>200?rgbToHex(Math.round(.4*e.r),Math.round(.4*e.g),Math.round(.4*e.b)):rgbToHex(Math.round(.6*e.r),Math.round(.6*e.g),Math.round(.6*e.b))}function formatTime(e){if(isNaN(e))return'0:00';const t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n.toString().padStart(2,'0')}`}function seekTrack(e){const t=document.getElementById('progressBar');audioPlayer.currentTime=(e.clientX-t.getBoundingClientRect().left)/t.offsetWidth*audioPlayer.duration}function toggleRepeat(){isRepeat=!isRepeat,document.getElementById('repeatBtn').classList.toggle('active',isRepeat)}function toggleMute(){audioPlayer.volume>0?(audioPlayer.volume=0,volumeSlider.value=0):(audioPlayer.volume=.7,volumeSlider.value=70)}function togglePlayPause(){currentPlayingId&&(audioPlayer.paused?(audioPlayer.play(),document.getElementById('playerPlayIcon').textContent='‚è∏'):(audioPlayer.pause(),document.getElementById('playerPlayIcon').textContent='‚ñ∂'))}function togglePlayerMenu(){document.getElementById('playerMenuDropdown').classList.toggle('show')}
function playPrevious(){if(!currentPlayingId||allUserTracks.length===0)return;const currentIndex=allUserTracks.findIndex(t=>t.id===currentPlayingId);if(currentIndex===-1)return;const prevIndex=currentIndex===0?allUserTracks.length-1:currentIndex-1;const prevTrack=allUserTracks[prevIndex];togglePlay(prevTrack.id)}
function playNext(){if(!currentPlayingId||allUserTracks.length===0)return;const currentIndex=allUserTracks.findIndex(t=>t.id===currentPlayingId);if(currentIndex===-1)return;const nextIndex=currentIndex===allUserTracks.length-1?0:currentIndex+1;const nextTrack=allUserTracks[nextIndex];togglePlay(nextTrack.id)}
function addToPlaylist(){togglePlayerMenu(),currentTrack&&playlists.length>0?alert('Select a playlist (feature in progress)'):alert('Create a playlist first!')}function addToLibrary(){togglePlayerMenu(),currentTrack&&!tracks.find(e=>e.id===currentTrack.id)&&(tracks.push(currentTrack),saveData(),renderLibrary(),alert('Added to your library!'))}function downloadCurrentTrack(){togglePlayerMenu(),currentTrack&&downloadTrack(currentTrack.id)}function updatePlayerBar(e){currentTrack=e;const t=document.getElementById('playerBar'),n=document.getElementById('playerArt');document.getElementById('playerTitle').textContent=e.title,document.getElementById('playerArtist').textContent=`${e.artist} ‚Ä¢ ${e.album}`,t.classList.add('active'),e.albumArt?(n.style.backgroundImage=`url(${e.albumArt})`,n.textContent=''):(n.style.backgroundImage='',n.textContent='‚ô™'),document.getElementById('playerPlayIcon').textContent='‚è∏',recentlyPlayed.find(t=>t.id===e.id)||(recentlyPlayed.unshift(e),recentlyPlayed.length>10&&recentlyPlayed.pop(),renderRecentlyPlayed(),saveData())}function renderRecentlyPlayed(){const e=document.getElementById('recentlyPlayedSection'),t=document.getElementById('recentlyPlayedList');recentlyPlayed.length>0?(e.style.display='block',t.innerHTML=recentlyPlayed.map(e=>`<div class="album-card" onclick="togglePlay('${e.id}')"><div class="album-art-large" style="${e.albumArt?`background-image:url(${e.albumArt})`:''}"> ${e.albumArt?'':'‚ô™'}<div class="play-overlay"><button class="play-overlay-btn">‚ñ∂</button></div></div><div class="album-title">${e.title}</div><div class="album-artist">${e.artist}</div></div>`).join('')):e.style.display='none'}function openEditTrack(e){const t=tracks.find(t=>t.id===e)||allUserTracks.find(t=>t.id===e);if(!t)return;currentEditingTrack=t,currentEditingAlbumArt=t.albumArt||null,document.getElementById('editTrackTitle').value=t.title,document.getElementById('editTrackArtist').value=t.artist,document.getElementById('editTrackAlbum').value=t.album;const n=document.getElementById('albumArtPreview');t.albumArt?(n.style.backgroundImage=`url(${t.albumArt})`,n.style.backgroundSize='cover',n.style.backgroundPosition='center',n.textContent='',n.classList.add('has-image')):(n.style.backgroundImage='',n.style.backgroundSize='',n.style.backgroundPosition='',n.innerHTML='<div>‚ô™</div>',n.classList.remove('has-image')),document.getElementById('editTrackModal').classList.add('show')}function closeEditTrack(){document.getElementById('editTrackModal').classList.remove('show'),currentEditingTrack=null,currentEditingAlbumArt=null}function saveTrackEdit(){currentEditingTrack&&(currentEditingTrack.title=document.getElementById('editTrackTitle').value||currentEditingTrack.title,currentEditingTrack.artist=document.getElementById('editTrackArtist').value||'Unknown Artist',currentEditingTrack.album=document.getElementById('editTrackAlbum').value||'Unknown Album',currentEditingTrack.albumArt=currentEditingAlbumArt,closeEditTrack(),saveData(),updateStats(),renderLibrary(),renderPopularTracks(),renderProfile(),renderRecentUploads(),renderRecentlyPlayed())}function loadData(){const e=localStorage.getItem('basspace_data');if(e)try{const e=JSON.parse(localStorage.getItem('basspace_data'));tracks=e.tracks||[],allUserTracks=e.allUserTracks||[],playlists=e.playlists||[],totalPlays=e.totalPlays||0,recentlyPlayed=e.recentlyPlayed||[],profilePicture=e.profilePicture||'ML',profileBanner=e.profileBanner||'linear-gradient(135deg,#0a1929,#132f4c)',profileBackground=e.profileBackground||'#050d1a',customGlowColor=e.customGlowColor||null,document.body.style.background=profileBackground,generateCompleteTheme(profileBackground),tracks.forEach(e=>{e.isPlaying=!1,e.audioData&&(e.dataUrl=e.audioData)}),allUserTracks.forEach(e=>{e.isPlaying=!1,e.audioData&&(e.dataUrl=e.audioData)}),updateStats(),renderLibrary(),renderPopularTracks(),renderProfile(),renderRecentlyPlayed(),updateBackgroundPreview(),updateColorSelection()}catch(e){console.error('Error loading data:',e)}}function saveData(){const e={tracks:tracks.map(e=>({id:e.id,title:e.title,artist:e.artist,album:e.album,albumArt:e.albumArt,audioData:e.audioData,duration:e.duration,filename:e.filename})),allUserTracks:allUserTracks.map(e=>({id:e.id,title:e.title,artist:e.artist,album:e.album,albumArt:e.albumArt,audioData:e.audioData,duration:e.duration,filename:e.filename})),playlists:playlists,totalPlays:totalPlays,recentlyPlayed:recentlyPlayed.map(e=>({id:e.id,title:e.title,artist:e.artist,album:e.album,albumArt:e.albumArt})),profilePicture:profilePicture,profileBanner:profileBanner,profileBackground:profileBackground,customGlowColor:customGlowColor};try{localStorage.setItem('basspace_data',JSON.stringify(e))}catch(e){'QuotaExceededError'===e.name&&alert('Storage limit exceeded! Try uploading smaller or fewer audio files.')}}function showScreen(e){document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active')),document.getElementById(e+'Screen').classList.add('active'),dropdown.classList.remove('show'),document.querySelectorAll('.nav-link').forEach(e=>{e.classList.remove('active')}),'home'===e&&(document.querySelector('.nav-link').classList.add('active'),renderPopularTracks()),'library'===e&&document.querySelectorAll('.nav-link')[1].classList.add('active'),'upload'===e&&document.querySelectorAll('.nav-link')[2].classList.add('active'),'profile'===e&&(renderProfile(),applyProfileStyles()),'settings'===e&&(updateProfilePicPreview(),updateBannerPreview(),updateBackgroundPreview(),updateColorSelection()),updateStats()}function saveProfile(){const e=document.getElementById('displayName').value;document.getElementById('bioInput').value;document.getElementById('profileUsername').textContent=e,document.getElementById('profileBio').textContent=document.getElementById('bioInput').value,saveData(),alert('Profile updated successfully!')}function uploadProfilePic(e){if(e.files&&e.files[0]){const t=new FileReader;t.onload=e=>{profilePicture=e.target.result,updateProfilePicPreview(),applyProfileStyles(),saveData()},t.readAsDataURL(e.files[0])}}function uploadBanner(e){if(e.files&&e.files[0]){const t=new FileReader;t.onload=e=>{profileBanner=`url(${e.target.result})`,updateBannerPreview(),applyProfileStyles(),saveData()},t.readAsDataURL(e.files[0])}}function uploadBackground(e){if(e.files&&e.files[0]){const t=new FileReader;t.onload=e=>{profileBackground=`url(${e.target.result})`,document.body.style.background=profileBackground,document.body.style.backgroundSize='cover',document.body.style.backgroundPosition='center',document.body.style.backgroundAttachment='fixed',updateBackgroundPreview(),updateColorSelection(),saveData()},t.readAsDataURL(e.files[0])}}function changeBackground(e){profileBackground=e,document.body.style.background=e,document.body.style.backgroundSize='',document.body.style.backgroundPosition='',document.body.style.backgroundAttachment='',generateCompleteTheme(e),updateColorSelection(),updateBackgroundPreview(),document.getElementById('customColorPicker').value=e,saveData()}
function changeGlowColor(color){customGlowColor=color;generateCompleteTheme(profileBackground);document.getElementById('customGlowPicker').value=color;saveData();alert('Custom glow color set!')}
function resetGlowColor(){customGlowColor=null;generateCompleteTheme(profileBackground);document.getElementById('customGlowPicker').value='';saveData();alert('Glow color reset to auto!')}
function updateProfilePicPreview(){const e=document.getElementById('profilePicPreview');profilePicture&&'ML'!==profilePicture&&!profilePicture.startsWith('data:')?(e.innerHTML='<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600;">PROFILE IMAGE</div><p style="color:var(--text-secondary);font-size:.875rem;">Click to upload</p>',e.classList.remove('has-image')):profilePicture.startsWith('data:')?(e.innerHTML=`<img src="${profilePicture}" class="image-preview" alt="Profile Picture">`,e.classList.add('has-image')):(e.innerHTML='<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600;">PROFILE IMAGE</div><p style="color:var(--text-secondary);font-size:.875rem;">Click to upload</p>',e.classList.remove('has-image'))}function updateBannerPreview(){const e=document.getElementById('bannerPreview');if(profileBanner.startsWith('url')){const t=profileBanner.match(/url\(([^)]+)\)/)[1];e.innerHTML=`<img src="${t}" class="image-preview" alt="Banner">`,e.classList.add('has-image')}else e.innerHTML='<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600;">BANNER IMAGE</div><p style="color:var(--text-secondary);font-size:.875rem;">Click to upload</p>',e.classList.remove('has-image')}function updateBackgroundPreview(){const e=document.getElementById('backgroundPreview');if(profileBackground.startsWith('url')){const t=profileBackground.match(/url\(([^)]+)\)/)[1];e.innerHTML=`<img src="${t}" class="image-preview" alt="Background">`,e.classList.add('has-image')}else e.innerHTML='<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600;">BACKGROUND IMAGE</div><p style="color:var(--text-secondary);font-size:.875rem;">Click to upload</p>',e.classList.remove('has-image')}function updateColorSelection(){document.querySelectorAll('.color-option').forEach(e=>{e.classList.remove('selected'),e.dataset.color===profileBackground&&e.classList.add('selected')})}function resetCustomization(){confirm('Reset all customization to defaults?')&&(profilePicture='ML',profileBanner='linear-gradient(135deg,#0a1929,#132f4c)',profileBackground='#050d1a',document.body.style.background=profileBackground,document.body.style.backgroundSize='',document.body.style.backgroundPosition='',document.body.style.backgroundAttachment='',generateCompleteTheme(profileBackground),updateProfilePicPreview(),updateBannerPreview(),updateBackgroundPreview(),updateColorSelection(),applyProfileStyles(),saveData(),alert('Customization reset to defaults!'))}function applyProfileStyles(){const e=document.getElementById('profileAvatarEl');profilePicture&&'ML'!==profilePicture&&profilePicture.startsWith('data:')?(e.style.backgroundImage=`url(${profilePicture})`,e.style.backgroundSize='cover',e.style.backgroundPosition='center',e.textContent=''):(e.style.backgroundImage='',e.textContent='ML'),profileBanner.startsWith('url')?(document.getElementById('profileBannerEl').style.background=profileBanner,document.getElementById('profileBannerEl').style.backgroundSize='cover',document.getElementById('profileBannerEl').style.backgroundPosition='center'):(document.getElementById('profileBannerEl').style.background=profileBanner,document.getElementById('profileBannerEl').style.backgroundSize='',document.getElementById('profileBannerEl').style.backgroundPosition=''),profileBackground.startsWith('url')?(document.body.style.background=profileBackground,document.body.style.backgroundSize='cover',document.body.style.backgroundPosition='center',document.body.style.backgroundAttachment='fixed'):(document.body.style.background=profileBackground,document.body.style.backgroundSize='',document.body.style.backgroundPosition='',document.body.style.backgroundAttachment='')}function showProfileTab(e){currentProfileTab=e;const t=document.querySelector("[onclick=\"showProfileTab('tracks')\"]");document.getElementById('playlistTabBtn');t.classList.toggle('active','tracks'===e),document.getElementById('playlistTabBtn').classList.toggle('active','playlists'===e),document.getElementById('profileTracksSection').style.display='tracks'===e?'block':'none',document.getElementById('profilePlaylistsSection').style.display='playlists'===e?'block':'none',renderProfile()}function renderProfile(){if(document.getElementById('profileTrackCount').textContent=tracks.length,document.getElementById('profilePlaylistCount').textContent=playlists.length,'tracks'===currentProfileTab){const e=document.getElementById('profileTrackList'),t=document.getElementById('profileEmptyTracks');0===tracks.length?(e.innerHTML='',t.style.display='block'):(t.style.display='none',e.innerHTML=tracks.map((e,t)=>`<div class="track"><div class="track-content"><div class="track-number">${e.isPlaying?'‚ô™':t+1}</div>${e.albumArt?`<div class="track-art" style="background-image:url(${e.albumArt})"></div>`:'<div class="track-art">‚ô™</div>'}<button class="play-btn" onclick="togglePlay('${e.id}')">${e.isPlaying?'‚è∏':'‚ñ∂'}</button><div class="track-info"><div class="track-title">${e.title}</div><div class="track-artist">${e.artist} ‚Ä¢ ${e.album}</div><div class="track-duration">${formatDuration(e.duration)}</div></div><div class="track-actions"><button class="btn-small" onclick="openEditTrack('${e.id}')">Edit</button><button class="btn-small" onclick="downloadTrack('${e.id}')">Download</button></div></div></div>`).join(''))}else{const e=document.getElementById('profilePlaylistList'),t=document.getElementById('profileEmptyPlaylists');0===playlists.length?(e.innerHTML='',t.style.display='block'):(t.style.display='none',e.innerHTML=playlists.map(e=>`<div class="playlist-card"><div class="playlist-icon">‚ô™</div><h3 class="playlist-name">${e.name}</h3><p class="playlist-count">${e.trackIds.length} tracks</p></div>`).join(''))}}function OLD_handleFiles_DISABLED(e){const t=Array.from(e).filter(e=>/audio\//.test(e.type)||/\.(mp3|m4a)$/i.test(e.name));if(0===t.length)return;document.getElementById('uploadProgress').classList.add('show');let n=0;t.forEach(e=>{const r=new FileReader;r.onload=function(r){const o=r.target.result,a={id:Math.random().toString(36).slice(2),audioData:o,dataUrl:o,title:e.name.replace(/\.(mp3|m4a|mp4)$/i,''),artist:'Unknown Artist',album:'Unknown Album',albumArt:null,duration:null,isPlaying:!1,filename:e.name},c=new Audio;c.src=o,c.onloadedmetadata=function(){a.duration=c.duration,tracks.push(a),allUserTracks.push(a),++n===t.length&&(document.getElementById('uploadProgress').classList.remove('show'),1===t.length&&openEditTrack(a.id),updateStats(),renderLibrary(),renderPopularTracks(),renderRecentUploads(),saveData())}},r.readAsDataURL(e)})}function renderRecentUploads(){const e=document.getElementById('uploadedTracks'),t=document.getElementById('recentTrackList');if(allUserTracks.length>0){e.style.display='block';const n=allUserTracks.slice(-10).reverse();t.innerHTML=n.map((e,t)=>`<div class="track"><div class="track-content"><div class="track-number">${e.isPlaying?'‚ô™':t+1}</div>${e.albumArt?`<div class="track-art" style="background-image:url(${e.albumArt})"></div>`:'<div class="track-art">‚ô™</div>'}<button class="play-btn" onclick="togglePlay('${e.id}')">${e.isPlaying?'‚è∏':'‚ñ∂'}</button><div class="track-info"><div class="track-title">${e.title}</div><div class="track-artist">${e.artist} ‚Ä¢ ${e.album}</div><div class="track-duration">${formatDuration(e.duration)}</div></div><div class="track-actions"><button class="btn-small" onclick="openEditTrack('${e.id}')">Edit</button><button class="btn-small" onclick="downloadTrack('${e.id}')">Download</button></div></div></div>`).join('')}else e.style.display='none'}function openCreatePlaylist(){document.getElementById('createPlaylistModal').classList.add('show'),dropdown.classList.remove('show')}function closeCreatePlaylist(){document.getElementById('createPlaylistModal').classList.remove('show'),document.getElementById('playlistNameInput').value=''}function confirmCreatePlaylist(){const e=document.getElementById('playlistNameInput').value.trim();e&&(playlists.push({id:Math.random().toString(36).slice(2),name:e,trackIds:[]}),closeCreatePlaylist(),updateStats(),renderProfile(),saveData())}function renderPopularTracks(e){const t=document.getElementById('popularTracks'),n=document.getElementById('noMusic'),r=document.getElementById('noResults'),o=e||allUserTracks;r.style.display='none',n.style.display='none',0===o.length?(t.innerHTML='',(e?r:n).style.display='block'):t.innerHTML=o.slice(0,20).map((e,t)=>`<div class="track"><div class="track-content"><div class="track-number">${e.isPlaying?'‚ô™':t+1}</div>${e.albumArt?`<div class="track-art" style="background-image:url(${e.albumArt})"></div>`:'<div class="track-art">‚ô™</div>'}<button class="play-btn" onclick="togglePlay('${e.id}')">${e.isPlaying?'‚è∏':'‚ñ∂'}</button><div class="track-info"><div class="track-title">${e.title}</div><div class="track-artist">${e.artist} ‚Ä¢ ${e.album}</div><div class="track-duration">${formatDuration(e.duration)}</div></div><div class="track-actions"><button class="btn-small" onclick="downloadTrack('${e.id}')">Download</button></div></div></div>`).join('')}function togglePlay(e){const t=tracks.find(t=>t.id===e)||allUserTracks.find(t=>t.id===e);if(!t)return;if(currentPlayingId!==e||audioPlayer.paused){if(currentPlayingId===e&&audioPlayer.paused)audioPlayer.play(),t.isPlaying=!0,document.getElementById('playerPlayIcon').textContent='‚è∏';else{tracks.forEach(e=>e.isPlaying=!1),allUserTracks.forEach(e=>e.isPlaying=!1);const n=t.dataUrl||t.audioData;audioPlayer.src=n,audioPlayer.load(),audioPlayer.play().then(()=>{currentPlayingId=e,t.isPlaying=!0,totalPlays++,updatePlayerBar(t),updateStats(),renderLibrary(),renderPopularTracks(),renderProfile()}).catch(e=>{console.error('Error playing audio:',e),alert('Error playing this track. The audio data may be corrupted.')})}}else audioPlayer.pause(),t.isPlaying=!1,document.getElementById('playerPlayIcon').textContent='‚ñ∂';renderLibrary(),renderPopularTracks(),renderProfile()}function downloadTrack(e){const t=tracks.find(t=>t.id===e)||allUserTracks.find(t=>t.id===e);if(!t)return;const n=document.createElement('a');n.href=t.dataUrl||t.audioData,n.download=t.filename||'track.mp3',n.click()}function deleteTrack(e){tracks=tracks.filter(t=>t.id!==e),allUserTracks=allUserTracks.filter(t=>t.id!==e),currentPlayingId===e&&(audioPlayer.pause(),currentPlayingId=null,document.getElementById('playerBar').classList.remove('active')),updateStats(),renderLibrary(),renderPopularTracks(),saveData()}function formatDuration(e){if(!e||isNaN(e))return'--:--';const t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n.toString().padStart(2,'0')}`}function updateStats(){document.getElementById('totalTracks').textContent=allUserTracks.length,document.getElementById('trackCount').textContent=tracks.length,document.getElementById('totalArtists').textContent=new Set(allUserTracks.map(e=>e.artist)).size,document.getElementById('totalPlays').textContent=totalPlays}function renderLibrary(){0===tracks.length?(trackList.innerHTML='',emptyState.style.display='block'):(emptyState.style.display='none',trackList.innerHTML=tracks.map((e,t)=>`<div class="track"><div class="track-content"><div class="track-number">${e.isPlaying?'‚ô™':t+1}</div>${e.albumArt?`<div class="track-art" style="background-image:url(${e.albumArt})"></div>`:'<div class="track-art">‚ô™</div>'}<button class="play-btn" onclick="togglePlay('${e.id}')">${e.isPlaying?'‚è∏':'‚ñ∂'}</button><div class="track-info"><div class="track-title">${e.title}</div><div class="track-artist">${e.artist} ‚Ä¢ ${e.album}</div><div class="track-duration">${formatDuration(e.duration)}</div></div><div class="track-actions"><button class="btn-small" onclick="openEditTrack('${e.id}')">Edit</button><button class="btn-small" onclick="downloadTrack('${e.id}')">Download</button><button class="btn-small" onclick="deleteTrack('${e.id}')">Delete</button></div></div></div>`).join(''))}audioPlayer.volume=.7,volumeSlider.value=70,volumeSlider.oninput=function(){audioPlayer.volume=this.value/100},albumArtInput.onchange=function(e){if(e.target.files&&e.target.files[0]){const t=new FileReader;t.onload=function(e){currentEditingAlbumArt=e.target.result;const t=document.getElementById('albumArtPreview');t.style.backgroundImage=`url(${currentEditingAlbumArt})`,t.style.backgroundSize='cover',t.style.backgroundPosition='center',t.textContent='',t.classList.add('has-image')},t.readAsDataURL(e.target.files[0])}},loadData(),profileBtn.onclick=e=>{e.stopPropagation(),dropdown.classList.toggle('show')},document.onclick=e=>{e.target.closest('.profile-menu')||dropdown.classList.remove('show'),e.target.closest('.player-menu')||document.getElementById('playerMenuDropdown').classList.remove('show')},uploadArea.onclick=()=>fileInput.click(),uploadArea.ondragover=e=>{e.preventDefault(),uploadArea.classList.add('drag-active')},uploadArea.ondragleave=()=>uploadArea.classList.remove('drag-active'),uploadArea.ondrop=e=>{e.preventDefault(),uploadArea.classList.remove('drag-active'),handleFiles(e.dataTransfer.files)},fileInput.onchange=e=>handleFiles(e.target.files),searchInput&&(searchInput.oninput=()=>{const e=searchInput.value.toLowerCase().trim();renderPopularTracks(e?allUserTracks.filter(t=>t.title.toLowerCase().includes(e)||t.artist.toLowerCase().includes(e)||t.album.toLowerCase().includes(e)):null)}),audioPlayer.ontimeupdate=function(){isNaN(audioPlayer.duration)||(document.getElementById('progressFill').style.width=audioPlayer.currentTime/audioPlayer.duration*100+'%',document.getElementById('currentTime').textContent=formatTime(audioPlayer.currentTime),document.getElementById('totalTime').textContent=formatTime(audioPlayer.duration))},audioPlayer.onended=()=>{isRepeat&&currentPlayingId?(audioPlayer.currentTime=0,audioPlayer.play()):(tracks.forEach(e=>e.isPlaying=!1),allUserTracks.forEach(e=>e.isPlaying=!1),currentPlayingId=null,document.getElementById('playerPlayIcon').textContent='‚ñ∂',renderLibrary(),renderPopularTracks(),renderProfile())},updateStats(),renderLibrary(),renderPopularTracks(),applyProfileStyles(),renderRecentlyPlayed();

// Bass-reactive player bar glow
let audioContext, analyser, dataArray, bufferLength, bassReactiveInterval;

function initAudioAnalyzer() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    const source = audioContext.createMediaElementSource(audioPlayer);
    source.connect(analyser);
    analyser.connect(audioContext.destination);
    analyser.fftSize = 256;
    bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);
  }
}

function startBassReaction() {
  const playBtn = document.getElementById('playPauseBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const repeatBtn = document.getElementById('repeatBtn');
  const menuBtn = document.getElementById('playerMenuBtn');
  
  if (!playBtn) return;
  
  if (bassReactiveInterval) clearInterval(bassReactiveInterval);
  
  bassReactiveInterval = setInterval(() => {
    if (!audioPlayer.paused && currentPlayingId) {
      analyser.getByteFrequencyData(dataArray);
      
      // Get bass frequencies (roughly 60-250 Hz, which is bins 0-10 for better coverage)
      let bassSum = 0;
      for (let i = 0; i < 10; i++) {
        bassSum += dataArray[i];
      }
      const bassAverage = bassSum / 10;
      
      // Normalize bass intensity (0-255 range to 0-1)
      const rawIntensity = bassAverage / 255;
      
      // Apply EXTREME exponential curve and threshold
      // Cube it for even more dramatic response, then amplify
      const bassIntensity = Math.pow(rawIntensity, 3) * 3; // Cube and 3x amplify
      
      // Only show glow if intensity is above threshold (removes constant glow)
      const threshold = 0.05;
      const finalIntensity = bassIntensity > threshold ? bassIntensity : 0;
      
      // Create pulsating glow based on bass - NO SCALE, only glow
      const glowSize = finalIntensity * 50; // 0-50px on strong bass hits
      
      const buttonGlow = glowSize > 0 ? `0 0 ${glowSize}px var(--accent), 0 0 ${glowSize * 1.5}px var(--accent)` : 'none';
      
      // Apply to all buttons - NO TRANSFORM
      playBtn.style.boxShadow = buttonGlow;
      if (prevBtn) prevBtn.style.boxShadow = buttonGlow;
      if (nextBtn) nextBtn.style.boxShadow = buttonGlow;
      if (repeatBtn) repeatBtn.style.boxShadow = buttonGlow;
      if (menuBtn) menuBtn.style.boxShadow = buttonGlow;
    }
  }, 30); // Faster update (30ms) for more responsive feel
}

function stopBassReaction() {
  if (bassReactiveInterval) {
    clearInterval(bassReactiveInterval);
    bassReactiveInterval = null;
  }
  
  // Reset button styles
  const playBtn = document.getElementById('playPauseBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const repeatBtn = document.getElementById('repeatBtn');
  const menuBtn = document.getElementById('playerMenuBtn');
  
  if (playBtn) playBtn.style.boxShadow = '';
  if (prevBtn) prevBtn.style.boxShadow = '';
  if (nextBtn) nextBtn.style.boxShadow = '';
  if (repeatBtn) repeatBtn.style.boxShadow = '';
  if (menuBtn) menuBtn.style.boxShadow = '';
}

// Hook into audio player events
audioPlayer.addEventListener('play', () => {
  if (!audioContext) initAudioAnalyzer();
  if (audioContext.state === 'suspended') audioContext.resume();
  startBassReaction();
});

audioPlayer.addEventListener('pause', stopBassReaction);
audioPlayer.addEventListener('ended', stopBassReaction);

// ========== SUPABASE AUTH FUNCTIONS ==========

// Check if user is logged in
async function checkAuth() {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) {
    currentUser = session.user;
    document.getElementById('authModal').style.display = 'none';
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('profileMenuContainer').style.display = 'block';
    loadCloudData();
  } else {
    currentUser = null;
    document.getElementById('loginBtn').style.display = 'block';
    document.getElementById('profileMenuContainer').style.display = 'none';
  }
}

// Switch between login and signup tabs
function switchAuthTab(tab) {
  clearAuthMessage();
  
  const loginForm = document.getElementById('loginForm');
  const signupForm = document.getElementById('signupForm');
  const tabs = document.querySelectorAll('.auth-tab');
  
  tabs.forEach(t => t.classList.remove('active'));
  
  if (tab === 'login') {
    loginForm.style.display = 'block';
    signupForm.style.display = 'none';
    tabs[0].classList.add('active');
  } else {
    loginForm.style.display = 'none';
    signupForm.style.display = 'block';
    tabs[1].classList.add('active');
  }
}

// Handle login
async function handleLogin() {
  console.log('handleLogin called');
  clearAuthMessage();
  
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  
  console.log('Email:', email);
  
  if (!email || !password) {
    showAuthMessage('Please fill in all fields', 'error');
    return;
  }
  
  try {
    console.log('Attempting Supabase login...');
    const { data, error } = await supabase.auth.signInWithPassword({
      email: email,
      password: password
    });
    
    console.log('Login response:', { data, error });
    
    if (error) {
      showAuthMessage('Login failed: ' + error.message, 'error');
    } else {
      currentUser = data.user;
      document.getElementById('authModal').style.display = 'none';
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('profileMenuContainer').style.display = 'block';
      loadCloudData();
    }
  } catch (err) {
    console.error('Login error:', err);
    showAuthMessage('Login error: ' + err.message, 'error');
  }
}

// Handle signup
async function handleSignup() {
  console.log('handleSignup called');
  clearAuthMessage();
  
  const email = document.getElementById('signupEmail').value;
  const password = document.getElementById('signupPassword').value;
  const confirmPassword = document.getElementById('signupPasswordConfirm').value;
  
  console.log('Signup email:', email);
  
  if (!email || !password || !confirmPassword) {
    showAuthMessage('Please fill in all fields', 'error');
    return;
  }
  
  if (password !== confirmPassword) {
    showAuthMessage('Passwords do not match', 'error');
    return;
  }
  
  if (password.length < 6) {
    showAuthMessage('Password must be at least 6 characters', 'error');
    return;
  }
  
  try {
    console.log('Attempting Supabase signup...');
    const { data, error } = await supabase.auth.signUp({
      email: email,
      password: password
    });
    
    console.log('Signup response:', { data, error });
    
    if (error) {
      showAuthMessage('Signup failed: ' + error.message, 'error');
    } else {
      showAuthMessage('Account created! Please check your email to verify your account.', 'success');
      // Switch to login tab after 3 seconds
      setTimeout(() => {
        switchAuthTab('login');
        clearAuthMessage();
      }, 3000);
    }
  } catch (err) {
    console.error('Signup error:', err);
    showAuthMessage('Signup error: ' + err.message, 'error');
  }
}

// Handle logout
async function handleLogout() {
  const { error } = await supabase.auth.signOut();
  if (!error) {
    currentUser = null;
    tracks = [];
    allUserTracks = [];
    playlists = [];
    renderLibrary();
    renderPopularTracks();
    document.getElementById('loginBtn').style.display = 'block';
    document.getElementById('profileMenuContainer').style.display = 'none';
  }
}

// Upload track to Supabase Storage
async function uploadToCloud(file, trackData) {
  if (!currentUser) return null;
  
  const fileExt = file.name.split('.').pop();
  const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`;
  
  const { data, error } = await supabase.storage
    .from('audio-files')
    .upload(fileName, file);
  
  if (error) {
    console.error('Upload error:', error);
    return null;
  }
  
  // Get public URL
  const { data: { publicUrl } } = supabase.storage
    .from('audio-files')
    .getPublicUrl(fileName);
  
  return publicUrl;
}

// Save track metadata to database
async function saveTrackToCloud(trackData) {
  if (!currentUser) return;
  
  const { data, error } = await supabase
    .from('tracks')
    .insert({
      user_id: currentUser.id,
      title: trackData.title,
      artist: trackData.artist,
      album: trackData.album,
      audio_url: trackData.audioUrl,
      album_art: trackData.albumArt,
      duration: trackData.duration,
      filename: trackData.filename
    })
    .select();
  
  if (error) {
    console.error('Save error:', error);
  }
  
  return data;
}

// Load tracks from cloud
async function loadCloudData() {
  if (!currentUser) return;
  
  const { data, error } = await supabase
    .from('tracks')
    .select('*')
    .eq('user_id', currentUser.id);
  
  if (!error && data) {
    // Convert cloud data to local format
    allUserTracks = data.map(track => ({
      id: track.id,
      title: track.title,
      artist: track.artist,
      album: track.album,
      albumArt: track.album_art,
      audioData: track.audio_url,
      dataUrl: track.audio_url,
      duration: track.duration,
      filename: track.filename,
      isPlaying: false
    }));
    
    tracks = [...allUserTracks];
    updateStats();
    renderLibrary();
    renderPopularTracks();
    renderRecentUploads();
  }
}

// Delete track from cloud
async function deleteTrackFromCloud(trackId) {
  if (!currentUser) return;
  
  const { error } = await supabase
    .from('tracks')
    .delete()
    .eq('id', trackId)
    .eq('user_id', currentUser.id);
  
  if (error) {
    console.error('Delete error:', error);
  }
}

// Initialize auth check on page load
window.addEventListener('load', () => {
  console.log('=== PAGE LOADED ===');
  
  // Attach login button click handler
  const loginBtn = document.getElementById('loginBtn');
  console.log('Login button found:', loginBtn);
  if (loginBtn) {
    loginBtn.addEventListener('click', () => {
      console.log('LOGIN BUTTON CLICKED!');
      openAuthModal();
    });
    console.log('Login button click listener attached');
  } else {
    console.error('Login button NOT FOUND!');
  }
  
  // Attach modal close button
  const closeBtn = document.getElementById('authModalCloseBtn');
  console.log('Close button found:', closeBtn);
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      console.log('CLOSE BUTTON CLICKED!');
      closeAuthModal();
    });
  }
  
  // Attach tab switching
  const authTabs = document.querySelectorAll('.auth-tab');
  console.log('Auth tabs found:', authTabs.length);
  authTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      console.log('TAB CLICKED:', tab.dataset.tab);
      switchAuthTab(tab.dataset.tab);
    });
  });
  
  // Attach login submit button
  const loginSubmitBtn = document.getElementById('loginSubmitBtn');
  console.log('Login submit button found:', loginSubmitBtn);
  if (loginSubmitBtn) {
    loginSubmitBtn.addEventListener('click', () => {
      console.log('LOGIN SUBMIT CLICKED!');
      handleLogin();
    });
  }
  
  // Attach signup submit button
  const signupSubmitBtn = document.getElementById('signupSubmitBtn');
  console.log('Signup submit button found:', signupSubmitBtn);
  if (signupSubmitBtn) {
    signupSubmitBtn.addEventListener('click', () => {
      console.log('SIGNUP SUBMIT CLICKED!');
      handleSignup();
    });
  }
  
  console.log('=== CHECKING AUTH ===');
  // Check authentication
  checkAuth();
});

// OVERRIDE handleFiles with cloud upload version
async function handleFiles(files) {
  // Check if user is logged in
  if (!currentUser) {
    alert('Please log in to upload music');
    openAuthModal();
    return;
  }
  
  const audioFiles = Array.from(files).filter(e => /audio\//.test(e.type) || /\.(mp3|m4a)$/i.test(e.name));
  if (audioFiles.length === 0) return;
  
  document.getElementById('uploadProgress').classList.add('show');
  
  for (const file of audioFiles) {
    try {
      console.log('Uploading file:', file.name, 'Size:', file.size);
      
      // Upload to Supabase Storage
      const publicUrl = await uploadToCloud(file, null);
      
      if (publicUrl) {
        // Get audio duration
        const audio = new Audio();
        audio.src = publicUrl;
        
        await new Promise((resolve, reject) => {
          audio.onloadedmetadata = () => resolve();
          audio.onerror = () => reject(new Error('Could not load audio'));
        });
        
        const duration = audio.duration;
        
        // Save to Supabase database
        const trackData = {
          title: file.name.replace(/\.(mp3|m4a|mp4)$/i, ''),
          artist: 'Unknown Artist',
          album: 'Unknown Album',
          audioUrl: publicUrl,
          albumArt: null,
          duration: duration,
          filename: file.name
        };
        
        const savedTrack = await saveTrackToCloud(trackData);
        
        if (savedTrack && savedTrack[0]) {
          const track = {
            id: savedTrack[0].id,
            title: savedTrack[0].title,
            artist: savedTrack[0].artist,
            album: savedTrack[0].album,
            albumArt: savedTrack[0].album_art,
            audioData: savedTrack[0].audio_url,
            dataUrl: savedTrack[0].audio_url,
            duration: savedTrack[0].duration,
            filename: savedTrack[0].filename,
            isPlaying: false
          };
          
          tracks.push(track);
          allUserTracks.push(track);
        }
      }
    } catch (error) {
      console.error('Upload error:', error);
      alert('Error uploading ' + file.name + ': ' + error.message);
    }
  }
  
  document.getElementById('uploadProgress').classList.remove('show');
  
  if (audioFiles.length === 1 && allUserTracks.length > 0) {
    openEditTrack(allUserTracks[allUserTracks.length - 1].id);
  }
  
  updateStats();
  renderLibrary();
  renderPopularTracks();
  renderRecentUploads();
}

</script>
</body>
</html>
