<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>basspace - Music Platform</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// Initialize Supabase immediately
const SUPABASE_URL = 'https://xysvtylivtnkykusreln.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5c3Z0eWxpdnRua3lrdXNyZWxuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMzA0NzEsImV4cCI6MjA4MTYwNjQ3MX0.Y3wXBhtyM79fg6sLenv6rGDwpPauCkSd0vMokYw65fA';
var supabase;
var currentUser = null;
var viewingUserId = null; // Track if we're viewing someone else's profile

// Wait for Supabase library to load
window.addEventListener('DOMContentLoaded', function() {
  if (window.supabase) {
    // Create Supabase client with v2 auth persistence
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: {
        persistSession: true,
        storageKey: 'supabase.auth.token',
        storage: {
          getItem: (key) => {
            const item = window.localStorage.getItem(key);
            console.log('ðŸ”‘ Getting auth item:', key, item ? 'exists' : 'null');
            return item;
          },
          setItem: (key, value) => {
            console.log('ðŸ’¾ Setting auth item:', key);
            window.localStorage.setItem(key, value);
          },
          removeItem: (key) => {
            console.log('ðŸ—‘ï¸ Removing auth item:', key);
            window.localStorage.removeItem(key);
          }
        },
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    });
    console.log('âœ… Supabase initialized with localStorage persistence');
    
    // Now that Supabase is ready, set up auth listeners and check session
    setupAuth();
  } else {
    console.error('âŒ Supabase library not loaded!');
  }
});

// Setup authentication after Supabase is initialized
function setupAuth() {
  // Listen for auth state changes (login, logout, token refresh)
  supabase.auth.onAuthStateChange((event, session) => {
    console.log('ðŸ”„ Auth state changed:', event);
    
    if (event === 'SIGNED_IN' && session) {
      console.log('âœ… User signed in:', session.user.email);
      currentUser = session.user;
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('profileMenuContainer').style.display = 'block';
      document.getElementById('notificationBellContainer').style.display = 'block';
      loadNotifications();
      loadCloudData();
    } else if (event === 'SIGNED_OUT') {
      console.log('ðŸ‘‹ User signed out - keeping all settings');
      currentUser = null;
      tracks = [];
      allUserTracks = [];
      // Keep everything else: playlists, colors, profile picture, etc.
      // User should have same settings when they sign back in
      renderLibrary();
      renderPopularTracks();
      document.getElementById('loginBtn').style.display = 'block';
      document.getElementById('profileMenuContainer').style.display = 'none';
    } else if (event === 'TOKEN_REFRESHED') {
      console.log('ðŸ”„ Token refreshed');
    }
  });
  
  // Check for existing session (wait for function to be defined)
  setTimeout(() => {
    if (typeof checkSession === 'function') {
      checkSession();
    }
  }, 100);
  
  // Close notification dropdown when clicking outside
  document.addEventListener('click', function(e) {
    const notificationBell = document.getElementById('notificationBell');
    const notificationDropdown = document.getElementById('notificationDropdown');
    
    if (notificationBell && notificationDropdown && 
        !notificationBell.contains(e.target) && 
        !notificationDropdown.contains(e.target)) {
      notificationDropdown.style.display = 'none';
    }
  });
}

// Modal functions defined globally
function openAuthModal() {
  const modal = document.getElementById('authModal');
  if (modal) {
    modal.style.display = 'flex';
    
    // Clear all signup fields to prevent autofill issues
    const signupUsername = document.getElementById('signupUsername');
    const signupEmail = document.getElementById('signupEmail');
    const signupPassword = document.getElementById('signupPassword');
    const signupPasswordConfirm = document.getElementById('signupPasswordConfirm');
    
    if (signupUsername) signupUsername.value = '';
    if (signupEmail) signupEmail.value = '';
    if (signupPassword) signupPassword.value = '';
    if (signupPasswordConfirm) signupPasswordConfirm.value = '';
    
    // Also clear login fields
    const loginEmail = document.getElementById('loginEmail');
    const loginPassword = document.getElementById('loginPassword');
    
    if (loginEmail) loginEmail.value = '';
    if (loginPassword) loginPassword.value = '';
  }
}

function closeAuthModal() {
  const modal = document.getElementById('authModal');
  if (modal) {
    modal.style.display = 'none';
  }
  // Clear message when closing
  clearAuthMessage();
}

// Show message in auth modal
function showAuthMessage(message, type = 'info') {
  const messageEl = document.getElementById('authMessage');
  if (messageEl) {
    messageEl.textContent = message;
    messageEl.style.display = 'block';
    
    // Style based on type
    if (type === 'success') {
      messageEl.style.background = 'rgba(34, 197, 94, 0.2)';
      messageEl.style.border = '1px solid rgba(34, 197, 94, 0.4)';
      messageEl.style.color = '#86efac';
    } else if (type === 'error') {
      messageEl.style.background = 'rgba(239, 68, 68, 0.2)';
      messageEl.style.border = '1px solid rgba(239, 68, 68, 0.4)';
      messageEl.style.color = '#fca5a5';
    } else {
      messageEl.style.background = 'rgba(59, 130, 246, 0.2)';
      messageEl.style.border = '1px solid rgba(59, 130, 246, 0.4)';
      messageEl.style.color = '#93c5fd';
    }
  }
}

// Clear message
function clearAuthMessage() {
  const messageEl = document.getElementById('authMessage');
  if (messageEl) {
    messageEl.style.display = 'none';
    messageEl.textContent = '';
  }
}

</script>

<!-- INSTANT COLOR LOADING - Prevents flash of default colors -->
<script>
(function() {
  try {
    const savedData = localStorage.getItem('basspace_data');
    if (savedData) {
      const data = JSON.parse(savedData);
      if (data.siteBackgroundColor) {
        const bgColor = data.siteBackgroundColor;
        document.body.style.background = bgColor;
        
        // Generate theme colors from background
        const hexToRgb = (hex) => {
          const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
          return result ? {r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16)} : {r: 5, g: 13, b: 26};
        };
        
        const rgbToHsl = (r, g, b) => {
          r /= 255; g /= 255; b /= 255;
          const max = Math.max(r, g, b), min = Math.min(r, g, b);
          let h, s, l = (max + min) / 2;
          if (max === min) {
            h = s = 0;
          } else {
            const d = max - min;
            s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
            switch (max) {
              case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
              case g: h = ((b - r) / d + 2) / 6; break;
              case b: h = ((r - g) / d + 4) / 6; break;
            }
          }
          return {h: Math.round(h * 360), s: Math.round(s * 100), l: Math.round(l * 100)};
        };
        
        const hslToHex = (h, s, l) => {
          s /= 100; l /= 100;
          const c = (1 - Math.abs(2 * l - 1)) * s;
          const x = c * (1 - Math.abs((h / 60) % 2 - 1));
          const m = l - c / 2;
          let r = 0, g = 0, b = 0;
          if (h >= 0 && h < 60) { r = c; g = x; b = 0; }
          else if (h >= 60 && h < 120) { r = x; g = c; b = 0; }
          else if (h >= 120 && h < 180) { r = 0; g = c; b = x; }
          else if (h >= 180 && h < 240) { r = 0; g = x; b = c; }
          else if (h >= 240 && h < 300) { r = x; g = 0; b = c; }
          else if (h >= 300 && h < 360) { r = c; g = 0; b = x; }
          r = Math.round((r + m) * 255);
          g = Math.round((g + m) * 255);
          b = Math.round((b + m) * 255);
          return '#' + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
        };
        
        const rgb = hexToRgb(bgColor);
        const baseHsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
        const isDark = ((299 * rgb.r) + (587 * rgb.g) + (114 * rgb.b)) / 1000 < 128;
        
        const secondary = hslToHex(baseHsl.h, baseHsl.s, isDark ? Math.min(baseHsl.l * 1.4, 35) : Math.max(baseHsl.l * 0.85, 5));
        const tertiary = hslToHex(baseHsl.h, baseHsl.s, isDark ? Math.min(baseHsl.l * 1.8, 45) : Math.max(baseHsl.l * 0.7, 3));
        const accent = data.customGlowColor || hslToHex(baseHsl.h, Math.min(baseHsl.s * 1.1, 100), isDark ? Math.min(baseHsl.l * 3, 65) : Math.min(baseHsl.l * 1.5, 50));
        
        document.documentElement.style.setProperty('--bg-primary', bgColor);
        document.documentElement.style.setProperty('--bg-secondary', secondary);
        document.documentElement.style.setProperty('--bg-tertiary', tertiary);
        document.documentElement.style.setProperty('--accent', accent);
        document.documentElement.style.setProperty('--card-hue', baseHsl.h);
        document.documentElement.style.setProperty('--card-sat', baseHsl.s + '%');
        document.documentElement.style.setProperty('--card-light', Math.min(baseHsl.l * 1.3, 30) + '%');
      }
    }
  } catch (e) {
    // Silent fail
  }
})();
</script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--bg-primary:#050d1a;--bg-secondary:#0a1929;--bg-tertiary:#132f4c;--accent:#5090d3;--text-primary:#fff;--text-secondary:#8ba3bf;--border-color:rgba(176,196,222,0.12);--border-dark:rgba(0,0,0,0.3);--nav-hue:210;--nav-sat:40%;--nav-light:20%}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto',sans-serif;background-color:var(--bg-primary);color:var(--text-primary);min-height:100vh;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;transition:background-color .3s ease}
.top-nav{background:hsla(var(--nav-hue, 210),var(--nav-sat, 40%),var(--nav-light, 20%),0.7);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border-bottom:1px solid var(--border-color);padding:.75rem 2rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;height:64px;transition:all .3s ease}
.logo{font-size:1.5rem;font-weight:800;cursor:pointer;letter-spacing:-.8px;background:linear-gradient(135deg,var(--accent-light) 0%,var(--text-primary) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 20px var(--accent-light)) drop-shadow(0 0 40px var(--accent-light)) drop-shadow(0 0 60px var(--accent-light))}
.nav-center{display:flex;align-items:center;gap:1rem;flex:1;max-width:600px;margin:0 2rem}
.nav-links{display:flex;gap:2rem;align-items:center}
.nav-link{color:#ffffff;text-decoration:none;font-size:.9rem;font-weight:500;transition:all .3s;cursor:pointer}
.nav-link:hover{color:#ffffff;text-shadow:0 0 20px var(--accent-light),0 0 40px var(--accent-light),0 0 60px var(--accent-light)}
.nav-link.active{color:#ffffff;text-shadow:0 0 30px var(--accent-light),0 0 60px var(--accent-light),0 0 90px var(--accent-light)}
.search-bar{flex:1;position:relative}
.search-icon{position:absolute;left:1rem;top:50%;transform:translateY(-50%);color:var(--text-secondary);font-size:.9rem}
.search-input{width:100%;padding:.6rem 1rem .6rem 2.75rem;background:var(--bg-secondary);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border:1px solid var(--border-color);border-radius:500px;color:var(--text-primary);font-size:.875rem;font-family:'Inter',sans-serif;transition:all .2s;cursor:text}
.search-tab{transition:all .2s}
.search-tab:hover{color:var(--text-primary)!important}
.search-tab.active{color:var(--accent)!important;border-bottom-color:var(--accent)!important}
.search-input:focus{outline:0;background:var(--bg-tertiary);border-color:var(--accent)}
.search-input::placeholder{color:var(--text-secondary);opacity:.6}
.profile-menu{position:relative}
.profile-btn{background:rgba(255,255,255,.08);border:1px solid var(--border-color);border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.75rem;transition:all .2s;font-weight:600}
.profile-btn:hover{background:rgba(255,255,255,.12);border-color:var(--accent)}
.dropdown{position:absolute;top:50px;right:0;background:hsla(var(--nav-hue, 210),var(--nav-sat, 40%),var(--nav-light, 20%),0.95);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid var(--border-color);border-radius:8px;min-width:200px;display:none;box-shadow:0 8px 24px rgba(0,0,0,.4);overflow:hidden}
.dropdown.show{display:block}
.dropdown-item{padding:.875rem 1rem;cursor:pointer;transition:background .2s;font-size:.875rem;font-weight:500;color:var(--text-secondary)}
.dropdown-item:hover{background:rgba(255,255,255,.08);color:var(--text-primary)}
.container{max-width:1600px;margin:0 auto;padding:0 2rem 140px 2rem}
.screen{display:none}
.screen.active{display:block}
#profileScreen{border-radius:0;overflow:visible}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
.section-title{font-size:1.75rem;font-weight:700;letter-spacing:-.5px;text-shadow:0 0 20px var(--accent),0 0 40px var(--accent)}
.recently-played{margin-bottom:3rem}
.horizontal-scroll{display:flex;gap:1rem;overflow-x:auto;padding-bottom:1rem;scrollbar-width:thin;scrollbar-color:var(--accent) transparent}
.horizontal-scroll::-webkit-scrollbar{height:8px}
.horizontal-scroll::-webkit-scrollbar-track{background:0 0}
.horizontal-scroll::-webkit-scrollbar-thumb{background:var(--accent);border-radius:4px}
.album-card{min-width:180px;background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 15%),0.6);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:1rem;cursor:pointer;transition:all .3s;box-shadow:0 4px 12px rgba(0,0,0,0.3),inset 0 1px 1px rgba(255,255,255,0.1);backdrop-filter:blur(10px) saturate(120%);-webkit-backdrop-filter:blur(10px) saturate(120%)}
.album-card:hover{border-color:rgba(255,255,255,0.2);box-shadow:0 0 0 1px var(--accent),0 8px 24px rgba(0,0,0,.5),0 0 40px rgba(var(--accent-rgb, 80,144,211),0.3);transform:translateY(-4px)}
.album-art-large{width:100%;aspect-ratio:1;background:rgba(255,255,255,.08);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:2rem;margin-bottom:1rem;background-size:cover;background-position:center;position:relative}
.play-overlay{position:absolute;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s;border-radius:6px}
.album-card:hover .play-overlay{opacity:1}
.play-overlay-btn{width:48px;height:48px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:var(--accent-text, #fff);border:2px solid rgba(0,0,0,0.4);cursor:pointer;transform:scale(.9);transition:transform .2s;box-shadow:0 2px 8px rgba(0,0,0,0.4)}
.album-card:hover .play-overlay-btn{transform:scale(1);box-shadow:0 4px 12px rgba(0,0,0,0.5),0 0 20px var(--accent)}
.album-title{font-weight:600;font-size:.875rem;margin-bottom:.25rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 15px var(--accent)}
.album-artist{color:var(--text-secondary);font-size:.8rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 8px var(--accent)}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:3rem}
.stat-card{background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 15%),0.6);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:2rem;text-align:center;transition:all .3s;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.3),inset 0 1px 1px rgba(255,255,255,0.1);backdrop-filter:blur(10px) saturate(120%);-webkit-backdrop-filter:blur(10px) saturate(120%)}
.stat-card:hover{border-color:rgba(255,255,255,0.2);box-shadow:0 0 0 1px var(--accent),0 8px 24px rgba(0,0,0,.5),0 0 40px rgba(var(--accent-rgb, 80,144,211),0.3);transform:translateY(-6px)}
.stat-number{font-size:3rem;font-weight:800;margin-bottom:.5rem;letter-spacing:-1px;color:var(--text-primary);text-shadow:0 0 20px var(--accent),0 0 40px var(--accent)}
.stat-label{color:var(--text-secondary);font-size:.875rem;text-transform:uppercase;letter-spacing:1px;font-weight:600}
.profile-header{position:relative;margin-bottom:2rem}
.profile-banner{height:200px;border-radius:0;overflow:hidden;backdrop-filter:blur(30px);-webkit-backdrop-filter:blur(30px);position:relative;border:1px solid rgba(255,255,255,0.08);border-left:none;border-right:none}
.profile-content-wrapper{padding:0 2rem;position:relative;margin-top:-60px}
.profile-main-info{display:flex;align-items:flex-start;gap:1.5rem}
.profile-main-info:hover{border-color:rgba(255,255,255,0.15);box-shadow:0 12px 32px rgba(0,0,0,.4)}
.profile-avatar-large{width:120px;height:120px;background:var(--bg-secondary);border:3px solid var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:3rem;font-weight:800;flex-shrink:0;box-shadow:0 0 30px var(--accent),0 8px 24px rgba(0,0,0,.4);position:relative;background-size:cover;background-position:center}
.profile-avatar-large::before{content:'';position:absolute;inset:-3px;border-radius:50%;background:linear-gradient(135deg,var(--accent),transparent);opacity:.3;z-index:-1}
.profile-text-content{flex:1;min-width:0}
.profile-text-content h1{font-size:2rem;font-weight:800;letter-spacing:-0.5px;text-shadow:0 0 20px var(--accent)}
.profile-username{color:var(--text-secondary);font-size:.85rem;font-weight:600;text-transform:uppercase;letter-spacing:1px}
.profile-bio{color:var(--text-secondary);font-size:.9rem;line-height:1.6;max-width:600px}
.profile-stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;margin-bottom:2rem}
.stat-card{background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 15%),0.6);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:1.25rem;display:flex;align-items:center;gap:1rem;transition:all .3s;cursor:pointer;backdrop-filter:blur(10px) saturate(120%);-webkit-backdrop-filter:blur(10px) saturate(120%);box-shadow:0 4px 12px rgba(0,0,0,0.3),inset 0 1px 1px rgba(255,255,255,0.1)}
.stat-card:hover{border-color:rgba(255,255,255,0.2);box-shadow:0 0 0 1px var(--accent),0 8px 24px rgba(0,0,0,.5),0 0 40px rgba(var(--accent-rgb, 80,144,211),0.3);transform:translateY(-2px)}
.stat-icon{font-size:2rem;opacity:.8}
.stat-content{flex:1}
.stat-number{font-size:1.75rem;font-weight:800;line-height:1;margin-bottom:.25rem;text-shadow:0 0 15px var(--accent)}
.stat-label{font-size:.75rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
.profile-tabs{display:flex;gap:1rem;border-bottom:2px solid var(--border-color);margin-bottom:2rem;padding:0 2rem}
.profile-tab{background:0 0;border:none;color:var(--text-secondary);font-size:.9rem;font-weight:600;padding:1rem 1.5rem;cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;font-family:'Inter',sans-serif;display:flex;align-items:center;gap:.5rem;border-radius:8px 8px 0 0}
.profile-tab:hover{background:rgba(255,255,255,0.05);color:var(--text-primary)}
.profile-tab.active{color:var(--text-primary);border-bottom-color:var(--accent);background:rgba(255,255,255,0.03)}
.tab-icon{font-size:1.1rem}
.stats-detailed-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem;padding:0 2rem}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:1rem 0;border-bottom:1px solid var(--border-color)}
.stat-row:last-child{border-bottom:none}
.stat-row-label{color:var(--text-secondary);font-size:.9rem;font-weight:500}
.stat-row-value{color:var(--text-primary);font-size:1.1rem;font-weight:700;text-shadow:0 0 10px var(--accent)}
.top-list{display:flex;flex-direction:column;gap:.75rem}
.top-list-item{display:flex;align-items:center;gap:1rem;padding:.75rem;background:rgba(255,255,255,0.03);border-radius:8px;transition:all .2s}
.top-list-item:hover{background:rgba(255,255,255,0.08)}
.top-list-rank{font-size:1.2rem;font-weight:800;color:var(--accent);min-width:30px}
.top-list-info{flex:1}
.top-list-name{font-weight:600;margin-bottom:.25rem}
.top-list-count{font-size:.85rem;color:var(--text-secondary)}
.profile-info{padding:0 2rem;margin-top:-60px;position:relative}
.profile-avatar-container{display:flex;align-items:flex-end;gap:2rem;margin-bottom:1.5rem}
.profile-avatar{width:140px;height:140px;background:var(--bg-secondary);border:4px solid var(--bg-primary);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:2.5rem;font-weight:800;box-shadow:0 8px 24px rgba(0,0,0,.4)}
.profile-details h1{font-size:2.5rem;font-weight:800;margin-bottom:.5rem;letter-spacing:-1px;text-shadow:0 0 25px var(--accent),0 0 50px var(--accent)}
.settings-section{background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 15%),0.6);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:2rem;margin-bottom:1.5rem;transition:all .3s;box-shadow:0 4px 12px rgba(0,0,0,0.3),inset 0 1px 1px rgba(255,255,255,0.1);backdrop-filter:blur(10px) saturate(120%);-webkit-backdrop-filter:blur(10px) saturate(120%)}
.settings-section:hover{border-color:rgba(255,255,255,0.2);box-shadow:0 0 0 1px var(--accent),0 8px 24px rgba(0,0,0,.5),0 0 40px rgba(var(--accent-rgb, 80,144,211),0.3)}
.settings-section h3{font-size:1.25rem;margin-bottom:2rem;font-weight:700;text-shadow:0 0 15px var(--accent),0 0 30px var(--accent)}

/* Frosted Glass Effect for Profile Page with Background */
.profile-page.has-background .panel,
.profile-page.has-background .track,
.profile-page.has-background .settings-section,
.profile-page.has-background .profile-info,
.profile-page.has-background .upload-area,
.profile-page.has-background .empty-state{background:rgba(10,13,26,0.7)!important;backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid rgba(255,255,255,0.18)}
.profile-page.has-background{background-size:cover!important;background-position:center!important;background-attachment:fixed!important}
.profile-page.has-background .profile-header{background:transparent}

/* Solid Panel Style */
.profile-page.solid-panels .panel,
.profile-page.solid-panels .track,
.profile-page.solid-panels .profile-info,
.profile-page.solid-panels .upload-area,
.profile-page.solid-panels .empty-state{background:var(--panel-bg,#0a0d1a)!important;backdrop-filter:none;-webkit-backdrop-filter:none;border:1px solid rgba(255,255,255,0.1)}

/* No Glow Option */
.profile-page.no-glow .panel,
.profile-page.no-glow .track,
.profile-page.no-glow .settings-section,
.profile-page.no-glow h1,
.profile-page.no-glow h2,
.profile-page.no-glow h3{text-shadow:none!important;box-shadow:none!important}

.setting-item{display:flex;justify-content:space-between;align-items:center;padding:1.25rem 0;border-bottom:1px solid var(--border-color)}
.setting-item:last-child{border-bottom:none}
.setting-label h4{margin-bottom:.25rem;font-weight:600;font-size:.95rem}
.setting-label p{color:var(--text-secondary);font-size:.85rem}
.toggle{width:50px;height:28px;background:rgba(255,255,255,.1);border-radius:14px;position:relative;cursor:pointer;transition:background .2s}
.toggle.active{background:var(--accent)}
.toggle-slider{width:24px;height:24px;background:#fff;border-radius:50%;position:absolute;top:2px;left:2px;transition:all .2s;box-shadow:0 2px 4px rgba(0,0,0,.2)}
.toggle.active .toggle-slider{left:24px}
.input-group{margin-bottom:1.5rem}
.input-group label{display:block;margin-bottom:.75rem;color:var(--text-secondary);font-size:.875rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.btn{padding:.875rem 2rem;border:none;border-radius:500px;font-weight:700;cursor:pointer;transition:all .2s;font-size:.95rem;font-family:'Inter',sans-serif;letter-spacing:.3px;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
.btn-primary{background:var(--accent);color:var(--accent-text, #fff);box-shadow:0 2px 8px rgba(0,0,0,0.3);border:2px solid rgba(0,0,0,0.3)}
.btn-primary:hover{transform:scale(1.05);filter:brightness(1.1);box-shadow:0 4px 12px rgba(0,0,0,0.4),0 0 20px var(--accent);border-color:rgba(0,0,0,0.5)}
.btn-secondary{background:rgba(255,255,255,.08);color:#fff;border:1px solid rgba(255,255,255,0.2);text-shadow:0 1px 3px rgba(0,0,0,0.5)}
.btn-secondary:hover{background:rgba(255,255,255,.15);border-color:rgba(255,255,255,0.3)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.9);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:1000}
.modal-overlay.show{display:flex}
.modal{background:hsla(var(--nav-hue, 210),var(--nav-sat, 40%),var(--nav-light, 20%),0.92);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid var(--border-color);border-radius:12px;padding:2.5rem;width:90%;max-width:500px;max-height:90vh;overflow-y:auto;position:relative}
.modal h3{font-size:1.75rem;margin-bottom:2rem;font-weight:700;text-shadow:0 0 20px var(--accent),0 0 40px var(--accent)}
.input{width:100%;padding:.875rem 1.25rem;background:rgba(255,255,255,.05);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:.95rem;margin-bottom:1rem;font-family:'Inter',sans-serif;transition:all .2s}
.input:focus{outline:0;border-color:var(--accent);background:rgba(255,255,255,.08)}
.input::placeholder{color:var(--text-secondary);opacity:.6}
textarea.input{resize:vertical;font-family:'Inter',sans-serif}
.modal-buttons{display:flex;gap:1rem;margin-top:2rem}
.modal-buttons .btn{flex:1}
.playlist-selection-item{padding:1rem;background:rgba(255,255,255,0.05);border:1px solid var(--border-color);border-radius:8px;margin-bottom:0.75rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:space-between}
.playlist-selection-item:hover:not(.disabled){background:rgba(255,255,255,0.1);border-color:var(--accent);transform:translateX(5px)}
.playlist-selection-item.disabled{opacity:0.5;cursor:not-allowed}
.upload-area{border:2px dashed rgba(255,255,255,0.2);border-radius:12px;padding:4rem;text-align:center;cursor:pointer;transition:all .3s;background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 15%),0.4);margin-bottom:2rem;backdrop-filter:blur(10px) saturate(120%);-webkit-backdrop-filter:blur(10px) saturate(120%);box-shadow:0 4px 12px rgba(0,0,0,0.3),inset 0 1px 1px rgba(255,255,255,0.1)}
.upload-area:hover{border-color:var(--accent);background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 18%),0.5);box-shadow:0 0 0 1px var(--accent),0 8px 24px rgba(0,0,0,.5),0 0 40px rgba(var(--accent-rgb, 80,144,211),0.3)}
.upload-area.drag-active{border-color:var(--accent);background:hsla(var(--card-hue, 210),var(--card-sat, 40%),var(--card-light, 20%),0.6);box-shadow:0 0 0 2px var(--accent),0 8px 24px rgba(0,0,0,.5),0 0 50px var(--accent)}
.upload-icon{font-size:3.5rem;margin-bottom:1.5rem;color:var(--text-secondary);font-weight:300;text-shadow:0 0 30px var(--accent),0 0 60px var(--accent)}
.upload-area h2{font-size:1.5rem;margin-bottom:.75rem;font-weight:700}
.upload-area p{color:var(--text-secondary);font-size:1rem}
.track-list{display:flex;flex-direction:column;gap:.5rem;position:relative;z-index:1}
.track{background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 15%),0.6);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:.75rem 1rem;transition:all .3s;cursor:pointer;box-shadow:0 4px 12px rgba(0,0,0,0.3),inset 0 1px 1px rgba(255,255,255,0.1);overflow:visible;position:relative;backdrop-filter:blur(10px) saturate(120%);-webkit-backdrop-filter:blur(10px) saturate(120%)}
.track:hover{border-color:rgba(255,255,255,0.2);box-shadow:0 0 0 1px var(--accent),0 8px 24px rgba(0,0,0,.5),0 0 40px rgba(var(--accent-rgb, 80,144,211),0.3)}
.track-content{display:flex;align-items:center;gap:1rem}
.track-number{width:2rem;text-align:center;color:var(--text-secondary);font-family:'Space Mono',monospace;font-size:.85rem;font-weight:600}
.track-art{width:48px;height:48px;background:rgba(255,255,255,.08);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;background-size:cover;background-position:center;color:var(--text-secondary);font-weight:600}
.play-btn{width:40px;height:40px;background:var(--accent);color:var(--accent-text, #fff);border:2px solid rgba(0,0,0,0.4);border-radius:50%;font-size:.9rem;cursor:pointer;transition:transform .2s,box-shadow .2s,filter .2s;display:flex;align-items:center;justify-content:center;font-weight:900;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,0.4);text-shadow:0 1px 2px rgba(0,0,0,0.5)}
.play-btn:hover{transform:scale(1.1);filter:brightness(1.15);box-shadow:0 4px 12px rgba(0,0,0,0.5);border-color:rgba(0,0,0,0.6)}
.track-info{flex:1;min-width:0}
.track-title{font-size:.95rem;font-weight:600;margin-bottom:.25rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 15px var(--accent)}
.track-artist{font-size:.85rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 8px var(--accent)}
.track-duration{font-size:.8rem;color:var(--text-secondary);margin-top:.25rem;font-family:'Space Mono',monospace}
.track-actions{display:flex;gap:.5rem;flex-shrink:0;position:relative;z-index:1;overflow:visible}
.track-menu-btn{width:32px;height:32px;background:rgba(255,255,255,.05);border:1px solid var(--border-color);border-radius:50%;color:var(--text-secondary);font-weight:900;cursor:pointer;transition:all .2s;font-size:1.2rem;display:flex;align-items:center;justify-content:center;line-height:1;position:relative;z-index:99999}
.track-menu-btn:hover{background:rgba(255,255,255,.1);border-color:var(--accent);color:var(--accent)}
.track-dropdown{position:absolute;right:0;top:100%;margin-top:.5rem;background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 12%),0.95);border:1px solid rgba(255,255,255,0.15);border-radius:10px;padding:.5rem;min-width:140px;z-index:999999;display:none;box-shadow:0 12px 40px rgba(0,0,0,.6),0 0 0 1px rgba(255,255,255,0.1) inset;backdrop-filter:blur(40px) saturate(180%);-webkit-backdrop-filter:blur(40px) saturate(180%)}
.playlist-track-row:hover .track-number{opacity:0}
.playlist-track-row .track-play-btn{opacity:0;transition:opacity .2s,transform .1s}
.playlist-track-row:hover .track-play-btn{opacity:1}
.track-dropdown.show{display:block;pointer-events:auto}
.track-dropdown::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;z-index:-1;pointer-events:none}
.track-dropdown.show::before{pointer-events:none}
.track-dropdown-item{padding:.5rem .75rem;color:var(--text-primary);font-size:.8rem;font-weight:600;cursor:pointer;border-radius:4px;transition:all .2s;white-space:nowrap;position:relative}
.track-dropdown-item:hover{background:rgba(255,255,255,.1);color:var(--accent)}
.track-dropdown-item.delete{color:#ff6b6b}
.track-dropdown-item.delete:hover{background:rgba(255,107,107,.1)}
.track-dropdown-item.has-submenu{padding-right:1.5rem}
.track-dropdown-item.has-submenu:after{content:'â€º';position:absolute;right:.5rem;top:50%;transform:translateY(-50%);font-size:1.2rem;line-height:1}
.track-submenu{position:absolute;top:-0.25rem;left:calc(100% + 0.25rem);background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 10%),0.97);border:1px solid rgba(255,255,255,0.2);border-radius:10px;padding:.5rem;min-width:160px;max-height:280px;overflow-y:auto;box-shadow:0 16px 48px rgba(0,0,0,.7),0 0 0 1px rgba(255,255,255,0.15) inset;backdrop-filter:blur(50px) saturate(200%);-webkit-backdrop-filter:blur(50px) saturate(200%);display:none;z-index:9999999;pointer-events:auto}
.track-submenu.show{display:block;pointer-events:auto}
.track-submenu-item{padding:.5rem .75rem;color:var(--text-primary);font-size:.8rem;font-weight:600;cursor:pointer;border-radius:4px;transition:all .2s;display:flex;justify-content:space-between;align-items:center;gap:.5rem}
.track-submenu-item:hover:not(.added){background:rgba(255,255,255,.1);color:var(--accent)}
.track-submenu-item.added{opacity:.5;cursor:not-allowed}
.track-submenu-item .checkmark{color:#22c55e;font-weight:bold;font-size:1rem}
.btn-small{padding:.5rem .875rem;background:rgba(255,255,255,.05);border:1px solid var(--border-color);border-radius:500px;color:var(--text-secondary);font-weight:600;cursor:pointer;transition:all .2s;font-size:.8rem}
.btn-small:hover{background:rgba(255,255,255,.1);color:var(--text-primary);border-color:var(--accent)}
.empty-state{text-align:center;padding:5rem 2rem}
.empty-state-icon{font-size:3rem;opacity:.4;margin-bottom:1.5rem;color:var(--text-primary);font-weight:300}
.empty-state h2{font-size:1.5rem;font-weight:700;margin-bottom:.5rem;text-shadow:0 0 20px var(--accent),0 0 40px var(--accent)}
.empty-state p{color:var(--text-secondary);font-size:.95rem;text-shadow:0 0 8px var(--accent)}
.page-header{margin-bottom:2.5rem;margin-top:-2rem;padding-top:0 !important}
.page-header h1{font-size:3rem;margin-bottom:.75rem;font-weight:900;letter-spacing:-1px;margin-top:0}
.page-header p{color:var(--text-secondary);font-size:.95rem;text-shadow:0 0 8px var(--accent)}
.image-upload-box{border:2px dashed var(--border-color);border-radius:8px;padding:2rem;text-align:center;cursor:pointer;transition:all .2s;background:rgba(255,255,255,.02);margin-top:.75rem;position:relative;overflow:hidden}
.image-upload-box:hover{border-color:var(--accent);background:rgba(255,255,255,.05)}
.image-upload-box.has-image{border-style:solid;border-color:var(--accent)}
.image-preview{width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0}
.color-picker-group{display:flex;gap:.75rem;margin-top:.75rem;flex-wrap:wrap}
.color-option{width:56px;height:56px;border:2px solid var(--border-color);border-radius:8px;cursor:pointer;transition:all .2s;position:relative}
.color-option:hover{border-color:var(--accent);transform:scale(1.05)}
.color-option.selected{border-color:var(--accent);border-width:3px}
.color-option.selected::after{content:'âœ“';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:1.5rem;font-weight:700;text-shadow:0 0 4px rgba(0,0,0,.8)}
.album-art-upload{width:160px;height:160px;border:2px dashed var(--border-color);background:rgba(255,255,255,.02);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;margin:0 auto 1.5rem;position:relative;overflow:hidden;font-size:2rem;color:var(--text-secondary);font-weight:600}
.album-art-upload:hover{border-color:var(--accent);background:rgba(255,255,255,.05)}
.album-art-upload.has-image{border-style:solid;border-color:var(--accent)}
.player-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.3);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border-top:2px solid var(--border-dark);padding:.75rem 2rem;display:none;z-index:200;height:90px;transition:all .3s ease}
.player-bar.active{display:flex}
.player-content{max-width:1600px;margin:0 auto;width:100%;display:grid;grid-template-columns:1fr 2fr 1fr;align-items:center;gap:2rem}
.player-track-info{display:flex;align-items:center;gap:1rem;min-width:0}
.player-track-art{width:56px;height:56px;background:rgba(255,255,255,.08);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;background-size:cover;background-position:center;color:var(--text-secondary);font-weight:600}
.player-text{min-width:0}
.player-title{font-weight:600;font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 15px var(--accent)}
.player-artist{color:var(--text-secondary);font-size:.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 8px var(--accent)}
.player-center{display:flex;flex-direction:column;gap:.5rem}
.player-controls{display:flex;align-items:center;justify-content:center;gap:1rem}
.player-btn{background:rgba(255,255,255,.08);border:1px solid var(--border-color);width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background .2s,border-color .2s;color:var(--text-primary);font-size:.85rem}
.player-btn.active{color:var(--accent);filter:drop-shadow(0 0 8px var(--accent)) drop-shadow(0 0 12px var(--accent));background:rgba(var(--accent-rgb),.15);border-color:var(--accent)}
.player-control-btn{background:transparent;border:none;width:36px;height:36px;color:var(--text-secondary);cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;border-radius:8px;position:relative}
.player-control-btn:hover{color:var(--text-primary);background:rgba(255,255,255,.05)}
.player-control-btn.active{color:var(--accent);filter:drop-shadow(0 0 8px var(--accent)) drop-shadow(0 0 12px var(--accent));background:rgba(var(--accent-rgb),.15)}
.playlist-control-btn{background:transparent;border:none;width:32px;height:32px;color:var(--text-secondary);cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;border-radius:8px}
.playlist-control-btn:hover{color:var(--text-primary)}
.playlist-control-btn.active{color:var(--accent);filter:drop-shadow(0 0 10px var(--accent)) drop-shadow(0 0 16px var(--accent)) drop-shadow(0 0 20px var(--accent));background:rgba(var(--accent-rgb),.2)}
.player-btn:hover{background:rgba(255,255,255,.15);border-color:var(--accent)}
.player-btn.repeat.active{background:var(--accent);color:var(--accent-text, #fff);border-color:rgba(0,0,0,0.3)}
.player-btn-main{width:40px;height:40px;background:var(--accent);color:var(--accent-text, #fff);font-size:1rem;border:2px solid rgba(0,0,0,0.4);box-shadow:0 2px 8px rgba(0,0,0,0.3)}
.player-btn-main:hover{filter:brightness(1.1);box-shadow:0 4px 12px rgba(0,0,0,0.4),0 0 20px var(--accent);border-color:rgba(0,0,0,0.6)}
.player-btn-main span{display:flex;align-items:center;justify-content:center;width:100%;height:100%;padding-left:2px}
.progress-container{display:flex;align-items:center;gap:.75rem}
.progress-time{font-size:.75rem;color:var(--text-secondary);font-family:'Space Mono',monospace;min-width:40px}
.progress-bar{flex:1;height:6px;background:rgba(255,255,255,.1);border-radius:3px;cursor:pointer;position:relative}
.progress-bar:hover .progress-fill::after{opacity:1}
.progress-fill{height:100%;background:var(--accent);border-radius:3px;position:relative;transition:width .1s linear}
.progress-fill::after{content:'';position:absolute;right:-6px;top:50%;transform:translateY(-50%);width:12px;height:12px;background:#fff;border-radius:50%;opacity:0;transition:opacity .2s}
.player-right{display:flex;align-items:center;justify-content:flex-end;gap:1rem}
.volume-control{display:flex;align-items:center;gap:.75rem}
.volume-icon{font-size:.85rem;cursor:pointer;color:var(--text-secondary);font-weight:600;transition:color .2s}
.volume-icon:hover{color:var(--text-primary)}
.volume-slider{-webkit-appearance:none;appearance:none;width:100px;height:4px;background:rgba(255,255,255,.1);outline:0;cursor:pointer;border-radius:2px}
.volume-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:12px;height:12px;background:#fff;cursor:pointer;border-radius:50%}
.volume-slider::-moz-range-thumb{width:12px;height:12px;background:#fff;cursor:pointer;border:none;border-radius:50%}
.player-menu{position:relative}
.player-menu-btn{background:0 0;border:none;color:var(--text-secondary);font-size:1.2rem;cursor:pointer;padding:.5rem;transition:color .2s}
.player-menu-btn:hover{color:var(--text-primary)}
.player-menu-dropdown{position:fixed;background:hsla(var(--nav-hue, 210),var(--nav-sat, 40%),var(--nav-light, 20%),0.95);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid var(--border-color);border-radius:8px;min-width:200px;display:none;box-shadow:0 8px 24px rgba(0,0,0,.4);z-index:10000}
.player-menu-dropdown.show{display:block}
.player-menu-item{padding:.875rem 1rem;cursor:pointer;transition:background .2s;font-size:.875rem;color:var(--text-secondary);display:flex;align-items:center;gap:.75rem}
.player-menu-item:hover{background:rgba(255,255,255,.08);color:var(--text-primary)}
.player-menu-item:first-child{border-radius:8px 8px 0 0}
.player-menu-item:last-child{border-radius:0 0 8px 8px}
.upload-progress{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:hsla(var(--nav-hue, 210),var(--nav-sat, 40%),var(--nav-light, 20%),0.95);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid var(--border-color);border-radius:12px;padding:2.5rem;z-index:2000;display:none;text-align:center;min-width:320px}
.upload-progress.show{display:block}
.spinner{border:3px solid rgba(255,255,255,.1);border-top:3px solid var(--accent);border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 1.5rem}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.playlist-card{background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 15%),0.6);border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:1.5rem;cursor:pointer;transition:all .3s;display:flex;flex-direction:column;gap:1rem;box-shadow:0 4px 12px rgba(0,0,0,0.3),inset 0 1px 1px rgba(255,255,255,0.1);height:100%;backdrop-filter:blur(10px) saturate(120%);-webkit-backdrop-filter:blur(10px) saturate(120%)}
.playlist-card:hover{border-color:rgba(255,255,255,0.2);transform:translateY(-4px);box-shadow:0 0 0 1px var(--accent),0 8px 24px rgba(0,0,0,.5),0 0 40px rgba(var(--accent-rgb, 80,144,211),0.3)}
.playlist-icon{font-size:3rem;width:100%;aspect-ratio:1;background:rgba(255,255,255,0.05);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:600;text-shadow:0 0 20px var(--accent);border:1px solid rgba(255,255,255,0.1);margin-bottom:0.5rem}
.playlist-name{font-weight:700;font-size:1.1rem;margin-bottom:.5rem;text-shadow:0 0 12px var(--accent);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.playlist-count{color:var(--text-secondary);font-size:.85rem;text-shadow:0 0 8px var(--accent)}
.color-input-group{display:flex;gap:1rem;align-items:center;margin-top:1rem}
.color-picker-input{width:60px;height:60px;border:2px solid var(--border-color);border-radius:8px;cursor:pointer;background:0 0}
.color-picker-input::-webkit-color-swatch-wrapper{padding:0}
.color-picker-input::-webkit-color-swatch{border:none;border-radius:6px}
.auth-tab{background:transparent;border:none;color:rgba(255,255,255,0.4);padding:.75rem 1.5rem;cursor:pointer;font-size:.95rem;font-weight:600;border-bottom:2px solid transparent;transition:all .2s;border-radius:8px 8px 0 0}
.auth-tab.active{color:#fff;background:var(--accent);border-bottom-color:var(--accent);font-weight:700}
.auth-tab:hover:not(.active){color:rgba(255,255,255,0.7);background:rgba(255,255,255,0.05)}
.input{width:100%;padding:.75rem 1rem;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:.95rem;transition:all .2s}
.input:focus{outline:none;border-color:var(--accent);background:var(--bg-tertiary)}
.input::placeholder{color:var(--text-secondary);opacity:.6}
.modal.show{display:flex !important}

/* Mobile Responsive Styles */
@media (max-width: 768px) {
  /* Typography - smaller, cleaner */
  .section-title{font-size:1.3rem}
  .page-header h1{font-size:2rem}
  .stat-number{font-size:2rem}
  
  /* Container - tighter padding */
  .container{padding:0 1rem 140px 1rem}
  
  /* Header - compact, centered */
  .header{padding:1rem;flex-direction:column;gap:1rem}
  .logo{font-size:1.3rem}
  .nav-links{gap:1rem;width:100%;justify-content:space-around}
  .nav-link{font-size:.85rem}
  .search-container{width:100%;order:3}
  .profile-menu{position:absolute;top:1rem;right:1rem}
  
  /* Stats grid - 2 columns, symmetrical */
  .stats-grid{grid-template-columns:1fr 1fr;gap:.75rem}
  .stat-card{padding:1.25rem}
  
  /* Track list - streamlined */
  .track{padding:.5rem}
  .track-content{gap:.5rem}
  .track-number{min-width:24px;font-size:.8rem}
  .track-art{width:40px;height:40px;font-size:.8rem}
  .play-btn{width:32px;height:32px;font-size:.7rem}
  .track-info{flex:1;min-width:0}
  .track-title{font-size:.85rem}
  .track-artist{font-size:.75rem}
  .track-duration{font-size:.7rem}
  .track-actions{flex-direction:column;gap:.25rem;width:auto}
  .btn-small{padding:.4rem .6rem;font-size:.7rem;white-space:nowrap}
  
  /* Albums - 2 columns, symmetrical */
  .albums-scroll{gap:.75rem;padding:.5rem 0}
  .album-card{min-width:calc(50% - .375rem);max-width:calc(50% - .375rem)}
  .album-art-large{height:120px}
  
  /* Player bar - compact, stacked */
  .player-bar{padding:.75rem 1rem;height:auto}
  .player-content{grid-template-columns:1fr;gap:1rem}
  .player-track-info{order:1}
  .player-track-art{width:48px;height:48px}
  .player-title{font-size:.85rem}
  .player-artist{font-size:.75rem}
  .player-center{order:2}
  .player-controls{gap:.75rem;justify-content:center}
  .player-btn{width:36px;height:36px;font-size:.9rem}
  .player-btn-main{width:44px;height:44px;font-size:1.1rem}
  .progress-container{order:3}
  .player-right{display:none}
  
  /* Modals - full screen on mobile */
  .modal-content{width:100%;height:100vh;max-width:100%;margin:0;border-radius:0;padding:1.5rem}
  
  /* Settings - single column */
  .settings-section{padding:1.25rem}
  .setting-item{flex-direction:column;align-items:flex-start;gap:.5rem}
  .color-picker-group{gap:.5rem}
  .color-option{width:48px;height:48px}
  
  /* Profile - streamlined */
  .profile-banner{height:120px}
  .profile-header{padding:1rem;margin-top:-40px}
  .profile-avatar{width:80px;height:80px;font-size:1.8rem}
  .profile-stats{flex-direction:column;gap:.75rem;width:100%}
  .profile-stat{text-align:center;padding:.75rem}
  
  /* Playlists - 2 columns symmetrical */
  .playlists-grid{grid-template-columns:1fr 1fr;gap:.75rem}
  .playlist-card{padding:1rem;height:140px}
  .playlist-icon{font-size:1.5rem;margin-bottom:.5rem}
  .playlist-name{font-size:.95rem}
  
  /* Hide unnecessary elements */
  .empty-state{padding:3rem 1rem}
  .empty-state-icon{font-size:2rem}
  
  /* Upload area - compact */
  .upload-area{padding:2rem 1rem}
  .upload-icon{font-size:2.5rem}
}

/* Extra small devices */
@media (max-width: 480px) {
  .stats-grid{grid-template-columns:1fr;gap:.5rem}
  .albums-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch;display:flex;flex-wrap:nowrap}
  .album-card{min-width:140px;max-width:140px}
  .playlists-grid{grid-template-columns:1fr;gap:.5rem}
  .track-actions{position:static;margin-top:.5rem;flex-direction:row;justify-content:flex-start}
}
</style>
</head>
<body>

<!-- Auth Modal -->
<div id="authModal" class="modal-overlay" style="display:none">
<div class="modal" style="max-width:400px;position:relative">
<button id="authModalCloseBtn" style="position:absolute;top:1rem;right:1rem;background:transparent;border:none;color:var(--text-secondary);font-size:1.5rem;cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">Ã—</button>
<h3 style="margin-bottom:2rem;text-align:center">welcome to basspace</h3>
<div id="authMessage" style="display:none;padding:1rem;border-radius:8px;margin-bottom:1.5rem;text-align:center;font-size:.95rem"></div>
<div id="authTabs" style="display:flex;gap:1rem;margin-bottom:2rem;border-bottom:2px solid var(--border-color)">
<button class="auth-tab active" data-tab="login">Login</button>
<button class="auth-tab" data-tab="signup">Sign Up</button>
</div>
<div id="loginForm">
<div class="input-group" style="margin-bottom:1rem">
<label>Email</label>
<input type="email" id="loginEmail" class="input" placeholder="your@email.com" onkeypress="if(event.key==='Enter')handleLogin()">
</div>
<div class="input-group" style="margin-bottom:1.5rem">
<label>Password</label>
<input type="password" id="loginPassword" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeypress="if(event.key==='Enter')handleLogin()">
</div>
<a href="#" onclick="showForgotPassword();return false" style="color:var(--accent);font-size:.875rem;text-decoration:none;display:block;margin-bottom:1rem;text-align:right">Forgot Password?</a>
<button type="button" class="btn btn-primary" id="loginSubmitBtn" style="width:100%" onclick="handleLogin()">Login</button>
</div>
<div id="signupForm" style="display:none">
<div class="input-group" style="margin-bottom:1rem">
<label>Username</label>
<input type="text" id="signupUsername" class="input" placeholder="username" onkeypress="if(event.key==='Enter')handleSignup()" onblur="checkUsernameAvailability()">
<div id="usernameAvailability" style="font-size:0.85rem;margin-top:0.5rem;display:none"></div>
</div>
<div class="input-group" style="margin-bottom:1rem">
<label>Email</label>
<input type="email" id="signupEmail" class="input" placeholder="your@email.com" onkeypress="if(event.key==='Enter')handleSignup()">
</div>
<div class="input-group" style="margin-bottom:1rem">
<label>Password</label>
<input type="password" id="signupPassword" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeypress="if(event.key==='Enter')handleSignup()">
</div>
<div class="input-group" style="margin-bottom:1.5rem">
<label>Confirm Password</label>
<input type="password" id="signupPasswordConfirm" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" onkeypress="if(event.key==='Enter')handleSignup()">
</div>
<button type="button" class="btn btn-primary" id="signupSubmitBtn" style="width:100%" onclick="handleSignup()">Create Account</button>
</div>
<div id="forgotPasswordForm" style="display:none">
<div class="input-group" style="margin-bottom:1.5rem">
<label>Email</label>
<input type="email" id="forgotEmail" class="input" placeholder="your@email.com" onkeypress="if(event.key==='Enter')handleForgotPassword()">
<p style="color:var(--text-secondary);font-size:.8rem;margin-top:.5rem">Enter your email to receive a password reset code</p>
</div>
<button type="button" class="btn btn-primary" id="forgotSubmitBtn" style="width:100%;margin-bottom:1rem" onclick="handleForgotPassword()">Send Reset Code</button>
<a href="#" onclick="showLoginForm();return false" style="color:var(--accent);font-size:.875rem;text-decoration:none;display:block;text-align:center">Back to Login</a>
</div>
<div id="resetPasswordForm" style="display:none">
<h3 style="margin-bottom:1.5rem">Reset Your Password</h3>
<div class="input-group" style="margin-bottom:1rem">
<label>New Password</label>
<input type="password" id="resetNewPassword" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
</div>
<div class="input-group" style="margin-bottom:1.5rem">
<label>Confirm New Password</label>
<input type="password" id="resetConfirmPassword" class="input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
</div>
<button type="button" class="btn btn-primary" style="width:100%;margin-bottom:1rem" onclick="handleResetPassword()">Reset Password</button>
<a href="#" onclick="showLoginForm();return false" style="color:var(--accent);font-size:.875rem;text-decoration:none;display:block;text-align:center">Back to Login</a>
</div>
<p style="color:var(--text-secondary);font-size:.875rem;text-align:center;margin-top:1rem">Your music will be saved to the cloud and accessible from any device</p>
</div>
</div>

<div class="top-nav">
<div class="logo" onclick="showScreen('home')">basspace</div>
<div class="nav-center">
<div class="search-bar"><span class="search-icon">ðŸ”</span>
<input type="text" id="searchInput" class="search-input" placeholder="Search songs, artists, albums">
</div>
</div>
<div style="display:flex;align-items:center;gap:2rem">
<div class="nav-links">
<div class="nav-link active" onclick="showScreen('home')">Home</div>
<div class="nav-link" onclick="showScreen('library')">Library</div>
<div class="nav-link" onclick="showScreen('upload')">Upload</div>
</div>

<!-- Notification Bell -->
<div id="notificationBellContainer" style="display:none;position:relative">
<button id="notificationBell" onclick="toggleNotifications()" style="background:transparent;border:none;color:var(--text-secondary);cursor:pointer;position:relative;width:40px;height:40px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s" onmouseover="this.style.background='rgba(255,255,255,0.1)';this.style.color='var(--text-primary)'" onmouseout="this.style.background='transparent';this.style.color='var(--text-secondary)'">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
  </svg>
  <span id="notificationBadge" style="display:none;position:absolute;top:8px;right:8px;background:var(--accent);color:#fff;border-radius:50%;width:18px;height:18px;font-size:0.7rem;font-weight:700;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 8px rgba(0,0,0,0.4)">0</span>
</button>

<!-- Notification Dropdown -->
<div id="notificationDropdown" style="display:none;position:absolute;top:calc(100% + 10px);right:0;width:360px;max-height:500px;overflow-y:auto;background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 15%),0.95);backdrop-filter:blur(20px);border:1px solid var(--border-color);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.4);z-index:1000">
  <div style="padding:1rem 1.5rem;border-bottom:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center">
    <h3 style="font-size:1.1rem;font-weight:700">Notifications</h3>
    <button onclick="markAllNotificationsRead()" style="background:transparent;border:none;color:var(--accent);cursor:pointer;font-size:0.875rem;font-weight:600">Mark all read</button>
  </div>
  <div id="notificationList" style="max-height:400px;overflow-y:auto">
    <!-- Notifications will be populated here -->
  </div>
</div>
</div>

<button id="loginBtn" class="btn btn-primary" style="padding:.5rem 1.5rem;display:block" onclick="if(typeof openAuthModal === 'function') openAuthModal();">Login / Sign Up</button>
<div class="profile-menu" id="profileMenuContainer" style="display:none">
<div class="profile-btn" id="profileBtn" onclick="event.stopPropagation(); document.getElementById('dropdown').classList.toggle('show');">ML</div>
<div id="dropdown" class="dropdown">
<div class="dropdown-item" onclick="showScreen('profile')">Profile</div>
<div class="dropdown-item" onclick="showScreen('upload')">Upload</div>
<div class="dropdown-item" onclick="showScreen('settings')">Settings</div>
<div class="dropdown-item" onclick="handleLogout()" style="color:#ff6b6b;border-top:1px solid var(--border-color);margin-top:.5rem;padding-top:.75rem">Logout</div>
</div>
</div>
</div>
</div>

<div class="container">
<div id="homeScreen" class="screen active">
<div class="recently-played" id="recentlyPlayedSection" style="display:none;margin-top:2rem">
<div class="section-header"><h2 class="section-title">Recently Played</h2></div>
<div class="horizontal-scroll" id="recentlyPlayedList"></div>
</div>

<div style="margin-bottom:3rem;margin-top:2rem">
<div class="section-header"><h2 class="section-title">Trending Tracks</h2></div>
<div id="popularTracks" class="track-list"></div>
<div id="noResults" class="empty-state" style="display:none">
<div class="empty-state-icon">âˆ…</div><h2>No results found</h2><p>Try searching for something else</p>
</div>
<div id="noMusic" class="empty-state">
<div class="empty-state-icon">â™ª</div><h2>welcome to basspace</h2><p>Upload your first track or create a playlist to get started</p>
</div>
</div>

<div class="stats">
<div class="stat-card"><div class="stat-number" id="totalTracks">0</div><div class="stat-label">Tracks</div></div>
<div class="stat-card"><div class="stat-number" id="totalArtists">0</div><div class="stat-label">Artists</div></div>
<div class="stat-card"><div class="stat-number" id="totalPlays">0</div><div class="stat-label">Plays</div></div>
</div>
</div>

<div id="profileScreen" class="screen profile-page">
<div class="profile-header">
<!-- Banner with content overlaid -->
<div class="profile-banner" id="profileBannerEl">
  <!-- Profile Song Indicator -->
  <div id="profileSongIndicator" style="position:absolute;top:1rem;right:1rem;background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);padding:0.75rem 1rem;border-radius:8px;display:none;align-items:center;gap:0.75rem;z-index:10">
    <div style="font-size:1.2rem;animation:pulse 2s infinite">â™ª</div>
    <div style="font-size:0.875rem">
      <div style="font-weight:600" id="profileSongTitle">Profile Song</div>
      <div style="color:var(--text-secondary);font-size:0.75rem" id="profileSongArtist">Playing...</div>
    </div>
    <button onclick="toggleProfileSongMute()" id="profileSongMuteBtn" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--text-primary)">â™ª</button>
  </div>
  
  <!-- Profile content directly on banner -->
  <div style="position:absolute;bottom:0;left:0;right:0;padding:2rem;display:flex;align-items:flex-end;gap:1.5rem;background:linear-gradient(to top, rgba(0,0,0,0.8), transparent)">
    <div class="profile-avatar-large" id="profileAvatarEl">ML</div>
    <div style="flex:1;padding-bottom:0.5rem">
      <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;margin-bottom:0.5rem">
        <h1 id="profileUsername" style="margin:0;font-size:2rem;text-shadow:0 2px 8px rgba(0,0,0,0.8)">Music Lover</h1>
        <button id="editProfileBtn" class="btn btn-secondary" onclick="openEditProfileModal()" style="padding:0.4rem 1.2rem;font-size:0.8rem">Edit Profile</button>
      </div>
      <p class="profile-username" id="profileUsernameAt" style="margin:0.25rem 0;text-shadow:0 1px 4px rgba(0,0,0,0.8)">@musiclover</p>
      <p class="profile-bio" id="profileBio" style="margin:0.5rem 0 1rem 0;text-shadow:0 1px 4px rgba(0,0,0,0.8)">Music enthusiast and creator</p>
      <div id="profileActionButtons" style="display:flex;gap:1rem;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="showScreen('upload')" style="padding:0.6rem 1.5rem;font-size:0.9rem">Upload Track</button>
        <button class="btn btn-secondary" onclick="openCreatePlaylist()" style="padding:0.6rem 1.5rem;font-size:0.9rem">Create Playlist</button>
      </div>
    </div>
  </div>
</div>

<style>
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
</style>
</div>

<!-- Tabs directly after header -->
<div class="profile-tabs">
<button class="profile-tab active" onclick="showProfileTab('tracks')">
<span>Tracks</span>
</button>
<button class="profile-tab" onclick="showProfileTab('playlists')" id="playlistTabBtn">
<span>Playlists</span>
</button>
<button class="profile-tab" onclick="showProfileTab('followers')" id="followersTabBtn">
<span id="followersCount">Followers</span>
</button>
<button class="profile-tab" onclick="showProfileTab('following')" id="followingTabBtn">
<span id="followingCount">Following</span>
</button>
<button class="profile-tab" onclick="showProfileTab('stats')" id="statsTabBtn">
<span>Stats</span>
</button>
</div>

<div id="profileTracksSection" style="display:none">
<div id="profileTrackList" class="track-list"></div>
<div id="profileEmptyTracks" class="empty-state">
<div class="empty-state-icon">â™ª</div><h2>No tracks uploaded</h2><p>Share your music with the world</p>
</div>
</div>

<div id="profilePlaylistsSection" style="display:none">
<div id="profilePlaylistList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem"></div>
<div id="profileEmptyPlaylists" class="empty-state">
<div class="empty-state-icon">â™ª</div><h2>No playlists created</h2><p>Organize your favorite tracks</p>
</div>
</div>

<div id="profileStatsSection" style="display:none">
<div class="stats-detailed-grid">
<div class="settings-section">
<h3>Listening Stats</h3>
<div class="stat-row">
<span class="stat-row-label">Total Plays</span>
<span class="stat-row-value" id="statsTotalPlays">0</span>
</div>
<div class="stat-row">
<span class="stat-row-label">Total Listening Time</span>
<span class="stat-row-value" id="statsTotalTime">0h 0m</span>
</div>
<div class="stat-row">
<span class="stat-row-label">Average Track Length</span>
<span class="stat-row-value" id="statsAvgDuration">0:00</span>
</div>
</div>

<div class="settings-section">
<h3>Library Stats</h3>
<div class="stat-row">
<span class="stat-row-label">Total Tracks</span>
<span class="stat-row-value" id="statsTotalTracks">0</span>
</div>
<div class="stat-row">
<span class="stat-row-label">Total Playlists</span>
<span class="stat-row-value" id="statsTotalPlaylists">0</span>
</div>
<div class="stat-row">
<span class="stat-row-label">Unique Artists</span>
<span class="stat-row-value" id="statsUniqueArtists">0</span>
</div>
<div class="stat-row">
<span class="stat-row-label">Unique Albums</span>
<span class="stat-row-value" id="statsUniqueAlbums">0</span>
</div>
</div>

<div class="settings-section">
<h3>Top Artists</h3>
<div id="statsTopArtists" class="top-list">
<div style="color:var(--text-secondary);text-align:center;padding:2rem">No data yet</div>
</div>
</div>

<div class="settings-section">
<h3>Top Albums</h3>
<div id="statsTopAlbums" class="top-list">
<div style="color:var(--text-secondary);text-align:center;padding:2rem">No data yet</div>
</div>
</div>
</div>
</div>
</div>

<!-- Followers Section -->
<div id="profileFollowersSection" style="display:none">
<div id="profileFollowersList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1.5rem;padding:2rem">
<!-- Followers will be populated here -->
</div>
<div id="profileFollowersEmpty" style="display:none;text-align:center;padding:4rem 2rem;color:var(--text-secondary)">
<div style="font-size:4rem;margin-bottom:1rem">ðŸ‘¥</div>
<h3 style="font-size:1.5rem;margin-bottom:0.5rem;color:var(--text-primary)">No followers yet</h3>
<p>Share your profile to get followers!</p>
</div>
</div>

<!-- Following Section -->
<div id="profileFollowingSection" style="display:none">
<div id="profileFollowingList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1.5rem;padding:2rem">
<!-- Following will be populated here -->
</div>
<div id="profileFollowingEmpty" style="display:none;text-align:center;padding:4rem 2rem;color:var(--text-secondary)">
<div style="font-size:4rem;margin-bottom:1rem">ðŸ”</div>
<h3 style="font-size:1.5rem;margin-bottom:0.5rem;color:var(--text-primary)">Not following anyone</h3>
<p>Search for users and follow them!</p>
</div>
</div>
</div>

<!-- User Profile View Screen -->
<div id="userProfileScreen" class="screen">
<div class="section-header" style="margin-bottom:2rem">
<button onclick="showScreen('search')" style="background:transparent;border:none;color:var(--text-secondary);cursor:pointer;font-size:1.5rem;padding:0.5rem;margin-right:1rem;transition:color 0.2s" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-secondary)'">â†</button>
<h2 class="section-title" style="display:inline">User Profile</h2>
</div>

<div id="userProfileContent" style="max-width:800px;margin:0 auto">
<!-- User profile content will be loaded here -->
</div>
</div>

<div id="settingsScreen" class="screen">
<div class="section-header"><h2 class="section-title">Settings</h2></div>

<div class="settings-section">
<h3>Account Information</h3>
<div class="input-group"><label>Display Name</label><input type="text" class="input" id="displayName" placeholder="Your display name"></div>
<div class="input-group"><label>Email</label><input type="email" class="input" id="emailInput" value="user@basspace.com"></div>
<div class="input-group"><label>Bio</label><textarea class="input" id="bioInput" rows="3">Music enthusiast and creator</textarea></div>
<button class="btn btn-primary" onclick="saveAccountInfo()">Save Changes</button>
</div>

<div class="settings-section">
<h3>Site Theme</h3>
<div class="input-group">
<label>Site Background Color</label>
<p style="color:var(--text-secondary);font-size:.875rem;margin-bottom:1rem">Choose a color for the overall site background (not your profile)</p>
<div class="color-input-group">
<input type="color" id="customColorPicker" class="color-picker-input" value="#050d1a">
<button class="btn" onclick="changeBackground(document.getElementById('customColorPicker').value)" style="margin-top:.5rem">Apply Color</button>
</div>
<div class="color-picker-group" style="margin-top:1rem">
<div class="color-option" style="background:#050d1a" onclick="changeBackground('#050d1a')" data-color="#050d1a"></div>
<div class="color-option" style="background:#1a0a29" onclick="changeBackground('#1a0a29')" data-color="#1a0a29"></div>
<div class="color-option" style="background:#0a2914" onclick="changeBackground('#0a2914')" data-color="#0a2914"></div>
<div class="color-option" style="background:#290a0a" onclick="changeBackground('#290a0a')" data-color="#290a0a"></div>
<div class="color-option" style="background:#000000" onclick="changeBackground('#000000')" data-color="#000000"></div>
<div class="color-option" style="background:#1c1c1c" onclick="changeBackground('#1c1c1c')" data-color="#1c1c1c"></div>
</div>
</div>

<div class="input-group" style="margin-top:2rem">
<label>Custom Glow Color (Optional)</label>
<p style="color:var(--text-secondary);font-size:.875rem;margin-bottom:1rem">Override the auto-generated glow color with your own choice</p>
<div class="color-input-group">
<input type="color" id="customGlowPicker" class="color-picker-input" value="">
<button class="btn" onclick="changeSiteGlowColor(document.getElementById('customGlowPicker').value)" style="margin-top:.5rem">Set Glow Color</button>
<button class="btn btn-secondary" onclick="resetSiteGlowColor()" style="margin-top:.5rem">Reset to Auto</button>
<p style="color:var(--text-secondary);font-size:.875rem;margin-top:.5rem">Leave empty to use auto-generated glow based on background color</p>
</div>
</div>
</div>

<div class="settings-section">
<h3>Playback Settings</h3>
<div class="setting-item">
<div class="setting-label"><h4>Autoplay</h4><p>Automatically play next track when current ends</p></div>
<div class="toggle" id="autoplayToggle" onclick="toggleSetting('autoplay')"><div class="toggle-slider"></div></div>
</div>
<div class="setting-item">
<div class="setting-label"><h4>Crossfade</h4><p>Smooth transition between tracks</p></div>
<div class="toggle" id="crossfadeToggle" onclick="toggleSetting('crossfade')"><div class="toggle-slider"></div></div>
</div>
<div class="setting-item">
<div class="setting-label"><h4>High Quality Audio</h4><p>Use higher bitrate for better sound</p></div>
<div class="toggle active" id="hqToggle" onclick="toggleSetting('highQuality')"><div class="toggle-slider"></div></div>
</div>
</div>

<div class="settings-section">
<h3>Notifications</h3>
<div class="setting-item">
<div class="setting-label"><h4>New Followers</h4><p>Get notified when someone follows you</p></div>
<div class="toggle active" id="followersToggle" onclick="toggleSetting('followers')"><div class="toggle-slider"></div></div>
</div>
<div class="setting-item">
<div class="setting-label"><h4>Comments</h4><p>Get notified about comments on your tracks</p></div>
<div class="toggle active" id="commentsToggle" onclick="toggleSetting('comments')"><div class="toggle-slider"></div></div>
</div>
<div class="setting-item">
<div class="setting-label"><h4>Likes</h4><p>Get notified when someone likes your music</p></div>
<div class="toggle active" id="likesToggle" onclick="toggleSetting('likes')"><div class="toggle-slider"></div></div>
</div>
</div>

<div class="settings-section">
<h3>Privacy</h3>
<div class="setting-item">
<div class="setting-label"><h4>Public Profile</h4><p>Allow others to view your profile</p></div>
<div class="toggle active" id="publicToggle" onclick="toggleSetting('public')"><div class="toggle-slider"></div></div>
</div>
<div class="setting-item">
<div class="setting-label"><h4>Show Listening History</h4><p>Display recently played tracks on your profile</p></div>
<div class="toggle active" id="historyToggle" onclick="toggleSetting('history')"><div class="toggle-slider"></div></div>
</div>
<div class="setting-item">
<div class="setting-label"><h4>Show Stats</h4><p>Display play counts and statistics</p></div>
<div class="toggle active" id="statsToggle" onclick="toggleSetting('stats')"><div class="toggle-slider"></div></div>
</div>
</div>

<div class="settings-section">
<h3>Storage & Data</h3>
<div class="setting-item">
<div class="setting-label"><h4>Download Quality</h4><p>Quality for downloaded tracks</p></div>
<select class="input" style="max-width:200px">
<option>High (320kbps)</option>
<option>Medium (192kbps)</option>
<option>Low (128kbps)</option>
</select>
</div>
<div class="setting-item">
<div class="setting-label"><h4>Cache Size</h4><p>Currently using 0 MB</p></div>
<button class="btn btn-secondary">Clear Cache</button>
</div>
</div>

<div class="settings-section">
<h3>Danger Zone</h3>
<button class="btn btn-secondary" style="background:rgba(255,59,48,0.1);border-color:rgba(255,59,48,0.3);color:#ff3b30">Delete Account</button>
<p style="color:var(--text-secondary);font-size:.85rem;margin-top:.5rem">This action cannot be undone</p>
</div>

</div>

</div>

<div id="uploadScreen" class="screen" style="max-width:1600px;margin:0 auto;padding:0 2rem 140px 2rem">
<div class="recently-played" style="display:none"></div>

<div style="margin-bottom:3rem;margin-top:-100px">
<div class="section-header"><h2 class="section-title">Upload Music</h2></div>
<div id="uploadArea" class="upload-area">
<input id="fileInput" type="file" multiple accept="audio/*,.mp3,.m4a" style="display:none">
<div class="upload-icon">â™ª</div>
<h2>Drop your audio files here</h2>
<p>or click to browse your files</p>
</div>
</div>
<div id="uploadedTracks" style="display:none">
<div class="section-header"><h2 class="section-title">Recently Uploaded</h2></div>
<div id="recentTrackList" class="track-list"></div>
</div>
</div>

<div id="libraryScreen" class="screen" style="max-width:1600px;margin:0 auto;padding:0 2rem 140px 2rem">
<div class="recently-played" style="display:none"></div>

<div style="margin-bottom:3rem;margin-top:-100px">
<div class="section-header"><h2 class="section-title">Your Library</h2></div>
<div class="section-header"><h2 class="section-title">My Tracks (<span id="trackCount">0</span>)</h2></div>
<div id="trackList" class="track-list"></div>
<div id="emptyState" class="empty-state">
<div class="empty-state-icon">â™ª</div><h2>Your library is empty</h2><p>Upload some tracks to get started</p>
</div>
</div>
</div>

<div id="createPlaylistModal" class="modal-overlay">
<div class="modal">
<h3>Create Playlist</h3>
<input id="playlistNameInput" type="text" class="input" placeholder="My Playlist">
<div class="modal-buttons">
<button class="btn btn-primary" onclick="confirmCreatePlaylist()">Create</button>
<button class="btn btn-secondary" onclick="closeCreatePlaylist()">Cancel</button>
</div>
</div>
</div>

<!-- View Playlist Modal -->
<div id="playlistViewModal" class="modal-overlay">
<div class="modal" style="max-width:800px;max-height:90vh;overflow-y:auto">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
<h3 id="playlistViewTitle">Playlist</h3>
<button onclick="closePlaylistView()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-primary)">Ã—</button>
</div>
<div id="playlistTrackList" class="track-list"></div>
<div id="playlistEmpty" class="empty-state" style="display:none;padding:3rem 1rem">
<div class="empty-state-icon">â™ª</div>
<h2>No tracks in this playlist</h2>
<p>Add some tracks to get started</p>
</div>
</div>
</div>

<!-- Playlist Customization Modal -->
<div id="playlistCustomizationModal" class="modal-overlay">
<div class="modal" style="max-width:700px;max-height:90vh;overflow-y:auto">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
<h3 id="playlistCustomTitle">Customize Playlist</h3>
<button onclick="closePlaylistCustomization()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-primary)">Ã—</button>
</div>

<div style="display:grid;gap:2rem">
  <!-- Background Color -->
  <div class="settings-section">
    <h4 style="margin-bottom:1rem;font-size:1.1rem">Background Color</h4>
    <div class="color-grid">
      <div class="color-option" data-color="#0a0e27" onclick="setPlaylistBackground('#0a0e27')" style="background:#0a0e27">
        <span class="color-check">âœ“</span>
      </div>
      <div class="color-option" data-color="#1a0a0f" onclick="setPlaylistBackground('#1a0a0f')" style="background:#1a0a0f">
        <span class="color-check">âœ“</span>
      </div>
      <div class="color-option" data-color="#0f1419" onclick="setPlaylistBackground('#0f1419')" style="background:#0f1419">
        <span class="color-check">âœ“</span>
      </div>
      <div class="color-option" data-color="#1e3a5f" onclick="setPlaylistBackground('#1e3a5f')" style="background:#1e3a5f">
        <span class="color-check">âœ“</span>
      </div>
      <div class="color-option" data-color="#2d1b4e" onclick="setPlaylistBackground('#2d1b4e')" style="background:#2d1b4e">
        <span class="color-check">âœ“</span>
      </div>
      <div class="color-option" data-color="#4a1c1c" onclick="setPlaylistBackground('#4a1c1c')" style="background:#4a1c1c">
        <span class="color-check">âœ“</span>
      </div>
    </div>
  </div>

  <!-- Custom Glow Color -->
  <div class="settings-section">
    <h4 style="margin-bottom:1rem;font-size:1.1rem">Glow Color</h4>
    <div class="color-grid">
      <div class="color-option" data-glow="#5090d3" onclick="setPlaylistGlow('#5090d3')" style="background:#5090d3">
        <span class="color-check">âœ“</span>
      </div>
      <div class="color-option" data-glow="#9b59b6" onclick="setPlaylistGlow('#9b59b6')" style="background:#9b59b6">
        <span class="color-check">âœ“</span>
      </div>
      <div class="color-option" data-glow="#e74c3c" onclick="setPlaylistGlow('#e74c3c')" style="background:#e74c3c">
        <span class="color-check">âœ“</span>
      </div>
      <div class="color-option" data-glow="#f39c12" onclick="setPlaylistGlow('#f39c12')" style="background:#f39c12">
        <span class="color-check">âœ“</span>
      </div>
      <div class="color-option" data-glow="#2ecc71" onclick="setPlaylistGlow('#2ecc71')" style="background:#2ecc71">
        <span class="color-check">âœ“</span>
      </div>
      <div class="color-option" data-glow="#1abc9c" onclick="setPlaylistGlow('#1abc9c')" style="background:#1abc9c">
        <span class="color-check">âœ“</span>
      </div>
      <div class="color-option" data-glow="#ff00ff" onclick="setPlaylistGlow('#ff00ff')" style="background:#ff00ff">
        <span class="color-check">âœ“</span>
      </div>
      <div class="color-option" data-glow="#00ff00" onclick="setPlaylistGlow('#00ff00')" style="background:#00ff00">
        <span class="color-check">âœ“</span>
      </div>
    </div>
  </div>

  <!-- Background Image Upload -->
  <div class="settings-section">
    <h4 style="margin-bottom:1rem;font-size:1.1rem">Background Image</h4>
    <input type="file" id="playlistBgInput" accept="image/*" style="display:none" onchange="handlePlaylistBgUpload(event)">
    <div id="playlistBgPreview" onclick="document.getElementById('playlistBgInput').click()" style="width:100%;height:200px;border:2px dashed rgba(255,255,255,0.2);border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all 0.2s;background-size:cover;background-position:center" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.2)'">
      <div style="text-align:center;color:var(--text-secondary)">
        <div style="font-size:1rem;font-weight:600;margin-bottom:0.5rem;text-transform:uppercase;letter-spacing:1px">BACKGROUND IMAGE</div>
        <p>Click to upload</p>
      </div>
    </div>
    <button onclick="removePlaylistBackground()" class="btn btn-secondary" style="margin-top:1rem;width:100%">Remove Background</button>
  </div>

  <!-- Action Buttons -->
  <div class="modal-buttons">
    <button class="btn btn-primary" onclick="savePlaylistCustomization()">Save Changes</button>
    <button class="btn btn-secondary" onclick="resetPlaylistCustomization()">Reset to Default</button>
    <button class="btn btn-secondary" onclick="closePlaylistCustomization()">Cancel</button>
  </div>
</div>

</div>
</div>

<!-- Add to Playlist Modal -->
<div id="editProfileModal" class="modal-overlay">
<div class="modal" style="max-width:700px;max-height:90vh;overflow-y:auto">
<h3>Edit Profile Appearance</h3>

<!-- Profile Song -->
<div class="input-group">
<label>Profile Song</label>
<p style="color:var(--text-secondary);font-size:.85rem;margin-bottom:0.5rem">Choose a song that auto-plays when people visit your profile</p>
<input type="file" id="profileSongInput" accept="audio/*,.mp3,.m4a" style="display:none" onchange="uploadProfileSong(this)">
<div id="profileSongDisplay" style="background:rgba(255,255,255,0.05);border:1px solid var(--border-color);border-radius:8px;padding:1rem;margin-bottom:0.5rem">
<div id="profileSongInfo" style="color:var(--text-secondary);text-align:center">No profile song selected</div>
</div>
<div style="display:flex;gap:0.5rem">
<button class="btn" onclick="document.getElementById('profileSongInput').click()" style="flex:1">Upload Song</button>
<button class="btn btn-secondary" onclick="removeProfileSong()" style="flex:1">Remove Song</button>
</div>
</div>

<!-- Profile Picture -->
<div class="input-group">
<label>Profile Picture (Will appear as circle)</label>
<input type="file" id="profilePicInput" accept="image/*" style="display:none" onchange="uploadProfilePic(this)">
<div class="image-upload-box" id="profilePicPreview" onclick="document.getElementById('profilePicInput').click()" style="height:200px;width:200px;border-radius:50%;margin:0 auto">
<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600">PROFILE IMAGE</div>
<p style="color:var(--text-secondary);font-size:.875rem">Click to upload</p>
</div>
</div>

<!-- Profile Banner -->
<div class="input-group">
<label>Profile Banner (Wide rectangular shape)</label>
<input type="file" id="bannerInput" accept="image/*" style="display:none" onchange="uploadBanner(this)">
<div class="image-upload-box" id="bannerPreview" onclick="document.getElementById('bannerInput').click()" style="height:120px;width:100%;max-width:600px;margin:0 auto">
<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600">BANNER IMAGE</div>
<p style="color:var(--text-secondary);font-size:.875rem">Click to upload</p>
</div>
</div>

<!-- Profile Background -->
<div class="input-group">
<label>Profile Background Image (Full screen)</label>
<input type="file" id="profileBackgroundInput" accept="image/*" style="display:none" onchange="uploadProfileBackground(this)">
<div class="image-upload-box" id="profileBackgroundPreview" onclick="document.getElementById('profileBackgroundInput').click()" style="height:150px;width:100%;max-width:600px;margin:0 auto">
<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600">BACKGROUND IMAGE</div>
<p style="color:var(--text-secondary);font-size:.875rem">Click to upload</p>
</div>
<button class="btn btn-secondary" onclick="removeProfileBackground()" style="margin-top:0.5rem">Remove Background</button>
</div>

<!-- Profile Background Color -->
<div class="input-group">
<label>Profile Background Color</label>
<p style="color:var(--text-secondary);font-size:.875rem;margin-bottom:1rem">Choose a color theme for your profile (others see this when visiting your profile). Your banner will use this color if no banner image is uploaded.</p>
<div class="color-input-group">
<input type="color" id="profileColorPicker" class="color-picker-input" value="#4c1a1a">
<button class="btn" onclick="changeProfileColor(document.getElementById('profileColorPicker').value)" style="margin-top:.5rem">Set Profile Color</button>
</div>
<div class="color-picker-group" style="margin-top:1rem">
<div class="color-option" style="background:#1a2332" onclick="changeProfileColor('#1a2332')"></div>
<div class="color-option" style="background:#2d1a4c" onclick="changeProfileColor('#2d1a4c')"></div>
<div class="color-option" style="background:#1a4c2d" onclick="changeProfileColor('#1a4c2d')"></div>
<div class="color-option" style="background:#4c1a1a" onclick="changeProfileColor('#4c1a1a')"></div>
<div class="color-option" style="background:#4c3d1a" onclick="changeProfileColor('#4c3d1a')"></div>
<div class="color-option" style="background:#1a1a4c" onclick="changeProfileColor('#1a1a4c')"></div>
</div>
</div>

<!-- Panel Style -->
<div class="input-group">
<label>Panel Style</label>
<div style="display:flex;gap:1rem;margin-top:0.5rem">
<button class="btn" onclick="setPanelStyle('glass')" id="glassStyleBtn" style="flex:1;background:rgba(255,255,255,0.1)">Frosted Glass</button>
<button class="btn" onclick="setPanelStyle('solid')" id="solidStyleBtn" style="flex:1">Solid Color</button>
</div>
<p style="color:var(--text-secondary);font-size:.85rem;margin-top:0.5rem">Glass style shows background through panels with blur</p>
</div>

<!-- Panel Color (for solid style) -->
<div class="input-group" id="panelColorSection" style="display:none">
<label>Panel Color</label>
<input type="color" id="panelColorPicker" class="color-picker-input" value="#0a0d1a">
<div class="color-picker-group" style="margin-top:1rem">
<div class="color-option" style="background:#0a0d1a" onclick="setPanelColor('#0a0d1a')"></div>
<div class="color-option" style="background:#1a1229" onclick="setPanelColor('#1a1229')"></div>
<div class="color-option" style="background:#0f1f14" onclick="setPanelColor('#0f1f14')"></div>
<div class="color-option" style="background:#1f0f0f" onclick="setPanelColor('#1f0f0f')"></div>
<div class="color-option" style="background:#121212" onclick="setPanelColor('#121212')"></div>
<div class="color-option" style="background:#2a2a2a" onclick="setPanelColor('#2a2a2a')"></div>
</div>
</div>

<!-- Panel Glow -->
<div class="input-group">
<label>Panel Glow Effect</label>
<div style="display:flex;align-items:center;gap:1rem">
<div class="toggle active" id="glowToggle" onclick="togglePanelGlow()"><div class="toggle-slider"></div></div>
<span style="color:var(--text-secondary);font-size:0.875rem">Add subtle glow to panels</span>
</div>
</div>

<!-- Glow Color -->
<div class="input-group" id="glowColorSection">
<label>Glow Color</label>
<input type="color" id="glowColorPicker" class="color-picker-input" value="">
<button class="btn" onclick="setGlowColor()" style="margin-top:0.5rem">Apply Glow Color</button>
<button class="btn btn-secondary" onclick="resetGlowColor()" style="margin-top:0.5rem">Reset to Auto</button>
<p style="color:var(--text-secondary);font-size:.85rem;margin-top:0.5rem">Leave empty for automatic color based on theme</p>
</div>

<!-- Text Color -->
<div class="input-group">
<label>Text Color</label>
<div style="display:flex;gap:1rem">
<button class="btn" onclick="setTextColor('light')" id="lightTextBtn" style="flex:1;background:rgba(255,255,255,0.1)">Light</button>
<button class="btn" onclick="setTextColor('dark')" id="darkTextBtn" style="flex:1">Dark</button>
<button class="btn" onclick="setTextColor('custom')" id="customTextBtn" style="flex:1">Custom</button>
</div>
<input type="color" id="textColorPicker" class="color-picker-input" value="#ffffff" style="margin-top:0.5rem;display:none">
</div>

<!-- Accent Color -->
<div class="input-group">
<label>Accent Color</label>
<input type="color" id="accentColorPicker" class="color-picker-input" value="">
<button class="btn" onclick="setAccentColor()" style="margin-top:0.5rem">Apply Accent Color</button>
<p style="color:var(--text-secondary);font-size:.85rem;margin-top:0.5rem">Used for buttons, highlights, and interactive elements</p>
</div>

<div class="modal-buttons">
<button class="btn btn-primary" onclick="saveProfileCustomization()">Save Changes</button>
<button class="btn btn-secondary" onclick="resetProfileCustomization()">Reset to Default</button>
<button class="btn btn-secondary" onclick="closeEditProfileModal()">Close</button>
</div>
</div>
</div>

<div id="editTrackModal" class="modal-overlay">
<div class="modal">
<h3>Edit Track</h3>
<input type="file" id="albumArtInput" accept="image/*" style="display:none">
<div class="album-art-upload" id="albumArtPreview" onclick="document.getElementById('albumArtInput').click()">
<div>â™ª</div>
</div>
<p style="text-align:center;color:var(--text-secondary);font-size:.875rem;margin-bottom:1.5rem">Click to add album artwork</p>
<div class="input-group"><label>Track Title</label><input type="text" class="input" id="editTrackTitle" placeholder="Enter track title"></div>
<div class="input-group"><label>Artist</label><input type="text" class="input" id="editTrackArtist" placeholder="Enter artist name"></div>
<div class="input-group"><label>Album</label><input type="text" class="input" id="editTrackAlbum" placeholder="Enter album name"></div>
<div class="modal-buttons">
<button class="btn btn-primary" onclick="saveTrackEdit()">Save Changes</button>
<button class="btn btn-secondary" onclick="closeEditTrack()">Cancel</button>
</div>
</div>
</div>

<!-- Playlist View Screen -->
<div id="playlistScreen" class="screen">
<div id="playlistViewContainer"></div>
</div>

<!-- Search Screen -->
<div id="searchScreen" class="screen">
<div style="max-width:1200px;margin:0 auto;padding:2rem">
  
  <!-- Search Header -->
  <div style="margin-bottom:2rem">
    <h1 style="font-size:3rem;font-weight:900;margin-bottom:1rem">Search</h1>
    
    <!-- Search Tabs -->
    <div style="display:flex;gap:1rem;border-bottom:2px solid var(--border-color);margin-bottom:2rem">
      <button id="searchTabSongs" class="search-tab active" onclick="switchSearchTab('songs')" style="background:none;border:none;color:var(--text-primary);font-size:1rem;font-weight:600;padding:0.75rem 1.5rem;cursor:pointer;border-bottom:3px solid transparent;transition:all 0.2s">
        Songs
      </button>
      <button id="searchTabArtists" class="search-tab" onclick="switchSearchTab('artists')" style="background:none;border:none;color:var(--text-secondary);font-size:1rem;font-weight:600;padding:0.75rem 1.5rem;cursor:pointer;border-bottom:3px solid transparent;transition:all 0.2s">
        Artists
      </button>
      <button id="searchTabUsers" class="search-tab" onclick="switchSearchTab('users')" style="background:none;border:none;color:var(--text-secondary);font-size:1rem;font-weight:600;padding:0.75rem 1.5rem;cursor:pointer;border-bottom:3px solid transparent;transition:all 0.2s">
        Users
      </button>
    </div>
  </div>
  
  <!-- Search Results Container -->
  <div id="searchResults">
    <!-- Results will be populated here -->
    <div id="searchEmptyState" style="text-align:center;padding:4rem 2rem;color:var(--text-secondary)">
      <div style="font-size:4rem;margin-bottom:1rem">ðŸ”</div>
      <h3 style="font-size:1.5rem;margin-bottom:0.5rem;color:var(--text-primary)">Start searching</h3>
      <p>Type in the search bar to find songs, artists, or users</p>
    </div>
    
    <div id="searchNoResults" style="display:none;text-align:center;padding:4rem 2rem;color:var(--text-secondary)">
      <div style="font-size:4rem;margin-bottom:1rem">ðŸ˜•</div>
      <h3 style="font-size:1.5rem;margin-bottom:0.5rem;color:var(--text-primary)">No results found</h3>
      <p>Try searching for something else</p>
    </div>
    
    <div id="searchSongsResults" style="display:none"></div>
    <div id="searchArtistsResults" style="display:none"></div>
    <div id="searchUsersResults" style="display:none"></div>
  </div>
  
</div>
</div>

<div class="upload-progress" id="uploadProgress">
<div class="spinner"></div>
<h3 style="margin-bottom:.5rem;font-weight:700">Processing Audio</h3>
<p style="color:var(--text-secondary);font-size:.875rem">This may take a moment...</p>
</div>

<div class="player-bar" id="playerBar">
<div class="player-content">
<div class="player-track-info">
<div class="player-track-art" id="playerArt">â™ª</div>
<div class="player-text">
<div class="player-title" id="playerTitle">No track playing</div>
<div class="player-artist" id="playerArtist">Select a track to begin</div>
</div>
</div>

<div class="player-center">
<div class="player-controls">
<button class="player-btn" id="repeatBtn" onclick="toggleRepeat()">â†»</button>
<button class="player-btn" id="prevBtn" onclick="playPrevious()">â®</button>
<button class="player-btn player-btn-main" id="playPauseBtn" onclick="togglePlayPause()"><span id="playerPlayIcon">â–¶</span></button>
<button class="player-btn" id="nextBtn" onclick="playNext()">â­</button>
<button class="player-btn player-menu-btn" id="playerMenuBtn" onclick="togglePlayerMenu()">â‹®</button>
</div>
<div class="progress-container">
<div class="progress-time" id="currentTime">0:00</div>
<div class="progress-bar" id="progressBar" onclick="seekTrack(event)">
<div class="progress-fill" id="progressFill"></div>
</div>
<div class="progress-time" id="totalTime">0:00</div>
</div>
</div>

<div class="player-right">
<!-- Shuffle and Loop buttons BEFORE volume -->
<div style="display:flex;gap:0.5rem;margin-right:1rem">
<button onclick="toggleShuffle()" id="shuffleBtn" class="player-control-btn" title="Shuffle">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
    <!-- Arrow 1: starts top-left, curves down to bottom-right -->
    <path d="M3 4 Q 12 12 18 18"/>
    <polyline points="15 21 21 21 21 15"/>
    
    <!-- Arrow 2: starts bottom-left, curves up to top-right -->
    <path d="M3 20 Q 12 12 18 6"/>
    <polyline points="15 3 21 3 21 9"/>
  </svg>
</button>
<button onclick="toggleLoop()" id="loopBtn" class="player-control-btn" title="Loop">
  <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
    <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16"></path>
  </svg>
</button>
</div>

<div class="volume-control">
<div class="volume-icon" onclick="toggleMute()">VOL</div>
<input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70">
</div>

<!-- Player menu moved to controls area -->
<div class="player-menu-dropdown" id="playerMenuDropdown">
<div class="player-menu-item" onclick="addToPlaylist()">+ Add to Playlist</div>
<div class="player-menu-item" onclick="addToLibrary()">+ Add to Library</div>
<div class="player-menu-item" onclick="downloadCurrentTrack()">â†“ Download</div>
</div>
</div>
</div>
</div>

<!-- Toast Notification Container -->
<div id="toastContainer" style="position:fixed;top:5rem;right:2rem;z-index:10000;display:flex;flex-direction:column;gap:0.75rem;pointer-events:none"></div>

<audio id="audioPlayer" preload="metadata" style="display:none"></audio>

<script>
let tracks=[],allUserTracks=[],totalPlays=0,currentPlayingId=null,playlists=[],currentProfileTab='tracks',profilePicture='ML',profileBanner='linear-gradient(135deg,#0a1929,#132f4c)',profileBackground='#050d1a',customGlowColor=null,currentEditingTrack=null,currentEditingAlbumArt=null,recentlyPlayed=[],isRepeat=!1,currentTrack=null;const audioPlayer=document.getElementById('audioPlayer'),fileInput=document.getElementById('fileInput'),uploadArea=document.getElementById('uploadArea'),trackList=document.getElementById('trackList'),emptyState=document.getElementById('emptyState'),searchInput=document.getElementById('searchInput'),profileBtn=document.getElementById('profileBtn'),dropdown=document.getElementById('dropdown'),volumeSlider=document.getElementById('volumeSlider'),albumArtInput=document.getElementById('albumArtInput');function generateCompleteTheme(e){const t=hexToRgb(e),baseHsl=rgbToHsl(t.r,t.g,t.b),n=(299*t.r+587*t.g+114*t.b)/1e3<128,r=Math.abs(t.r-t.g)<10&&Math.abs(t.g-t.b)<10&&Math.abs(t.r-t.b)<10;let o,a,c;if(r){const r=Math.round((t.r+t.g+t.b)/3);o=rgbToHex(Math.min(255,Math.round(r*1.4)),Math.min(255,Math.round(r*1.4)),Math.min(255,Math.round(r*1.4))),a=rgbToHex(Math.min(255,Math.round(r*1.8)),Math.min(255,Math.round(r*1.8)),Math.min(255,Math.round(r*1.8))),c=n?"#5090d3":"#2d5a8c"}else{o=hslToHex(baseHsl.h,baseHsl.s,n?Math.min(baseHsl.l*1.4,35):Math.max(baseHsl.l*0.85,5)),a=hslToHex(baseHsl.h,baseHsl.s,n?Math.min(baseHsl.l*1.8,45):Math.max(baseHsl.l*0.7,3)),c=hslToHex(baseHsl.h,Math.min(baseHsl.s*1.1,100),n?Math.min(baseHsl.l*3,65):Math.min(baseHsl.l*1.5,50))}const isVeryLight=baseHsl.l>85;const i="#ffffff",l="#ffffff",s=isVeryLight?"rgba(0, 0, 0, 0.12)":"rgba(255, 255, 255, 0.12)";const navHsl=rgbToHsl(t.r,t.g,t.b);const panelBorder=baseHsl.l>50?"rgba(0,0,0,0.3)":"rgba(255,255,255,0.3)";const lightBorder=hslToHex(baseHsl.h,Math.max(baseHsl.s*0.8,40),75);const lightGlow=hslToHex(baseHsl.h,Math.min(baseHsl.s*1.3,100),Math.min(baseHsl.l*5,90));const finalAccent=customGlowColor||c;document.documentElement.style.setProperty('--bg-primary',e),document.documentElement.style.setProperty('--bg-secondary',o),document.documentElement.style.setProperty('--bg-tertiary',a),document.documentElement.style.setProperty('--accent',finalAccent),document.documentElement.style.setProperty('--border-light',lightBorder),document.documentElement.style.setProperty('--accent-light',lightGlow),document.documentElement.style.setProperty('--text-primary',i),document.documentElement.style.setProperty('--text-secondary',l),document.documentElement.style.setProperty('--border-color',s),document.documentElement.style.setProperty('--border-dark',panelBorder),document.documentElement.style.setProperty('--nav-hue',navHsl.h),document.documentElement.style.setProperty('--nav-sat',navHsl.s+'%'),document.documentElement.style.setProperty('--nav-light',Math.min(navHsl.l*1.3,30)+'%')}function hexToRgb(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:5,g:13,b:26}}function rgbToHex(e,t,n){return"#"+((1<<24)+(e<<16)+(t<<8)+n).toString(16).slice(1)}function rgbToHsl(r,g,b){r/=255,g/=255,b/=255;const max=Math.max(r,g,b),min=Math.min(r,g,b);let h,s,l=(max+min)/2;if(max===min){h=s=0}else{const d=max-min;s=l>.5?d/(2-max-min):d/(max+min);switch(max){case r:h=((g-b)/d+(g<b?6:0))/6;break;case g:h=((b-r)/d+2)/6;break;case b:h=((r-g)/d+4)/6;break}}return{h:Math.round(h*360),s:Math.round(s*100),l:Math.round(l*100)}}function hslToHex(h,s,l){s/=100,l/=100;const c=(1-Math.abs(2*l-1))*s,x=c*(1-Math.abs((h/60)%2-1)),m=l-c/2;let r=0,g=0,b=0;if(h>=0&&h<60){r=c,g=x,b=0}else if(h>=60&&h<120){r=x,g=c,b=0}else if(h>=120&&h<180){r=0,g=c,b=x}else if(h>=180&&h<240){r=0,g=x,b=c}else if(h>=240&&h<300){r=x,g=0,b=c}else if(h>=300&&h<360){r=c,g=0,b=x}r=Math.round((r+m)*255),g=Math.round((g+m)*255),b=Math.round((b+m)*255);return rgbToHex(r,g,b)}function adjustBrightness(e,t){const n=hexToRgb(e);return rgbToHex(Math.min(255,Math.max(0,Math.round(n.r*t))),Math.min(255,Math.max(0,Math.round(n.g*t))),Math.min(255,Math.max(0,Math.round(n.b*t))))}function generateAccentColor(e,t){if(t){const t=Math.max(e.r,e.g,e.b);if(t<80)return rgbToHex(Math.min(255,Math.round(e.r*3.5)),Math.min(255,Math.round(e.g*3.5)),Math.min(255,Math.round(e.b*3.5)));const n=t<150?300/t:2.2;return rgbToHex(Math.min(255,Math.round(e.r*n)),Math.min(255,Math.round(e.g*n)),Math.min(255,Math.round(e.b*n)))}const n=Math.max(e.r,e.g,e.b);return n>200?rgbToHex(Math.round(.4*e.r),Math.round(.4*e.g),Math.round(.4*e.b)):rgbToHex(Math.round(.6*e.r),Math.round(.6*e.g),Math.round(.6*e.b))}function formatTime(e){if(isNaN(e))return'0:00';const t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n.toString().padStart(2,'0')}`}function seekTrack(e){const t=document.getElementById('progressBar');audioPlayer.currentTime=(e.clientX-t.getBoundingClientRect().left)/t.offsetWidth*audioPlayer.duration}function toggleRepeat(){isRepeat=!isRepeat,document.getElementById('repeatBtn').classList.toggle('active',isRepeat)}function toggleMute(){audioPlayer.volume>0?(audioPlayer.volume=0,volumeSlider.value=0):(audioPlayer.volume=.7,volumeSlider.value=70)}function togglePlayPause(){currentPlayingId&&(audioPlayer.paused?(audioPlayer.play(),document.getElementById('playerPlayIcon').textContent='â¸'):(audioPlayer.pause(),document.getElementById('playerPlayIcon').textContent='â–¶'))}function togglePlayerMenu(){document.getElementById('playerMenuDropdown').classList.toggle('show')}
function playPrevious(){if(!currentPlayingId||allUserTracks.length===0)return;const currentIndex=allUserTracks.findIndex(t=>t.id===currentPlayingId);if(currentIndex===-1)return;const prevIndex=currentIndex===0?allUserTracks.length-1:currentIndex-1;const prevTrack=allUserTracks[prevIndex];togglePlay(prevTrack.id)}
function playNext(){if(!currentPlayingId||allUserTracks.length===0)return;const currentIndex=allUserTracks.findIndex(t=>t.id===currentPlayingId);if(currentIndex===-1)return;const nextIndex=currentIndex===allUserTracks.length-1?0:currentIndex+1;const nextTrack=allUserTracks[nextIndex];togglePlay(nextTrack.id)}
function addToPlaylist(){togglePlayerMenu(),currentTrack&&playlists.length>0?alert('Select a playlist (feature in progress)'):alert('Create a playlist first!')}function addToLibrary(){togglePlayerMenu(),currentTrack&&!tracks.find(e=>e.id===currentTrack.id)&&(tracks.push(currentTrack),saveData(),renderLibrary(),alert('Added to your library!'))}function downloadCurrentTrack(){togglePlayerMenu(),currentTrack&&downloadTrack(currentTrack.id)}function updatePlayerBar(e){currentTrack=e;const t=document.getElementById('playerBar'),n=document.getElementById('playerArt');document.getElementById('playerTitle').textContent=e.title,document.getElementById('playerArtist').textContent=`${e.artist} â€¢ ${e.album}`,t.classList.add('active'),e.albumArt?(n.style.backgroundImage=`url(${e.albumArt})`,n.textContent=''):(n.style.backgroundImage='',n.textContent='â™ª'),document.getElementById('playerPlayIcon').textContent='â¸',recentlyPlayed.find(t=>t.id===e.id)||(recentlyPlayed.unshift(e),recentlyPlayed.length>10&&recentlyPlayed.pop(),renderRecentlyPlayed(),saveData())}function renderRecentlyPlayed(){const e=document.getElementById('recentlyPlayedSection'),t=document.getElementById('recentlyPlayedList');recentlyPlayed.length>0?(e.style.display='block',t.innerHTML=recentlyPlayed.map(e=>`<div class="album-card" onclick="togglePlay('${e.id}')"><div class="album-art-large" style="${e.albumArt?`background-image:url(${e.albumArt})`:''}"> ${e.albumArt?'':'â™ª'}<div class="play-overlay"><button class="play-overlay-btn">â–¶</button></div></div><div class="album-title">${e.title}</div><div class="album-artist">${e.artist}</div></div>`).join('')):e.style.display='none'}function openEditTrack(e){const t=tracks.find(t=>t.id===e)||allUserTracks.find(t=>t.id===e);if(!t)return;currentEditingTrack=t,currentEditingAlbumArt=t.albumArt||null,document.getElementById('editTrackTitle').value=t.title,document.getElementById('editTrackArtist').value=t.artist,document.getElementById('editTrackAlbum').value=t.album;const n=document.getElementById('albumArtPreview');t.albumArt?(n.style.backgroundImage=`url(${t.albumArt})`,n.style.backgroundSize='cover',n.style.backgroundPosition='center',n.textContent='',n.classList.add('has-image')):(n.style.backgroundImage='',n.style.backgroundSize='',n.style.backgroundPosition='',n.innerHTML='<div>â™ª</div>',n.classList.remove('has-image')),document.getElementById('editTrackModal').classList.add('show')}function closeEditTrack(){document.getElementById('editTrackModal').classList.remove('show'),currentEditingTrack=null,currentEditingAlbumArt=null}function saveTrackEdit(){currentEditingTrack&&(currentEditingTrack.title=document.getElementById('editTrackTitle').value||currentEditingTrack.title,currentEditingTrack.artist=document.getElementById('editTrackArtist').value||'Unknown Artist',currentEditingTrack.album=document.getElementById('editTrackAlbum').value||'Unknown Album',currentEditingTrack.albumArt=currentEditingAlbumArt,closeEditTrack(),saveData(),updateStats(),renderLibrary(),renderPopularTracks(),renderProfile(),renderRecentUploads(),renderRecentlyPlayed())}function loadData(){const e=localStorage.getItem('basspace_data');if(e)try{const e=JSON.parse(localStorage.getItem('basspace_data'));tracks=e.tracks||[],allUserTracks=e.allUserTracks||[],playlists=e.playlists||[],totalPlays=e.totalPlays||0,recentlyPlayed=e.recentlyPlayed||[],profilePicture=e.profilePicture||'ML',profileBanner=e.profileBanner||'linear-gradient(135deg,#0a1929,#132f4c)',profileBackground=e.profileBackground||'#050d1a',customGlowColor=e.customGlowColor||null,document.body.style.background=profileBackground,generateCompleteTheme(profileBackground),tracks.forEach(e=>{e.isPlaying=!1,e.audioData&&(e.dataUrl=e.audioData)}),allUserTracks.forEach(e=>{e.isPlaying=!1,e.audioData&&(e.dataUrl=e.audioData)}),updateStats(),renderLibrary(),renderPopularTracks(),renderProfile(),renderRecentlyPlayed(),updateBackgroundPreview(),updateColorSelection()}catch(e){console.error('Error loading data:',e)}}function saveData(){const e={tracks:tracks.map(e=>({id:e.id,title:e.title,artist:e.artist,album:e.album,albumArt:e.albumArt,audioData:e.audioData,duration:e.duration,filename:e.filename})),allUserTracks:allUserTracks.map(e=>({id:e.id,title:e.title,artist:e.artist,album:e.album,albumArt:e.albumArt,audioData:e.audioData,duration:e.duration,filename:e.filename})),playlists:playlists,totalPlays:totalPlays,recentlyPlayed:recentlyPlayed.map(e=>({id:e.id,title:e.title,artist:e.artist,album:e.album,albumArt:e.albumArt})),profilePicture:profilePicture,profileBanner:profileBanner,profileBackground:profileBackground,customGlowColor:customGlowColor};try{localStorage.setItem('basspace_data',JSON.stringify(e))}catch(e){'QuotaExceededError'===e.name&&alert('Storage limit exceeded! Try uploading smaller or fewer audio files.')}}function showScreen(e){document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active')),document.getElementById(e+'Screen').classList.add('active'),dropdown.classList.remove('show'),document.querySelectorAll('.nav-link').forEach(e=>{e.classList.remove('active')}),'home'===e&&(document.querySelector('.nav-link').classList.add('active'),renderPopularTracks()),'library'===e&&document.querySelectorAll('.nav-link')[1].classList.add('active'),'upload'===e&&document.querySelectorAll('.nav-link')[2].classList.add('active'),'profile'===e&&(renderProfile(),applyProfileStyles()),'settings'===e&&(updateProfilePicPreview(),updateBannerPreview(),updateBackgroundPreview(),updateColorSelection()),updateStats()}function saveProfile(){const e=document.getElementById('displayName').value;document.getElementById('bioInput').value;document.getElementById('profileUsername').textContent=e,document.getElementById('profileBio').textContent=document.getElementById('bioInput').value,saveData(),alert('Profile updated successfully!')}function uploadProfilePic(e){if(e.files&&e.files[0]){const t=new FileReader;t.onload=e=>{profilePicture=e.target.result,updateProfilePicPreview(),applyProfileStyles(),saveData()},t.readAsDataURL(e.files[0])}}
function uploadBanner(e){if(e.files&&e.files[0]){const t=new FileReader;t.onload=e=>{profileBanner=`url(${e.target.result})`,updateBannerPreview(),applyProfileStyles(),saveData()},t.readAsDataURL(e.files[0])}}

async function uploadProfileBackground(input) {
  if (input.files && input.files[0]) {
    const file = input.files[0];
    
    if (!supabase || !currentUser) {
      alert('Please log in to upload background');
      return;
    }
    
    try {
      // Show loading
      const loadingDiv = document.createElement('div');
      loadingDiv.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:orange;color:white;padding:20px;border-radius:8px;z-index:99999;font-size:16px;';
      loadingDiv.textContent = 'â³ Uploading background...';
      document.body.appendChild(loadingDiv);
      
      // Upload to Supabase Storage
      const fileExt = file.name.split('.').pop();
      const fileName = `${currentUser.id}/profile-bg-${Date.now()}.${fileExt}`;
      
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('profile-images')
        .upload(fileName, file, {
          cacheControl: '3600',
          upsert: true
        });
      
      if (uploadError) throw uploadError;
      
      // Get public URL
      const { data: urlData } = supabase.storage
        .from('profile-images')
        .getPublicUrl(fileName);
      
      const publicUrl = urlData.publicUrl;
      
      console.log('âœ… Profile background URL:', publicUrl);
      
      // Save URL to database
      const { error: dbError } = await supabase
        .from('profiles')
        .update({ profile_background_image: publicUrl })
        .eq('id', currentUser.id);
      
      if (dbError) throw dbError;
      
      console.log('âœ… Profile background saved to database');
      
      // Store in global variable
      window.userProfileBackgroundImage = publicUrl;
      
      // Apply immediately ONLY if we're on the profile screen
      const onProfileScreen = document.getElementById('profileScreen')?.classList.contains('active');
      if (onProfileScreen) {
        document.body.style.backgroundImage = `url(${publicUrl})`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';
        document.body.style.backgroundAttachment = 'fixed';
        document.body.style.backgroundColor = '';
      }
      
      // Update preview
      await updateProfileBackgroundPreview();
      
      // Remove loading, show success
      loadingDiv.remove();
      const successDiv = document.createElement('div');
      successDiv.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:green;color:white;padding:20px;border-radius:8px;z-index:99999;font-size:16px;';
      successDiv.textContent = 'âœ… Background image saved!';
      document.body.appendChild(successDiv);
      setTimeout(() => successDiv.remove(), 2000);
      
    } catch (err) {
      console.error('Exception saving background:', err);
      alert('Error uploading background: ' + err.message);
    }
  }
}

async function removeProfileBackground() {
  if (supabase && currentUser) {
    try {
      const { error } = await supabase
        .from('profiles')
        .update({ profile_background_image: null })
        .eq('id', currentUser.id);
      
      if (error) {
        console.error('Error removing background:', error);
        return;
      }
      
      console.log('âœ… Background image removed');
      
      // Remove from body
      document.body.style.backgroundImage = '';
      
      // Restore profile color if they have one
      if (currentUser) {
        const { data } = await supabase
          .from('profiles')
          .select('profile_color')
          .eq('id', currentUser.id)
          .single();
        
        if (data && data.profile_color) {
          document.body.style.backgroundColor = data.profile_color;
        }
      }
      
      updateProfileBackgroundPreview();
      
      alert('Background image removed');
    } catch (err) {
      console.error('Exception:', err);
    }
  }
}

async function updateProfileBackgroundPreview() {
  const preview = document.getElementById('profileBackgroundPreview');
  
  // Load from database if user is logged in
  if (supabase && currentUser) {
    try {
      const { data } = await supabase
        .from('profiles')
        .select('profile_background_image')
        .eq('id', currentUser.id)
        .single();
      
      if (data && data.profile_background_image) {
        preview.innerHTML = `<img src="${data.profile_background_image}" class="image-preview" alt="Profile Background">`;
        preview.classList.add('has-image');
        return;
      }
    } catch (err) {
      console.error('Error loading background preview:', err);
    }
  }
  
  // No background image
  preview.innerHTML = '<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600">PROFILE BACKGROUND</div><p style="color:var(--text-secondary);font-size:.875rem">Click to upload background image</p>';
  preview.classList.remove('has-image');
}

function uploadBackground(e){if(e.files&&e.files[0]){const t=new FileReader;t.onload=e=>{profileBackground=`url(${e.target.result})`,document.body.style.background=profileBackground,document.body.style.backgroundSize='cover',document.body.style.backgroundPosition='center',document.body.style.backgroundAttachment='fixed',updateBackgroundPreview(),updateColorSelection(),saveData()},t.readAsDataURL(e.files[0])}}function changeBackground(e){profileBackground=e,document.body.style.background=e,document.body.style.backgroundSize='',document.body.style.backgroundPosition='',document.body.style.backgroundAttachment='',generateCompleteTheme(e),updateColorSelection(),updateBackgroundPreview(),document.getElementById('customColorPicker').value=e,saveData()}
function changeGlowColor(color){customGlowColor=color;generateCompleteTheme(profileBackground);document.getElementById('customGlowPicker').value=color;saveData();alert('Custom glow color set!')}
function resetGlowColor(){customGlowColor=null;generateCompleteTheme(profileBackground);document.getElementById('customGlowPicker').value='';saveData();alert('Glow color reset to auto!')}
function updateProfilePicPreview(){const e=document.getElementById('profilePicPreview');profilePicture&&'ML'!==profilePicture&&!profilePicture.startsWith('data:')?(e.innerHTML='<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600;">PROFILE IMAGE</div><p style="color:var(--text-secondary);font-size:.875rem;">Click to upload</p>',e.classList.remove('has-image')):profilePicture.startsWith('data:')?(e.innerHTML=`<img src="${profilePicture}" class="image-preview" alt="Profile Picture">`,e.classList.add('has-image')):(e.innerHTML='<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600;">PROFILE IMAGE</div><p style="color:var(--text-secondary);font-size:.875rem;">Click to upload</p>',e.classList.remove('has-image'))}function updateBannerPreview(){const e=document.getElementById('bannerPreview');if(profileBanner.startsWith('url')){const t=profileBanner.match(/url\(([^)]+)\)/)[1];e.innerHTML=`<img src="${t}" class="image-preview" alt="Banner">`,e.classList.add('has-image')}else e.innerHTML='<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600;">BANNER IMAGE</div><p style="color:var(--text-secondary);font-size:.875rem;">Click to upload</p>',e.classList.remove('has-image')}function updateBackgroundPreview(){const e=document.getElementById('backgroundPreview');if(profileBackground.startsWith('url')){const t=profileBackground.match(/url\(([^)]+)\)/)[1];e.innerHTML=`<img src="${t}" class="image-preview" alt="Background">`,e.classList.add('has-image')}else e.innerHTML='<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600;">BACKGROUND IMAGE</div><p style="color:var(--text-secondary);font-size:.875rem;">Click to upload</p>',e.classList.remove('has-image')}function updateColorSelection(){document.querySelectorAll('.color-option').forEach(e=>{e.classList.remove('selected'),e.dataset.color===profileBackground&&e.classList.add('selected')})}function resetCustomization(){confirm('Reset all customization to defaults?')&&(profilePicture='ML',profileBanner='linear-gradient(135deg,#0a1929,#132f4c)',profileBackground='#050d1a',document.body.style.background=profileBackground,document.body.style.backgroundSize='',document.body.style.backgroundPosition='',document.body.style.backgroundAttachment='',generateCompleteTheme(profileBackground),updateProfilePicPreview(),updateBannerPreview(),updateBackgroundPreview(),updateColorSelection(),applyProfileStyles(),saveData(),alert('Customization reset to defaults!'))}function applyProfileStyles(){const e=document.getElementById('profileAvatarEl');profilePicture&&'ML'!==profilePicture&&profilePicture.startsWith('data:')?(e.style.backgroundImage=`url(${profilePicture})`,e.style.backgroundSize='cover',e.style.backgroundPosition='center',e.textContent=''):(e.style.backgroundImage='',e.textContent='ML'),profileBanner.startsWith('url')?(document.getElementById('profileBannerEl').style.background=profileBanner,document.getElementById('profileBannerEl').style.backgroundSize='cover',document.getElementById('profileBannerEl').style.backgroundPosition='center'):(document.getElementById('profileBannerEl').style.background=profileBanner,document.getElementById('profileBannerEl').style.backgroundSize='',document.getElementById('profileBannerEl').style.backgroundPosition=''),profileBackground.startsWith('url')?(document.body.style.background=profileBackground,document.body.style.backgroundSize='cover',document.body.style.backgroundPosition='center',document.body.style.backgroundAttachment='fixed'):(document.body.style.background=profileBackground,document.body.style.backgroundSize='',document.body.style.backgroundPosition='',document.body.style.backgroundAttachment='')}function showProfileTab(e){currentProfileTab=e;const t=document.querySelector("[onclick=\"showProfileTab('tracks')\"]");document.getElementById('playlistTabBtn');t.classList.toggle('active','tracks'===e),document.getElementById('playlistTabBtn').classList.toggle('active','playlists'===e),document.getElementById('profileTracksSection').style.display='tracks'===e?'block':'none',document.getElementById('profilePlaylistsSection').style.display='playlists'===e?'block':'none',renderProfile()}function renderProfile(){if(document.getElementById('profileTrackCount').textContent=tracks.length,document.getElementById('profilePlaylistCount').textContent=playlists.length,'tracks'===currentProfileTab){const e=document.getElementById('profileTrackList'),t=document.getElementById('profileEmptyTracks');0===tracks.length?(e.innerHTML='',t.style.display='block'):(t.style.display='none',e.innerHTML=tracks.map((e,t)=>`<div class="track"><div class="track-content"><div class="track-number">${e.isPlaying?'â™ª':t+1}</div>${e.albumArt?`<div class="track-art" style="background-image:url(${e.albumArt})"></div>`:'<div class="track-art">â™ª</div>'}<button class="play-btn" onclick="togglePlay('${e.id}')">${e.isPlaying?'â¸':'â–¶'}</button><div class="track-info"><div class="track-title">${e.title}</div><div class="track-artist">${e.artist} â€¢ ${e.album}</div><div class="track-duration">${formatDuration(e.duration)}</div></div><div class="track-actions"><button class="btn-small" onclick="openEditTrack('${e.id}')">Edit</button><button class="btn-small" onclick="downloadTrack('${e.id}')">Download</button></div></div></div>`).join(''))}else{const e=document.getElementById('profilePlaylistList'),t=document.getElementById('profileEmptyPlaylists');0===playlists.length?(e.innerHTML='',t.style.display='block'):(t.style.display='none',e.innerHTML=playlists.map(e=>`<div class="playlist-card"><div class="playlist-icon">â™ª</div><h3 class="playlist-name">${e.name}</h3><p class="playlist-count">${e.trackIds.length} tracks</p></div>`).join(''))}}function OLD_handleFiles_DISABLED(e){const t=Array.from(e).filter(e=>/audio\//.test(e.type)||/\.(mp3|m4a)$/i.test(e.name));if(0===t.length)return;document.getElementById('uploadProgress').classList.add('show');let n=0;t.forEach(e=>{const r=new FileReader;r.onload=function(r){const o=r.target.result,a={id:Math.random().toString(36).slice(2),audioData:o,dataUrl:o,title:e.name.replace(/\.(mp3|m4a|mp4)$/i,''),artist:'Unknown Artist',album:'Unknown Album',albumArt:null,duration:null,isPlaying:!1,filename:e.name},c=new Audio;c.src=o,c.onloadedmetadata=function(){a.duration=c.duration,tracks.push(a),allUserTracks.push(a),++n===t.length&&(document.getElementById('uploadProgress').classList.remove('show'),1===t.length&&openEditTrack(a.id),updateStats(),renderLibrary(),renderPopularTracks(),renderRecentUploads(),saveData())}},r.readAsDataURL(e)})}function renderRecentUploads(){const e=document.getElementById('uploadedTracks'),t=document.getElementById('recentTrackList');if(allUserTracks.length>0){e.style.display='block';const n=allUserTracks.slice(-10).reverse();t.innerHTML=n.map((e,t)=>`<div class="track"><div class="track-content"><div class="track-number">${e.isPlaying?'â™ª':t+1}</div>${e.albumArt?`<div class="track-art" style="background-image:url(${e.albumArt})"></div>`:'<div class="track-art">â™ª</div>'}<button class="play-btn" onclick="togglePlay('${e.id}')">${e.isPlaying?'â¸':'â–¶'}</button><div class="track-info"><div class="track-title">${e.title}</div><div class="track-artist">${e.artist} â€¢ ${e.album}</div><div class="track-duration">${formatDuration(e.duration)}</div></div><div class="track-actions"><button class="btn-small" onclick="openEditTrack('${e.id}')">Edit</button><button class="btn-small" onclick="downloadTrack('${e.id}')">Download</button></div></div></div>`).join('')}else e.style.display='none'}function openCreatePlaylist(){document.getElementById('createPlaylistModal').classList.add('show'),dropdown.classList.remove('show')}function closeCreatePlaylist(){document.getElementById('createPlaylistModal').classList.remove('show'),document.getElementById('playlistNameInput').value=''}function confirmCreatePlaylist(){const e=document.getElementById('playlistNameInput').value.trim();e&&(playlists.push({id:Math.random().toString(36).slice(2),name:e,trackIds:[]}),closeCreatePlaylist(),updateStats(),renderProfile(),saveData())}function renderPopularTracks(e){const t=document.getElementById('popularTracks'),n=document.getElementById('noMusic'),r=document.getElementById('noResults'),o=e||allUserTracks;r.style.display='none',n.style.display='none',0===o.length?(t.innerHTML='',(e?r:n).style.display='block'):t.innerHTML=o.slice(0,20).map((e,t)=>`<div class="track"><div class="track-content"><div class="track-number">${e.isPlaying?'â™ª':t+1}</div>${e.albumArt?`<div class="track-art" style="background-image:url(${e.albumArt})"></div>`:'<div class="track-art">â™ª</div>'}<button class="play-btn" onclick="togglePlay('${e.id}')">${e.isPlaying?'â¸':'â–¶'}</button><div class="track-info"><div class="track-title">${e.title}</div><div class="track-artist">${e.artist} â€¢ ${e.album}</div><div class="track-duration">${formatDuration(e.duration)}</div></div><div class="track-actions"><button class="btn-small" onclick="downloadTrack('${e.id}')">Download</button></div></div></div>`).join('')}function togglePlay(e){const t=tracks.find(t=>t.id===e)||allUserTracks.find(t=>t.id===e);if(!t)return;if(currentPlayingId!==e||audioPlayer.paused){if(currentPlayingId===e&&audioPlayer.paused)audioPlayer.play(),t.isPlaying=!0,document.getElementById('playerPlayIcon').textContent='â¸';else{tracks.forEach(e=>e.isPlaying=!1),allUserTracks.forEach(e=>e.isPlaying=!1);const n=t.dataUrl||t.audioData;audioPlayer.src=n,audioPlayer.load(),audioPlayer.play().then(()=>{currentPlayingId=e,t.isPlaying=!0,totalPlays++,updatePlayerBar(t),updateStats(),renderLibrary(),renderPopularTracks(),renderProfile()}).catch(e=>{console.error('Error playing audio:',e),alert('Error playing this track. The audio data may be corrupted.')})}}else audioPlayer.pause(),t.isPlaying=!1,document.getElementById('playerPlayIcon').textContent='â–¶';renderLibrary(),renderPopularTracks(),renderProfile()}function downloadTrack(e){const t=tracks.find(t=>t.id===e)||allUserTracks.find(t=>t.id===e);if(!t)return;const n=document.createElement('a');n.href=t.dataUrl||t.audioData,n.download=t.filename||'track.mp3',n.click()}function deleteTrack(e){tracks=tracks.filter(t=>t.id!==e),allUserTracks=allUserTracks.filter(t=>t.id!==e),currentPlayingId===e&&(audioPlayer.pause(),currentPlayingId=null,document.getElementById('playerBar').classList.remove('active')),updateStats(),renderLibrary(),renderPopularTracks(),saveData()}function formatDuration(e){if(!e||isNaN(e))return'--:--';const t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n.toString().padStart(2,'0')}`}function updateStats(){document.getElementById('totalTracks').textContent=allUserTracks.length,document.getElementById('trackCount').textContent=tracks.length,document.getElementById('totalArtists').textContent=new Set(allUserTracks.map(e=>e.artist)).size,document.getElementById('totalPlays').textContent=totalPlays}function renderLibrary(){0===tracks.length?(trackList.innerHTML='',emptyState.style.display='block'):(emptyState.style.display='none',trackList.innerHTML=tracks.map((e,t)=>`<div class="track"><div class="track-content"><div class="track-number">${e.isPlaying?'â™ª':t+1}</div>${e.albumArt?`<div class="track-art" style="background-image:url(${e.albumArt})"></div>`:'<div class="track-art">â™ª</div>'}<button class="play-btn" onclick="togglePlay('${e.id}')">${e.isPlaying?'â¸':'â–¶'}</button><div class="track-info"><div class="track-title">${e.title}</div><div class="track-artist">${e.artist} â€¢ ${e.album}</div><div class="track-duration">${formatDuration(e.duration)}</div></div><div class="track-actions"><button class="btn-small" onclick="openEditTrack('${e.id}')">Edit</button><button class="btn-small" onclick="downloadTrack('${e.id}')">Download</button><button class="btn-small" onclick="deleteTrack('${e.id}')">Delete</button></div></div></div>`).join(''))}audioPlayer.volume=.7,volumeSlider.value=70,volumeSlider.oninput=function(){audioPlayer.volume=this.value/100},albumArtInput.onchange=function(e){if(e.target.files&&e.target.files[0]){const t=new FileReader;t.onload=function(e){currentEditingAlbumArt=e.target.result;const t=document.getElementById('albumArtPreview');t.style.backgroundImage=`url(${currentEditingAlbumArt})`,t.style.backgroundSize='cover',t.style.backgroundPosition='center',t.textContent='',t.classList.add('has-image')},t.readAsDataURL(e.target.files[0])}},//loadData() DISABLED - using cloud storage now,profileBtn.onclick=e=>{e.stopPropagation(),dropdown.classList.toggle('show')},document.onclick=e=>{e.target.closest('.profile-menu')||dropdown.classList.remove('show'),e.target.closest('.player-menu')||document.getElementById('playerMenuDropdown').classList.remove('show')},uploadArea.onclick=()=>fileInput.click(),uploadArea.ondragover=e=>{e.preventDefault(),uploadArea.classList.add('drag-active')},uploadArea.ondragleave=()=>uploadArea.classList.remove('drag-active'),uploadArea.ondrop=e=>{e.preventDefault(),uploadArea.classList.remove('drag-active'),handleFiles(e.dataTransfer.files)},fileInput.onchange=e=>handleFiles(e.target.files),searchInput&&(searchInput.oninput=()=>{const e=searchInput.value.toLowerCase().trim();renderPopularTracks(e?allUserTracks.filter(t=>t.title.toLowerCase().includes(e)||t.artist.toLowerCase().includes(e)||t.album.toLowerCase().includes(e)):null)}),audioPlayer.ontimeupdate=function(){isNaN(audioPlayer.duration)||(document.getElementById('progressFill').style.width=audioPlayer.currentTime/audioPlayer.duration*100+'%',document.getElementById('currentTime').textContent=formatTime(audioPlayer.currentTime),document.getElementById('totalTime').textContent=formatTime(audioPlayer.duration))},audioPlayer.onended=()=>{isRepeat&&currentPlayingId?(audioPlayer.currentTime=0,audioPlayer.play()):(tracks.forEach(e=>e.isPlaying=!1),allUserTracks.forEach(e=>e.isPlaying=!1),currentPlayingId=null,document.getElementById('playerPlayIcon').textContent='â–¶',renderLibrary(),renderPopularTracks(),renderProfile())},updateStats(),renderLibrary(),renderPopularTracks(),applyProfileStyles(),renderRecentlyPlayed();

// Initialize theme on page load
generateCompleteTheme(profileBackground);

// CRITICAL: Override the minified applyProfileStyles that's messing with body background
function applyProfileStyles() {
  console.log('âœ… applyProfileStyles called (clean override - does NOT touch body background)');
  
  const profileAvatarEl = document.getElementById('profileAvatarEl');
  const profileBannerEl = document.getElementById('profileBannerEl');
  
  if (!profileAvatarEl || !profileBannerEl) return;
  
  // Apply profile picture only
  if (profilePicture && profilePicture !== 'ML' && profilePicture.startsWith('data:')) {
    profileAvatarEl.style.backgroundImage = `url(${profilePicture})`;
    profileAvatarEl.style.backgroundSize = 'cover';
    profileAvatarEl.style.backgroundPosition = 'center';
    profileAvatarEl.textContent = '';
  } else {
    profileAvatarEl.style.backgroundImage = '';
    profileAvatarEl.textContent = 'ML';
  }
  
  // Apply profile banner only
  if (profileBanner && profileBanner.startsWith('url')) {
    profileBannerEl.style.background = profileBanner;
    profileBannerEl.style.backgroundSize = 'cover';
    profileBannerEl.style.backgroundPosition = 'center';
  } else {
    profileBannerEl.style.background = '';
    profileBannerEl.style.backgroundSize = '';
    profileBannerEl.style.backgroundPosition = '';
  }
  
  // DO NOT TOUCH BODY BACKGROUND - it's managed by showScreen() for profiles
}

// Override generateCompleteTheme to also set card colors
function generateCompleteTheme(bgColor) {
  // Extract HSL from background color
  const rgb = hexToRgb(bgColor);
  const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
  const isDark = (rgb.r * 299 + rgb.g * 587 + rgb.b * 114) / 1000 < 128;
  const isGrayscale = Math.abs(rgb.r - rgb.g) < 10 && Math.abs(rgb.g - rgb.b) < 10 && Math.abs(rgb.r - rgb.b) < 10;
  
  // CRITICAL: Store current background if locked
  let savedBackgroundImage = null;
  let savedBackgroundColor = null;
  if (window.profileBackgroundLocked) {
    savedBackgroundImage = document.body.style.backgroundImage;
    savedBackgroundColor = document.body.style.backgroundColor;
    console.log('ðŸ”’ Background locked - will restore after theme update');
  }
  
  let secondary, tertiary, accent;
  
  if (isGrayscale) {
    const avg = Math.round((rgb.r + rgb.g + rgb.b) / 3);
    secondary = rgbToHex(
      Math.min(255, Math.round(avg * 1.4)),
      Math.min(255, Math.round(avg * 1.4)),
      Math.min(255, Math.round(avg * 1.4))
    );
    tertiary = rgbToHex(
      Math.min(255, Math.round(avg * 1.8)),
      Math.min(255, Math.round(avg * 1.8)),
      Math.min(255, Math.round(avg * 1.8))
    );
    accent = isDark ? '#5090d3' : '#2d5a8c';
  } else {
    secondary = hslToHex(
      hsl.h,
      hsl.s,
      isDark ? Math.min(hsl.l * 1.4, 35) : Math.max(hsl.l * 0.85, 5)
    );
    tertiary = hslToHex(
      hsl.h,
      hsl.s,
      isDark ? Math.min(hsl.l * 1.8, 45) : Math.max(hsl.l * 0.7, 3)
    );
    accent = hslToHex(
      hsl.h,
      Math.min(hsl.s * 1.1, 100),
      isDark ? Math.min(hsl.l * 3, 65) : Math.min(hsl.l * 1.5, 50)
    );
  }
  
  const isVeryLight = hsl.l > 85;
  const textPrimary = '#ffffff';
  const textSecondary = '#ffffff';
  const borderColor = isVeryLight ? 'rgba(0, 0, 0, 0.12)' : 'rgba(255, 255, 255, 0.12)';
  const panelBorder = hsl.l > 50 ? 'rgba(0,0,0,0.3)' : 'rgba(255,255,255,0.3)';
  const lightBorder = hslToHex(hsl.h, Math.max(hsl.s * 0.8, 40), 75);
  const lightGlow = hslToHex(hsl.h, Math.min(hsl.s * 1.3, 100), Math.min(hsl.l * 5, 90));
  const finalAccent = customGlowColor || accent;
  
  // Calculate contrasting text color for accent buttons
  const accentTextColor = getContrastColor(finalAccent);
  
  console.log('ðŸŽ¨ Theme generated - Accent:', finalAccent, 'Text:', accentTextColor);
  
  // Set all CSS variables
  document.documentElement.style.setProperty('--bg-primary', bgColor);
  document.documentElement.style.setProperty('--bg-secondary', secondary);
  document.documentElement.style.setProperty('--bg-tertiary', tertiary);
  document.documentElement.style.setProperty('--accent', finalAccent);
  document.documentElement.style.setProperty('--accent-text', accentTextColor);
  document.documentElement.style.setProperty('--border-light', lightBorder);
  document.documentElement.style.setProperty('--accent-light', lightGlow);
  document.documentElement.style.setProperty('--text-primary', textPrimary);
  document.documentElement.style.setProperty('--text-secondary', textSecondary);
  document.documentElement.style.setProperty('--border-color', borderColor);
  document.documentElement.style.setProperty('--border-dark', panelBorder);
  document.documentElement.style.setProperty('--nav-hue', hsl.h);
  document.documentElement.style.setProperty('--nav-sat', hsl.s + '%');
  document.documentElement.style.setProperty('--nav-light', Math.min(hsl.l * 1.3, 30) + '%');
  
  // NEW: Set card CSS variables to match background
  document.documentElement.style.setProperty('--card-hue', hsl.h);
  document.documentElement.style.setProperty('--card-sat', hsl.s + '%');
  document.documentElement.style.setProperty('--card-light', hsl.l + '%');
  
  // Set accent RGB for use in rgba()
  const accentRgb = hexToRgb(finalAccent);
  document.documentElement.style.setProperty('--accent-rgb', `${accentRgb.r},${accentRgb.g},${accentRgb.b}`);
  
  // CRITICAL: Restore background if it was locked
  if (window.profileBackgroundLocked && savedBackgroundImage) {
    console.log('ðŸ”’ Restoring locked background image');
    document.body.style.backgroundImage = savedBackgroundImage;
    document.body.style.backgroundColor = savedBackgroundColor;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
    document.body.style.backgroundAttachment = 'fixed';
  }
}

// Override uploadProfilePic to update header avatar and sync to database
// CRITICAL: Override minified loadData to prevent it from overriding database values
function loadData() {
  // If user is logged in, DO NOTHING - we use loadCloudData() instead
  if (currentUser) {
    console.log('âš ï¸ loadData() skipped - user logged in, using cloud data');
    return;
  }
  
  // Only load from localStorage if not logged in (legacy support)
  console.log('Loading from localStorage (not logged in)');
  const savedData = localStorage.getItem('basspace_data');
  if (!savedData) return;
  
  try {
    const data = JSON.parse(savedData);
    profileBackground = data.profileBackground || '#050d1a';
    // DON'T set document.body.style.background here!
  } catch (err) {
    console.error('Error loading localStorage:', err);
  }
}

async function uploadProfilePic(fileInput) {
  console.log('ðŸ“¸ uploadProfilePic called');
  console.log('ðŸ“¸ Current user:', currentUser ? currentUser.id : 'NOT LOGGED IN');
  
  if (fileInput.files && fileInput.files[0]) {
    console.log('ðŸ“¸ File selected:', fileInput.files[0].name);
    const reader = new FileReader();
    reader.onload = async function(e) {
      profilePicture = e.target.result;
      console.log('ðŸ“¸ Profile picture loaded, length:', profilePicture.length);
      
      // Update all profile picture instances
      updateProfilePicPreview();
      applyProfileStyles();
      updateHeaderAvatar();
      
      // Save to localStorage FIRST
      saveData();
      console.log('ðŸ’¾ Saved to localStorage');
      
      // Update cache immediately
      if (currentUser) {
        userProfilesCache[currentUser.id] = {
          ...userProfilesCache[currentUser.id],
          profile_picture: profilePicture
        };
        console.log('ðŸ“¦ Cache updated');
      }
      
      // Re-render tracks to show updated avatar
      renderPopularTracks();
      console.log('ðŸ”„ Tracks re-rendered');
      
      // Sync to database if user is logged in
      if (currentUser) {
        try {
          console.log('ðŸ’¾ Attempting to save profile picture to database...');
          console.log('Profile picture size:', profilePicture.length, 'characters');
          
          const { data, error } = await supabase
            .from('profiles')
            .update({ profile_picture: profilePicture })
            .eq('id', currentUser.id);
          
          if (error) {
            console.error('âŒ Error updating profile picture in database:', error);
            console.error('Error details:', error.message, error.code);
            alert('ERROR saving profile picture: ' + error.message);
          } else {
            console.log('âœ… Profile picture synced to database successfully');
            console.log('Response data:', data);
            alert('âœ… Profile picture saved to database! Size: ' + profilePicture.length + ' characters');
          }
        } catch (err) {
          console.error('âŒ Exception syncing profile picture:', err);
          alert('EXCEPTION saving profile picture: ' + err.message);
        }
      } else {
        console.warn('âš ï¸ No currentUser - cannot save to database');
        alert('WARNING: Not logged in - profile picture NOT saved to database');
      }
    };
    reader.readAsDataURL(fileInput.files[0]);
  }
}

// Upload banner image
async function uploadBanner(fileInput) {
  console.log('ðŸŽ¨ uploadBanner called');
  if (fileInput.files && fileInput.files[0]) {
    const file = fileInput.files[0];
    console.log('ðŸŽ¨ Banner file selected:', file.name);
    
    if (!supabase || !currentUser) {
      alert('Please log in to upload banner');
      return;
    }
    
    try {
      // Show loading
      const loadingDiv = document.createElement('div');
      loadingDiv.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:orange;color:white;padding:20px;border-radius:8px;z-index:99999;font-size:16px;';
      loadingDiv.textContent = 'â³ Uploading banner...';
      document.body.appendChild(loadingDiv);
      
      // Upload to Supabase Storage
      const fileExt = file.name.split('.').pop();
      const fileName = `${currentUser.id}/banner-${Date.now()}.${fileExt}`;
      
      const { data: uploadData, error: uploadError } = await supabase.storage
        .from('profile-images')
        .upload(fileName, file, {
          cacheControl: '3600',
          upsert: true
        });
      
      if (uploadError) throw uploadError;
      
      // Get public URL
      const { data: urlData } = supabase.storage
        .from('profile-images')
        .getPublicUrl(fileName);
      
      const publicUrl = urlData.publicUrl;
      
      // Save URL to database
      const { error: dbError } = await supabase
        .from('profiles')
        .update({ banner_color: publicUrl })
        .eq('id', currentUser.id);
      
      if (dbError) throw dbError;
      
      console.log('âœ… Banner saved to storage:', publicUrl);
      
      // Update local variable
      profileBanner = `url(${publicUrl})`;
      
      // Update UI
      updateBannerPreview();
      applyProfileStyles();
      
      // Remove loading, show success
      loadingDiv.remove();
      const successDiv = document.createElement('div');
      successDiv.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:green;color:white;padding:20px;border-radius:8px;z-index:99999;font-size:16px;';
      successDiv.textContent = 'âœ… Banner saved!';
      document.body.appendChild(successDiv);
      setTimeout(() => successDiv.remove(), 2000);
      
    } catch (err) {
      console.error('âŒ Exception saving banner:', err);
      alert('Error uploading banner: ' + err.message);
    }
  }
}

// Override updateProfilePicPreview with circular shape
function updateProfilePicPreview() {
  const preview = document.getElementById('profilePicPreview');
  if (profilePicture && profilePicture !== 'ML' && profilePicture.startsWith('data:')) {
    preview.style.backgroundImage = `url(${profilePicture})`;
    preview.style.backgroundSize = 'cover';
    preview.style.backgroundPosition = 'center';
    preview.innerHTML = '';
    preview.classList.add('has-image');
  } else {
    preview.style.backgroundImage = '';
    preview.style.backgroundSize = '';
    preview.style.backgroundPosition = '';
    preview.innerHTML = '<div style="font-size:1.2rem;color:var(--text-secondary);font-weight:600;display:flex;align-items:center;justify-content:center;height:100%;">Profile Picture</div>';
    preview.classList.remove('has-image');
  }
}

// Override updateBannerPreview with banner shape
function updateBannerPreview() {
  const preview = document.getElementById('bannerPreview');
  if (profileBanner.startsWith('url')) {
    const url = profileBanner.match(/url\(([^)]+)\)/)[1];
    preview.style.backgroundImage = `url(${url})`;
    preview.style.backgroundSize = 'cover';
    preview.style.backgroundPosition = 'center';
    preview.innerHTML = '';
    preview.classList.add('has-image');
  } else if (profileBanner.startsWith('linear-gradient') || profileBanner.startsWith('#')) {
    preview.style.background = profileBanner;
    preview.style.backgroundSize = '';
    preview.style.backgroundPosition = '';
    preview.innerHTML = '';
    preview.classList.add('has-image');
  } else {
    preview.style.background = '';
    preview.style.backgroundImage = '';
    preview.innerHTML = '<div style="font-size:1.2rem;color:var(--text-secondary);font-weight:600;display:flex;align-items:center;justify-content:center;height:100%;">Profile Banner</div>';
    preview.classList.remove('has-image');
  }
}

// Override updateBackgroundPreview with full rectangle shape
function updateBackgroundPreview() {
  const preview = document.getElementById('backgroundPreview');
  if (profileBackground.startsWith('url')) {
    const url = profileBackground.match(/url\(([^)]+)\)/)[1];
    preview.style.backgroundImage = `url(${url})`;
    preview.style.backgroundSize = 'cover';
    preview.style.backgroundPosition = 'center';
    preview.innerHTML = '';
    preview.classList.add('has-image');
  } else if (profileBackground.startsWith('#')) {
    preview.style.background = profileBackground;
    preview.style.backgroundImage = '';
    preview.style.backgroundSize = '';
    preview.style.backgroundPosition = '';
    preview.innerHTML = '';
    preview.classList.add('has-image');
  } else {
    preview.style.background = '';
    preview.style.backgroundImage = '';
    preview.innerHTML = '<div style="font-size:1.2rem;color:var(--text-secondary);font-weight:600;display:flex;align-items:center;justify-content:center;height:100%;">Background Image</div>';
    preview.classList.remove('has-image');
  }
}

// Update header avatar
function updateHeaderAvatar() {
  const headerBtn = document.getElementById('profileBtn');
  if (headerBtn) {
    if (profilePicture && profilePicture !== 'ML' && profilePicture.startsWith('data:')) {
      headerBtn.style.backgroundImage = `url(${profilePicture})`;
      headerBtn.style.backgroundSize = 'cover';
      headerBtn.style.backgroundPosition = 'center';
      headerBtn.textContent = '';
    } else {
      headerBtn.style.backgroundImage = '';
      headerBtn.textContent = 'ML';
    }
  }
}

// Override togglePlayerMenu to position dropdown correctly
function togglePlayerMenu() {
  const dropdown = document.getElementById('playerMenuDropdown');
  const button = document.getElementById('playerMenuBtn');
  
  const isShowing = dropdown.classList.toggle('show');
  
  if (isShowing && button) {
    const rect = button.getBoundingClientRect();
    dropdown.style.bottom = `${window.innerHeight - rect.top + 8}px`;
    dropdown.style.left = `${rect.left}px`;
  }
}

// Override toggleRepeat to add visual feedback
function toggleRepeat() {
  isRepeat = !isRepeat;
  const btn = document.getElementById('repeatBtn');
  if (isRepeat) {
    btn.classList.add('active');
  } else {
    btn.classList.remove('active');
  }
  console.log('Repeat mode:', isRepeat ? 'ON' : 'OFF');
}

// Play next track in queue
function playNext() {
  if (currentQueue.length > 0 && currentQueueIndex < currentQueue.length - 1) {
    playNextInQueue();
  }
}

// Play previous track in queue
function playPrevious() {
  if (currentQueue.length > 0 && currentQueueIndex > 0) {
    currentQueueIndex -= 2; // Subtract 2 because playNextInQueue will add 1
    playNextInQueue();
  }
}

// ============================================
// PLAYLIST QUEUE & PLAYBACK MANAGEMENT
// ============================================

// Play next track in queue
function playNextInQueue() {
  if (currentQueue.length === 0) return;
  
  currentQueueIndex++;
  
  // Loop back to start if at end and loop is enabled
  if (currentQueueIndex >= currentQueue.length) {
    if (isLoopEnabled) {
      currentQueueIndex = 0;
    } else {
      // End of queue, stop playback
      currentQueue = [];
      currentQueueIndex = -1;
      currentPlayingPlaylistId = null;
      return;
    }
  }
  
  const nextTrackId = currentQueue[currentQueueIndex];
  togglePlay(nextTrackId);
}

// Start playing a playlist from a specific track
function playPlaylist(playlistId, startTrackId = null) {
  const playlist = playlists.find(p => p.id === playlistId);
  if (!playlist || playlist.trackIds.length === 0) return;
  
  currentPlayingPlaylistId = playlistId;
  
  // Build queue
  let trackIds = [...playlist.trackIds];
  
  // Shuffle if enabled
  if (isShuffleEnabled) {
    trackIds = shuffleArray(trackIds);
  }
  
  currentQueue = trackIds;
  
  // Find starting index
  if (startTrackId) {
    currentQueueIndex = currentQueue.indexOf(startTrackId);
    if (currentQueueIndex === -1) currentQueueIndex = 0;
  } else {
    currentQueueIndex = 0;
  }
  
  // Start playing
  const trackId = currentQueue[currentQueueIndex];
  togglePlay(trackId);
}

// Shuffle array helper
function shuffleArray(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

// Toggle shuffle mode
function toggleShuffle() {
  isShuffleEnabled = !isShuffleEnabled;
  
  // Update UI with STRONG glow effect - BOTH buttons
  const shuffleBtn = document.getElementById('shuffleBtn');
  const playlistShuffleBtn = document.getElementById('playlistShuffleBtn');
  
  if (isShuffleEnabled) {
    if (shuffleBtn) shuffleBtn.classList.add('active');
    if (playlistShuffleBtn) playlistShuffleBtn.classList.add('active');
  } else {
    if (shuffleBtn) shuffleBtn.classList.remove('active');
    if (playlistShuffleBtn) playlistShuffleBtn.classList.remove('active');
  }
  
  // If currently playing a playlist, rebuild queue
  if (currentPlayingPlaylistId && currentQueue.length > 0) {
    const currentTrackId = currentQueue[currentQueueIndex];
    const playlist = playlists.find(p => p.id === currentPlayingPlaylistId);
    
    if (playlist) {
      let newQueue = [...playlist.trackIds];
      if (isShuffleEnabled) {
        newQueue = shuffleArray(newQueue);
      }
      currentQueue = newQueue;
      currentQueueIndex = currentQueue.indexOf(currentTrackId);
    }
  }
}

// Toggle loop mode
function toggleLoop() {
  isLoopEnabled = !isLoopEnabled;
  
  // Update UI with STRONG glow effect - BOTH buttons
  const loopBtn = document.getElementById('loopBtn');
  const playlistLoopBtn = document.getElementById('playlistLoopBtn');
  
  if (isLoopEnabled) {
    if (loopBtn) loopBtn.classList.add('active');
    if (playlistLoopBtn) playlistLoopBtn.classList.add('active');
  } else {
    if (loopBtn) loopBtn.classList.remove('active');
    if (playlistLoopBtn) playlistLoopBtn.classList.remove('active');
  }
}

// Override audioPlayer.onended to support queue playback
audioPlayer.onended = function() {
  console.log('Track ended. Queue length:', currentQueue.length);
  
  // If in repeat single track mode (from minified code)
  if (isRepeat && currentPlayingId) {
    audioPlayer.currentTime = 0;
    audioPlayer.play();
    return;
  }
  
  // If we have a queue, play next track
  if (currentQueue.length > 0) {
    playNextInQueue();
  } else {
    // No queue, stop playback
    tracks.forEach(t => t.isPlaying = false);
    allUserTracks.forEach(t => t.isPlaying = false);
    if (window.publicTracks) {
      window.publicTracks.forEach(t => t.isPlaying = false);
    }
    currentPlayingId = null;
    document.getElementById('playerPlayIcon').textContent = 'â–¶';
    renderLibrary();
    renderPopularTracks();
    renderProfile();
  }
};

// ============================================
// END QUEUE MANAGEMENT
// ============================================

// Initialize theme on page load (duplicate line removed above)

// Load customization data from localStorage
function loadCustomizationData() {
  console.log('ðŸ”„ Loading customization data from localStorage');
  try {
    const savedData = localStorage.getItem('basspace_data');
    if (savedData) {
      const data = JSON.parse(savedData);
      console.log('ðŸ“¦ Found saved data:', Object.keys(data));
      
      // Load site background color FIRST (for whole site, not profile)
      if (data.siteBackgroundColor) {
        console.log('ðŸŽ¨ Loading site background:', data.siteBackgroundColor);
        currentSiteBackgroundColor = data.siteBackgroundColor;
        document.body.style.background = data.siteBackgroundColor;
        document.body.style.backgroundSize = '';
        document.body.style.backgroundPosition = '';
        document.body.style.backgroundAttachment = '';
        generateCompleteTheme(data.siteBackgroundColor);
      }
      
      // Load playlists
      if (data.playlists) {
        playlists = data.playlists;
        console.log('ðŸŽµ Loaded', playlists.length, 'playlists');
      }
      
      // Load profile images
      if (data.profilePicture) {
        profilePicture = data.profilePicture;
        console.log('ðŸ“¸ Loaded profile picture, length:', profilePicture.length);
      }
      if (data.profileBanner) {
        profileBanner = data.profileBanner;
      }
      if (data.profileBackground) {
        profileBackground = data.profileBackground;
      }
      if (data.customGlowColor) {
        customGlowColor = data.customGlowColor;
        // Apply the custom glow color immediately
        const textColor = getContrastColor(customGlowColor);
        document.documentElement.style.setProperty('--accent', customGlowColor);
        document.documentElement.style.setProperty('--accent-text', textColor);
        const rgb = hexToRgb(customGlowColor);
        document.documentElement.style.setProperty('--accent-rgb', `${rgb.r},${rgb.g},${rgb.b}`);
        console.log('âœ¨ Loaded custom glow color:', customGlowColor, 'with text:', textColor);
      }
      
      // Load profile customization
      if (data.profileCustomization) {
        profileCustomization = data.profileCustomization;
      }
      
      // Load profile song
      if (data.profileSong) {
        profileSong = data.profileSong;
      }
      
      // Apply customization IMMEDIATELY
      applyProfileStyles();
      applyProfileCustomization();
      
      // Update header avatar IMMEDIATELY
      if (typeof updateHeaderAvatar === 'function') {
        updateHeaderAvatar();
        console.log('âœ… Header avatar updated');
      }
      
      // Update cache if logged in
      if (currentUser && profilePicture) {
        userProfilesCache[currentUser.id] = {
          ...userProfilesCache[currentUser.id],
          profile_picture: profilePicture
        };
        console.log('ðŸ“¦ Profile picture cached for current user');
        
        // Re-render tracks to show profile picture
        if (typeof renderPopularTracks === 'function') {
          renderPopularTracks();
          console.log('ðŸ”„ Re-rendered tracks with profile picture');
        }
      }
      
      console.log('âœ… Customization data loaded from localStorage');
    } else {
      console.log('â„¹ï¸ No saved data found in localStorage');
    }
  } catch (error) {
    console.error('âŒ Error loading customization data:', error);
  }
  
  // FORCE re-apply background color to ensure it's not overridden
  setTimeout(() => {
    const savedData = localStorage.getItem('basspace_data');
    if (savedData) {
      const data = JSON.parse(savedData);
      if (data.siteBackgroundColor) {
        currentSiteBackgroundColor = data.siteBackgroundColor;
        document.body.style.background = data.siteBackgroundColor;
        generateCompleteTheme(data.siteBackgroundColor);
        console.log('ðŸ”„ Re-applied site background color:', data.siteBackgroundColor);
      }
      // Re-apply custom glow color
      if (data.customGlowColor) {
        customGlowColor = data.customGlowColor;
        const textColor = getContrastColor(customGlowColor);
        document.documentElement.style.setProperty('--accent', customGlowColor);
        document.documentElement.style.setProperty('--accent-text', textColor);
        const rgb = hexToRgb(customGlowColor);
        document.documentElement.style.setProperty('--accent-rgb', `${rgb.r},${rgb.g},${rgb.b}`);
        console.log('ðŸ”„ Re-applied custom glow color:', customGlowColor);
      }
      // Re-apply playlists
      if (data.playlists && data.playlists.length > 0) {
        playlists = data.playlists;
        console.log('ðŸ”„ Re-applied playlists:', playlists.length);
      }
    }
  }, 500);
}

// Call on page load
loadCustomizationData();

// Set default banner to empty so CSS foggy style shows
if (!profileBanner || profileBanner === 'linear-gradient(135deg,#0a1929,#132f4c)') {
  profileBanner = '';
}

// CRITICAL: Re-apply site background after applyProfileStyles runs
// This ensures siteBackgroundColor is not overwritten by profileBackground
setTimeout(() => {
  const savedData = localStorage.getItem('basspace_data');
  if (savedData) {
    const data = JSON.parse(savedData);
    if (data.siteBackgroundColor) {
      document.body.style.background = data.siteBackgroundColor;
      document.body.style.backgroundSize = '';
      document.body.style.backgroundPosition = '';
      document.body.style.backgroundAttachment = '';
      generateCompleteTheme(data.siteBackgroundColor);
    }
  }
}, 100);

// Profile customization settings
let profileCustomization = {
  panelStyle: 'glass', // 'glass' or 'solid'
  panelColor: '#0a0d1a',
  glowEnabled: true,
  glowColor: null,
  textColor: 'light', // 'light', 'dark', or 'custom'
  customTextColor: '#ffffff',
  accentColor: null
};

// Profile song
let profileSong = {
  audioData: null,
  title: null,
  artist: null,
  filename: null
};

// Create separate audio player for profile song
const profileSongPlayer = new Audio();
profileSongPlayer.loop = true;
profileSongPlayer.volume = 0.5;

// Open/Close Edit Profile Modal
function openEditProfileModal() {
  document.getElementById('editProfileModal').classList.add('show');
  updateProfilePicPreview();
  updateBannerPreview();
  updateProfileBackgroundPreview();
  updateProfileSongDisplay();
  
  // Update button states
  document.getElementById('glassStyleBtn').style.background = profileCustomization.panelStyle === 'glass' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  document.getElementById('solidStyleBtn').style.background = profileCustomization.panelStyle === 'solid' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  
  document.getElementById('panelColorSection').style.display = profileCustomization.panelStyle === 'solid' ? 'block' : 'none';
  
  if (profileCustomization.glowEnabled) {
    document.getElementById('glowToggle').classList.add('active');
  } else {
    document.getElementById('glowToggle').classList.remove('active');
  }
  
  document.getElementById('lightTextBtn').style.background = profileCustomization.textColor === 'light' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  document.getElementById('darkTextBtn').style.background = profileCustomization.textColor === 'dark' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  document.getElementById('customTextBtn').style.background = profileCustomization.textColor === 'custom' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  
  document.getElementById('textColorPicker').style.display = profileCustomization.textColor === 'custom' ? 'block' : 'none';
}

function closeEditProfileModal() {
  document.getElementById('editProfileModal').classList.remove('show');
}

// Profile Song Functions
function uploadProfileSong(input) {
  if (input.files && input.files[0]) {
    const file = input.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
      profileSong.audioData = e.target.result;
      profileSong.filename = file.name;
      profileSong.title = file.name.replace(/\.(mp3|m4a|mp4)$/i, '');
      profileSong.artist = 'Unknown Artist';
      
      // Get duration
      const tempAudio = new Audio();
      tempAudio.src = e.target.result;
      tempAudio.onloadedmetadata = function() {
        updateProfileSongDisplay();
        saveData();
      };
    };
    
    reader.readAsDataURL(file);
  }
}

function removeProfileSong() {
  profileSong = {
    audioData: null,
    title: null,
    artist: null,
    filename: null
  };
  
  // Stop playing if currently playing
  profileSongPlayer.pause();
  profileSongPlayer.src = '';
  
  updateProfileSongDisplay();
  saveData();
}

function updateProfileSongDisplay() {
  const display = document.getElementById('profileSongInfo');
  
  if (!display) return; // Modal not open yet
  
  if (profileSong && profileSong.audioData) {
    display.innerHTML = `
      <div style="display:flex;align-items:center;gap:1rem">
        <div style="font-size:2rem">â™ª</div>
        <div style="text-align:left;flex:1">
          <div style="font-weight:600;color:var(--text-primary)">${profileSong.title || profileSong.filename || 'Untitled'}</div>
          <div style="font-size:0.875rem;color:var(--text-secondary)">${profileSong.artist || 'Unknown Artist'}</div>
        </div>
        <button class="btn btn-secondary" onclick="testPlayProfileSong()" style="padding:0.5rem 1rem">Test Play</button>
      </div>
    `;
  } else {
    display.innerHTML = '<div style="color:var(--text-secondary);text-align:center">No profile song selected</div>';
  }
}

function testPlayProfileSong() {
  if (profileSong && profileSong.audioData) {
    if (profileSongPlayer.paused) {
      profileSongPlayer.src = profileSong.audioData;
      profileSongPlayer.volume = 0.5;
      profileSongPlayer.play();
      
      // Auto-stop after 10 seconds for testing
      setTimeout(() => {
        profileSongPlayer.pause();
        profileSongPlayer.currentTime = 0;
      }, 10000);
    } else {
      profileSongPlayer.pause();
      profileSongPlayer.currentTime = 0;
    }
  }
}

// Start profile song when visiting profile page
function startProfileSong() {
  if (!profileSong || !profileSong.audioData) {
    console.log('No profile song to play');
    return;
  }
  
  console.log('Starting profile song:', profileSong.title);
  
  profileSongPlayer.src = profileSong.audioData;
  profileSongPlayer.volume = 0.5;
  profileSongPlayer.loop = true;
  
  // Show indicator
  const indicator = document.getElementById('profileSongIndicator');
  if (indicator) {
    indicator.style.display = 'flex';
    
    const titleEl = document.getElementById('profileSongTitle');
    const artistEl = document.getElementById('profileSongArtist');
    
    if (titleEl) titleEl.textContent = profileSong.title || profileSong.filename || 'Profile Song';
    if (artistEl) artistEl.textContent = profileSong.artist || 'Unknown Artist';
  }
  
  // Auto-play with user interaction handling
  const playPromise = profileSongPlayer.play();
  if (playPromise !== undefined) {
    playPromise
      .then(() => {
        console.log('âœ… Profile song playing');
      })
      .catch(error => {
        console.log('âš ï¸ Profile song autoplay prevented by browser - click anywhere to start');
        // Add click listener to start on first interaction
        const startOnClick = () => {
          profileSongPlayer.play()
            .then(() => console.log('âœ… Profile song started after user interaction'))
            .catch(e => console.error('Failed to play:', e));
          document.removeEventListener('click', startOnClick);
        };
        document.addEventListener('click', startOnClick, { once: true });
      });
  }
}

function stopProfileSong() {
  profileSongPlayer.pause();
  profileSongPlayer.currentTime = 0;
  
  // Hide indicator
  const indicator = document.getElementById('profileSongIndicator');
  if (indicator) {
    indicator.style.display = 'none';
  }
}

function toggleProfileSongMute() {
  if (profileSongPlayer.volume > 0) {
    profileSongPlayer.volume = 0;
    document.getElementById('profileSongMuteBtn').textContent = 'Unmute';
  } else {
    profileSongPlayer.volume = 0.5;
    document.getElementById('profileSongMuteBtn').textContent = 'Mute';
  }
}

// Panel Style
function setPanelStyle(style) {
  profileCustomization.panelStyle = style;
  document.getElementById('glassStyleBtn').style.background = style === 'glass' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  document.getElementById('solidStyleBtn').style.background = style === 'solid' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  document.getElementById('panelColorSection').style.display = style === 'solid' ? 'block' : 'none';
  applyProfileCustomization();
}

function setPanelColor(color) {
  profileCustomization.panelColor = color;
  document.getElementById('panelColorPicker').value = color;
  applyProfileCustomization();
}

function togglePanelGlow() {
  profileCustomization.glowEnabled = !profileCustomization.glowEnabled;
  document.getElementById('glowToggle').classList.toggle('active');
  applyProfileCustomization();
}

function setGlowColor() {
  const color = document.getElementById('glowColorPicker').value;
  profileCustomization.glowColor = color;
  customGlowColor = color;
  generateCompleteTheme(profileBackground);
  applyProfileCustomization();
}

function resetGlowColor() {
  profileCustomization.glowColor = null;
  customGlowColor = null;
  document.getElementById('glowColorPicker').value = '';
  generateCompleteTheme(profileBackground);
  applyProfileCustomization();
}

function setTextColor(type) {
  profileCustomization.textColor = type;
  document.getElementById('lightTextBtn').style.background = type === 'light' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  document.getElementById('darkTextBtn').style.background = type === 'dark' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  document.getElementById('customTextBtn').style.background = type === 'custom' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  document.getElementById('textColorPicker').style.display = type === 'custom' ? 'block' : 'none';
  applyProfileCustomization();
}

function setAccentColor() {
  const color = document.getElementById('accentColorPicker').value;
  profileCustomization.accentColor = color;
  applyProfileCustomization();
}

function applyProfileCustomization() {
  const profileScreen = document.getElementById('profileScreen');
  
  // Apply panel style
  if (profileCustomization.panelStyle === 'solid') {
    profileScreen.classList.remove('has-background');
    profileScreen.classList.add('solid-panels');
    profileScreen.style.setProperty('--panel-bg', profileCustomization.panelColor);
  } else {
    profileScreen.classList.remove('solid-panels');
    // Check if user has a profile background image OR color
    if (window.userProfileBackgroundImage || window.userProfileColor) {
      profileScreen.classList.add('has-background');
      console.log('âœ… Added has-background class to profileScreen');
    }
  }
  
  // Apply glow
  if (!profileCustomization.glowEnabled) {
    profileScreen.classList.add('no-glow');
  } else {
    profileScreen.classList.remove('no-glow');
  }
  
  // Apply text color
  if (profileCustomization.textColor === 'dark') {
    profileScreen.style.setProperty('--text-primary', '#1a1a1a');
    profileScreen.style.setProperty('--text-secondary', '#666666');
  } else if (profileCustomization.textColor === 'custom') {
    const customColor = document.getElementById('textColorPicker').value;
    profileCustomization.customTextColor = customColor;
    profileScreen.style.setProperty('--text-primary', customColor);
  } else {
    profileScreen.style.setProperty('--text-primary', '#ffffff');
    profileScreen.style.setProperty('--text-secondary', 'rgba(255,255,255,0.7)');
  }
  
  // Apply accent color
  if (profileCustomization.accentColor) {
    profileScreen.style.setProperty('--accent', profileCustomization.accentColor);
  }
}

function saveProfileCustomization() {
  saveData();
  closeEditProfileModal();
  showSuccessToast(); // Just checkmark
}

function resetProfileCustomization() {
  profileCustomization = {
    panelStyle: 'glass',
    panelColor: '#0a0d1a',
    glowEnabled: true,
    glowColor: null,
    textColor: 'light',
    customTextColor: '#ffffff',
    accentColor: null
  };
  
  profilePicture = 'ML';
  profileBanner = '';  // Empty = use foggy CSS default
  profileBackground = null;
  
  applyProfileCustomization();
  applyProfileStyles();
  updateProfilePicPreview();
  updateBannerPreview();
  updateProfileBackgroundPreview();
  
  // CRITICAL: Restore site background color after applying defaults
  // Don't let profile defaults override the site-wide color
  if (currentSiteBackgroundColor && !window.profileBackgroundLocked) {
    document.body.style.backgroundColor = currentSiteBackgroundColor;
    document.body.style.backgroundImage = '';
    generateCompleteTheme(currentSiteBackgroundColor);
    console.log('âœ… Restored site background color after applying defaults:', currentSiteBackgroundColor);
  }
  
  // Restore custom glow if set
  if (customGlowColor) {
    const textColor = getContrastColor(customGlowColor);
    document.documentElement.style.setProperty('--accent', customGlowColor);
    document.documentElement.style.setProperty('--accent-text', textColor);
    const rgb = hexToRgb(customGlowColor);
    document.documentElement.style.setProperty('--accent-rgb', `${rgb.r},${rgb.g},${rgb.b}`);
    console.log('âœ… Restored custom glow color after applying defaults:', customGlowColor, 'with text:', textColor);
  }
  
  saveData();
  showSuccessToast(); // Just checkmark
}

// Settings toggle function
function toggleSetting(setting) {
  const toggle = document.getElementById(setting + 'Toggle');
  if (toggle) {
    toggle.classList.toggle('active');
  }
}

// Store the current site background color globally
let currentSiteBackgroundColor = '#050d1a';

// Helper function to determine if a color is light or dark
function getContrastColor(hexColor) {
  const rgb = hexToRgb(hexColor);
  // Calculate relative luminance using the formula
  const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
  
  // If luminance > 0.5, color is light, so use dark text
  // If luminance <= 0.5, color is dark, so use light text
  const textColor = luminance > 0.5 ? '#000000' : '#ffffff';
  console.log('ðŸŽ¨ Contrast color for', hexColor, '(luminance:', luminance.toFixed(2) + ') =', textColor);
  return textColor;
}

// Override changeBackground to apply site-wide color (not profile-specific)
async function changeBackground(color) {
  console.log('ðŸŽ¨ Changing background to:', color);
  
  // Store it globally
  currentSiteBackgroundColor = color;
  profileBackground = color; // IMPORTANT: Set this variable too!
  
  // This is for site-wide background color
  document.body.style.backgroundColor = color;
  document.body.style.backgroundImage = '';
  document.body.style.backgroundSize = '';
  document.body.style.backgroundPosition = '';
  document.body.style.backgroundAttachment = '';
  
  // Update color picker
  const picker = document.getElementById('customColorPicker');
  if (picker) {
    picker.value = color;
  }
  
  // Update color selection UI
  document.querySelectorAll('.color-option').forEach(option => {
    option.classList.remove('selected');
    if (option.dataset.color === color) {
      option.classList.add('selected');
    }
  });
  
  // Generate theme based on color (this will also set card colors)
  generateCompleteTheme(color);
  
  // Save to localStorage
  saveData();
  
  // CRITICAL: Save to database IMMEDIATELY
  if (supabase && currentUser) {
    try {
      console.log('ðŸ’¾ SAVING background color to database:', color);
      console.log('ðŸ’¾ Current user ID:', currentUser.id);
      
      const { data, error } = await supabase
        .from('profiles')
        .update({ 
          background_color: color,
          banner_color: color // Use same color for banner
        })
        .eq('id', currentUser.id);
      
      if (error) {
        console.error('âŒ DATABASE ERROR:', error);
        // Show visible error
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:red;color:white;padding:20px;border-radius:8px;z-index:99999;font-size:16px;';
        errorDiv.textContent = 'ERROR SAVING: ' + error.message;
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
      } else {
        console.log('âœ… SAVED TO DATABASE');
        
        // VERIFY the save by reading it back
        const { data: verifyData, error: verifyError } = await supabase
          .from('profiles')
          .select('background_color, banner_color')
          .eq('id', currentUser.id)
          .single();
        
        if (verifyData) {
          console.log('âœ… VERIFIED - Data in database:', verifyData);
          
          // Show visible success with verification
          const successDiv = document.createElement('div');
          successDiv.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:green;color:white;padding:20px;border-radius:8px;z-index:99999;font-size:16px;';
          successDiv.innerHTML = 'âœ… Background color saved!<br>Verified: ' + verifyData.background_color;
          document.body.appendChild(successDiv);
          setTimeout(() => successDiv.remove(), 3000);
        } else {
          console.error('âš ï¸ Save succeeded but verification failed');
          const warnDiv = document.createElement('div');
          warnDiv.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:orange;color:black;padding:20px;border-radius:8px;z-index:99999;font-size:16px;';
          warnDiv.textContent = 'âš ï¸ Saved but could not verify';
          document.body.appendChild(warnDiv);
          setTimeout(() => warnDiv.remove(), 3000);
        }
      }
    } catch (err) {
      console.error('âŒ EXCEPTION:', err);
    }
  } else {
    console.warn('âš ï¸ Cannot save - not logged in');
    const warnDiv = document.createElement('div');
    warnDiv.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:orange;color:black;padding:20px;border-radius:8px;z-index:99999;font-size:16px;';
    warnDiv.textContent = 'âš ï¸ Not logged in - cannot save';
    document.body.appendChild(warnDiv);
    setTimeout(() => warnDiv.remove(), 3000);
  }
  
  console.log('âœ… Background changed');
}

// Change profile banner color (separate from site background)
async function changeProfileColor(color) {
  console.log('ðŸŽ¨ Changing profile color to:', color);
  
  // Save to database
  if (supabase && currentUser) {
    try {
      console.log('ðŸ’¾ Saving profile color to database:', color);
      
      const { data, error } = await supabase
        .from('profiles')
        .update({ 
          profile_color: color
        })
        .eq('id', currentUser.id);
      
      if (error) {
        console.error('âŒ DATABASE ERROR:', error);
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:red;color:white;padding:20px;border-radius:8px;z-index:99999;font-size:16px;';
        errorDiv.textContent = 'ERROR: ' + error.message;
        document.body.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
      } else {
        console.log('âœ… Profile color saved');
        
        // Store in global variable
        window.userProfileColor = color;
        
        // Apply immediately ONLY if we're on the profile screen
        const onProfileScreen = document.getElementById('profileScreen')?.classList.contains('active');
        if (onProfileScreen) {
          document.body.style.backgroundImage = '';
          document.body.style.backgroundColor = color;
          generateCompleteTheme(color);
        }
        
        // Show success
        const successDiv = document.createElement('div');
        successDiv.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:green;color:white;padding:20px;border-radius:8px;z-index:99999;font-size:16px;';
        successDiv.innerHTML = 'âœ… Profile color saved!<br>Others will see this on your profile';
        document.body.appendChild(successDiv);
        setTimeout(() => successDiv.remove(), 3000);
      }
    } catch (err) {
      console.error('âŒ EXCEPTION:', err);
    }
  } else {
    const warnDiv = document.createElement('div');
    warnDiv.style.cssText = 'position:fixed;top:20px;left:50%;transform:translateX(-50%);background:orange;color:black;padding:20px;border-radius:8px;z-index:99999;font-size:16px;';
    warnDiv.textContent = 'âš ï¸ Not logged in';
    document.body.appendChild(warnDiv);
    setTimeout(() => warnDiv.remove(), 3000);
  }
}

// Change site-wide glow color
function changeSiteGlowColor(color) {
  customGlowColor = color;
  
  // Calculate contrasting text color for buttons
  const textColor = getContrastColor(color);
  
  // ONLY update the accent/glow color, don't regenerate entire theme
  document.documentElement.style.setProperty('--accent', color);
  document.documentElement.style.setProperty('--accent-text', textColor);
  
  // Update accent RGB for rgba usage
  const rgb = hexToRgb(color);
  document.documentElement.style.setProperty('--accent-rgb', `${rgb.r},${rgb.g},${rgb.b}`);
  
  // Update picker
  document.getElementById('customGlowPicker').value = color;
  
  // Save
  saveData();
  
  console.log('âœ¨ Glow color changed to:', color, 'with text color:', textColor);
}

// Reset site-wide glow color to auto
function resetSiteGlowColor() {
  customGlowColor = null;
  
  // Regenerate theme to get auto accent color
  const currentBg = currentSiteBackgroundColor || document.body.style.background || '#050d1a';
  generateCompleteTheme(currentBg);
  
  // Reset to default white text on accent
  document.documentElement.style.setProperty('--accent-text', '#ffffff');
  
  document.getElementById('customGlowPicker').value = '';
  saveData();
  
  console.log('âœ¨ Glow color reset to auto');
}

// Save account info
function saveAccountInfo() {
  const displayName = document.getElementById('displayName').value;
  const bio = document.getElementById('bioInput').value;
  document.getElementById('profileUsername').textContent = displayName;
  document.getElementById('profileBio').textContent = bio;
  saveData();
}

// Override applyProfileStyles to apply background only to profile page with frosted glass
function applyProfileStyles() {
  const profileAvatarEl = document.getElementById('profileAvatarEl');
  const profileBannerEl = document.getElementById('profileBannerEl');
  const profileScreen = document.getElementById('profileScreen');
  
  // Apply profile picture
  if (profilePicture && profilePicture !== 'ML' && profilePicture.startsWith('data:')) {
    profileAvatarEl.style.backgroundImage = `url(${profilePicture})`;
    profileAvatarEl.style.backgroundSize = 'cover';
    profileAvatarEl.style.backgroundPosition = 'center';
    profileAvatarEl.textContent = '';
  } else {
    profileAvatarEl.style.backgroundImage = '';
    profileAvatarEl.textContent = 'ML';
  }
  
  // Apply profile banner
  if (profileBanner && profileBanner.startsWith('url')) {
    // User uploaded image - use it
    profileBannerEl.style.background = profileBanner;
    profileBannerEl.style.backgroundSize = 'cover';
    profileBannerEl.style.backgroundPosition = 'center';
  } else {
    // No image - clear inline styles to show CSS default (foggy)
    profileBannerEl.style.background = '';
    profileBannerEl.style.backgroundSize = '';
    profileBannerEl.style.backgroundPosition = '';
  }
  
  // CRITICAL: DO NOT TOUCH document.body.style.background!
  // Background is managed by:
  // - loadCloudData() loading from database
  // - changeBackground() for site theme
  // - uploadProfileBackground() for profile background image
  // - changeProfileColor() for profile color
}

// OVERRIDE functions from minified code to remove all alerts/confirms
function addToPlaylist() {
  togglePlayerMenu();
  // Silent - just close menu
}

function addToLibrary() {
  togglePlayerMenu();
  if (currentTrack && !tracks.find(t => t.id === currentTrack.id)) {
    tracks.push(currentTrack);
    saveData();
    renderLibrary();
    // Silent - no alert
  }
}

async function saveProfile() {
  const displayName = document.getElementById('displayName').value;
  const bio = document.getElementById('bioInput').value;
  document.getElementById('profileUsername').textContent = displayName;
  document.getElementById('profileBio').textContent = bio;
  saveData();
  
  // Also save to Supabase profiles table so user appears in search
  if (supabase && currentUser) {
    try {
      const { error } = await supabase
        .from('profiles')
        .update({
          display_name: displayName,
          bio: bio
        })
        .eq('id', currentUser.id);
      
      if (error) {
        console.error('Error updating profile in database:', error);
      } else {
        console.log('Profile updated in database successfully');
      }
    } catch (err) {
      console.error('Error saving profile to database:', err);
    }
  }
  // Silent - no alert
}

function changeGlowColor(color) {
  customGlowColor = color;
  generateCompleteTheme(profileBackground);
  document.getElementById('customGlowPicker').value = color;
  saveData();
  // Silent - no alert
}

function resetGlowColor() {
  customGlowColor = null;
  generateCompleteTheme(profileBackground);
  document.getElementById('customGlowPicker').value = '';
  saveData();
  // Silent - no alert
}

function resetCustomization() {
  // Silent - no confirm, just reset
  profilePicture = 'ML';
  profileBanner = 'linear-gradient(135deg,#0a1929,#132f4c)';
  profileBackground = '#050d1a';
  document.body.style.background = profileBackground;
  document.body.style.backgroundSize = '';
  document.body.style.backgroundPosition = '';
  document.body.style.backgroundAttachment = '';
  generateCompleteTheme(profileBackground);
  updateProfilePicPreview();
  updateBannerPreview();
  updateBackgroundPreview();
  updateColorSelection();
  applyProfileStyles();
  saveData();
  // Silent - no alert
}

function saveData() {
  console.log('ðŸ’¾ Saving data to localStorage...');
  const data = {
    tracks: tracks.map(t => ({
      id: t.id,
      title: t.title,
      artist: t.artist,
      album: t.album,
      albumArt: t.albumArt,
      audioData: t.audioData,
      duration: t.duration,
      filename: t.filename
    })),
    allUserTracks: allUserTracks.map(t => ({
      id: t.id,
      title: t.title,
      artist: t.artist,
      album: t.album,
      albumArt: t.albumArt,
      audioData: t.audioData,
      duration: t.duration,
      filename: t.filename
    })),
    playlists: playlists,
    totalPlays: totalPlays,
    recentlyPlayed: recentlyPlayed.map(t => ({
      id: t.id,
      title: t.title,
      artist: t.artist,
      album: t.album,
      albumArt: t.albumArt
    })),
    profilePicture: profilePicture,
    profileBanner: profileBanner,
    profileBackground: profileBackground,
    customGlowColor: customGlowColor,
    profileCustomization: profileCustomization,
    profileSong: profileSong,
    siteBackgroundColor: currentSiteBackgroundColor
  };
  
  console.log('ðŸ’¾ Saving:', {
    playlists: playlists.length,
    profilePicture: profilePicture ? profilePicture.substring(0, 50) + '...' : 'none',
    siteBackground: currentSiteBackgroundColor
  });
  
  try {
    localStorage.setItem('basspace_data', JSON.stringify(data));
    console.log('âœ… Data saved successfully to localStorage');
  } catch (e) {
    console.error('âŒ Error saving data:', e);
    if (e.name === 'QuotaExceededError') {
      console.error('Storage limit exceeded');
      alert('Storage limit exceeded! Try uploading smaller files.');
    }
  }
}

// Helper function to toggle track menu
function toggleTrackMenu(trackId, event) {
  event.stopPropagation();
  const dropdown = document.getElementById(`track-menu-${trackId}`);
  const button = event.currentTarget;
  const track = button.closest('.track');
  
  // Reset all tracks to normal z-index and re-enable pointer events
  document.querySelectorAll('.track').forEach(t => {
    t.style.zIndex = '';
    t.style.position = 'relative';
  });
  
  // Close all other menus and their submenus
  document.querySelectorAll('.track-dropdown').forEach(menu => {
    if (menu.id !== `track-menu-${trackId}`) {
      menu.classList.remove('show');
    }
  });
  
  // Close all submenus
  document.querySelectorAll('.track-submenu').forEach(submenu => {
    submenu.classList.remove('show');
  });
  
  // Toggle this menu
  const isShowing = dropdown.classList.toggle('show');
  
  // If showing, elevate this track's z-index way above everything
  if (isShowing && track) {
    track.style.zIndex = '999999999';
    track.style.position = 'relative';
    
    // Check if dropdown will bleed off screen and adjust position
    setTimeout(() => {
      const rect = dropdown.getBoundingClientRect();
      const viewportWidth = window.innerWidth;
      
      // If dropdown extends past right edge, flip it to the left
      if (rect.right > viewportWidth - 10) {
        dropdown.style.right = 'auto';
        dropdown.style.left = '0';
      } else {
        dropdown.style.right = '0';
        dropdown.style.left = 'auto';
      }
    }, 0);
  }
}

// Close menus when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('.track-menu-btn') && !e.target.closest('.track-dropdown') && !e.target.closest('.track-submenu')) {
    // Close all menus
    document.querySelectorAll('.track-dropdown').forEach(menu => {
      menu.classList.remove('show');
    });
    document.querySelectorAll('.track-submenu').forEach(submenu => {
      submenu.classList.remove('show');
    });
    
    // Reset all track z-indexes
    document.querySelectorAll('.track').forEach(t => {
      t.style.zIndex = '';
    });
  }
});

// Fixed downloadTrack to not open new tab
function downloadTrack(trackId) {
  const track = tracks.find(t => t.id === trackId) || allUserTracks.find(t => t.id === trackId);
  if (!track) return;
  
  const url = track.dataUrl || track.audioData;
  const filename = track.filename || `${track.title}.mp3`;
  
  // Use fetch to download without opening new tab
  fetch(url)
    .then(response => response.blob())
    .then(blob => {
      const blobUrl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = blobUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(blobUrl);
    })
    .catch(error => {
      console.error('Download error:', error);
      // Silent fail - just log to console
    });
}

// Delete track with cloud sync
async function deleteTrack(trackId) {
  // Close all menus first
  document.querySelectorAll('.track-dropdown, .track-submenu').forEach(menu => {
    menu.classList.remove('show');
  });
  
  // Reset track z-indexes
  document.querySelectorAll('.track').forEach(t => {
    t.style.zIndex = '';
  });
  
  // Delete from local arrays FIRST (immediate UI update)
  tracks = tracks.filter(t => t.id !== trackId);
  allUserTracks = allUserTracks.filter(t => t.id !== trackId);
  
  // Also remove from public tracks if present
  if (window.publicTracks) {
    window.publicTracks = window.publicTracks.filter(t => t.id !== trackId);
  }
  
  // Stop playback if this track is playing
  if (currentPlayingId === trackId) {
    audioPlayer.pause();
    currentPlayingId = null;
    document.getElementById('playerBar').classList.remove('active');
  }
  
  // UPDATE UI IMMEDIATELY
  updateStats();
  renderLibrary();
  renderPopularTracks();
  renderRecentUploads();
  renderProfile();
  
  // Delete from cloud in background (after UI updates)
  if (currentUser) {
    deleteTrackFromCloud(trackId).catch(err => {
      console.error('Background delete error:', err);
    });
  }
  
  // Reload public tracks in background
  if (typeof loadPublicTracks === 'function') {
    loadPublicTracks().catch(err => {
      console.error('Background reload error:', err);
    });
  }
}

// Add track to playlist
// Track currently being added to playlist
let currentTrackToAdd = null;

// Playlist queue and playback modes
let currentQueue = []; // Array of track IDs in order
let currentQueueIndex = -1; // Current position in queue
let isShuffleEnabled = false; // Shuffle mode
let isLoopEnabled = false; // Loop playlist mode
let currentPlayingPlaylistId = null; // Track which playlist is playing

// User profiles cache (for showing uploader info)
let userProfilesCache = {}; // userId -> {username, display_name, profile_picture}

// Fetch user profile from database
async function fetchUserProfile(userId) {
  if (userProfilesCache[userId]) {
    return userProfilesCache[userId];
  }
  
  try {
    const { data, error } = await supabase
      .from('profiles')
      .select('username, display_name, profile_picture')
      .eq('id', userId)
      .single();
    
    if (data) {
      userProfilesCache[userId] = data;
      return data;
    }
  } catch (err) {
    console.error('Error fetching user profile:', err);
  }
  
  return null;
}

// Toggle notification dropdown
function toggleNotifications() {
  const dropdown = document.getElementById('notificationDropdown');
  dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
  if (dropdown.style.display === 'block') {
    loadNotifications();
  }
}

// Load notifications
async function loadNotifications() {
  if (!currentUser) return;
  
  try {
    const { data, error } = await supabase
      .from('notifications')
      .select('*')
      .eq('user_id', currentUser.id)
      .order('created_at', { ascending: false })
      .limit(20);
    
    if (error) throw error;
    
    renderNotifications(data);
  } catch (err) {
    console.error('Error loading notifications:', err);
  }
}

// Render notifications
async function renderNotifications(data) {
  const notificationList = document.getElementById('notificationList');
  const badge = document.getElementById('notificationBadge');
  
  if (!data || data.length === 0) {
    notificationList.innerHTML = '<div style="padding:2rem;text-align:center;color:var(--text-secondary)">No notifications yet</div>';
    badge.style.display = 'none';
    return;
  }
  
  // Count unread
  const unreadCount = data.filter(function(n) { return !n.read; }).length;
  if (unreadCount > 0) {
    badge.textContent = unreadCount > 9 ? '9+' : unreadCount;
    badge.style.display = 'flex';
  } else {
    badge.style.display = 'none';
  }
  
  // Render notifications
  let html = '';
  for (let i = 0; i < data.length; i++) {
    const notif = data[i];
    let displayName = 'Someone';
    let avatar = '';
    
    console.log('Processing notification:', notif);
    
    // Fetch profile for the user who triggered the notification
    if (notif.from_user_id) {
      console.log('Fetching profile for user:', notif.from_user_id);
      const { data: profileData, error: profileError } = await supabase
        .from('profiles')
        .select('username, display_name, profile_picture')
        .eq('id', notif.from_user_id)
        .single();
      
      console.log('Profile data:', profileData, 'Error:', profileError);
      
      if (profileData) {
        displayName = profileData.display_name || profileData.username || 'Someone';
        avatar = profileData.profile_picture || '';
        console.log('Using displayName:', displayName, 'avatar:', avatar);
      }
    } else {
      console.log('No from_user_id in notification');
    }
    
    const timeAgo = getTimeAgo(new Date(notif.created_at));
    const bgColor = notif.read ? 'transparent' : 'rgba(255,255,255,0.05)';
    
    html += '<div onclick="markNotificationRead(\'' + notif.id + '\')" style="padding:1rem 1.5rem;border-bottom:1px solid var(--border-color);cursor:pointer;background:' + bgColor + ';transition:background 0.2s" onmouseover="this.style.background=\'rgba(255,255,255,0.08)\'" onmouseout="this.style.background=\'' + bgColor + '\'">';
    html += '<div style="display:flex;gap:0.75rem;align-items:start">';
    
    if (avatar) {
      html += '<div style="width:40px;height:40px;border-radius:50%;background:url(' + avatar + ');background-size:cover;background-position:center;flex-shrink:0"></div>';
    } else {
      html += '<div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg, var(--accent), var(--accent-light));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;flex-shrink:0">' + displayName.substring(0,2).toUpperCase() + '</div>';
    }
    
    html += '<div style="flex:1;min-width:0">';
    html += '<div style="font-weight:600;margin-bottom:0.25rem"><span style="color:var(--text-primary)">' + displayName + '</span> <span style="color:var(--text-secondary);font-weight:400">' + notif.message + '</span></div>';
    html += '<div style="font-size:0.875rem;color:var(--text-secondary)">' + timeAgo + '</div>';
    html += '</div>';
    
    if (!notif.read) {
      html += '<div style="width:8px;height:8px;border-radius:50%;background:var(--accent);flex-shrink:0;margin-top:0.5rem"></div>';
    }
    
    html += '</div></div>';
  }
  
  notificationList.innerHTML = html;
}

// Mark notification as read
async function markNotificationRead(notificationId) {
  try {
    await supabase
      .from('notifications')
      .update({ read: true })
      .eq('id', notificationId);
    
    loadNotifications();
  } catch (err) {
    console.error('Error marking notification read:', err);
  }
}

// Mark all notifications as read
async function markAllNotificationsRead() {
  if (!currentUser) return;
  
  try {
    await supabase
      .from('notifications')
      .update({ read: true })
      .eq('user_id', currentUser.id)
      .eq('read', false);
    
    loadNotifications();
  } catch (err) {
    console.error('Error marking all read:', err);
  }
}

// Helper function for time ago
function getTimeAgo(date) {
  const seconds = Math.floor((new Date() - date) / 1000);
  
  if (seconds < 60) return 'just now';
  const minutes = Math.floor(seconds / 60);
  if (minutes < 60) return minutes + 'm ago';
  const hours = Math.floor(minutes / 60);
  if (hours < 24) return hours + 'h ago';
  const days = Math.floor(hours / 24);
  if (days < 7) return days + 'd ago';
  const weeks = Math.floor(days / 7);
  return weeks + 'w ago';
}

// View another user's profile
async function viewUserProfile(userId) {
  if (!userId) return;
  
  // CRITICAL: Lock the background to prevent any changes while viewing this profile
  window.profileBackgroundLocked = true;
  
  try {
    // Fetch user profile from database
    const { data: profile, error } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', userId)
      .single();
    
    if (error) throw error;
    if (!profile) {
      alert('User profile not found');
      return;
    }
    
    // Check if viewing own profile - if so, just show normal profile screen
    if (currentUser && userId === currentUser.id) {
      viewingUserId = null;
      window.profileBackgroundLocked = false; // Unlock for own profile
      showScreen('profile');
      
      // Show edit buttons
      const editBtn = document.getElementById('editProfileBtn');
      const actionButtons = document.getElementById('profileActionButtons');
      if (editBtn) editBtn.style.display = 'block';
      if (actionButtons) actionButtons.style.display = 'flex';
      
      applyProfileStyles(); // Restore own styles
      renderProfile();
      return;
    }
    
    // Set viewing state
    viewingUserId = userId;
    
    // IMPORTANT: Store original profile data AND site theme BEFORE modifying anything
    if (!window.originalProfileData) {
      const usernameEl = document.getElementById('profileUsername');
      const usernameAtEl = document.getElementById('profileUsernameAt');
      const bioEl = document.getElementById('profileBio');
      const avatarEl = document.getElementById('profileAvatarEl');
      const bannerEl = document.getElementById('profileBannerEl');
      
      window.originalProfileData = {
        username: usernameEl ? usernameEl.textContent : '',
        usernameAt: usernameAtEl ? usernameAtEl.textContent : '',
        bio: bioEl ? bioEl.textContent : '',
        avatarBg: avatarEl ? avatarEl.style.backgroundImage : '',
        avatarText: avatarEl ? avatarEl.textContent : '',
        bannerBg: bannerEl ? bannerEl.style.background : '',
        profilePicture: profilePicture,
        profileBanner: profileBanner,
        siteTheme: currentSiteBackgroundColor || profileBackground, // Save current site theme
        bodyBgImage: document.body.style.backgroundImage, // Save body background image
        bodyBgColor: document.body.style.backgroundColor // Save body background color
      };
      console.log('ðŸ“¦ Saved original profile data and site theme:', window.originalProfileData);
    }
    
    // Manually show profile screen WITHOUT calling showScreen() to preserve originalProfileData
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('profileScreen').classList.add('active');
    dropdown.classList.remove('show');
    
    // Hide edit buttons when viewing someone else's profile
    const editBtn = document.getElementById('editProfileBtn');
    const actionButtons = document.getElementById('profileActionButtons');
    if (editBtn) editBtn.style.display = 'none';
    if (actionButtons) actionButtons.style.display = 'none';
    
    // Update the profile screen with their data
    const displayName = profile.display_name || profile.username;
    const avatar = profile.profile_picture;
    const bio = profile.bio || '';
    
    console.log('ðŸ“‹ Full profile data:', profile);
    console.log('ðŸ‘¤ Display name:', displayName);
    console.log('ðŸ–¼ï¸ Avatar URL:', avatar);
    console.log('ðŸ“ Bio:', bio);
    console.log('ðŸŽ¨ Background color:', profile.background_color);
    console.log('ðŸŽ¨ Banner color:', profile.banner_color);
    
    // Update profile banner and avatar
    const bannerEl = document.getElementById('profileBannerEl');
    const avatarEl = document.getElementById('profileAvatarEl');
    const usernameEl = document.getElementById('profileUsername');
    const bioEl = document.getElementById('profileBio');
    
    // Set banner and apply profile color theme
    // Priority: 1. Banner image 2. Profile color 3. Default
    
    console.log('ðŸ” DEBUG - Profile data loaded:');
    console.log('  profile_background_image:', profile.profile_background_image ? (profile.profile_background_image.substring(0, 50) + '...') : 'NULL');
    console.log('  banner_color:', profile.banner_color ? (profile.banner_color.substring(0, 50) + '...') : 'NULL');
    console.log('  profile_color:', profile.profile_color);
    
    let profileColorTheme = null; // Track the color to apply as theme
    
    // First, apply profile background image if they have one
    if (profile.profile_background_image) {
      console.log('ðŸ–¼ï¸ Applying profile background image');
      const bgImage = profile.profile_background_image.startsWith('http') 
        ? profile.profile_background_image 
        : profile.profile_background_image; // Could be base64 or URL
      
      // Store for protection interval
      window.viewingUserProfileData = {
        backgroundImage: `url(${bgImage})`,
        backgroundColor: null
      };
      
      document.body.style.backgroundImage = `url(${bgImage})`;
      document.body.style.backgroundSize = 'cover';
      document.body.style.backgroundPosition = 'center';
      document.body.style.backgroundAttachment = 'fixed';
      document.body.style.backgroundColor = '';
      
      // CRITICAL: Add has-background class
      const profileScreen = document.getElementById('profileScreen');
      if (profileScreen) {
        profileScreen.classList.add('has-background');
        console.log('âœ… Added has-background class for viewed profile');
      }
    } else if (profile.profile_color && profile.profile_color.startsWith('#')) {
      // Use their profile color as background
      console.log('ðŸŽ¨ Applying profile background color:', profile.profile_color);
      
      // Store for protection interval
      window.viewingUserProfileData = {
        backgroundImage: null,
        backgroundColor: profile.profile_color
      };
      
      document.body.style.backgroundImage = '';
      document.body.style.backgroundColor = profile.profile_color;
      profileColorTheme = profile.profile_color;
      
      // CRITICAL: Add has-background class
      const profileScreen = document.getElementById('profileScreen');
      if (profileScreen) {
        profileScreen.classList.add('has-background');
        console.log('âœ… Added has-background class for profile color');
      }
    }
    
    // Now set the banner
    if (profile.banner_color) {
      if (profile.banner_color.startsWith('data:image')) {
        // It's a base64 banner IMAGE - use it for banner
        console.log('ðŸŽ¨ Using base64 banner IMAGE (length:', profile.banner_color.length, 'chars)');
        bannerEl.style.background = 'url(' + profile.banner_color + ')';
        bannerEl.style.backgroundSize = 'cover';
        bannerEl.style.backgroundPosition = 'center';
      } else if (profile.banner_color.startsWith('http')) {
        // It's a URL banner IMAGE
        console.log('ðŸŽ¨ Using URL banner IMAGE:', profile.banner_color);
        bannerEl.style.background = 'url(' + profile.banner_color + ')';
        bannerEl.style.backgroundSize = 'cover';
        bannerEl.style.backgroundPosition = 'center';
      } else if (profile.banner_color.startsWith('#')) {
        // It's a color
        console.log('ðŸŽ¨ Using banner color:', profile.banner_color);
        const bannerColorLight = adjustBrightness(profile.banner_color, 1.3);
        bannerEl.style.background = 'linear-gradient(135deg, ' + profile.banner_color + ', ' + bannerColorLight + ')';
        bannerEl.style.backgroundSize = '';
        bannerEl.style.backgroundPosition = '';
      }
      
      // Still use profile_color for the overall theme if available
      if (profile.profile_color && profile.profile_color.startsWith('#')) {
        profileColorTheme = profile.profile_color;
      }
    } else if (profile.profile_color && profile.profile_color.startsWith('#')) {
      // They have a custom PROFILE COLOR - use it for both banner and theme
      console.log('ðŸŽ¨ Using profile color for banner:', profile.profile_color);
      profileColorTheme = profile.profile_color;
      
      const bannerColorLight = adjustBrightness(profile.profile_color, 1.3);
      bannerEl.style.background = 'linear-gradient(135deg, ' + profile.profile_color + ', ' + bannerColorLight + ')';
      bannerEl.style.backgroundSize = '';
      bannerEl.style.backgroundPosition = '';
    } else {
      // Default
      console.log('ðŸŽ¨ Using default banner');
      bannerEl.style.background = 'linear-gradient(135deg, #1a2332, #2d3e50)';
      bannerEl.style.backgroundSize = '';
      bannerEl.style.backgroundPosition = '';
    }
    
    // Apply the profile color theme to cards/accents
    if (profileColorTheme) {
      console.log('ðŸŽ¨ Applying profile color theme:', profileColorTheme);
      generateCompleteTheme(profileColorTheme);
    }
    
    // Set avatar - IMPORTANT: Use proper URL formatting and check if it exists
    if (avatar && avatar !== '' && avatar !== 'ML') {
      console.log('âœ… Setting avatar URL:', avatar);
      avatarEl.style.backgroundImage = 'url("' + avatar + '")';
      avatarEl.style.backgroundSize = 'cover';
      avatarEl.style.backgroundPosition = 'center';
      avatarEl.textContent = '';
      console.log('âœ… Avatar element backgroundImage set to:', avatarEl.style.backgroundImage);
    } else {
      console.log('âŒ No avatar, using initials for:', displayName);
      avatarEl.style.backgroundImage = '';
      avatarEl.textContent = displayName.substring(0, 2).toUpperCase();
    }
    
    // Set name and bio
    usernameEl.textContent = displayName;
    bioEl.textContent = bio || 'No bio yet';
    
    // Set @username
    const usernameAtEl = document.getElementById('profileUsernameAt');
    if (usernameAtEl) {
      usernameAtEl.textContent = '@' + profile.username;
    }
    
    // Get follower/following counts and update tabs
    const { data: followersData } = await supabase
      .from('follows')
      .select('id')
      .eq('following_id', userId);
    
    const { data: followingData } = await supabase
      .from('follows')
      .select('id')
      .eq('follower_id', userId);
    
    const followersCount = followersData ? followersData.length : 0;
    const followingCount = followingData ? followingData.length : 0;
    
    document.getElementById('followersCount').textContent = followersCount + ' Follower' + (followersCount !== 1 ? 's' : '');
    document.getElementById('followingCount').textContent = followingCount + ' Following';
    
    // Show tabs and load the default tab (followers)
    showProfileTab('followers');
    
  } catch (err) {
    console.error('Error loading user profile:', err);
    alert('Error loading user profile');
  }
}

// Helper to generate playlist submenu HTML
function getPlaylistSubmenu(trackId, menuPrefix = '') {
  if (playlists.length === 0) {
    return '';
  }
  
  const submenuItems = playlists.map(playlist => {
    const isAdded = playlist.trackIds.includes(trackId);
    return `
      <div class="track-submenu-item ${isAdded ? 'added' : ''}" ${!isAdded ? `onclick="addToPlaylistFromMenu('${trackId}', '${playlist.id}', event)"` : ''}>
        <span>${playlist.name}</span>
        ${isAdded ? '<span class="checkmark">âœ“</span>' : ''}
      </div>
    `;
  }).join('');
  
  return `<div id="playlist-submenu-${menuPrefix}${trackId}" class="track-submenu">${submenuItems}</div>`;
}

// Add track to playlist from dropdown menu
function addToPlaylistFromMenu(trackId, playlistId, event) {
  event.stopPropagation();
  
  const playlist = playlists.find(p => p.id === playlistId);
  if (!playlist || playlist.trackIds.includes(trackId)) return;
  
  // Add track
  playlist.trackIds.push(trackId);
  saveData();
  
  // Show checkmark and play sound
  showSuccessToast(true);
  
  // Close all menus
  document.querySelectorAll('.track-dropdown, .track-submenu').forEach(m => m.classList.remove('show'));
  
  // Re-render to update UI
  renderLibrary();
  renderPopularTracks();
  renderProfile();
  renderRecentUploads();
}

// Show playlist submenu on click
function showPlaylistSubmenu(trackId, event) {
  event.stopPropagation();
  
  // Hide all other submenus
  document.querySelectorAll('.track-submenu').forEach(s => s.classList.remove('show'));
  
  // Find and show this submenu
  const menuItem = event.currentTarget;
  const parentMenu = menuItem.closest('.track-dropdown');
  const submenu = parentMenu.querySelector('.track-submenu');
  
  if (submenu) {
    submenu.classList.add('show');
  }
}

// Toast notification functions
function showSuccessToast(playSound = false) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  
  toast.style.cssText = `
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4), 0 0 0 3px rgba(34, 197, 94, 0.2);
    pointer-events: auto;
    animation: successPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    backdrop-filter: blur(10px);
  `;
  
  toast.innerHTML = `
    <div style="
      color: white;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    ">âœ“</div>
  `;
  
  container.appendChild(toast);
  
  // Only play sound if requested (for playlist add)
  if (playSound) {
    playSuccessSound();
  }
  
  // Auto remove after 1.5 seconds
  setTimeout(() => {
    toast.style.animation = 'successFade 0.3s ease-out';
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }, 1500);
}

function showErrorToast(message) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  
  toast.style.cssText = `
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: rgba(239, 68, 68, 0.95);
    padding: 0.75rem 1.25rem;
    border-radius: 50px;
    box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
    pointer-events: auto;
    animation: slideIn 0.3s ease-out;
    backdrop-filter: blur(10px);
  `;
  
  toast.innerHTML = `
    <div style="
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: #ef4444;
      flex-shrink: 0;
    ">âœ•</div>
    <div style="
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    ">${message}</div>
  `;
  
  container.appendChild(toast);
  
  // Auto remove after 2.5 seconds
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }, 2500);
}

// Success sound using Web Audio API
function playSuccessSound() {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    // Create a short, pleasant "pop" sound
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    // Bubble pop frequency sweep
    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
    oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
    
    // Quick fade out
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
    
    oscillator.type = 'sine';
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.1);
  } catch (e) {
    // Silent fail if audio context not supported
    console.log('Audio not supported');
  }
}

// Add CSS animations for toast
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(100px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
  
  @keyframes slideOut {
    from {
      opacity: 1;
      transform: translateX(0);
    }
    to {
      opacity: 0;
      transform: translateX(100px);
    }
  }
  
  @keyframes successPop {
    0% {
      opacity: 0;
      transform: scale(0);
    }
    50% {
      transform: scale(1.2);
    }
    100% {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  @keyframes successFade {
    to {
      opacity: 0;
      transform: scale(0.8);
    }
  }
`;
document.head.appendChild(style);

// Playlist view functions
let currentViewingPlaylist = null;

function openPlaylist(playlistId) {
  const playlist = playlists.find(p => p.id === playlistId);
  if (!playlist) return;
  
  currentViewingPlaylist = playlist;
  
  // Set title
  document.getElementById('playlistViewTitle').textContent = playlist.name;
  
  // Get tracks in this playlist - search in all available track sources
  const playlistTracks = playlist.trackIds
    .map(id => {
      // Search in user's tracks first, then all tracks, then public tracks
      return tracks.find(t => t.id === id) || 
             allUserTracks.find(t => t.id === id) ||
             (window.publicTracks && window.publicTracks.find(t => t.id === id));
    })
    .filter(t => t); // Remove any null/undefined
  
  const trackListEl = document.getElementById('playlistTrackList');
  const emptyEl = document.getElementById('playlistEmpty');
  
  if (playlistTracks.length === 0) {
    trackListEl.innerHTML = '';
    emptyEl.style.display = 'block';
  } else {
    emptyEl.style.display = 'none';
    trackListEl.innerHTML = playlistTracks.map((track, index) => `
      <div class="track">
        <div class="track-content">
          <div class="track-number">${track.isPlaying ? 'â™ª' : index + 1}</div>
          ${track.albumArt 
            ? `<div class="track-art" style="background-image:url(${track.albumArt})"></div>`
            : '<div class="track-art">â™ª</div>'
          }
          <button class="play-btn" onclick="togglePlay('${track.id}')">${track.isPlaying ? 'â¸' : 'â–¶'}</button>
          <div class="track-info">
            <div class="track-title">${track.title}</div>
            <div class="track-artist">${track.artist} â€¢ ${track.album}</div>
            <div class="track-duration">${formatDuration(track.duration)}</div>
          </div>
          <div class="track-actions">
            <button class="track-menu-btn" onclick="toggleTrackMenu('playlist-${track.id}', event)">â‹¯</button>
            <div id="track-menu-playlist-${track.id}" class="track-dropdown">
              <div class="track-dropdown-item" onclick="togglePlay('${track.id}')">Play</div>
              <div class="track-dropdown-item" onclick="downloadTrack('${track.id}')">Download</div>
              <div class="track-dropdown-item delete" onclick="removeFromPlaylist('${playlist.id}', '${track.id}')">Remove from Playlist</div>
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }
  
  // Show modal
  document.getElementById('playlistViewModal').classList.add('show');
}

function closePlaylistView() {
  document.getElementById('playlistViewModal').classList.remove('show');
  currentViewingPlaylist = null;
}

function removeFromPlaylist(playlistId, trackId) {
  const playlist = playlists.find(p => p.id === playlistId);
  if (!playlist) return;
  
  // Close menus
  document.querySelectorAll('.track-dropdown, .track-submenu').forEach(menu => {
    menu.classList.remove('show');
  });
  
  // Remove track from playlist
  playlist.trackIds = playlist.trackIds.filter(id => id !== trackId);
  
  saveData();
  
  // Update profile immediately (which will re-render the expanded playlist)
  renderProfile();
}

// Override confirmCreatePlaylist
function confirmCreatePlaylist() {
  const name = document.getElementById('playlistNameInput').value.trim();
  if (name) {
    playlists.push({
      id: Math.random().toString(36).slice(2),
      name: name,
      trackIds: []
    });
    closeCreatePlaylist();
    updateStats();
    renderProfile();
    saveData();
    showSuccessToast(); // Just checkmark, no text
  }
}

function addTrackToPlaylist(trackId) {
  if (playlists.length === 0) {
    showErrorToast('Create a playlist first!');
    return;
  }
  
  currentTrackToAdd = trackId;
  
  // Populate playlist selection
  const playlistList = document.getElementById('playlistSelectionList');
  playlistList.innerHTML = playlists.map(playlist => {
    const alreadyInPlaylist = playlist.trackIds.includes(trackId);
    return `
      <div class="playlist-selection-item ${alreadyInPlaylist ? 'disabled' : ''}" onclick="${alreadyInPlaylist ? '' : `addToPlaylistConfirm('${playlist.id}')`}">
        <div style="flex:1">
          <div style="font-weight:600;margin-bottom:0.25rem">${playlist.name}</div>
          <div style="font-size:0.85rem;color:var(--text-secondary)">${playlist.trackIds.length} tracks</div>
        </div>
        ${alreadyInPlaylist ? '<div style="color:var(--text-secondary);font-size:0.85rem">Already added</div>' : '<div style="color:var(--accent);font-size:0.85rem">Add â†’</div>'}
      </div>
    `;
  }).join('');
  
  // Show modal
  document.getElementById('addToPlaylistModal').classList.add('show');
}

function closeAddToPlaylist() {
  document.getElementById('addToPlaylistModal').classList.remove('show');
  currentTrackToAdd = null;
}

function addToPlaylistConfirm(playlistId) {
  const playlist = playlists.find(p => p.id === playlistId);
  if (!playlist) return;
  
  // Add track to playlist if not already there
  if (!playlist.trackIds.includes(currentTrackToAdd)) {
    playlist.trackIds.push(currentTrackToAdd);
    
    // Show checkmark on the playlist item
    const playlistItem = event.target.closest('.playlist-selection-item');
    if (playlistItem) {
      const originalHTML = playlistItem.innerHTML;
      playlistItem.style.background = 'rgba(34, 197, 94, 0.2)';
      playlistItem.style.borderColor = '#22c55e';
      playlistItem.innerHTML = `
        <div style="flex:1">
          <div style="font-weight:600;margin-bottom:0.25rem">${playlist.name}</div>
          <div style="font-size:0.85rem;color:var(--text-secondary)">${playlist.trackIds.length} tracks</div>
        </div>
        <div style="color:#22c55e;font-size:1.5rem;font-weight:bold">âœ“</div>
      `;
      
      // Wait a moment then close
      setTimeout(() => {
        saveData();
        showSuccessToast(true); // Play sound for playlist add!
        renderProfile();
        closeAddToPlaylist();
      }, 600);
    } else {
      saveData();
      showSuccessToast(true); // Play sound for playlist add!
      renderProfile();
    }
  }
}

// Toggle playlist expansion inline (Spotify/SoundCloud style)
function togglePlaylistExpansion(playlistId) {
  // Instead of expanding inline, show full playlist page
  window.currentViewingPlaylist = playlistId;
  showScreen('playlist');
}

// New function to show playlist screen
function showScreen(screenName) {
  console.log('ðŸ“º Showing screen:', screenName);
  
  // If leaving profile screen, restore site background and UNLOCK
  const currentlyOnProfile = document.getElementById('profileScreen')?.classList.contains('active');
  if (currentlyOnProfile && screenName !== 'profile') {
    console.log('â†©ï¸ Leaving profile, restoring site background');
    
    // UNLOCK background
    window.profileBackgroundLocked = false;
    window.viewingUserProfileData = null; // Clear viewed user data
    
    // Restore site background color from database/settings
    if (currentSiteBackgroundColor) {
      document.body.style.backgroundImage = '';
      document.body.style.backgroundColor = currentSiteBackgroundColor;
      generateCompleteTheme(currentSiteBackgroundColor);
    }
  }
  
  // Only restore global customization if we're currently on a playlist AND leaving it
  const currentlyOnPlaylist = document.getElementById('playlistScreen')?.classList.contains('active');
  if (currentlyOnPlaylist && screenName !== 'playlist') {
    console.log('â†©ï¸ Leaving playlist, restoring global customization');
    restoreGlobalCustomization();
  }
  
  // Hide all screens
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  
  // Update nav links
  document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
  dropdown.classList.remove('show');
  
  if (screenName === 'playlist') {
    // Show playlist view (custom screen)
    renderPlaylistView();
    const playlistScreen = document.getElementById('playlistScreen');
    if (playlistScreen) {
      playlistScreen.classList.add('active');
      console.log('âœ… Playlist screen activated');
    } else {
      console.error('âŒ Playlist screen not found');
    }
    // Don't activate any nav link for playlist view
  } else {
    // Normal screen switching
    const targetScreen = document.getElementById(screenName + 'Screen');
    if (targetScreen) {
      targetScreen.classList.add('active');
      console.log('âœ… Screen activated:', screenName);
    } else {
      console.error('âŒ Screen not found:', screenName + 'Screen');
    }
    
    if (screenName === 'home') {
      document.querySelectorAll('.nav-link')[0].classList.add('active');
      renderPopularTracks();
      stopProfileSong();
    } else if (screenName === 'library') {
      document.querySelectorAll('.nav-link')[1].classList.add('active');
      renderLibrary();
      stopProfileSong();
    } else if (screenName === 'upload') {
      document.querySelectorAll('.nav-link')[2].classList.add('active');
      renderRecentUploads();
      stopProfileSong();
    } else if (screenName === 'search') {
      // Don't activate any nav link for search
      // Search screen is activated via search input focus
      stopProfileSong();
    } else if (screenName === 'profile') {
      // Reset viewing state - we're looking at our own profile
      viewingUserId = null;
      
      // LOCK background to prevent flickering
      window.profileBackgroundLocked = true;
      
      // Restore original profile data if it was saved
      if (window.originalProfileData) {
        console.log('ðŸ”„ Restoring original profile data and site theme');
        const usernameEl = document.getElementById('profileUsername');
        const usernameAtEl = document.getElementById('profileUsernameAt');
        const bioEl = document.getElementById('profileBio');
        const avatarEl = document.getElementById('profileAvatarEl');
        const bannerEl = document.getElementById('profileBannerEl');
        
        if (usernameEl) usernameEl.textContent = window.originalProfileData.username;
        if (usernameAtEl) usernameAtEl.textContent = window.originalProfileData.usernameAt;
        if (bioEl) bioEl.textContent = window.originalProfileData.bio;
        if (avatarEl) {
          avatarEl.style.backgroundImage = window.originalProfileData.avatarBg;
          avatarEl.textContent = window.originalProfileData.avatarText;
        }
        if (bannerEl) {
          bannerEl.style.background = window.originalProfileData.bannerBg;
        }
        
        // Restore global profile variables
        profilePicture = window.originalProfileData.profilePicture;
        profileBanner = window.originalProfileData.profileBanner;
        
        // IMPORTANT: Restore the original site theme and body background
        if (window.originalProfileData.siteTheme) {
          console.log('ðŸŽ¨ Restoring original site theme:', window.originalProfileData.siteTheme);
          generateCompleteTheme(window.originalProfileData.siteTheme);
        }
        
        // Restore body background image/color
        document.body.style.backgroundImage = window.originalProfileData.bodyBgImage || '';
        document.body.style.backgroundColor = window.originalProfileData.bodyBgColor || '';
        
        // Clear the saved data
        window.originalProfileData = null;
      }
      
      // Show edit buttons
      const editBtn = document.getElementById('editProfileBtn');
      const actionButtons = document.getElementById('profileActionButtons');
      if (editBtn) editBtn.style.display = 'block';
      if (actionButtons) actionButtons.style.display = 'flex';
      
      // APPLY PROFILE BACKGROUND (only when viewing OWN profile)
      if (window.userProfileBackgroundImage) {
        console.log('ðŸ–¼ï¸ Applying profile background image');
        
        document.body.style.backgroundImage = `url(${window.userProfileBackgroundImage})`;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';
        document.body.style.backgroundAttachment = 'fixed';
        document.body.style.backgroundColor = '';
        
        // CRITICAL: Add has-background class to profileScreen
        const profileScreen = document.getElementById('profileScreen');
        if (profileScreen) {
          profileScreen.classList.add('has-background');
          console.log('âœ… Added has-background class');
        }
        
        console.log('âœ… Profile background image applied');
      } else if (window.userProfileColor) {
        console.log('ðŸŽ¨ Applying profile color:', window.userProfileColor);
        document.body.style.backgroundImage = '';
        document.body.style.backgroundColor = window.userProfileColor;
        generateCompleteTheme(window.userProfileColor);
      } else {
        console.log('âš ï¸ No profile background or color found');
      }
      
      showProfileTab('tracks');
      renderProfile();
      applyProfileStyles();
      startProfileSong();
    } else if (screenName === 'settings') {
      // Load current display name and bio from profile
      const displayNameInput = document.getElementById('displayName');
      const bioInput = document.getElementById('bioInput');
      const profileUsername = document.getElementById('profileUsername');
      const profileBio = document.getElementById('profileBio');
      
      if (displayNameInput && profileUsername) {
        displayNameInput.value = profileUsername.textContent || '';
      }
      
      if (bioInput && profileBio) {
        bioInput.value = profileBio.textContent || '';
      }
      
      updateProfilePicPreview();
      updateBannerPreview();
      updateBackgroundPreview();
      updateColorSelection();
      const colorPicker = document.getElementById('customColorPicker');
      if (colorPicker) {
        const currentBg = document.body.style.background || '#050d1a';
        colorPicker.value = currentBg;
      }
      stopProfileSong();
    }
    
    updateStats();
  }
}

// Override showProfileTab to handle stats tab
function showProfileTab(tab) {
  currentProfileTab = tab;
  
  // Update tab buttons
  document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
  if (tab === 'tracks') {
    document.querySelector("[onclick=\"showProfileTab('tracks')\"]").classList.add('active');
  } else if (tab === 'playlists') {
    document.getElementById('playlistTabBtn').classList.add('active');
  } else if (tab === 'followers') {
    document.getElementById('followersTabBtn').classList.add('active');
  } else if (tab === 'following') {
    document.getElementById('followingTabBtn').classList.add('active');
  } else if (tab === 'stats') {
    document.getElementById('statsTabBtn').classList.add('active');
  }
  
  // Show/hide sections
  document.getElementById('profileTracksSection').style.display = tab === 'tracks' ? 'block' : 'none';
  document.getElementById('profilePlaylistsSection').style.display = tab === 'playlists' ? 'block' : 'none';
  document.getElementById('profileFollowersSection').style.display = tab === 'followers' ? 'block' : 'none';
  document.getElementById('profileFollowingSection').style.display = tab === 'following' ? 'block' : 'none';
  document.getElementById('profileStatsSection').style.display = tab === 'stats' ? 'block' : 'none';
  
  // Load data for the tab
  if (tab === 'followers') {
    loadFollowers(viewingUserId); // Pass the user ID we're viewing
  } else if (tab === 'following') {
    loadFollowing(viewingUserId); // Pass the user ID we're viewing
  } else if (tab === 'tracks') {
    loadUserTracks(viewingUserId); // Load their tracks
  } else if (tab === 'playlists') {
    loadUserPlaylists(viewingUserId); // Load their playlists
  } else if (tab === 'stats') {
    loadUserStats(viewingUserId); // Load their stats
  }
  
  // Only call renderProfile if viewing OWN profile
  if (!viewingUserId) {
    renderProfile();
  }
}

// Override renderProfile to update stat cards
function renderProfile() {
  // Note: Stat cards removed from profile - stats now only in Stats tab
  
  // If on stats tab, calculate detailed stats
  if (currentProfileTab === 'stats') {
    // Calculate total listening time
    const totalSeconds = allUserTracks.reduce((sum, t) => sum + (t.duration || 0), 0);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    document.getElementById('statsTotalTime').textContent = `${hours}h ${minutes}m`;
    
    // Calculate average duration
    const avgDuration = allUserTracks.length > 0 ? totalSeconds / allUserTracks.length : 0;
    document.getElementById('statsAvgDuration').textContent = formatDuration(avgDuration);
    
    // Update stats
    document.getElementById('statsTotalPlays').textContent = totalPlays;
    document.getElementById('statsTotalTracks').textContent = allUserTracks.length;
    document.getElementById('statsTotalPlaylists').textContent = playlists.length;
    document.getElementById('statsUniqueArtists').textContent = new Set(allUserTracks.map(t => t.artist)).size;
    document.getElementById('statsUniqueAlbums').textContent = new Set(allUserTracks.map(t => t.album)).size;
    
    // Top Artists
    const artistCounts = {};
    allUserTracks.forEach(t => {
      artistCounts[t.artist] = (artistCounts[t.artist] || 0) + 1;
    });
    const topArtists = Object.entries(artistCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);
    
    const topArtistsEl = document.getElementById('statsTopArtists');
    if (topArtists.length > 0) {
      topArtistsEl.innerHTML = topArtists.map(([ artist, count], index) => `
        <div class="top-list-item">
          <div class="top-list-rank">${index + 1}</div>
          <div class="top-list-info">
            <div class="top-list-name">${artist}</div>
            <div class="top-list-count">${count} track${count !== 1 ? 's' : ''}</div>
          </div>
        </div>
      `).join('');
    } else {
      topArtistsEl.innerHTML = '<div style="color:var(--text-secondary);text-align:center;padding:2rem">No data yet</div>';
    }
    
    // Top Albums
    const albumCounts = {};
    allUserTracks.forEach(t => {
      const key = `${t.album}|${t.artist}`;
      albumCounts[key] = (albumCounts[key] || 0) + 1;
    });
    const topAlbums = Object.entries(albumCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);
    
    const topAlbumsEl = document.getElementById('statsTopAlbums');
    if (topAlbums.length > 0) {
      topAlbumsEl.innerHTML = topAlbums.map(([key, count], index) => {
        const [album, artist] = key.split('|');
        return `
          <div class="top-list-item">
            <div class="top-list-rank">${index + 1}</div>
            <div class="top-list-info">
              <div class="top-list-name">${album}</div>
              <div class="top-list-count">${artist} â€¢ ${count} track${count !== 1 ? 's' : ''}</div>
            </div>
          </div>
        `;
      }).join('');
    } else {
      topAlbumsEl.innerHTML = '<div style="color:var(--text-secondary);text-align:center;padding:2rem">No data yet</div>';
    }
  }
  
  // Show/hide appropriate section
  if (currentProfileTab === 'tracks') {
    const trackList = document.getElementById('profileTrackList');
    const emptyTracks = document.getElementById('profileEmptyTracks');
    
    if (tracks.length === 0) {
      trackList.innerHTML = '';
      emptyTracks.style.display = 'block';
    } else {
      emptyTracks.style.display = 'none';
      trackList.innerHTML = tracks.map((track, index) => `
        <div class="track">
          <div class="track-content">
            <div class="track-number">${track.isPlaying ? 'â™ª' : index + 1}</div>
            ${track.albumArt 
              ? `<div class="track-art" style="background-image:url(${track.albumArt})"></div>`
              : '<div class="track-art">â™ª</div>'
            }
            <button class="play-btn" onclick="togglePlay('${track.id}')">${track.isPlaying ? 'â¸' : 'â–¶'}</button>
            <div class="track-info">
              <div class="track-title">${track.title}</div>
              <div class="track-artist">${track.artist} â€¢ ${track.album}</div>
              <div class="track-duration">${formatDuration(track.duration)}</div>
            </div>
            <div class="track-actions">
              <button class="track-menu-btn" onclick="toggleTrackMenu('profile-${track.id}', event)">â‹¯</button>
              <div id="track-menu-profile-${track.id}" class="track-dropdown">
                <div class="track-dropdown-item" onclick="togglePlay('${track.id}')">Play</div>
                ${track.userId === currentUser?.id ? `<div class="track-dropdown-item" onclick="openEditTrack('${track.id}')">Edit</div>` : ''}
                <div class="track-dropdown-item" onclick="downloadTrack('${track.id}')">Download</div>
                <div class="track-dropdown-item has-submenu" onclick="showPlaylistSubmenu('${track.id}', event)">
                  Add to Playlist
                  ${getPlaylistSubmenu(track.id, 'profile-')}
                </div>
                ${track.userId === currentUser?.id ? `<div class="track-dropdown-item delete" onclick="deleteTrack('${track.id}')">Delete</div>` : ''}
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }
  } else if (currentProfileTab === 'playlists') {
    const playlistList = document.getElementById('profilePlaylistList');
    const emptyPlaylists = document.getElementById('profileEmptyPlaylists');
    
    if (playlists.length === 0) {
      playlistList.innerHTML = '';
      emptyPlaylists.style.display = 'block';
    } else {
      emptyPlaylists.style.display = 'none';
      
      // Full-width grid layout (4-5 columns)
      playlistList.innerHTML = `
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1.5rem">
          ${playlists.map(playlist => {
            // Get tracks for this playlist
            const playlistTracks = playlist.trackIds
              .map(id => {
                return tracks.find(t => t.id === id) || 
                       allUserTracks.find(t => t.id === id) ||
                       (window.publicTracks && window.publicTracks.find(t => t.id === id));
              })
              .filter(t => t);
            
            return `
              <div class="playlist-card" onclick="togglePlaylistExpansion('${playlist.id}')">
                <div class="playlist-icon">â™ª</div>
                <div>
                  <h3 class="playlist-name">${playlist.name}</h3>
                  <p class="playlist-count">${playlist.trackIds.length} ${playlist.trackIds.length === 1 ? 'track' : 'tracks'}</p>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
  }
}

// Render full-page playlist view
function renderPlaylistView() {
  const playlist = playlists.find(p => p.id === window.currentViewingPlaylist);
  if (!playlist) {
    showScreen('profile');
    return;
  }
  
  // Apply playlist customization
  applyPlaylistCustomization(playlist.id);
  
  // Get tracks for this playlist
  const playlistTracks = playlist.trackIds
    .map(id => {
      return tracks.find(t => t.id === id) || 
             allUserTracks.find(t => t.id === id) ||
             (window.publicTracks && window.publicTracks.find(t => t.id === id));
    })
    .filter(t => t);
  
  // Calculate stats
  const totalDuration = playlistTracks.reduce((sum, t) => sum + (t.duration || 0), 0);
  const hours = Math.floor(totalDuration / 3600);
  const minutes = Math.floor((totalDuration % 3600) / 60);
  const totalMinutes = Math.floor(totalDuration / 60);
  const durationText = hours > 0 ? `${hours} hr ${minutes} min` : `${totalMinutes} min`;
  const uniqueArtists = new Set(playlistTracks.map(t => t.artist)).size;
  
  const container = document.getElementById('playlistViewContainer');
  const screen = document.getElementById('playlistScreen');
  screen.classList.add('active');
  
  container.innerHTML = `
    <div style="min-height:100vh;background:linear-gradient(180deg, hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 15%),0.8) 0%, hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 8%),0.4) 300px, transparent 100%)">
      <!-- Spotify-style Header -->
      <div style="padding:2rem;margin-bottom:2rem">
        <div style="display:flex;gap:2rem;align-items:flex-end">
          <!-- Playlist Cover -->
          <div style="width:232px;height:232px;background:linear-gradient(135deg,var(--accent),var(--accent-light));border-radius:8px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:5rem;color:#fff;box-shadow:0 8px 24px rgba(0,0,0,0.5);font-weight:700">â™ª</div>
          
          <!-- Playlist Info -->
          <div style="flex:1;padding-bottom:1.5rem">
            <div style="font-size:0.75rem;font-weight:700;text-transform:uppercase;margin-bottom:0.75rem;letter-spacing:1px">Public Playlist</div>
            <h1 style="font-size:5rem;font-weight:900;margin:0 0 1.5rem 0;line-height:0.9;letter-spacing:-3px">${playlist.name}</h1>
            <div style="color:var(--text-secondary);font-size:0.95rem;margin-bottom:1rem;line-height:1.6">${playlistTracks.length > 0 ? 'Your custom playlist featuring ' + Array.from(new Set(playlistTracks.slice(0,3).map(t => t.artist))).join(', ') : 'Your custom playlist'}</div>
            <div style="display:flex;align-items:center;gap:0.5rem;font-size:0.875rem;font-weight:600">
              ${profilePicture && profilePicture !== 'ML' && profilePicture.startsWith('data:') 
                ? `<div style="width:24px;height:24px;border-radius:50%;background-image:url(${profilePicture});background-size:cover;background-position:center"></div>`
                : '<div style="width:24px;height:24px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-size:0.7rem">ML</div>'
              }
              <span>${currentUser?.email?.split('@')[0] || 'User'}</span>
              <span style="color:var(--text-secondary)">â€¢</span>
              <span style="color:var(--text-secondary)">${playlistTracks.length} song${playlistTracks.length !== 1 ? 's' : ''}</span>
              ${playlistTracks.length > 0 ? `<span style="color:var(--text-secondary)">â€¢</span><span style="color:var(--text-secondary)">${durationText}</span>` : ''}
            </div>
          </div>
        </div>
      </div>
      
      <!-- Content Area -->
      <div style="padding:0 2rem 2rem 2rem">
        <!-- Controls Row -->
        <div style="display:flex;align-items:center;gap:2rem;margin-bottom:2rem;padding:1.5rem 0">
          <button onclick="showProfileTab('playlists');showScreen('profile')" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:50%;width:40px;height:40px;color:var(--text-secondary);cursor:pointer;font-size:1.2rem;display:flex;align-items:center;justify-content:center;transition:all 0.2s" onmouseover="this.style.background='rgba(255,255,255,0.2)';this.style.color='#fff'" onmouseout="this.style.background='rgba(255,255,255,0.1)';this.style.color='var(--text-secondary)'">â†</button>
          ${playlistTracks.length > 0 ? `
            <button onclick="playPlaylist('${playlist.id}')" style="background:var(--accent);border:none;border-radius:50%;width:56px;height:56px;color:#000;font-size:1.5rem;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;font-weight:900;box-shadow:0 4px 12px rgba(0,0,0,0.3);padding-left:4px" onmouseover="this.style.transform='scale(1.06)'" onmouseout="this.style.transform='scale(1)'">â–¶</button>
            <button onclick="toggleShuffle()" id="playlistShuffleBtn" class="playlist-control-btn" title="Shuffle">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <!-- Arrow 1: starts top-left, curves down to bottom-right -->
                <path d="M3 4 Q 12 12 18 18"/>
                <polyline points="15 21 21 21 21 15"/>
                
                <!-- Arrow 2: starts bottom-left, curves up to top-right -->
                <path d="M3 20 Q 12 12 18 6"/>
                <polyline points="15 3 21 3 21 9"/>
              </svg>
            </button>
            <button onclick="toggleLoop()" id="playlistLoopBtn" class="playlist-control-btn" title="Loop">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 1l4 4-4 4"/>
                <path d="M3 11V9a4 4 0 0 1 4-4h14"/>
                <path d="M7 23l-4-4 4-4"/>
                <path d="M21 13v2a4 4 0 0 1-4 4H3"/>
              </svg>
            </button>
            <button onclick="openPlaylistCustomization('${playlist.id}')" style="background:transparent;border:none;width:32px;height:32px;color:var(--text-secondary);cursor:pointer;font-size:1.2rem;transition:all 0.2s;display:flex;align-items:center;justify-content:center" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='var(--text-secondary)'" title="Edit Playlist">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
              </svg>
            </button>
            <button style="background:transparent;border:none;width:32px;height:32px;color:var(--text-secondary);cursor:pointer;font-size:1.5rem;transition:all 0.2s;display:flex;align-items:center;justify-content:center" onmouseover="this.style.color='#fff'" onmouseout="this.style.color='var(--text-secondary)'">â‹¯</button>
          ` : ''}
        </div>
        
        ${playlistTracks.length === 0 ? `
          <div style="text-align:center;color:var(--text-secondary);padding:6rem 1rem">
            <div style="font-size:5rem;margin-bottom:1.5rem;opacity:0.2">â™ª</div>
            <h3 style="font-size:1.5rem;margin-bottom:0.75rem;color:var(--text-primary);font-weight:700">This playlist is empty</h3>
            <p style="font-size:1rem;opacity:0.8">Add songs using the three-dot menu on any track</p>
          </div>
        ` : `
          <!-- Track Table Header -->
          <div style="display:grid;grid-template-columns:40px 4fr 2fr 1fr 40px;gap:1rem;padding:0.75rem 1rem;border-bottom:1px solid rgba(255,255,255,0.1);color:var(--text-secondary);font-size:0.875rem;font-weight:500;margin-bottom:0.5rem">
            <div style="text-align:center">#</div>
            <div>Title</div>
            <div>Album</div>
            <div style="text-align:right;padding-right:1rem">â±</div>
            <div></div>
          </div>
          
          <!-- Track List -->
          <div>
            ${playlistTracks.map((track, index) => `
              <div class="playlist-track-row" style="border-radius:4px;padding:0.5rem 1rem;margin-bottom:0;transition:background 0.2s;position:relative" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background=''">
                <div style="display:grid;grid-template-columns:40px 4fr 2fr 1fr 40px;gap:1rem;align-items:center">
                  <!-- Track Number / Play Button -->
                  <div style="text-align:center;position:relative">
                    <span class="track-number" style="font-family:'Space Mono',monospace;font-size:0.9rem;color:var(--text-secondary);transition:opacity 0.2s">${track.isPlaying ? 'â™ª' : index + 1}</span>
                    <button class="track-play-btn" onclick="event.stopPropagation();playPlaylistFrom('${playlist.id}', '${track.id}')" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:32px;height:32px;background:var(--accent);border:none;border-radius:50%;color:var(--accent-text,#fff);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:0.85rem;box-shadow:0 4px 12px rgba(0,0,0,0.3)" onmouseover="this.style.transform='translate(-50%,-50%) scale(1.1)'" onmouseout="this.style.transform='translate(-50%,-50%) scale(1)'">
                      ${track.isPlaying ? 'â¸' : 'â–¶'}
                    </button>
                  </div>
                  
                  <!-- Title + Artist -->
                  <div style="display:flex;align-items:center;gap:1rem;min-width:0">
                    ${track.albumArt 
                      ? `<div style="width:40px;height:40px;background-image:url(${track.albumArt});background-size:cover;background-position:center;border-radius:4px;flex-shrink:0"></div>`
                      : '<div style="width:40px;height:40px;background:rgba(255,255,255,0.08);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;color:var(--text-secondary)">â™ª</div>'
                    }
                    <div style="min-width:0">
                      <div style="font-size:1rem;font-weight:500;margin-bottom:0.25rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;color:${track.isPlaying ? 'var(--accent)' : 'var(--text-primary)'}">${track.title}</div>
                      <div style="font-size:0.875rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${track.artist}</div>
                    </div>
                  </div>
                  
                  <!-- Album -->
                  <div style="font-size:0.875rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">${track.album}</div>
                  
                  <!-- Duration -->
                  <div style="font-size:0.875rem;color:var(--text-secondary);font-family:'Space Mono',monospace;text-align:right;padding-right:1rem">${formatDuration(track.duration)}</div>
                  
                  <!-- Menu Button -->
                  <div style="text-align:center">
                    <button class="track-menu-btn" onclick="toggleTrackMenu('playlist-view-${track.id}', event)" style="width:32px;height:32px;background:transparent;border:none;border-radius:50%;color:var(--text-secondary);font-weight:900;cursor:pointer;transition:all 0.2s;font-size:1.2rem;display:flex;align-items:center;justify-content:center" onmouseover="this.style.background='rgba(255,255,255,0.1)';this.style.color='#fff'" onmouseout="this.style.background='transparent';this.style.color='var(--text-secondary)'">â‹¯</button>
                    <div id="track-menu-playlist-view-${track.id}" class="track-dropdown">
                      <div class="track-dropdown-item" onclick="playPlaylistFrom('${playlist.id}', '${track.id}')">Play</div>
                      <div class="track-dropdown-item" onclick="downloadTrack('${track.id}')">Download</div>
                      <div class="track-dropdown-item delete" onclick="removeFromPlaylist('${playlist.id}', '${track.id}')">Remove from Playlist</div>
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        `}
      </div>
    </div>
  `;
}

// OVERRIDE render functions with three-dot menu
function renderLibrary() {
  if (tracks.length === 0) {
    trackList.innerHTML = '';
    emptyState.style.display = 'block';
  } else {
    emptyState.style.display = 'none';
    trackList.innerHTML = tracks.map((track, index) => `
      <div class="track">
        <div class="track-content">
          <div class="track-number">${track.isPlaying ? 'â™ª' : index + 1}</div>
          ${track.albumArt 
            ? `<div class="track-art" style="background-image:url(${track.albumArt})"></div>`
            : '<div class="track-art">â™ª</div>'
          }
          <button class="play-btn" onclick="togglePlay('${track.id}')">${track.isPlaying ? 'â¸' : 'â–¶'}</button>
          <div class="track-info">
            <div class="track-title">${track.title}</div>
            <div class="track-artist">${track.artist} â€¢ ${track.album}</div>
            <div class="track-duration">${formatDuration(track.duration)}</div>
          </div>
          <div class="track-actions">
            <button class="track-menu-btn" onclick="toggleTrackMenu('${track.id}', event)">â‹¯</button>
            <div id="track-menu-${track.id}" class="track-dropdown">
              <div class="track-dropdown-item" onclick="togglePlay('${track.id}')">Play</div>
              ${track.userId === currentUser?.id ? `<div class="track-dropdown-item" onclick="openEditTrack('${track.id}')">Edit</div>` : ''}
              <div class="track-dropdown-item" onclick="downloadTrack('${track.id}')">Download</div>
              <div class="track-dropdown-item has-submenu" onclick="showPlaylistSubmenu('${track.id}', event)">
                Add to Playlist
                ${getPlaylistSubmenu(track.id)}
              </div>
              ${track.userId === currentUser?.id ? `<div class="track-dropdown-item delete" onclick="deleteTrack('${track.id}')">Delete</div>` : ''}
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }
}

function renderRecentUploads() {
  const uploadedTracks = document.getElementById('uploadedTracks');
  const recentTrackList = document.getElementById('recentTrackList');
  
  if (allUserTracks.length > 0) {
    uploadedTracks.style.display = 'block';
    const recent = allUserTracks.slice(-10).reverse();
    
    recentTrackList.innerHTML = recent.map((track, index) => `
      <div class="track">
        <div class="track-content">
          <div class="track-number">${track.isPlaying ? 'â™ª' : index + 1}</div>
          ${track.albumArt 
            ? `<div class="track-art" style="background-image:url(${track.albumArt})"></div>`
            : '<div class="track-art">â™ª</div>'
          }
          <button class="play-btn" onclick="togglePlay('${track.id}')">${track.isPlaying ? 'â¸' : 'â–¶'}</button>
          <div class="track-info">
            <div class="track-title">${track.title}</div>
            <div class="track-artist">${track.artist} â€¢ ${track.album}</div>
            <div class="track-duration">${formatDuration(track.duration)}</div>
          </div>
          <div class="track-actions">
            <button class="track-menu-btn" onclick="toggleTrackMenu('recent-${track.id}', event)">â‹¯</button>
            <div id="track-menu-recent-${track.id}" class="track-dropdown">
              <div class="track-dropdown-item" onclick="togglePlay('${track.id}')">Play</div>
              ${track.userId === currentUser?.id ? `<div class="track-dropdown-item" onclick="openEditTrack('${track.id}')">Edit</div>` : ''}
              <div class="track-dropdown-item" onclick="downloadTrack('${track.id}')">Download</div>
              <div class="track-dropdown-item has-submenu" onclick="showPlaylistSubmenu('${track.id}', event)">
                Add to Playlist
                ${getPlaylistSubmenu(track.id, 'recent-')}
              </div>
              ${track.userId === currentUser?.id ? `<div class="track-dropdown-item delete" onclick="deleteTrack('${track.id}')">Delete</div>` : ''}
            </div>
          </div>
        </div>
      </div>
    `).join('');
  } else {
    uploadedTracks.style.display = 'none';
  }
}

function renderPopularTracks(filtered) {
  const popularTracks = document.getElementById('popularTracks');
  const noMusic = document.getElementById('noMusic');
  const noResults = document.getElementById('noResults');
  
  // Use public tracks if available, otherwise fall back to user's tracks
  const allTracks = window.publicTracks || allUserTracks;
  const tracksToShow = filtered || allTracks;
  
  noResults.style.display = 'none';
  noMusic.style.display = 'none';
  
  if (tracksToShow.length === 0) {
    popularTracks.innerHTML = '';
    (filtered ? noResults : noMusic).style.display = 'block';
  } else {
    popularTracks.innerHTML = tracksToShow.slice(0, 20).map((track, index) => {
      // Get user info from cache if available
      const uploaderProfile = track.userId ? userProfilesCache[track.userId] : null;
      const uploaderInitials = uploaderProfile?.display_name ? uploaderProfile.display_name.substring(0, 2).toUpperCase() : '?';
      const uploaderPic = uploaderProfile?.profile_picture;
      const uploaderName = uploaderProfile?.display_name || 'Unknown User';
      
      return `
      <div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.5rem">
        ${uploaderPic 
          ? `<div class="uploader-avatar" onclick="viewUserProfile('${track.userId}')" style="width:40px;height:40px;border-radius:50%;background-image:url(${uploaderPic});background-size:cover;background-position:center;cursor:pointer;border:2px solid rgba(255,255,255,0.2);flex-shrink:0;transition:all 0.3s;box-shadow:0 2px 8px rgba(0,0,0,0.3)" onmouseover="this.style.transform='scale(1.15)';this.style.borderColor='var(--accent)';this.style.boxShadow='0 0 20px var(--accent)'" onmouseout="this.style.transform='scale(1)';this.style.borderColor='rgba(255,255,255,0.2)';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.3)'" title="${uploaderName}"></div>`
          : `<div class="uploader-avatar" onclick="viewUserProfile('${track.userId}')" style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg, var(--accent), var(--accent-light));display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;cursor:pointer;border:2px solid rgba(255,255,255,0.2);flex-shrink:0;transition:all 0.3s;box-shadow:0 2px 8px rgba(0,0,0,0.3);color:#fff" onmouseover="this.style.transform='scale(1.15)';this.style.borderColor='var(--accent)';this.style.boxShadow='0 0 20px var(--accent)'" onmouseout="this.style.transform='scale(1)';this.style.borderColor='rgba(255,255,255,0.2)';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.3)'" title="${uploaderName}">${uploaderInitials}</div>`
        }
        <div class="track" style="flex:1">
          <div class="track-content">
            <div class="track-number">${track.isPlaying ? 'â™ª' : index + 1}</div>
            ${track.albumArt 
              ? `<div class="track-art" style="background-image:url(${track.albumArt})"></div>`
              : '<div class="track-art">â™ª</div>'
            }
            <button class="play-btn" onclick="togglePlay('${track.id}')">${track.isPlaying ? 'â¸' : 'â–¶'}</button>
            <div class="track-info">
              <div class="track-title">${track.title}</div>
              <div class="track-artist">${track.artist} â€¢ ${track.album}</div>
              <div class="track-duration">${formatDuration(track.duration)}</div>
            </div>
            <div class="track-actions">
              <button class="track-menu-btn" onclick="toggleTrackMenu('home-${track.id}', event)">â‹¯</button>
              <div id="track-menu-home-${track.id}" class="track-dropdown">
                <div class="track-dropdown-item" onclick="togglePlay('${track.id}')">Play</div>
                <div class="track-dropdown-item" onclick="downloadTrack('${track.id}')">Download</div>
                <div class="track-dropdown-item has-submenu" onclick="showPlaylistSubmenu('${track.id}', event)">
                  Add to Playlist
                  ${getPlaylistSubmenu(track.id, 'home-')}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    }).join('');
    
    // Fetch user profiles for tracks that don't have them cached
    tracksToShow.slice(0, 20).forEach(track => {
      if (track.userId && !userProfilesCache[track.userId]) {
        fetchUserProfile(track.userId).then(() => {
          // Re-render after fetching profile
          renderPopularTracks(filtered);
        });
      }
    });
  }
}

// OVERRIDE togglePlay with signed URL support
// Cache for signed URLs to avoid refetching
const signedUrlCache = new Map();

// Preload signed URLs for visible tracks to make playback instant
async function preloadTrackUrls(trackList) {
  if (!currentUser || !supabase) return;
  
  const tracksToPreload = trackList.slice(0, 10); // Preload first 10 visible tracks
  
  for (const track of tracksToPreload) {
    // Skip if already cached
    if (signedUrlCache.has(track.id)) {
      const cached = signedUrlCache.get(track.id);
      if (Date.now() < cached.expiresAt) continue;
    }
    
    let audioUrl = track.dataUrl || track.audioData || track.audio_url;
    
    // Only preload Supabase storage URLs
    if (audioUrl && audioUrl.includes('supabase') && audioUrl.includes('audio-files')) {
      try {
        const urlParts = audioUrl.split('/storage/v1/object/public/audio-files/');
        if (urlParts.length > 1) {
          const filePath = urlParts[1];
          
          const { data, error } = await supabase.storage
            .from('audio-files')
            .createSignedUrl(filePath, 3600);
          
          if (!error && data && data.signedUrl) {
            signedUrlCache.set(track.id, {
              url: data.signedUrl,
              expiresAt: Date.now() + (3500 * 1000)
            });
            console.log('âš¡ Preloaded signed URL for:', track.title);
          }
        }
      } catch (e) {
        // Silent fail for preloading
      }
    }
  }
}

async function togglePlay(trackId) {
  // Search in user's tracks first, then all public tracks
  const track = tracks.find(t => t.id === trackId) || 
                allUserTracks.find(t => t.id === trackId) ||
                (window.publicTracks && window.publicTracks.find(t => t.id === trackId));
  
  if (!track) return;
  
  let audioUrl = track.dataUrl || track.audioData || track.audio_url;
  
  if (!audioUrl) {
    showErrorToast('Track has no audio URL');
    return;
  }
  
  // Check cache first for instant playback
  if (signedUrlCache.has(trackId)) {
    const cached = signedUrlCache.get(trackId);
    // Check if cached URL is still valid (expires in 1 hour)
    if (Date.now() < cached.expiresAt) {
      audioUrl = cached.url;
      console.log('âš¡ Using cached signed URL for instant playback');
    } else {
      signedUrlCache.delete(trackId);
    }
  }
  
  // If URL is a Supabase storage URL and not cached, get a signed URL
  if (!signedUrlCache.has(trackId) && audioUrl.includes('supabase') && audioUrl.includes('audio-files') && currentUser) {
    try {
      // Extract the file path from the URL
      const urlParts = audioUrl.split('/storage/v1/object/public/audio-files/');
      if (urlParts.length > 1) {
        const filePath = urlParts[1];
        
        // Get a signed URL that works for 1 hour
        const { data, error } = await supabase.storage
          .from('audio-files')
          .createSignedUrl(filePath, 3600); // 1 hour expiry
        
        if (!error && data && data.signedUrl) {
          audioUrl = data.signedUrl;
          // Cache the signed URL
          signedUrlCache.set(trackId, {
            url: audioUrl,
            expiresAt: Date.now() + (3500 * 1000) // 58 minutes (slightly less than 1 hour)
          });
          console.log('âœ… Signed URL fetched and cached');
        }
      }
    } catch (e) {
      console.warn('Could not get signed URL, using original:', e);
    }
  }
  
  if (currentPlayingId !== trackId || audioPlayer.paused) {
    if (currentPlayingId === trackId && audioPlayer.paused) {
      // Resume paused track - INSTANT
      const playPromise = audioPlayer.play();
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            track.isPlaying = true;
            document.getElementById('playerPlayIcon').textContent = 'â¸';
          })
          .catch(error => {
            showErrorToast('Could not resume playback');
          });
      }
    } else {
      // Play new track
      // Reset all tracks
      tracks.forEach(t => t.isPlaying = false);
      allUserTracks.forEach(t => t.isPlaying = false);
      if (window.publicTracks) {
        window.publicTracks.forEach(t => t.isPlaying = false);
      }
      
      // OPTIMIZED: Set preload to 'auto' for faster loading
      audioPlayer.preload = 'auto';
      
      // Set audio source
      audioPlayer.src = audioUrl;
      
      // Test if URL is actually accessible
      fetch(audioUrl, { method: 'HEAD' })
        .then(response => {
          if (response.ok) {
            console.log('âœ… Audio URL is accessible');
          } else {
            alert('Audio file not accessible!\nStatus: ' + response.status + '\nURL: ' + audioUrl.substring(0, 80));
          }
        })
        .catch(error => {
          alert('CORS ERROR!\nCannot access audio file.\n\nError: ' + error.message + '\n\nFIX: Go to Supabase Storage â†’ audio-files bucket â†’ Configuration â†’ Add CORS policy:\n{"allowedOrigins": ["*"], "allowedMethods": ["GET"]}');
        });
      
      console.log('ðŸŽµ Audio src set to:', audioUrl);
      console.log('ðŸ”Š Audio element state:', {
        muted: audioPlayer.muted,
        volume: audioPlayer.volume,
        readyState: audioPlayer.readyState,
        networkState: audioPlayer.networkState
      });
      
      // Add event listeners to debug
      // Set audio source
      audioPlayer.src = audioUrl;
      
      // Try to play
      const playPromise = audioPlayer.play();
      
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            currentPlayingId = trackId;
            track.isPlaying = true;
            totalPlays++;
            updatePlayerBar(track);
            updateStats();
            renderLibrary();
            renderPopularTracks();
            renderProfile();
          })
          .catch(error => {
            console.warn('Playback error (might still play):', error);
          });
      }
    }
  } else {
    // Pause
    audioPlayer.pause();
    track.isPlaying = false;
    document.getElementById('playerPlayIcon').textContent = 'â–¶';
  }
  
  renderLibrary();
  renderPopularTracks();
  renderProfile();
}

// Show error toast notification
function showErrorToast(message) {
  const existingToast = document.querySelector('.error-toast');
  if (existingToast) existingToast.remove();
  
  const toast = document.createElement('div');
  toast.className = 'error-toast';
  toast.style.cssText = 'position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:rgba(255,107,107,0.95);color:white;padding:1rem 2rem;border-radius:8px;font-size:0.95rem;font-weight:600;z-index:10000;box-shadow:0 8px 24px rgba(0,0,0,0.4);backdrop-filter:blur(10px);animation:slideUp 0.3s ease;';
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(-50%) translateY(20px)';
    toast.style.transition = 'all 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

// Re-attach critical event handlers after everything loads
window.addEventListener('DOMContentLoaded', function() {
  console.log('Re-attaching event handlers');
  
  // Fix player bar time updates
  audioPlayer.addEventListener('timeupdate', function() {
    if (!isNaN(audioPlayer.duration) && audioPlayer.duration > 0) {
      const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
      const progressFill = document.getElementById('progressFill');
      const currentTimeEl = document.getElementById('currentTime');
      const totalTimeEl = document.getElementById('totalTime');
      
      if (progressFill) {
        progressFill.style.width = progressPercent + '%';
      }
      if (currentTimeEl) {
        currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
      }
      if (totalTimeEl) {
        totalTimeEl.textContent = formatTime(audioPlayer.duration);
      }
    }
  });
  
  console.log('âœ… Player bar time update handler attached');
  
  // Add audio error handler
  audioPlayer.addEventListener('error', function(e) {
    console.error('ðŸ”´ Audio player error:', e);
    console.error('Error code:', audioPlayer.error?.code);
    console.error('Error message:', audioPlayer.error?.message);
    console.error('Current src:', audioPlayer.src);
    
    let errorMsg = 'Audio playback error: ';
    if (audioPlayer.error) {
      switch(audioPlayer.error.code) {
        case 1:
          errorMsg += 'MEDIA_ERR_ABORTED - Playback aborted';
          break;
        case 2:
          errorMsg += 'MEDIA_ERR_NETWORK - Network error loading audio';
          break;
        case 3:
          errorMsg += 'MEDIA_ERR_DECODE - Audio decoding failed';
          break;
        case 4:
          errorMsg += 'MEDIA_ERR_SRC_NOT_SUPPORTED - Audio format not supported or file not accessible';
          break;
        default:
          errorMsg += 'Unknown error';
      }
    }
    // Silent error - already logged to console
  });
  
  console.log('Audio error handler attached');
  
  // Profile dropdown
  const profileBtnEl = document.getElementById('profileBtn');
  if (profileBtnEl) {
    profileBtnEl.onclick = function(e) {
      e.stopPropagation();
      const dropdownEl = document.getElementById('dropdown');
      if (dropdownEl) {
        dropdownEl.classList.toggle('show');
      }
    };
    console.log('Profile button handler attached');
  }
  
  // Upload area click
  const uploadAreaEl = document.getElementById('uploadArea');
  const fileInputEl = document.getElementById('fileInput');
  if (uploadAreaEl && fileInputEl) {
    uploadAreaEl.onclick = function() {
      fileInputEl.click();
    };
    console.log('Upload area click handler attached');
  }
  
  // File input change
  if (fileInputEl) {
    fileInputEl.onchange = function(e) {
      handleFiles(e.target.files);
    };
    console.log('File input change handler attached');
  }
  
  // Upload area drag and drop
  if (uploadAreaEl) {
    uploadAreaEl.ondragover = function(e) {
      e.preventDefault();
      uploadAreaEl.classList.add('drag-active');
    };
    
    uploadAreaEl.ondragleave = function() {
      uploadAreaEl.classList.remove('drag-active');
    };
    
    uploadAreaEl.ondrop = function(e) {
      e.preventDefault();
      uploadAreaEl.classList.remove('drag-active');
      handleFiles(e.dataTransfer.files);
    };
    console.log('Upload area drag handlers attached');
  }
});

// Bass-reactive player bar glow
var audioContext, analyser, dataArray, bufferLength, bassReactiveInterval;

function initAudioAnalyzer() {
  // DISABLED - Bass visualization disabled to keep audio working
  // Will re-enable in future update
  console.log('Bass visualization temporarily disabled');
}

function startBassReaction() {
  const playBtn = document.getElementById('playPauseBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const repeatBtn = document.getElementById('repeatBtn');
  const menuBtn = document.getElementById('playerMenuBtn');
  
  if (!playBtn) return;
  
  if (bassReactiveInterval) clearInterval(bassReactiveInterval);
  
  bassReactiveInterval = setInterval(() => {
    if (!audioPlayer.paused && currentPlayingId) {
      analyser.getByteFrequencyData(dataArray);
      
      // Get bass frequencies (roughly 60-250 Hz, which is bins 0-10 for better coverage)
      let bassSum = 0;
      for (let i = 0; i < 10; i++) {
        bassSum += dataArray[i];
      }
      const bassAverage = bassSum / 10;
      
      // Normalize bass intensity (0-255 range to 0-1)
      const rawIntensity = bassAverage / 255;
      
      // Apply EXTREME exponential curve and threshold
      // Cube it for even more dramatic response, then amplify
      const bassIntensity = Math.pow(rawIntensity, 3) * 3; // Cube and 3x amplify
      
      // Only show glow if intensity is above threshold (removes constant glow)
      const threshold = 0.05;
      const finalIntensity = bassIntensity > threshold ? bassIntensity : 0;
      
      // Create INTENSE, FOCUSED glow - smaller radius, higher opacity
      const glowSize = finalIntensity * 15; // 0-15px (much smaller!)
      const glowIntensity = finalIntensity * 2; // Boost intensity
      
      // Triple-layer INTENSE glow with small radius
      const buttonGlow = glowSize > 0 
        ? `0 0 ${glowSize}px rgba(var(--accent-rgb), ${glowIntensity}), 
           0 0 ${glowSize * 1.5}px rgba(var(--accent-rgb), ${glowIntensity * 0.8}),
           0 0 ${glowSize * 2}px rgba(var(--accent-rgb), ${glowIntensity * 0.5})`
        : 'none';
      
      // Apply to all buttons - NO TRANSFORM
      playBtn.style.boxShadow = buttonGlow;
      if (prevBtn) prevBtn.style.boxShadow = buttonGlow;
      if (nextBtn) nextBtn.style.boxShadow = buttonGlow;
      if (repeatBtn) repeatBtn.style.boxShadow = buttonGlow;
      if (menuBtn) menuBtn.style.boxShadow = buttonGlow;
    }
  }, 30); // Faster update (30ms) for more responsive feel
}

function stopBassReaction() {
  if (bassReactiveInterval) {
    clearInterval(bassReactiveInterval);
    bassReactiveInterval = null;
  }
  
  // Reset button styles
  const playBtn = document.getElementById('playPauseBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const repeatBtn = document.getElementById('repeatBtn');
  const menuBtn = document.getElementById('playerMenuBtn');
  
  if (playBtn) playBtn.style.boxShadow = '';
  if (prevBtn) prevBtn.style.boxShadow = '';
  if (nextBtn) nextBtn.style.boxShadow = '';
  if (repeatBtn) repeatBtn.style.boxShadow = '';
  if (menuBtn) menuBtn.style.boxShadow = '';
}

// Hook into audio player events
audioPlayer.addEventListener('play', () => {
  if (!audioContext) initAudioAnalyzer();
  if (audioContext.state === 'suspended') audioContext.resume();
  startBassReaction();
});

audioPlayer.addEventListener('pause', stopBassReaction);
audioPlayer.addEventListener('ended', stopBassReaction);

// ========== SUPABASE AUTH FUNCTIONS ==========

// Check if user is logged in
async function checkAuth() {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) {
    currentUser = session.user;
    
    // DO NOT clear localStorage - user settings are stored there!
    
    document.getElementById('authModal').style.display = 'none';
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('profileMenuContainer').style.display = 'block';
    loadCloudData();
  } else {
    currentUser = null;
    document.getElementById('loginBtn').style.display = 'block';
    document.getElementById('profileMenuContainer').style.display = 'none';
  }
}

// Switch between login and signup tabs
function switchAuthTab(tab) {
  clearAuthMessage();
  
  const loginForm = document.getElementById('loginForm');
  const signupForm = document.getElementById('signupForm');
  const tabs = document.querySelectorAll('.auth-tab');
  
  tabs.forEach(t => t.classList.remove('active'));
  
  if (tab === 'login') {
    loginForm.style.display = 'block';
    signupForm.style.display = 'none';
    tabs[0].classList.add('active');
  } else {
    loginForm.style.display = 'none';
    signupForm.style.display = 'block';
    tabs[1].classList.add('active');
  }
}

// Handle login
async function handleLogin() {
  clearAuthMessage();
  
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  
  if (!email || !password) {
    showAuthMessage('Please fill in all fields', 'error');
    return;
  }
  
  try {
    const { data, error } = await supabase.auth.signInWithPassword({
      email: email,
      password: password
    });
    
    if (error) {
      // Better error messages
      if (error.message.includes('Email not confirmed')) {
        showAuthMessage('Please verify your email address before logging in. Check your inbox for the verification link.', 'error');
      } else if (error.message.includes('Invalid login credentials')) {
        showAuthMessage('Invalid email or password. Please try again.', 'error');
      } else {
        showAuthMessage('Login failed: ' + error.message, 'error');
      }
    } else {
      currentUser = data.user;
      
      document.getElementById('authModal').style.display = 'none';
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('profileMenuContainer').style.display = 'block';
      document.getElementById('notificationBellContainer').style.display = 'block';
      loadNotifications();
      loadCloudData();
    }
  } catch (err) {
    console.error('Login error:', err);
    showAuthMessage('Login error: ' + err.message, 'error');
  }
}

// Handle signup
async function handleSignup() {
  console.log('handleSignup called');
  clearAuthMessage();
  
  const username = document.getElementById('signupUsername').value.trim();
  const email = document.getElementById('signupEmail').value;
  const password = document.getElementById('signupPassword').value;
  const confirmPassword = document.getElementById('signupPasswordConfirm').value;
  
  if (!username || !email || !password || !confirmPassword) {
    showAuthMessage('Please fill in all fields', 'error');
    return;
  }
  
  // Validate username format
  if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
    showAuthMessage('Username must be 3-20 characters (letters, numbers, and underscores only)', 'error');
    return;
  }
  
  if (password !== confirmPassword) {
    showAuthMessage('Passwords do not match', 'error');
    return;
  }
  
  if (password.length < 6) {
    showAuthMessage('Password must be at least 6 characters', 'error');
    return;
  }
  
  const btn = document.getElementById('signupSubmitBtn');
  btn.disabled = true;
  btn.textContent = 'Creating Account...';
  
  try {
    const { data, error } = await supabase.auth.signUp({
      email: email,
      password: password,
      options: {
        data: {
          username: username
        }
      }
    });
    
    if (error) {
      // Handle rate limit error specifically
      if (error.message.includes('security purposes')) {
        showAuthMessage('Please wait a minute before trying again (rate limit).', 'error');
      } else {
        showAuthMessage('Signup failed: ' + error.message, 'error');
      }
      btn.disabled = false;
      btn.textContent = 'Create Account';
      return;
    }
    
    // Save username to profiles table - don't wait for it, do it in background
    if (data.user) {
      saveUserProfile(data.user.id, username, email).catch(err => {
        console.error('Failed to save profile, but user was created:', err);
      });
    }
    
    // Check if user was created but needs email confirmation
    if (data.user && !data.session) {
      showAuthMessage('âœ… Account created! Please check your email to verify your account before logging in.', 'success');
      // Switch to login tab after 5 seconds
      setTimeout(() => {
        switchAuthTab('login');
        clearAuthMessage();
        btn.disabled = false;
        btn.textContent = 'Create Account';
      }, 5000);
    } else if (data.session) {
      // Email confirmation disabled - user is auto logged in
      showAuthMessage('âœ… Account created successfully!', 'success');
      currentUser = data.user;
      document.getElementById('authModal').style.display = 'none';
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('profileMenuContainer').style.display = 'block';
      document.getElementById('notificationBellContainer').style.display = 'block';
      setTimeout(() => {
        loadNotifications();
        loadCloudData();
      }, 1000);
    }
  } catch (err) {
    console.error('Signup error:', err);
    showAuthMessage('Signup error: ' + err.message, 'error');
    btn.disabled = false;
    btn.textContent = 'Create Account';
  }
}

// Show forgot password form
function showForgotPassword() {
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('signupForm').style.display = 'none';
  document.getElementById('forgotPasswordForm').style.display = 'block';
  document.getElementById('resetPasswordForm').style.display = 'none';
  document.getElementById('authTabs').style.display = 'none';
  clearAuthMessage();
}

// Show login form
function showLoginForm() {
  document.getElementById('loginForm').style.display = 'block';
  document.getElementById('signupForm').style.display = 'none';
  document.getElementById('forgotPasswordForm').style.display = 'none';
  document.getElementById('resetPasswordForm').style.display = 'none';
  document.getElementById('authTabs').style.display = 'flex';
  switchAuthTab('login');
  clearAuthMessage();
}

// Handle forgot password
async function handleForgotPassword() {
  const email = document.getElementById('forgotEmail').value.trim();
  
  if (!email) {
    showAuthMessage('Please enter your email address', 'error');
    return;
  }
  
  if (!supabase) {
    showAuthMessage('Error: Database connection not available', 'error');
    return;
  }
  
  const btn = document.getElementById('forgotSubmitBtn');
  btn.disabled = true;
  btn.textContent = 'Sending...';
  
  try {
    // Send reset email - Supabase will handle checking if user exists
    const { data, error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: `${window.location.origin}/#reset-password`
    });
    
    if (error) {
      showAuthMessage('Error: ' + error.message, 'error');
    } else {
      // Always show success for security (don't reveal if email exists)
      showAuthMessage('âœ… If an account exists with this email, you will receive a password reset link. Please check your inbox and spam folder.', 'success');
    }
  } catch (err) {
    showAuthMessage('Error: ' + (err.message || 'Failed to send reset email'), 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'Send Reset Code';
  }
}

// Handle password reset
async function handleResetPassword() {
  const newPassword = document.getElementById('resetNewPassword').value;
  const confirmPassword = document.getElementById('resetConfirmPassword').value;
  
  if (!newPassword || !confirmPassword) {
    showAuthMessage('Please fill in all fields', 'error');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    showAuthMessage('Passwords do not match', 'error');
    return;
  }
  
  if (newPassword.length < 6) {
    showAuthMessage('Password must be at least 6 characters', 'error');
    return;
  }
  
  try {
    const { data, error } = await supabase.auth.updateUser({
      password: newPassword
    });
    
    if (error) {
      showAuthMessage('Error resetting password: ' + error.message, 'error');
    } else {
      showAuthMessage('Password reset successfully! You can now login.', 'success');
      setTimeout(() => {
        showLoginForm();
      }, 2000);
    }
  } catch (err) {
    console.error('Reset password error:', err);
    showAuthMessage('Error resetting password', 'error');
  }
}

// Check if username is available
async function checkUsernameAvailability(username) {
  if (!username) {
    username = document.getElementById('signupUsername').value.trim();
  }
  
  if (!username) {
    return false;
  }
  
  // Validate format
  if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
    return false;
  }
  
  try {
    // Check if username exists in profiles table
    const { data, error } = await supabase
      .from('profiles')
      .select('username')
      .eq('username', username.toLowerCase());
    
    if (error) {
      console.error('Error checking username:', error);
      return false;
    }
    
    // If data exists and has items, username is taken
    if (data && data.length > 0) {
      return false; // Username taken
    }
    
    return true; // Username available
  } catch (err) {
    console.error('Username check error:', err);
    return false;
  }
}

// Save user profile to database
async function saveUserProfile(userId, username, email) {
  try {
    // Add timeout to prevent hanging
    const timeoutPromise = new Promise((_, reject) => 
      setTimeout(() => reject(new Error('Profile save timeout')), 5000)
    );
    
    const savePromise = supabase
      .from('profiles')
      .upsert({
        id: userId,
        username: username.toLowerCase(),
        display_name: username,
        email: email,
        created_at: new Date().toISOString()
      });
    
    const { error } = await Promise.race([savePromise, timeoutPromise]);
    
    if (error) {
      console.error('Error saving profile:', error);
      throw error;
    } else {
      console.log('âœ… User profile saved');
    }
  } catch (err) {
    console.error('Profile save error:', err);
    throw err; // Re-throw so signup knows it failed
  }
}

// Handle logout
async function handleLogout() {
  const { error } = await supabase.auth.signOut();
  if (!error) {
    currentUser = null;
    tracks = [];
    allUserTracks = [];
    // Keep everything else: playlists, colors, profile picture, etc.
    // User should have same settings when they sign back in
    renderLibrary();
    renderPopularTracks();
    document.getElementById('loginBtn').style.display = 'block';
    document.getElementById('profileMenuContainer').style.display = 'none';
    document.getElementById('notificationBellContainer').style.display = 'none';
  }
}

// Check for existing session on page load
async function checkSession() {
  console.log('ðŸ” Checking for existing session...');
  
  try {
    const { data: { session }, error } = await supabase.auth.getSession();
    
    if (error) {
      console.error('âŒ Session check error:', error);
      return;
    }
    
    if (session && session.user) {
      console.log('âœ… Found existing session for user:', session.user.email);
      currentUser = session.user;
      
      // Update UI
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('profileMenuContainer').style.display = 'block';
      document.getElementById('notificationBellContainer').style.display = 'block';
      
      // Load notifications
      loadNotifications();
      
      // Load user's cloud data
      await loadCloudData();
      
      // CRITICAL: Re-apply localStorage customization AFTER cloud data loads
      // This ensures localStorage settings override database (if database is empty)
      setTimeout(() => {
        const savedData = localStorage.getItem('basspace_data');
        if (savedData) {
          const data = JSON.parse(savedData);
          
          // Re-apply site background
          if (data.siteBackgroundColor) {
            currentSiteBackgroundColor = data.siteBackgroundColor;
            document.body.style.background = data.siteBackgroundColor;
            generateCompleteTheme(data.siteBackgroundColor);
            console.log('ðŸ”„ Re-applied site background after cloud load:', data.siteBackgroundColor);
          }
          
          // Re-apply custom glow color
          if (data.customGlowColor) {
            customGlowColor = data.customGlowColor;
            const textColor = getContrastColor(customGlowColor);
            document.documentElement.style.setProperty('--accent', customGlowColor);
            document.documentElement.style.setProperty('--accent-text', textColor);
            const rgb = hexToRgb(customGlowColor);
            document.documentElement.style.setProperty('--accent-rgb', `${rgb.r},${rgb.g},${rgb.b}`);
            console.log('ðŸ”„ Re-applied custom glow after cloud load:', customGlowColor);
          }
          
          // Re-apply playlists
          if (data.playlists && data.playlists.length > 0) {
            playlists = data.playlists;
            console.log('ðŸ”„ Re-applied playlists after cloud load:', playlists.length);
          }
          
          // Re-apply profile picture if exists in localStorage
          if (data.profilePicture && data.profilePicture !== 'ML') {
            profilePicture = data.profilePicture;
            updateHeaderAvatar();
            
            // Update cache
            if (currentUser) {
              userProfilesCache[currentUser.id] = {
                ...userProfilesCache[currentUser.id],
                profile_picture: profilePicture
              };
            }
            
            // Re-render tracks
            renderPopularTracks();
            console.log('ðŸ”„ Re-applied profile picture after cloud load');
          }
        }
      }, 200);
      
      // Load all public tracks for social feed
      await loadPublicTracks();
    } else {
      console.log('â„¹ï¸ No existing session found');
      
      // Even if not logged in, load public tracks for browsing
      await loadPublicTracks();
      
      // Show login button
      document.getElementById('loginBtn').style.display = 'block';
      document.getElementById('profileMenuContainer').style.display = 'none';
    }
  } catch (err) {
    console.error('âŒ Error checking session:', err);
  }
}

// Upload track to Supabase Storage
async function uploadToCloud(file, trackData) {
  if (!currentUser) return null;
  
  const fileExt = file.name.split('.').pop();
  const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`;
  
  console.log('ðŸ“¤ Uploading file:', {
    name: file.name,
    size: file.size,
    type: file.type,
    fileName: fileName
  });
  
  // Upload with explicit content type
  const { data, error } = await supabase.storage
    .from('audio-files')
    .upload(fileName, file, {
      contentType: file.type || 'audio/mpeg',
      cacheControl: '3600',
      upsert: false
    });
  
  if (error) {
    console.error('âŒ Upload error:', error);
    alert('Upload failed! Error: ' + error.message + '\n\nMake sure the "audio-files" bucket exists and is PUBLIC in Supabase Storage settings.');
    return null;
  }
  
  // Get public URL
  const { data: urlData } = supabase.storage
    .from('audio-files')
    .getPublicUrl(fileName);
  
  const publicUrl = urlData.publicUrl;
  console.log('âœ… File uploaded. Public URL:', publicUrl);
  
  // Verify the uploaded file is actually accessible and valid
  try {
    const testAudio = new Audio();
    testAudio.src = publicUrl;
    
    await new Promise((resolve, reject) => {
      testAudio.addEventListener('loadedmetadata', () => {
        console.log('âœ… Upload verified - duration:', testAudio.duration);
        resolve();
      });
      testAudio.addEventListener('error', (e) => {
        console.error('âŒ Uploaded file cannot be played!', e);
        reject(new Error('File uploaded but cannot be played - may be corrupted'));
      });
      
      // Timeout after 10 seconds
      setTimeout(() => reject(new Error('Timeout loading uploaded file')), 10000);
    });
    
  } catch (e) {
    console.error('âš ï¸ Upload verification failed:', e);
    alert('WARNING: File uploaded but may be corrupted!\n\n' + e.message + '\n\nTry re-uploading or use a different file.');
    // Still return the URL even if verification fails
  }
  
  return publicUrl;
}

// Save track metadata to database
async function saveTrackToCloud(trackData) {
  if (!currentUser) return;
  
  const { data, error } = await supabase
    .from('tracks')
    .insert({
      user_id: currentUser.id,
      title: trackData.title,
      artist: trackData.artist,
      album: trackData.album,
      audio_url: trackData.audioUrl,
      album_art: trackData.albumArt,
      duration: trackData.duration,
      filename: trackData.filename
    })
    .select();
  
  if (error) {
    console.error('Save error:', error);
  }
  
  return data;
}

// Load tracks from cloud
async function loadCloudData() {
  if (!currentUser) {
    console.log('âŒ loadCloudData: No user logged in');
    return;
  }
  
  console.log('ðŸ”„ Loading cloud data for user:', currentUser.id);
  
  // Load user profile first
  try {
    const { data: profileData, error: profileError } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', currentUser.id)
      .single();
    
    if (!profileError && profileData) {
      console.log('ðŸ“‹ Profile data loaded:', profileData);
      
      // Update profile display
      const usernameEl = document.querySelector('.profile-username');
      if (usernameEl) {
        usernameEl.textContent = '@' + profileData.username;
      }
      
      const displayNameEl = document.getElementById('profileUsername');
      if (displayNameEl && profileData.display_name) {
        displayNameEl.textContent = profileData.display_name;
        
        // Also update the settings input field if it exists
        const displayNameInput = document.getElementById('displayName');
        if (displayNameInput) {
          displayNameInput.value = profileData.display_name;
        }
      }
      
      // Update bio if it exists
      if (profileData.bio) {
        const bioEl = document.getElementById('profileBio');
        const bioInput = document.getElementById('bioInput');
        if (bioEl) bioEl.textContent = profileData.bio;
        if (bioInput) bioInput.value = profileData.bio;
      }
      
      console.log('=== LOADING USER PROFILE DATA ===');
      console.log('Background color from DB:', profileData.background_color);
      console.log('Profile picture from DB:', profileData.profile_picture);
      
      // Load background color from database (SITE background, not profile)
      if (profileData.background_color) {
        console.log('âœ… Storing site background color:', profileData.background_color);
        profileBackground = profileData.background_color;
        currentSiteBackgroundColor = profileData.background_color;
        
        // CRITICAL: Don't touch background if it's locked (viewing someone's profile)
        if (window.profileBackgroundLocked) {
          console.log('ðŸ”’ Background locked - skipping all background changes');
        } else {
          // Only apply to document.body if NOT on ANY profile screen
          const onProfileScreen = document.getElementById('profileScreen')?.classList.contains('active');
          if (!onProfileScreen) {
            console.log('âœ… Applying site background (not on profile)');
            document.body.style.backgroundColor = profileData.background_color;
            document.body.style.backgroundSize = '';
            document.body.style.backgroundPosition = '';
            document.body.style.backgroundAttachment = '';
            document.body.style.backgroundImage = '';
          } else {
            console.log('â­ï¸ Skipping site background (on profile screen - own or viewing)');
          }
          
          // Only update theme if not viewing someone else's profile
          if (!viewingUserId) {
            generateCompleteTheme(profileData.background_color);
          }
        }
        
        // Update color picker if it exists
        const picker = document.getElementById('customColorPicker');
        if (picker) picker.value = profileData.background_color;
        
        // Update color selection
        updateColorSelection();
        
        saveData(); // Save to localStorage too
        
        console.log('âœ… Site background color loaded');
      } else {
        console.log('âš ï¸ No background color in database, using default');
      }
      
      // Load profile picture from database
      if (profileData.profile_picture && profileData.profile_picture !== 'ML') {
        console.log('âœ… Setting profile picture:', profileData.profile_picture);
        profilePicture = profileData.profile_picture;
        updateHeaderAvatar();
        applyProfileStyles();
        
        // Save to localStorage to preserve it
        saveData();
        
        // Cache for track display
        userProfilesCache[currentUser.id] = {
          username: profileData.username,
          display_name: profileData.display_name,
          profile_picture: profileData.profile_picture
        };
        
        // Re-render tracks to show updated profile picture
        console.log('âœ… Profile picture loaded, re-rendering tracks');
        renderPopularTracks();
      }
      
      // Load banner from database (can be image URL, base64, or color)
      if (profileData.banner_color) {
        console.log('âœ… Loading banner from database');
        
        if (profileData.banner_color.startsWith('data:image')) {
          // It's base64 image
          profileBanner = 'url(' + profileData.banner_color + ')';
        } else if (profileData.banner_color.startsWith('http')) {
          // It's a URL
          profileBanner = 'url(' + profileData.banner_color + ')';
        } else {
          // It's a color
          profileBanner = profileData.banner_color;
        }
        
        applyProfileStyles(); // Apply banner
        saveData(); // Save to localStorage
        
        console.log('âœ… Banner loaded');
      }
      
      // CRITICAL: Store profile background/color in global variables
      // DO NOT apply to document.body here - only apply when viewing profile!
      if (profileData.profile_background_image) {
        console.log('âœ… Storing profile background image');
        window.userProfileBackgroundImage = profileData.profile_background_image;
      }
      
      if (profileData.profile_color && profileData.profile_color.startsWith('#')) {
        console.log('âœ… Storing profile color:', profileData.profile_color);
        window.userProfileColor = profileData.profile_color;
      }
    }
  } catch (err) {
    console.warn('Could not load profile:', err);
  }
  
  // Test: Check if we can access the tracks table
  try {
    const { data, error } = await supabase
      .from('tracks')
      .select('*')
      .eq('user_id', currentUser.id);
    
    console.log('Raw Supabase response:', { data, error });
    
    if (error) {
      console.error('âŒ Error loading cloud data:', error);
      console.error('Error details:', {
        message: error.message,
        details: error.details,
        hint: error.hint,
        code: error.code
      });
      
      // Log error but don't interrupt user
      console.error('âš ï¸ Database not set up. Please check Supabase setup.');
      return;
    }
    
    if (data) {
      console.log('âœ… Cloud data loaded:', data.length, 'tracks');
      console.log('Raw cloud data:', data);
      
      if (data.length === 0) {
        console.warn('âš ï¸ No tracks found in database for this user');
      }
      
      // Convert cloud data to local format
      allUserTracks = data.map(track => {
        let audioUrl = track.audio_url;
        
        // FIX: Convert expired signed URLs to public URLs
        if (audioUrl && audioUrl.includes('/sign/')) {
          // Extract the file path from signed URL
          // Format: .../sign/audio-files/USER_ID/TIMESTAMP.mp3?token=...
          const match = audioUrl.match(/\/sign\/(audio-files\/.+?)\?/);
          if (match) {
            const filePath = match[1];
            // Convert to public URL
            const { data: urlData } = supabase.storage
              .from('audio-files')
              .getPublicUrl(filePath.replace('audio-files/', ''));
            audioUrl = urlData.publicUrl;
            console.log('ðŸ”„ Converted signed URL to public:', audioUrl);
          }
        }
        
        return {
          id: track.id,
          title: track.title,
          artist: track.artist,
          album: track.album,
          albumArt: track.album_art,
          audioData: audioUrl,
          dataUrl: audioUrl,
          duration: track.duration,
          filename: track.filename,
          userId: track.user_id,
          isPlaying: false
        };
      });
      
      tracks = [...allUserTracks];
      console.log('âœ… Tracks arrays populated. tracks:', tracks.length, 'allUserTracks:', allUserTracks.length);
      
      updateStats();
      renderLibrary();
      renderPopularTracks();
      renderRecentUploads();
      
      console.log('âœ… Render functions called after cloud data load');
    }
  } catch (err) {
    console.error('âŒ Exception in loadCloudData:', err);
    // Silent fail - error logged
  }
}

// Load ALL public tracks for the social feed/trending page
async function loadPublicTracks() {
  console.log('ðŸŒ Loading all public tracks...');
  
  try {
    // Fetch ALL tracks from database (not just current user)
    const { data, error } = await supabase
      .from('tracks')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(100); // Load latest 100 tracks
    
    console.log('ðŸ“¦ Public tracks response:', { data, error });
    
    if (error) {
      console.error('âŒ Error loading public tracks:', error);
      console.error('Error details:', {
        message: error.message,
        details: error.details,
        hint: error.hint,
        code: error.code
      });
      
      // If error is RLS related, show helpful message
      if (error.code === '42501' || error.message.includes('policy')) {
        console.error('âš ï¸ RLS POLICY ERROR: Tracks table needs public read policy!');
        console.error('Run FIX_PUBLIC_TRACKS.sql to enable public viewing');
      }
      
      window.publicTracks = [];
      return;
    }
    
    if (data && data.length > 0) {
      console.log('âœ… Loaded', data.length, 'public tracks');
      console.log('Sample track:', data[0]);
      
      // Create a global public tracks array
      window.publicTracks = data.map(track => ({
        id: track.id,
        title: track.title,
        artist: track.artist,
        album: track.album,
        albumArt: track.album_art,
        audioData: track.audio_url,
        dataUrl: track.audio_url,
        duration: track.duration,
        filename: track.filename,
        userId: track.user_id,
        isPlaying: false
      }));
      
      console.log('âœ… window.publicTracks populated with', window.publicTracks.length, 'tracks');
      
      // Render public tracks on home page
      renderPopularTracks();
      
      // Preload signed URLs for instant playback
      setTimeout(() => {
        preloadTrackUrls(window.publicTracks);
      }, 1000); // Delay by 1 second to not block initial page load
    } else {
      console.log('â„¹ï¸ No public tracks found in database');
      window.publicTracks = [];
    }
  } catch (err) {
    console.error('âŒ Error loading public tracks:', err);
    window.publicTracks = [];
  }
}

// Delete track from cloud
async function deleteTrackFromCloud(trackId) {
  if (!currentUser) return;
  
  const { error } = await supabase
    .from('tracks')
    .delete()
    .eq('id', trackId)
    .eq('user_id', currentUser.id);
  
  if (error) {
    console.error('Delete error:', error);
  }
}

// Initialize auth check on page load
window.addEventListener('load', () => {
  console.log('=== PAGE LOADED ===');
  
  // Attach login button click handler
  const loginBtn = document.getElementById('loginBtn');
  console.log('Login button found:', loginBtn);
  if (loginBtn) {
    loginBtn.addEventListener('click', () => {
      console.log('LOGIN BUTTON CLICKED!');
      openAuthModal();
    });
    console.log('Login button click listener attached');
  } else {
    console.error('Login button NOT FOUND!');
  }
  
  // Attach modal close button
  const closeBtn = document.getElementById('authModalCloseBtn');
  console.log('Close button found:', closeBtn);
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      console.log('CLOSE BUTTON CLICKED!');
      closeAuthModal();
    });
  }
  
  // Attach tab switching
  const authTabs = document.querySelectorAll('.auth-tab');
  console.log('Auth tabs found:', authTabs.length);
  authTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      console.log('TAB CLICKED:', tab.dataset.tab);
      switchAuthTab(tab.dataset.tab);
    });
  });
  
  // Attach login submit button
  const loginSubmitBtn = document.getElementById('loginSubmitBtn');
  console.log('Login submit button found:', loginSubmitBtn);
  if (loginSubmitBtn) {
    loginSubmitBtn.addEventListener('click', () => {
      console.log('LOGIN SUBMIT CLICKED!');
      handleLogin();
    });
  }
  
  // Attach signup submit button
  const signupSubmitBtn = document.getElementById('signupSubmitBtn');
  console.log('Signup submit button found:', signupSubmitBtn);
  if (signupSubmitBtn) {
    signupSubmitBtn.addEventListener('click', () => {
      console.log('SIGNUP SUBMIT CLICKED!');
      handleSignup();
    });
  }
  
  console.log('=== CHECKING AUTH ===');
  // Check authentication
  checkAuth();
});

// OVERRIDE handleFiles with cloud upload version
async function handleFiles(files) {
  // Check if user is logged in
  if (!currentUser) {
    openAuthModal();
    return;
  }
  
  const audioFiles = Array.from(files).filter(e => /audio\//.test(e.type) || /\.(mp3|m4a)$/i.test(e.name));
  if (audioFiles.length === 0) return;
  
  document.getElementById('uploadProgress').classList.add('show');
  
  for (const file of audioFiles) {
    try {
      console.log('Uploading file:', file.name, 'Size:', file.size);
      
      // Upload to Supabase Storage
      const publicUrl = await uploadToCloud(file, null);
      
      if (publicUrl) {
        // Get audio duration
        const audio = new Audio();
        audio.src = publicUrl;
        
        await new Promise((resolve, reject) => {
          audio.onloadedmetadata = () => resolve();
          audio.onerror = () => reject(new Error('Could not load audio'));
        });
        
        const duration = audio.duration;
        
        // Save to Supabase database
        const trackData = {
          title: file.name.replace(/\.(mp3|m4a|mp4)$/i, ''),
          artist: 'Unknown Artist',
          album: 'Unknown Album',
          audioUrl: publicUrl,
          albumArt: null,
          duration: duration,
          filename: file.name
        };
        
        const savedTrack = await saveTrackToCloud(trackData);
        console.log('ðŸ’¾ saveTrackToCloud response:', savedTrack);
        
        if (savedTrack && savedTrack[0]) {
          const track = {
            id: savedTrack[0].id,
            title: savedTrack[0].title,
            artist: savedTrack[0].artist,
            album: savedTrack[0].album,
            albumArt: savedTrack[0].album_art,
            audioData: savedTrack[0].audio_url,
            dataUrl: savedTrack[0].audio_url,
            duration: savedTrack[0].duration,
            filename: savedTrack[0].filename,
            userId: currentUser.id, // Store owner ID
            isPlaying: false
          };
          
          tracks.push(track);
          allUserTracks.push(track);
          console.log('âœ… Track added to arrays:', track.title);
          console.log('Total tracks now:', tracks.length, 'All user tracks:', allUserTracks.length);
        } else {
          console.error('Failed to save track to cloud:', savedTrack);
        }
      }
    } catch (error) {
      console.error('Upload error:', error);
      // Silent fail - error logged to console
    }
  }
  
  document.getElementById('uploadProgress').classList.remove('show');
  
  console.log('ðŸ”„ Reloading all cloud data after upload...');
  // Reload from cloud to ensure everything is in sync
  await loadCloudData();
  
  // Reload public tracks so new upload appears in everyone's feed
  await loadPublicTracks();
  
  // Show in-page success message instead of browser alert
  if (audioFiles.length > 0) {
    const uploadArea = document.getElementById('uploadArea');
    const successMsg = document.createElement('div');
    successMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(34,197,94,0.95);color:white;padding:2rem 3rem;border-radius:12px;font-size:1.2rem;font-weight:600;z-index:10000;box-shadow:0 10px 40px rgba(0,0,0,0.3);backdrop-filter:blur(10px);';
    successMsg.innerHTML = `âœ… Successfully uploaded ${audioFiles.length} song(s)!<br><small style="font-size:0.9rem;opacity:0.9;margin-top:0.5rem;display:block;">Check your Library or scroll down to see them</small>`;
    document.body.appendChild(successMsg);
    
    setTimeout(() => {
      successMsg.remove();
    }, 3000);
  }
  
  if (audioFiles.length === 1 && allUserTracks.length > 0) {
    openEditTrack(allUserTracks[allUserTracks.length - 1].id);
  }
  
  // Scroll to recently uploaded section to show the new tracks
  const uploadedSection = document.getElementById('uploadedTracks');
  if (uploadedSection && uploadedSection.style.display !== 'none') {
    uploadedSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

console.log('âœ… All scripts loaded successfully');

// ============================================
// SEARCH SYSTEM
// ============================================

let currentSearchTab = 'songs';
let currentSearchQuery = '';

// Switch search tab
function switchSearchTab(tab) {
  currentSearchTab = tab;
  
  // Update tab styling
  document.querySelectorAll('.search-tab').forEach(t => {
    t.classList.remove('active');
    t.style.color = 'var(--text-secondary)';
    t.style.borderBottomColor = 'transparent';
  });
  
  const activeTab = document.getElementById('searchTab' + tab.charAt(0).toUpperCase() + tab.slice(1));
  activeTab.classList.add('active');
  activeTab.style.color = 'var(--accent)';
  activeTab.style.borderBottomColor = 'var(--accent)';
  
  // Re-run search with current query
  if (currentSearchQuery) {
    performSearch(currentSearchQuery);
  }
}

// Perform search based on current tab
async function performSearch(query) {
  currentSearchQuery = query.toLowerCase().trim();
  
  const emptyState = document.getElementById('searchEmptyState');
  const noResults = document.getElementById('searchNoResults');
  const songsResults = document.getElementById('searchSongsResults');
  const artistsResults = document.getElementById('searchArtistsResults');
  const usersResults = document.getElementById('searchUsersResults');
  
  // Hide all
  emptyState.style.display = 'none';
  noResults.style.display = 'none';
  songsResults.style.display = 'none';
  artistsResults.style.display = 'none';
  usersResults.style.display = 'none';
  
  if (!currentSearchQuery) {
    emptyState.style.display = 'block';
    return;
  }
  
  if (currentSearchTab === 'songs') {
    searchSongs(currentSearchQuery);
  } else if (currentSearchTab === 'artists') {
    searchArtists(currentSearchQuery);
  } else if (currentSearchTab === 'users') {
    searchUsers(currentSearchQuery);
  }
}

// Search for songs
function searchSongs(query) {
  const songsResults = document.getElementById('searchSongsResults');
  const noResults = document.getElementById('searchNoResults');
  
  // Search in all public tracks
  const allTracks = window.publicTracks || [];
  const results = allTracks.filter(track => 
    track.title.toLowerCase().includes(query) ||
    track.artist.toLowerCase().includes(query) ||
    track.album.toLowerCase().includes(query)
  );
  
  if (results.length === 0) {
    noResults.style.display = 'block';
    return;
  }
  
  songsResults.style.display = 'block';
  songsResults.innerHTML = `
    <h2 style="font-size:1.5rem;font-weight:700;margin-bottom:1.5rem">
      Songs <span style="color:var(--text-secondary);font-weight:400">(${results.length})</span>
    </h2>
    ${results.map((track, index) => {
      const uploaderProfile = track.userId ? userProfilesCache[track.userId] : null;
      const uploaderPic = uploaderProfile?.profile_picture;
      const uploaderName = uploaderProfile?.display_name || 'Unknown User';
      const uploaderInitials = uploaderName.substring(0, 2).toUpperCase();
      
      return `
        <div style="display:flex;align-items:center;gap:1rem;margin-bottom:0.5rem">
          ${uploaderPic 
            ? `<div class="uploader-avatar" onclick="viewUserProfile('${track.userId}')" style="width:40px;height:40px;border-radius:50%;background-image:url(${uploaderPic});background-size:cover;background-position:center;cursor:pointer;border:2px solid rgba(255,255,255,0.2);flex-shrink:0;transition:all 0.3s;box-shadow:0 2px 8px rgba(0,0,0,0.3)" onmouseover="this.style.transform='scale(1.15)';this.style.borderColor='var(--accent)';this.style.boxShadow='0 0 20px var(--accent)'" onmouseout="this.style.transform='scale(1)';this.style.borderColor='rgba(255,255,255,0.2)';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.3)'" title="${uploaderName}"></div>`
            : `<div class="uploader-avatar" onclick="viewUserProfile('${track.userId}')" style="width:40px;height:40px;border-radius:50%;background:linear-gradient(135deg, var(--accent), var(--accent-light));display:flex;align-items:center;justify-content:center;font-size:0.8rem;font-weight:700;cursor:pointer;border:2px solid rgba(255,255,255,0.2);flex-shrink:0;transition:all 0.3s;box-shadow:0 2px 8px rgba(0,0,0,0.3);color:#fff" onmouseover="this.style.transform='scale(1.15)';this.style.borderColor='var(--accent)';this.style.boxShadow='0 0 20px var(--accent)'" onmouseout="this.style.transform='scale(1)';this.style.borderColor='rgba(255,255,255,0.2)';this.style.boxShadow='0 2px 8px rgba(0,0,0,0.3)'" title="${uploaderName}">${uploaderInitials}</div>`
          }
          <div class="track" style="flex:1">
            <div class="track-content">
              <div class="track-number">${track.isPlaying ? 'â™ª' : index + 1}</div>
              ${track.albumArt 
                ? `<div class="track-art" style="background-image:url(${track.albumArt})"></div>`
                : '<div class="track-art">â™ª</div>'
              }
              <button class="play-btn" onclick="togglePlay('${track.id}')">${track.isPlaying ? 'â¸' : 'â–¶'}</button>
              <div class="track-info">
                <div class="track-title">${highlightMatch(track.title, query)}</div>
                <div class="track-artist">${highlightMatch(track.artist, query)} â€¢ ${highlightMatch(track.album, query)}</div>
                <div class="track-duration">${formatDuration(track.duration)}</div>
              </div>
              <div class="track-actions">
                <button class="track-menu-btn" onclick="toggleTrackMenu('search-${track.id}', event)">â‹¯</button>
                <div id="track-menu-search-${track.id}" class="track-dropdown">
                  <div class="track-dropdown-item" onclick="togglePlay('${track.id}')">Play</div>
                  <div class="track-dropdown-item" onclick="downloadTrack('${track.id}')">Download</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }).join('')}
  `;
}

// Search for artists
function searchArtists(query) {
  const artistsResults = document.getElementById('searchArtistsResults');
  const noResults = document.getElementById('searchNoResults');
  
  // Get all unique artists from public tracks
  const allTracks = window.publicTracks || [];
  const artistsMap = new Map();
  
  allTracks.forEach(track => {
    const artistLower = track.artist.toLowerCase();
    if (artistLower.includes(query)) {
      if (!artistsMap.has(track.artist)) {
        artistsMap.set(track.artist, {
          name: track.artist,
          tracks: [],
          albumArt: track.albumArt
        });
      }
      artistsMap.get(track.artist).tracks.push(track);
    }
  });
  
  const results = Array.from(artistsMap.values());
  
  if (results.length === 0) {
    noResults.style.display = 'block';
    return;
  }
  
  artistsResults.style.display = 'block';
  artistsResults.innerHTML = `
    <h2 style="font-size:1.5rem;font-weight:700;margin-bottom:1.5rem">
      Artists <span style="color:var(--text-secondary);font-weight:400">(${results.length})</span>
    </h2>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1.5rem">
      ${results.map(artist => `
        <div class="artist-card" style="background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 15%),0.6);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:1rem;cursor:pointer;transition:all .3s;box-shadow:0 4px 12px rgba(0,0,0,0.3);backdrop-filter:blur(10px);text-align:center" onmouseover="this.style.transform='translateY(-4px)';this.style.boxShadow='0 0 0 1px var(--accent), 0 8px 24px rgba(0,0,0,0.5)'" onmouseout="this.style.transform='';this.style.boxShadow='0 4px 12px rgba(0,0,0,0.3)'">
          <div style="width:120px;height:120px;margin:0 auto 1rem;border-radius:50%;background:${artist.albumArt ? `url(${artist.albumArt})` : 'linear-gradient(135deg, var(--accent), var(--accent-light))'};background-size:cover;background-position:center;display:flex;align-items:center;justify-content:center;font-size:3rem;border:3px solid rgba(255,255,255,0.1);box-shadow:0 4px 12px rgba(0,0,0,0.3)">
            ${!artist.albumArt ? 'ðŸŽ¤' : ''}
          </div>
          <h3 style="font-size:1rem;font-weight:700;margin-bottom:0.25rem">${highlightMatch(artist.name, query)}</h3>
          <p style="color:var(--text-secondary);font-size:0.875rem">${artist.tracks.length} song${artist.tracks.length !== 1 ? 's' : ''}</p>
        </div>
      `).join('')}
    </div>
  `;
}

// Search for users
async function searchUsers(query) {
  const usersResults = document.getElementById('searchUsersResults');
  const noResults = document.getElementById('searchNoResults');
  
  if (!supabase) {
    noResults.style.display = 'block';
    return;
  }
  
  try {
    // Search in profiles table - Firefox-compatible query
    const { data, error } = await supabase
      .from('profiles')
      .select('*')
      .or('username.ilike.%' + query + '%,display_name.ilike.%' + query + '%')
      .limit(20);
    
    if (error) {
      console.error('User search error:', error);
      throw error;
    }
    
    if (!data || data.length === 0) {
      noResults.style.display = 'block';
      usersResults.style.display = 'none';
      return;
    }
    
    // Check follow status for each user if logged in
    let followedUsers = new Set();
    if (currentUser) {
      const userIds = data.map(function(u) { return u.id; });
      const { data: followData } = await supabase
        .from('follows')
        .select('following_id')
        .eq('follower_id', currentUser.id)
        .in('following_id', userIds);
      
      if (followData) {
        followedUsers = new Set(followData.map(function(f) { return f.following_id; }));
      }
    }
    
    noResults.style.display = 'none';
    usersResults.style.display = 'block';
    
    // Build HTML string for better Firefox compatibility
    let userCardsHTML = '';
    for (let i = 0; i < data.length; i++) {
      const user = data[i];
      const isFollowing = followedUsers.has(user.id);
      const isSelf = currentUser && user.id === currentUser.id;
      const displayName = user.display_name || user.username || '?';
      const initials = displayName.substring(0, 2).toUpperCase();
      const hasProfilePic = user.profile_picture && user.profile_picture !== '' && user.profile_picture !== 'ML';
      
      userCardsHTML += '<div class="user-card" style="background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 15%),0.6);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:1.5rem;transition:all .3s;box-shadow:0 4px 12px rgba(0,0,0,0.3);backdrop-filter:blur(10px);text-align:center">';
      userCardsHTML += '<div onclick="viewUserProfile(\'' + user.id + '\')" style="cursor:pointer">';
      
      // Profile picture div with explicit background properties
      if (hasProfilePic) {
        // Use the raw base64 data directly
        userCardsHTML += '<div style="width:80px;height:80px;margin:0 auto 1rem;border-radius:50%;background-image:url(\'' + user.profile_picture + '\');background-size:cover;background-position:center;background-repeat:no-repeat;border:3px solid rgba(255,255,255,0.1);box-shadow:0 4px 12px rgba(0,0,0,0.3)"></div>';
      } else {
        userCardsHTML += '<div style="width:80px;height:80px;margin:0 auto 1rem;border-radius:50%;background:linear-gradient(135deg, var(--accent), var(--accent-light));display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700;border:3px solid rgba(255,255,255,0.1);box-shadow:0 4px 12px rgba(0,0,0,0.3);color:#fff">' + initials + '</div>';
      }
      
      userCardsHTML += '<h3 style="font-size:1rem;font-weight:700;margin-bottom:0.25rem">' + highlightMatch(displayName, query) + '</h3>';
      userCardsHTML += '<p style="color:var(--text-secondary);font-size:0.875rem;margin-bottom:1rem">@' + user.username + '</p>';
      userCardsHTML += '</div>';
      
      if (!isSelf) {
        const btnStyle = isFollowing ? 'background:rgba(255,255,255,0.1);color:var(--text-primary)' : '';
        const btnText = isFollowing ? 'Following' : 'Follow';
        userCardsHTML += '<button id="followBtn_' + user.id + '" onclick="event.stopPropagation();toggleFollow(\'' + user.id + '\')" class="btn btn-primary" style="width:100%;padding:0.5rem 1rem;font-size:0.875rem;' + btnStyle + '">';
        userCardsHTML += btnText;
        userCardsHTML += '</button>';
      }
      
      userCardsHTML += '</div>';
    }
    
    usersResults.innerHTML = '<h2 style="font-size:1.5rem;font-weight:700;margin-bottom:1.5rem">Users <span style="color:var(--text-secondary);font-weight:400">(' + data.length + ')</span></h2><div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1.5rem">' + userCardsHTML + '</div>';
    
  } catch (err) {
    console.error('Error searching users:', err);
    noResults.style.display = 'block';
    usersResults.style.display = 'none';
  }
}

// Toggle follow/unfollow user
async function toggleFollow(userId) {
  if (!currentUser) {
    alert('Please login to follow users');
    return;
  }
  
  if (userId === currentUser.id) {
    alert("You can't follow yourself!");
    return;
  }
  
  const btn = document.getElementById(`followBtn_${userId}`);
  if (!btn) return;
  
  const isFollowing = btn.textContent.trim() === 'Following';
  
  try {
    if (isFollowing) {
      // Unfollow
      const { error } = await supabase
        .from('follows')
        .delete()
        .eq('follower_id', currentUser.id)
        .eq('following_id', userId);
      
      if (error) throw error;
      
      btn.textContent = 'Follow';
      btn.style.background = 'var(--accent)';
      btn.style.color = '#fff';
      btn.onmouseover = null;
      btn.onmouseout = null;
    } else {
      // Follow
      const { error } = await supabase
        .from('follows')
        .insert({
          follower_id: currentUser.id,
          following_id: userId,
          created_at: new Date().toISOString()
        });
      
      if (error) throw error;
      
      // Create notification for the followed user
      await supabase.from('notifications').insert({
        user_id: userId,
        type: 'follow',
        message: 'started following you',
        from_user_id: currentUser.id,
        created_at: new Date().toISOString()
      });
      
      btn.textContent = 'Following';
      btn.style.background = 'rgba(255,255,255,0.1)';
      btn.style.color = 'var(--text-primary)';
      // Add hover effect to show it's clickable and will unfollow
      btn.onmouseover = function() {
        this.textContent = 'Unfollow';
        this.style.background = 'rgba(255,59,48,0.2)';
        this.style.borderColor = '#ff3b30';
        this.style.color = '#ff3b30';
      };
      btn.onmouseout = function() {
        this.textContent = 'Following';
        this.style.background = 'rgba(255,255,255,0.1)';
        this.style.borderColor = '';
        this.style.color = 'var(--text-primary)';
      };
    }
  } catch (err) {
    console.error('Error toggling follow:', err);
    alert('Error updating follow status. Please try again.');
  }
}

// Load followers list
async function loadFollowers(userId) {
  // Use provided userId or default to currentUser
  const targetUserId = userId || (currentUser ? currentUser.id : null);
  if (!targetUserId) return;
  
  const followersList = document.getElementById('profileFollowersList');
  const followersEmpty = document.getElementById('profileFollowersEmpty');
  const followersCount = document.getElementById('followersCount');
  
  try {
    // Get all users who follow the target user
    const { data, error } = await supabase
      .from('follows')
      .select('follower_id, profiles!follows_follower_id_fkey(id, username, display_name, profile_picture)')
      .eq('following_id', targetUserId);
    
    if (error) throw error;
    
    // Update count
    followersCount.textContent = data.length + ' Follower' + (data.length !== 1 ? 's' : '');
    
    if (!data || data.length === 0) {
      followersList.innerHTML = '';
      followersEmpty.style.display = 'block';
      return;
    }
    
    followersEmpty.style.display = 'none';
    
    // Render followers
    let html = '';
    for (let i = 0; i < data.length; i++) {
      const follower = data[i].profiles;
      if (!follower) continue;
      
      const displayName = follower.display_name || follower.username;
      const avatar = follower.profile_picture || '';
      
      html += '<div class="user-card" style="background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 15%),0.6);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:1.5rem;text-align:center">';
      html += '<div onclick="viewUserProfile(\'' + follower.id + '\')" style="cursor:pointer">';
      
      if (avatar) {
        html += '<div style="width:80px;height:80px;margin:0 auto 1rem;border-radius:50%;background:url(\'' + avatar + '\');background-size:cover;background-position:center"></div>';
      } else {
        html += '<div style="width:80px;height:80px;margin:0 auto 1rem;border-radius:50%;background:linear-gradient(135deg, var(--accent), var(--accent-light));display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.5rem;font-weight:700">' + displayName.substring(0,2).toUpperCase() + '</div>';
      }
      
      html += '<h3 style="font-size:1rem;font-weight:700;margin-bottom:0.25rem">' + displayName + '</h3>';
      html += '<p style="color:var(--text-secondary);font-size:0.875rem">@' + follower.username + '</p>';
      html += '</div></div>';
    }
    
    followersList.innerHTML = html;
  } catch (err) {
    console.error('Error loading followers:', err);
    followersEmpty.style.display = 'block';
    followersList.innerHTML = '';
  }
}

// Load following list
async function loadFollowing(userId) {
  // Use provided userId or default to currentUser
  const targetUserId = userId || (currentUser ? currentUser.id : null);
  if (!targetUserId) return;
  
  const followingList = document.getElementById('profileFollowingList');
  const followingEmpty = document.getElementById('profileFollowingEmpty');
  const followingCount = document.getElementById('followingCount');
  
  try {
    // Get all users that the target user follows
    const { data, error } = await supabase
      .from('follows')
      .select('following_id, profiles!follows_following_id_fkey(id, username, display_name, profile_picture)')
      .eq('follower_id', targetUserId);
    
    if (error) throw error;
    
    // Update count
    followingCount.textContent = data.length + ' Following';
    
    if (!data || data.length === 0) {
      followingList.innerHTML = '';
      followingEmpty.style.display = 'block';
      return;
    }
    
    followingEmpty.style.display = 'none';
    
    // Render following
    let html = '';
    for (let i = 0; i < data.length; i++) {
      const following = data[i].profiles;
      if (!following) continue;
      
      const displayName = following.display_name || following.username;
      const avatar = following.profile_picture || '';
      
      html += '<div class="user-card" style="background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 15%),0.6);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:1.5rem;text-align:center">';
      html += '<div onclick="viewUserProfile(\'' + following.id + '\')" style="cursor:pointer">';
      
      if (avatar) {
        html += '<div style="width:80px;height:80px;margin:0 auto 1rem;border-radius:50%;background:url(\'' + avatar + '\');background-size:cover;background-position:center"></div>';
      } else {
        html += '<div style="width:80px;height:80px;margin:0 auto 1rem;border-radius:50%;background:linear-gradient(135deg, var(--accent), var(--accent-light));display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.5rem;font-weight:700">' + displayName.substring(0,2).toUpperCase() + '</div>';
      }
      
      html += '<h3 style="font-size:1rem;font-weight:700;margin-bottom:0.25rem">' + displayName + '</h3>';
      html += '<p style="color:var(--text-secondary);font-size:0.875rem">@' + following.username + '</p>';
      html += '</div>';
      
      // Add unfollow button
      html += '<button onclick="event.stopPropagation();toggleFollowFromProfile(\'' + following.id + '\')" class="btn btn-primary" style="width:100%;padding:0.5rem;font-size:0.875rem;margin-top:1rem;background:rgba(255,255,255,0.1)">Following</button>';
      html += '</div>';
    }
    
    followingList.innerHTML = html;
  } catch (err) {
    console.error('Error loading following:', err);
    followingEmpty.style.display = 'block';
    followingList.innerHTML = '';
  }
}

// Load tracks for a specific user
async function loadUserTracks(userId) {
  const targetUserId = userId || (currentUser ? currentUser.id : null);
  if (!targetUserId) return;
  
  const tracksSection = document.getElementById('profileTracksSection');
  
  if (userId && userId !== currentUser.id) {
    // Viewing someone else - show placeholder
    tracksSection.innerHTML = '<div style="text-align:center;padding:4rem 2rem;color:var(--text-secondary)"><div style="font-size:3rem;margin-bottom:1rem">ðŸŽµ</div><h3 style="font-size:1.5rem;margin-bottom:0.5rem;color:var(--text-primary)">User Tracks</h3><p>Public track viewing coming soon!</p></div>';
  } else {
    // Viewing own profile - use existing renderProfile
    renderProfile();
  }
}

// Load playlists for a specific user
async function loadUserPlaylists(userId) {
  const targetUserId = userId || (currentUser ? currentUser.id : null);
  if (!targetUserId) return;
  
  const playlistsSection = document.getElementById('profilePlaylistsSection');
  
  if (userId && userId !== currentUser.id) {
    // Viewing someone else - show placeholder
    playlistsSection.innerHTML = '<div style="text-align:center;padding:4rem 2rem;color:var(--text-secondary)"><div style="font-size:3rem;margin-bottom:1rem">ðŸ“</div><h3 style="font-size:1.5rem;margin-bottom:0.5rem;color:var(--text-primary)">User Playlists</h3><p>Public playlist viewing coming soon!</p></div>';
  } else {
    // Viewing own profile - use existing renderProfile
    renderProfile();
  }
}

// Load stats for a specific user
async function loadUserStats(userId) {
  const targetUserId = userId || (currentUser ? currentUser.id : null);
  if (!targetUserId) return;
  
  const statsSection = document.getElementById('profileStatsSection');
  
  if (userId && userId !== currentUser.id) {
    // Viewing someone else - show placeholder
    statsSection.innerHTML = '<div style="text-align:center;padding:4rem 2rem;color:var(--text-secondary)"><div style="font-size:3rem;margin-bottom:1rem">ðŸ“Š</div><h3 style="font-size:1.5rem;margin-bottom:0.5rem;color:var(--text-primary)">User Stats</h3><p>Public stats viewing coming soon!</p></div>';
  } else {
    // Viewing own profile - use existing renderProfile
    renderProfile();
  }
}

// Toggle follow from profile page (refreshes the list after)
async function toggleFollowFromProfile(userId) {
  if (!currentUser) return;
  
  try {
    // Unfollow
    const { error } = await supabase
      .from('follows')
      .delete()
      .eq('follower_id', currentUser.id)
      .eq('following_id', userId);
    
    if (error) throw error;
    
    // Reload the following list
    loadFollowing();
  } catch (err) {
    console.error('Error unfollowing:', err);
    alert('Error unfollowing user. Please try again.');
  }
}

// Highlight matching text in search results
function highlightMatch(text, query) {
  if (!query) return text;
  const regex = new RegExp(`(${query})`, 'gi');
  return text.replace(regex, '<span style="color:var(--accent);font-weight:700">$1</span>');
}

// View a user's profile (placeholder for future feature)
// Toggle follow from user profile page
async function toggleFollowOnProfile(userId) {
  if (!currentUser) {
    alert('Please login to follow users');
    return;
  }
  
  const btn = document.getElementById('userProfileFollowBtn');
  if (!btn) return;
  
  const isFollowing = btn.textContent.trim() === 'Following';
  
  try {
    if (isFollowing) {
      // Unfollow
      const { error } = await supabase
        .from('follows')
        .delete()
        .eq('follower_id', currentUser.id)
        .eq('following_id', userId);
      
      if (error) throw error;
      
      btn.textContent = 'Follow';
      btn.style.background = 'var(--accent)';
      btn.style.color = '#fff';
    } else {
      // Follow
      const { error } = await supabase
        .from('follows')
        .insert({
          follower_id: currentUser.id,
          following_id: userId,
          created_at: new Date().toISOString()
        });
      
      if (error) throw error;
      
      // Create notification
      await supabase.from('notifications').insert({
        user_id: userId,
        type: 'follow',
        message: 'started following you',
        from_user_id: currentUser.id,
        created_at: new Date().toISOString()
      });
      
      btn.textContent = 'Following';
      btn.style.background = 'rgba(255,255,255,0.1)';
      btn.style.color = 'var(--text-primary)';
    }
  } catch (err) {
    console.error('Error toggling follow:', err);
    alert('Error updating follow status');
  }
}

// Update search input to open search screen and perform search
document.getElementById('searchInput').addEventListener('focus', function() {
  showScreen('search');
});

document.getElementById('searchInput').addEventListener('input', function(e) {
  const query = e.target.value;
  performSearch(query);
});

// FINAL OVERRIDE - Must be at end to override minified code
// This ensures siteBackgroundColor, customGlowColor, and playlists are ALWAYS restored
setInterval(() => {
  // CRITICAL: Don't run this when on profile screen - it fights with profile backgrounds!
  const onProfileScreen = document.getElementById('profileScreen')?.classList.contains('active');
  if (onProfileScreen) {
    return; // Skip restoration when viewing profiles
  }
  
  const savedData = localStorage.getItem('basspace_data');
  if (!savedData) return;
  
  try {
    const data = JSON.parse(savedData);
    
    // Restore background color
    if (currentSiteBackgroundColor && currentSiteBackgroundColor !== '#050d1a') {
      const currentBg = document.body.style.backgroundColor;
      if (currentBg !== currentSiteBackgroundColor) {
        document.body.style.backgroundColor = currentSiteBackgroundColor;
        document.body.style.backgroundImage = '';
        document.body.style.backgroundSize = '';
        document.body.style.backgroundPosition = '';
        document.body.style.backgroundAttachment = '';
        console.log('ðŸ”§ Auto-restored site background color:', currentSiteBackgroundColor);
      }
    }
    
    // Restore custom glow color
    if (customGlowColor) {
      const currentAccent = document.documentElement.style.getPropertyValue('--accent');
      if (currentAccent !== customGlowColor) {
        const textColor = getContrastColor(customGlowColor);
        document.documentElement.style.setProperty('--accent', customGlowColor);
        document.documentElement.style.setProperty('--accent-text', textColor);
        const rgb = hexToRgb(customGlowColor);
        document.documentElement.style.setProperty('--accent-rgb', `${rgb.r},${rgb.g},${rgb.b}`);
        console.log('ðŸ”§ Auto-restored custom glow color:', customGlowColor);
      }
    }
    
    // Restore playlists if they got cleared (but user is still logged in)
    if (currentUser && data.playlists && data.playlists.length > 0 && playlists.length === 0) {
      playlists = data.playlists;
      console.log('ðŸ”§ Auto-restored playlists:', playlists.length);
    }
  } catch (e) {
    console.error('Auto-restore error:', e);
  }
}, 1000); // Check every second

// ============================================
// PLAYLIST CUSTOMIZATION SYSTEM
// ============================================

// Current playlist being customized
let currentCustomizingPlaylist = null;
let tempPlaylistBackground = null;
let tempPlaylistGlow = null;
let tempPlaylistBgImage = null;

// Open playlist customization modal
function openPlaylistCustomization(playlistId) {
  currentCustomizingPlaylist = playlistId;
  const playlist = playlists.find(p => p.id === playlistId);
  
  if (!playlist) return;
  
  tempPlaylistBackground = playlist.customBackground || null;
  tempPlaylistGlow = playlist.customGlow || null;
  tempPlaylistBgImage = playlist.customBgImage || null;
  
  document.getElementById('playlistCustomTitle').textContent = `Customize "${playlist.name}"`;
  updatePlaylistCustomPreview();
  document.getElementById('playlistCustomizationModal').classList.add('show');
}

// Close playlist customization modal
function closePlaylistCustomization() {
  document.getElementById('playlistCustomizationModal').classList.remove('show');
  currentCustomizingPlaylist = null;
  tempPlaylistBackground = null;
  tempPlaylistGlow = null;
  tempPlaylistBgImage = null;
}

// Set playlist background color
function setPlaylistBackground(color) {
  tempPlaylistBackground = color;
  tempPlaylistBgImage = null;
  updatePlaylistCustomPreview();
  updateColorSelection();
}

// Set playlist glow color
function setPlaylistGlow(color) {
  tempPlaylistGlow = color;
  updatePlaylistCustomPreview();
  updateGlowSelection();
}

// Handle background image upload
function handlePlaylistBgUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    tempPlaylistBgImage = e.target.result;
    tempPlaylistBackground = null;
    updatePlaylistCustomPreview();
  };
  reader.readAsDataURL(file);
}

// Remove playlist background
function removePlaylistBackground() {
  tempPlaylistBgImage = null;
  tempPlaylistBackground = null;
  updatePlaylistCustomPreview();
}

// Update preview in modal
function updatePlaylistCustomPreview() {
  const preview = document.getElementById('playlistBgPreview');
  
  if (tempPlaylistBgImage) {
    preview.style.backgroundImage = `url(${tempPlaylistBgImage})`;
    preview.innerHTML = '';
  } else if (tempPlaylistBackground) {
    preview.style.backgroundImage = 'none';
    preview.style.background = tempPlaylistBackground;
    preview.innerHTML = '';
  } else {
    preview.style.backgroundImage = 'none';
    preview.style.background = '';
    preview.innerHTML = `
      <div style="text-align:center;color:var(--text-secondary)">
        <div style="font-size:1rem;font-weight:600;margin-bottom:0.5rem;text-transform:uppercase;letter-spacing:1px">BACKGROUND IMAGE</div>
        <p>Click to upload</p>
      </div>
    `;
  }
  
  updateColorSelection();
  updateGlowSelection();
}

// Save playlist customization
function savePlaylistCustomization() {
  if (!currentCustomizingPlaylist) return;
  
  const playlist = playlists.find(p => p.id === currentCustomizingPlaylist);
  if (!playlist) return;
  
  playlist.customBackground = tempPlaylistBackground;
  playlist.customGlow = tempPlaylistGlow;
  playlist.customBgImage = tempPlaylistBgImage;
  
  saveData();
  
  if (window.currentViewingPlaylist === currentCustomizingPlaylist) {
    applyPlaylistCustomization(currentCustomizingPlaylist);
    renderPlaylistView();
  }
  
  closePlaylistCustomization();
  showSuccessToast('Playlist customization saved!');
}

// Reset playlist customization to default
function resetPlaylistCustomization() {
  if (!confirm('Reset this playlist to default appearance?')) return;
  
  if (!currentCustomizingPlaylist) return;
  
  const playlist = playlists.find(p => p.id === currentCustomizingPlaylist);
  if (!playlist) return;
  
  playlist.customBackground = null;
  playlist.customGlow = null;
  playlist.customBgImage = null;
  
  saveData();
  
  if (window.currentViewingPlaylist === currentCustomizingPlaylist) {
    restoreGlobalCustomization();
    renderPlaylistView();
  }
  
  closePlaylistCustomization();
  showSuccessToast('Playlist reset to default!');
}

// Apply playlist customization when viewing a playlist
function applyPlaylistCustomization(playlistId) {
  const playlist = playlists.find(p => p.id === playlistId);
  if (!playlist) return;
  
  if (playlist.customBgImage) {
    document.body.style.background = `url(${playlist.customBgImage})`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
    document.body.style.backgroundAttachment = 'fixed';
  } else if (playlist.customBackground) {
    document.body.style.background = playlist.customBackground;
    document.body.style.backgroundSize = '';
    document.body.style.backgroundPosition = '';
    document.body.style.backgroundAttachment = '';
    generateCompleteTheme(playlist.customBackground);
  }
  
  if (playlist.customGlow) {
    const textColor = getContrastColor(playlist.customGlow);
    document.documentElement.style.setProperty('--accent', playlist.customGlow);
    document.documentElement.style.setProperty('--accent-text', textColor);
    const rgb = hexToRgb(playlist.customGlow);
    document.documentElement.style.setProperty('--accent-rgb', `${rgb.r},${rgb.g},${rgb.b}`);
  }
}

// Restore global customization
function restoreGlobalCustomization() {
  // PRIORITY 1: Site background color (highest priority - user's chosen site color)
  if (currentSiteBackgroundColor) {
    document.body.style.background = currentSiteBackgroundColor;
    document.body.style.backgroundSize = '';
    document.body.style.backgroundPosition = '';
    document.body.style.backgroundAttachment = '';
    generateCompleteTheme(currentSiteBackgroundColor);
    console.log('âœ… Restored site background color:', currentSiteBackgroundColor);
  }
  // PRIORITY 2: Only apply profileBackground if no siteBackgroundColor exists
  else if (profileBackground && profileBackground.startsWith('url')) {
    document.body.style.background = profileBackground;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundPosition = 'center';
    document.body.style.backgroundAttachment = 'fixed';
  } else if (profileBackground && !profileBackground.includes('gradient')) {
    document.body.style.background = profileBackground;
    generateCompleteTheme(profileBackground);
  }
  
  // Restore custom glow
  if (customGlowColor) {
    const textColor = getContrastColor(customGlowColor);
    document.documentElement.style.setProperty('--accent', customGlowColor);
    document.documentElement.style.setProperty('--accent-text', textColor);
    const rgb = hexToRgb(customGlowColor);
    document.documentElement.style.setProperty('--accent-rgb', `${rgb.r},${rgb.g},${rgb.b}`);
    console.log('âœ… Restored custom glow color:', customGlowColor);
  }
}

// Success toast notification
function showSuccessToast(message) {
  let toast = document.getElementById('successToast');
  if (!toast) {
    toast = document.createElement('div');
    toast.id = 'successToast';
    toast.style.cssText = `
      position: fixed;
      top: 2rem;
      right: 2rem;
      background: var(--accent);
      color: var(--accent-text, #fff);
      padding: 1rem 1.5rem;
      border-radius: 8px;
      font-weight: 600;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 10000;
      opacity: 0;
      transform: translateY(-20px);
      transition: all 0.3s;
    `;
    document.body.appendChild(toast);
  }
  
  toast.textContent = message;
  toast.style.opacity = '1';
  toast.style.transform = 'translateY(0)';
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateY(-20px)';
  }, 3000);
}

// Handle password reset from email link
window.addEventListener('load', async () => {
  // Check if this is a password reset redirect
  const hash = window.location.hash;
  
  if (hash && hash.includes('type=recovery')) {
    // User clicked reset password link from email
    console.log('ðŸ” Password reset link detected');
    
    // Get the access token from the URL
    const hashParams = new URLSearchParams(hash.substring(1));
    const accessToken = hashParams.get('access_token');
    
    if (accessToken) {
      // Show auth modal with reset password form
      document.getElementById('authModal').style.display = 'flex';
      document.getElementById('loginForm').style.display = 'none';
      document.getElementById('signupForm').style.display = 'none';
      document.getElementById('forgotPasswordForm').style.display = 'none';
      document.getElementById('resetPasswordForm').style.display = 'block';
      document.getElementById('authTabs').style.display = 'none';
      
      showAuthMessage('Please enter your new password below.', 'success');
    }
  }
});

// AGGRESSIVE BACKGROUND PROTECTION
// This forcefully maintains the background every 50ms when on profile screen
setInterval(() => {
  const profileScreen = document.getElementById('profileScreen');
  if (!profileScreen || !profileScreen.classList.contains('active')) {
    return; // Not on profile screen, do nothing
  }
  
  // Viewing someone else's profile
  if (viewingUserId && window.viewingUserProfileData) {
    const expectedBg = window.viewingUserProfileData.backgroundImage;
    const expectedColor = window.viewingUserProfileData.backgroundColor;
    
    // Ensure has-background class is present
    const profileScreen = document.getElementById('profileScreen');
    if (profileScreen && !profileScreen.classList.contains('has-background')) {
      profileScreen.classList.add('has-background');
      console.log('ðŸ›¡ï¸ Re-added has-background class for viewed user');
    }
    
    if (expectedBg) {
      const current = document.body.style.backgroundImage;
      if (!current || current === 'none' || current === '') {
        document.body.style.backgroundImage = expectedBg;
        document.body.style.backgroundSize = 'cover';
        document.body.style.backgroundPosition = 'center';
        document.body.style.backgroundAttachment = 'fixed';
        document.body.style.backgroundColor = '';
        console.log('ðŸ›¡ï¸ Restored viewed user profile background');
      }
    } else if (expectedColor) {
      const current = document.body.style.backgroundColor;
      if (current !== expectedColor) {
        document.body.style.backgroundImage = '';
        document.body.style.backgroundColor = expectedColor;
        console.log('ðŸ›¡ï¸ Restored viewed user profile color');
      }
    }
    return;
  }
  
  // Viewing OWN profile - force background to stay
  if (window.userProfileBackgroundImage) {
    const current = document.body.style.backgroundImage;
    const expected = `url("${window.userProfileBackgroundImage}")`;
    
    // Ensure has-background class is present
    const profileScreen = document.getElementById('profileScreen');
    if (profileScreen && !profileScreen.classList.contains('has-background')) {
      profileScreen.classList.add('has-background');
      console.log('ðŸ›¡ï¸ Re-added has-background class');
    }
    
    // If it's been cleared, restore it
    if (!current || current === 'none' || current === '' || !current.includes(window.userProfileBackgroundImage)) {
      document.body.style.backgroundImage = `url(${window.userProfileBackgroundImage})`;
      document.body.style.backgroundSize = 'cover';
      document.body.style.backgroundPosition = 'center';
      document.body.style.backgroundAttachment = 'fixed';
      document.body.style.backgroundColor = '';
      console.log('ðŸ›¡ï¸ Restored profile background image');
    }
  } else if (window.userProfileColor) {
    const current = document.body.style.backgroundColor;
    
    // Ensure has-background class is present
    const profileScreen = document.getElementById('profileScreen');
    if (profileScreen && !profileScreen.classList.contains('has-background')) {
      profileScreen.classList.add('has-background');
      console.log('ðŸ›¡ï¸ Re-added has-background class for color');
    }
    
    if (current !== window.userProfileColor) {
      document.body.style.backgroundImage = '';
      document.body.style.backgroundColor = window.userProfileColor;
      console.log('ðŸ›¡ï¸ Restored profile background color');
    }
  }
}, 50); // Check every 50ms - VERY aggressive

</script>
</body>
</html>
