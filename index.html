<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>basspace - Music Platform</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
// Initialize Supabase immediately
const SUPABASE_URL = 'https://xysvtylivtnkykusreln.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh5c3Z0eWxpdnRua3lrdXNyZWxuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwMzA0NzEsImV4cCI6MjA4MTYwNjQ3MX0.Y3wXBhtyM79fg6sLenv6rGDwpPauCkSd0vMokYw65fA';
var supabase;
var currentUser = null;

// Wait for Supabase library to load
window.addEventListener('DOMContentLoaded', function() {
  if (window.supabase) {
    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    console.log('Supabase initialized');
    
    // Now that Supabase is ready, set up auth listeners and check session
    setupAuth();
  }
});

// Setup authentication after Supabase is initialized
function setupAuth() {
  // Listen for auth state changes (login, logout, token refresh)
  supabase.auth.onAuthStateChange((event, session) => {
    console.log('üîÑ Auth state changed:', event);
    
    if (event === 'SIGNED_IN' && session) {
      console.log('‚úÖ User signed in:', session.user.email);
      currentUser = session.user;
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('profileMenuContainer').style.display = 'block';
      loadCloudData();
    } else if (event === 'SIGNED_OUT') {
      console.log('üëã User signed out');
      currentUser = null;
      tracks = [];
      allUserTracks = [];
      playlists = [];
      renderLibrary();
      renderPopularTracks();
      document.getElementById('loginBtn').style.display = 'block';
      document.getElementById('profileMenuContainer').style.display = 'none';
    } else if (event === 'TOKEN_REFRESHED') {
      console.log('üîÑ Token refreshed');
    }
  });
  
  // Check for existing session (wait for function to be defined)
  setTimeout(() => {
    if (typeof checkSession === 'function') {
      checkSession();
    }
  }, 100);
}

// Modal functions defined globally
function openAuthModal() {
  const modal = document.getElementById('authModal');
  if (modal) {
    modal.style.display = 'flex';
  }
}

function closeAuthModal() {
  const modal = document.getElementById('authModal');
  if (modal) {
    modal.style.display = 'none';
  }
  // Clear message when closing
  clearAuthMessage();
}

// Show message in auth modal
function showAuthMessage(message, type = 'info') {
  const messageEl = document.getElementById('authMessage');
  if (messageEl) {
    messageEl.textContent = message;
    messageEl.style.display = 'block';
    
    // Style based on type
    if (type === 'success') {
      messageEl.style.background = 'rgba(34, 197, 94, 0.2)';
      messageEl.style.border = '1px solid rgba(34, 197, 94, 0.4)';
      messageEl.style.color = '#86efac';
    } else if (type === 'error') {
      messageEl.style.background = 'rgba(239, 68, 68, 0.2)';
      messageEl.style.border = '1px solid rgba(239, 68, 68, 0.4)';
      messageEl.style.color = '#fca5a5';
    } else {
      messageEl.style.background = 'rgba(59, 130, 246, 0.2)';
      messageEl.style.border = '1px solid rgba(59, 130, 246, 0.4)';
      messageEl.style.color = '#93c5fd';
    }
  }
}

// Clear message
function clearAuthMessage() {
  const messageEl = document.getElementById('authMessage');
  if (messageEl) {
    messageEl.style.display = 'none';
    messageEl.textContent = '';
  }
}

</script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--bg-primary:#050d1a;--bg-secondary:#0a1929;--bg-tertiary:#132f4c;--accent:#5090d3;--text-primary:#fff;--text-secondary:#8ba3bf;--border-color:rgba(176,196,222,0.12);--border-dark:rgba(0,0,0,0.3);--nav-hue:210;--nav-sat:40%;--nav-light:20%}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI','Roboto',sans-serif;background:var(--bg-primary);color:var(--text-primary);min-height:100vh;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;transition:all .3s ease}
.top-nav{background:hsla(var(--nav-hue, 210),var(--nav-sat, 40%),var(--nav-light, 20%),0.7);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border-bottom:1px solid var(--border-color);padding:.75rem 2rem;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;z-index:100;height:64px;transition:all .3s ease}
.logo{font-size:1.5rem;font-weight:800;cursor:pointer;letter-spacing:-.8px;background:linear-gradient(135deg,var(--accent-light) 0%,var(--text-primary) 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;filter:drop-shadow(0 0 20px var(--accent-light)) drop-shadow(0 0 40px var(--accent-light)) drop-shadow(0 0 60px var(--accent-light))}
.nav-center{display:flex;align-items:center;gap:1rem;flex:1;max-width:600px;margin:0 2rem}
.nav-links{display:flex;gap:2rem;align-items:center}
.nav-link{color:#ffffff;text-decoration:none;font-size:.9rem;font-weight:500;transition:all .3s;cursor:pointer}
.nav-link:hover{color:#ffffff;text-shadow:0 0 20px var(--accent-light),0 0 40px var(--accent-light),0 0 60px var(--accent-light)}
.nav-link.active{color:#ffffff;text-shadow:0 0 30px var(--accent-light),0 0 60px var(--accent-light),0 0 90px var(--accent-light)}
.search-bar{flex:1;position:relative}
.search-icon{position:absolute;left:1rem;top:50%;transform:translateY(-50%);color:var(--text-secondary);font-size:.9rem}
.search-input{width:100%;padding:.6rem 1rem .6rem 2.75rem;background:var(--bg-secondary);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px);border:1px solid var(--border-color);border-radius:500px;color:var(--text-primary);font-size:.875rem;font-family:'Inter',sans-serif;transition:all .2s}
.search-input:focus{outline:0;background:var(--bg-tertiary);border-color:var(--accent)}
.search-input::placeholder{color:var(--text-secondary);opacity:.6}
.profile-menu{position:relative}
.profile-btn{background:rgba(255,255,255,.08);border:1px solid var(--border-color);border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:.75rem;transition:all .2s;font-weight:600}
.profile-btn:hover{background:rgba(255,255,255,.12);border-color:var(--accent)}
.dropdown{position:absolute;top:50px;right:0;background:hsla(var(--nav-hue, 210),var(--nav-sat, 40%),var(--nav-light, 20%),0.95);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid var(--border-color);border-radius:8px;min-width:200px;display:none;box-shadow:0 8px 24px rgba(0,0,0,.4);overflow:hidden}
.dropdown.show{display:block}
.dropdown-item{padding:.875rem 1rem;cursor:pointer;transition:background .2s;font-size:.875rem;font-weight:500;color:var(--text-secondary)}
.dropdown-item:hover{background:rgba(255,255,255,.08);color:var(--text-primary)}
.container{max-width:1600px;margin:0 auto;padding:1rem 2rem 140px 2rem}
.screen{display:none;padding:0;margin:0}
.screen.active{display:block}
#profileScreen{border-radius:0;overflow:visible}
.section-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
.section-title{font-size:1.75rem;font-weight:700;letter-spacing:-.5px;text-shadow:0 0 20px var(--accent),0 0 40px var(--accent)}
.recently-played{margin-bottom:3rem}
.horizontal-scroll{display:flex;gap:1rem;overflow-x:auto;padding-bottom:1rem;scrollbar-width:thin;scrollbar-color:var(--accent) transparent}
.horizontal-scroll::-webkit-scrollbar{height:8px}
.horizontal-scroll::-webkit-scrollbar-track{background:0 0}
.horizontal-scroll::-webkit-scrollbar-thumb{background:var(--accent);border-radius:4px}
.album-card{min-width:180px;background:var(--bg-primary);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:1rem;cursor:pointer;transition:all .3s;box-shadow:0 0 10px rgba(255,255,255,0.04),inset 0 0 20px rgba(255,255,255,0.02)}
.album-card:hover{border-color:rgba(255,255,255,0.12);box-shadow:0 0 20px var(--accent),0 10px 25px rgba(0,0,0,.5);transform:translateY(-4px)}
.album-art-large{width:100%;aspect-ratio:1;background:rgba(255,255,255,.08);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:2rem;margin-bottom:1rem;background-size:cover;background-position:center;position:relative}
.play-overlay{position:absolute;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity .2s;border-radius:6px}
.album-card:hover .play-overlay{opacity:1}
.play-overlay-btn{width:48px;height:48px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.2rem;color:#fff;border:2px solid rgba(0,0,0,0.4);cursor:pointer;transform:scale(.9);transition:transform .2s;box-shadow:0 2px 8px rgba(0,0,0,0.4)}
.album-card:hover .play-overlay-btn{transform:scale(1);box-shadow:0 4px 12px rgba(0,0,0,0.5),0 0 20px var(--accent)}
.album-title{font-weight:600;font-size:.875rem;margin-bottom:.25rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 15px var(--accent)}
.album-artist{color:var(--text-secondary);font-size:.8rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 8px var(--accent)}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:1.5rem;margin-bottom:3rem}
.stat-card{background:var(--bg-primary);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:2rem;text-align:center;transition:all .3s;cursor:pointer;box-shadow:0 0 10px rgba(255,255,255,0.04),inset 0 0 20px rgba(255,255,255,0.02)}
.stat-card:hover{border-color:rgba(255,255,255,0.12);box-shadow:0 0 20px var(--accent),0 12px 30px rgba(0,0,0,.5);transform:translateY(-6px)}
.stat-number{font-size:3rem;font-weight:800;margin-bottom:.5rem;letter-spacing:-1px;color:var(--text-primary);text-shadow:0 0 20px var(--accent),0 0 40px var(--accent)}
.stat-label{color:var(--text-secondary);font-size:.875rem;text-transform:uppercase;letter-spacing:1px;font-weight:600;text-shadow:0 0 8px var(--accent)}
.profile-header{position:relative;margin-bottom:2rem}
.profile-banner{height:280px;background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 15%),0.4);border-radius:0;overflow:hidden;backdrop-filter:blur(30px) saturate(160%);-webkit-backdrop-filter:blur(30px) saturate(160%);position:relative;border:1px solid rgba(255,255,255,0.08);border-left:none;border-right:none}
.profile-content-wrapper{padding:0 2rem;position:relative;margin-top:-60px}
.profile-main-info{display:flex;align-items:flex-start;gap:1.5rem}
.profile-main-info:hover{border-color:rgba(255,255,255,0.15);box-shadow:0 12px 32px rgba(0,0,0,.4)}
.profile-avatar-large{width:120px;height:120px;background:var(--bg-secondary);border:3px solid var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:3rem;font-weight:800;flex-shrink:0;box-shadow:0 0 30px var(--accent),0 8px 24px rgba(0,0,0,.4);position:relative;background-size:cover;background-position:center}
.profile-avatar-large::before{content:'';position:absolute;inset:-3px;border-radius:50%;background:linear-gradient(135deg,var(--accent),transparent);opacity:.3;z-index:-1}
.profile-text-content{flex:1;min-width:0}
.profile-text-content h1{font-size:2rem;font-weight:800;letter-spacing:-0.5px;text-shadow:0 0 20px var(--accent)}
.profile-username{color:var(--text-secondary);font-size:.85rem;font-weight:600;text-transform:uppercase;letter-spacing:1px}
.profile-bio{color:var(--text-secondary);font-size:.9rem;line-height:1.6;max-width:600px}
.profile-stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;margin-bottom:2rem}
.stat-card{background:var(--bg-primary);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:1.25rem;display:flex;align-items:center;gap:1rem;transition:all .3s;cursor:pointer}
.stat-card:hover{border-color:var(--accent);box-shadow:0 0 20px var(--accent),0 4px 12px rgba(0,0,0,.3);transform:translateY(-2px)}
.stat-icon{font-size:2rem;opacity:.8}
.stat-content{flex:1}
.stat-number{font-size:1.75rem;font-weight:800;line-height:1;margin-bottom:.25rem;text-shadow:0 0 15px var(--accent)}
.stat-label{font-size:.75rem;color:var(--text-secondary);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
.profile-tabs{display:flex;gap:1rem;border-bottom:2px solid var(--border-color);margin-bottom:2rem;padding:0 2rem}
.profile-tab{background:0 0;border:none;color:var(--text-secondary);font-size:.9rem;font-weight:600;padding:1rem 1.5rem;cursor:pointer;border-bottom:3px solid transparent;transition:all .2s;font-family:'Inter',sans-serif;display:flex;align-items:center;gap:.5rem;border-radius:8px 8px 0 0}
.profile-tab:hover{background:rgba(255,255,255,0.05);color:var(--text-primary)}
.profile-tab.active{color:var(--text-primary);border-bottom-color:var(--accent);background:rgba(255,255,255,0.03)}
.tab-icon{font-size:1.1rem}
.stats-detailed-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem;padding:0 2rem}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:1rem 0;border-bottom:1px solid var(--border-color)}
.stat-row:last-child{border-bottom:none}
.stat-row-label{color:var(--text-secondary);font-size:.9rem;font-weight:500}
.stat-row-value{color:var(--text-primary);font-size:1.1rem;font-weight:700;text-shadow:0 0 10px var(--accent)}
.top-list{display:flex;flex-direction:column;gap:.75rem}
.top-list-item{display:flex;align-items:center;gap:1rem;padding:.75rem;background:rgba(255,255,255,0.03);border-radius:8px;transition:all .2s}
.top-list-item:hover{background:rgba(255,255,255,0.08)}
.top-list-rank{font-size:1.2rem;font-weight:800;color:var(--accent);min-width:30px}
.top-list-info{flex:1}
.top-list-name{font-weight:600;margin-bottom:.25rem}
.top-list-count{font-size:.85rem;color:var(--text-secondary)}
.profile-info{padding:0 2rem;margin-top:-60px;position:relative}
.profile-avatar-container{display:flex;align-items:flex-end;gap:2rem;margin-bottom:1.5rem}
.profile-avatar{width:140px;height:140px;background:var(--bg-secondary);border:4px solid var(--bg-primary);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:2.5rem;font-weight:800;box-shadow:0 8px 24px rgba(0,0,0,.4)}
.profile-details h1{font-size:2.5rem;font-weight:800;margin-bottom:.5rem;letter-spacing:-1px;text-shadow:0 0 25px var(--accent),0 0 50px var(--accent)}
.settings-section{background:var(--bg-primary);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:2rem;margin-bottom:1.5rem;transition:all .3s;box-shadow:0 0 10px rgba(255,255,255,0.04),inset 0 0 20px rgba(255,255,255,0.02)}
.settings-section:hover{border-color:rgba(255,255,255,0.12);box-shadow:0 0 18px var(--accent),0 8px 25px rgba(0,0,0,.4)}
.settings-section h3{font-size:1.25rem;margin-bottom:2rem;font-weight:700;text-shadow:0 0 15px var(--accent),0 0 30px var(--accent)}

/* Frosted Glass Effect for Profile Page with Background */
.profile-page.has-background .panel,
.profile-page.has-background .track,
.profile-page.has-background .settings-section,
.profile-page.has-background .profile-info,
.profile-page.has-background .upload-area,
.profile-page.has-background .empty-state{background:rgba(10,13,26,0.7)!important;backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid rgba(255,255,255,0.18)}
.profile-page.has-background{background-size:cover!important;background-position:center!important;background-attachment:fixed!important}
.profile-page.has-background .profile-header{background:transparent}

/* Solid Panel Style */
.profile-page.solid-panels .panel,
.profile-page.solid-panels .track,
.profile-page.solid-panels .profile-info,
.profile-page.solid-panels .upload-area,
.profile-page.solid-panels .empty-state{background:var(--panel-bg,#0a0d1a)!important;backdrop-filter:none;-webkit-backdrop-filter:none;border:1px solid rgba(255,255,255,0.1)}

/* No Glow Option */
.profile-page.no-glow .panel,
.profile-page.no-glow .track,
.profile-page.no-glow .settings-section,
.profile-page.no-glow h1,
.profile-page.no-glow h2,
.profile-page.no-glow h3{text-shadow:none!important;box-shadow:none!important}

.setting-item{display:flex;justify-content:space-between;align-items:center;padding:1.25rem 0;border-bottom:1px solid var(--border-color)}
.setting-item:last-child{border-bottom:none}
.setting-label h4{margin-bottom:.25rem;font-weight:600;font-size:.95rem}
.setting-label p{color:var(--text-secondary);font-size:.85rem}
.toggle{width:50px;height:28px;background:rgba(255,255,255,.1);border-radius:14px;position:relative;cursor:pointer;transition:background .2s}
.toggle.active{background:var(--accent)}
.toggle-slider{width:24px;height:24px;background:#fff;border-radius:50%;position:absolute;top:2px;left:2px;transition:all .2s;box-shadow:0 2px 4px rgba(0,0,0,.2)}
.toggle.active .toggle-slider{left:24px}
.input-group{margin-bottom:1.5rem}
.input-group label{display:block;margin-bottom:.75rem;color:var(--text-secondary);font-size:.875rem;font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.btn{padding:.875rem 2rem;border:none;border-radius:500px;font-weight:700;cursor:pointer;transition:all .2s;font-size:.95rem;font-family:'Inter',sans-serif;letter-spacing:.3px;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
.btn-primary{background:var(--accent);color:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.3);border:2px solid rgba(0,0,0,0.3)}
.btn-primary:hover{transform:scale(1.05);filter:brightness(1.1);box-shadow:0 4px 12px rgba(0,0,0,0.4),0 0 20px var(--accent);border-color:rgba(0,0,0,0.5)}
.btn-secondary{background:rgba(255,255,255,.08);color:#fff;border:1px solid rgba(255,255,255,0.2);text-shadow:0 1px 3px rgba(0,0,0,0.5)}
.btn-secondary:hover{background:rgba(255,255,255,.15);border-color:rgba(255,255,255,0.3)}
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.9);backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;z-index:1000}
.modal-overlay.show{display:flex}
.modal{background:hsla(var(--nav-hue, 210),var(--nav-sat, 40%),var(--nav-light, 20%),0.92);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid var(--border-color);border-radius:12px;padding:2.5rem;width:90%;max-width:500px;max-height:90vh;overflow-y:auto;position:relative}
.modal h3{font-size:1.75rem;margin-bottom:2rem;font-weight:700;text-shadow:0 0 20px var(--accent),0 0 40px var(--accent)}
.input{width:100%;padding:.875rem 1.25rem;background:rgba(255,255,255,.05);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:.95rem;margin-bottom:1rem;font-family:'Inter',sans-serif;transition:all .2s}
.input:focus{outline:0;border-color:var(--accent);background:rgba(255,255,255,.08)}
.input::placeholder{color:var(--text-secondary);opacity:.6}
textarea.input{resize:vertical;font-family:'Inter',sans-serif}
.modal-buttons{display:flex;gap:1rem;margin-top:2rem}
.modal-buttons .btn{flex:1}
.playlist-selection-item{padding:1rem;background:rgba(255,255,255,0.05);border:1px solid var(--border-color);border-radius:8px;margin-bottom:0.75rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:space-between}
.playlist-selection-item:hover:not(.disabled){background:rgba(255,255,255,0.1);border-color:var(--accent);transform:translateX(5px)}
.playlist-selection-item.disabled{opacity:0.5;cursor:not-allowed}
.upload-area{border:2px dashed var(--border-color);border-radius:12px;padding:4rem;text-align:center;cursor:pointer;transition:all .3s;background:rgba(255,255,255,.02);margin-bottom:2rem}
.upload-area:hover{border-color:var(--accent);background:rgba(255,255,255,.05)}
.upload-area.drag-active{border-color:var(--accent);background:rgba(80,144,211,.1)}
.upload-icon{font-size:3.5rem;margin-bottom:1.5rem;color:var(--text-secondary);font-weight:300;text-shadow:0 0 30px var(--accent),0 0 60px var(--accent)}
.upload-area h2{font-size:1.5rem;margin-bottom:.75rem;font-weight:700}
.upload-area p{color:var(--text-secondary);font-size:1rem}
.track-list{display:flex;flex-direction:column;gap:.5rem;position:relative;z-index:1}
.track{background:var(--bg-primary);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:.75rem 1rem;transition:all .3s;cursor:pointer;box-shadow:0 0 8px rgba(255,255,255,0.04),inset 0 0 20px rgba(255,255,255,0.02);overflow:visible;position:relative}
.track:hover{border-color:rgba(255,255,255,0.12);box-shadow:0 0 15px var(--accent),0 6px 20px rgba(0,0,0,.4);transform:translateY(-2px)}
.track-content{display:flex;align-items:center;gap:1rem}
.track-number{width:2rem;text-align:center;color:var(--text-secondary);font-family:'Space Mono',monospace;font-size:.85rem;font-weight:600}
.track-art{width:48px;height:48px;background:rgba(255,255,255,.08);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;background-size:cover;background-position:center;color:var(--text-secondary);font-weight:600}
.play-btn{width:40px;height:40px;background:var(--accent);color:#fff;border:2px solid rgba(0,0,0,0.4);border-radius:50%;font-size:.9rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;font-weight:900;flex-shrink:0;box-shadow:0 2px 8px rgba(0,0,0,0.4);text-shadow:0 1px 2px rgba(0,0,0,0.5)}
.play-btn:hover{transform:scale(1.1);filter:brightness(1.1);box-shadow:0 4px 12px rgba(0,0,0,0.5),0 0 20px var(--accent);border-color:rgba(0,0,0,0.6)}
.track-info{flex:1;min-width:0}
.track-title{font-size:.95rem;font-weight:600;margin-bottom:.25rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 15px var(--accent)}
.track-artist{font-size:.85rem;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 8px var(--accent)}
.track-duration{font-size:.8rem;color:var(--text-secondary);margin-top:.25rem;font-family:'Space Mono',monospace}
.track-actions{display:flex;gap:.5rem;flex-shrink:0;position:relative;z-index:1;overflow:visible}
.track-menu-btn{width:32px;height:32px;background:rgba(255,255,255,.05);border:1px solid var(--border-color);border-radius:50%;color:var(--text-secondary);font-weight:900;cursor:pointer;transition:all .2s;font-size:1.2rem;display:flex;align-items:center;justify-content:center;line-height:1;position:relative;z-index:99999}
.track-menu-btn:hover{background:rgba(255,255,255,.1);border-color:var(--accent);color:var(--accent)}
.track-dropdown{position:absolute;right:0;top:100%;margin-top:.5rem;background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 12%),0.95);border:1px solid rgba(255,255,255,0.15);border-radius:10px;padding:.5rem;min-width:140px;z-index:999999;display:none;box-shadow:0 12px 40px rgba(0,0,0,.6),0 0 0 1px rgba(255,255,255,0.1) inset;backdrop-filter:blur(40px) saturate(180%);-webkit-backdrop-filter:blur(40px) saturate(180%)}
.track-dropdown.show{display:block;pointer-events:auto}
.track-dropdown::before{content:'';position:fixed;top:0;left:0;right:0;bottom:0;z-index:-1;pointer-events:none}
.track-dropdown.show::before{pointer-events:none}
.track-dropdown-item{padding:.5rem .75rem;color:var(--text-primary);font-size:.8rem;font-weight:600;cursor:pointer;border-radius:4px;transition:all .2s;white-space:nowrap;position:relative}
.track-dropdown-item:hover{background:rgba(255,255,255,.1);color:var(--accent)}
.track-dropdown-item.delete{color:#ff6b6b}
.track-dropdown-item.delete:hover{background:rgba(255,107,107,.1)}
.track-dropdown-item.has-submenu:after{content:'‚Ä∫';margin-left:0.5rem;float:right;font-size:1.2rem}
.track-submenu{position:absolute;top:-0.25rem;left:calc(100% + 0.25rem);background:hsla(var(--card-hue, 210),var(--card-sat, 30%),var(--card-light, 10%),0.97);border:1px solid rgba(255,255,255,0.2);border-radius:10px;padding:.5rem;min-width:160px;max-height:280px;overflow-y:auto;box-shadow:0 16px 48px rgba(0,0,0,.7),0 0 0 1px rgba(255,255,255,0.15) inset;backdrop-filter:blur(50px) saturate(200%);-webkit-backdrop-filter:blur(50px) saturate(200%);display:none;z-index:9999999;pointer-events:auto}
.track-submenu.show{display:block;pointer-events:auto}
.track-submenu-item{padding:.5rem .75rem;color:var(--text-primary);font-size:.8rem;font-weight:600;cursor:pointer;border-radius:4px;transition:all .2s;display:flex;justify-content:space-between;align-items:center;gap:.5rem}
.track-submenu-item:hover:not(.added){background:rgba(255,255,255,.1);color:var(--accent)}
.track-submenu-item.added{opacity:.5;cursor:not-allowed}
.track-submenu-item .checkmark{color:#22c55e;font-weight:bold;font-size:1rem}
.btn-small{padding:.5rem .875rem;background:rgba(255,255,255,.05);border:1px solid var(--border-color);border-radius:500px;color:var(--text-secondary);font-weight:600;cursor:pointer;transition:all .2s;font-size:.8rem}
.btn-small:hover{background:rgba(255,255,255,.1);color:var(--text-primary);border-color:var(--accent)}
.empty-state{text-align:center;padding:5rem 2rem}
.empty-state-icon{font-size:3rem;opacity:.4;margin-bottom:1.5rem;color:var(--text-primary);font-weight:300}
.empty-state h2{font-size:1.5rem;font-weight:700;margin-bottom:.5rem;text-shadow:0 0 20px var(--accent),0 0 40px var(--accent)}
.empty-state p{color:var(--text-secondary);font-size:.95rem;text-shadow:0 0 8px var(--accent)}
.page-header{margin-bottom:1.5rem}
.page-header h1{font-size:2.5rem;margin-bottom:.5rem;font-weight:900;letter-spacing:-1px;text-shadow:0 0 25px var(--accent),0 0 50px var(--accent)}
.page-header p{color:var(--text-secondary);font-size:.95rem;text-shadow:0 0 8px var(--accent)}
.image-upload-box{border:2px dashed var(--border-color);border-radius:8px;padding:2rem;text-align:center;cursor:pointer;transition:all .2s;background:rgba(255,255,255,.02);margin-top:.75rem;position:relative;overflow:hidden}
.image-upload-box:hover{border-color:var(--accent);background:rgba(255,255,255,.05)}
.image-upload-box.has-image{border-style:solid;border-color:var(--accent)}
.image-preview{width:100%;height:100%;object-fit:cover;position:absolute;top:0;left:0}
.color-picker-group{display:flex;gap:.75rem;margin-top:.75rem;flex-wrap:wrap}
.color-option{width:56px;height:56px;border:2px solid var(--border-color);border-radius:8px;cursor:pointer;transition:all .2s;position:relative}
.color-option:hover{border-color:var(--accent);transform:scale(1.05)}
.color-option.selected{border-color:var(--accent);border-width:3px}
.color-option.selected::after{content:'‚úì';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:1.5rem;font-weight:700;text-shadow:0 0 4px rgba(0,0,0,.8)}
.album-art-upload{width:160px;height:160px;border:2px dashed var(--border-color);background:rgba(255,255,255,.02);border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;margin:0 auto 1.5rem;position:relative;overflow:hidden;font-size:2rem;color:var(--text-secondary);font-weight:600}
.album-art-upload:hover{border-color:var(--accent);background:rgba(255,255,255,.05)}
.album-art-upload.has-image{border-style:solid;border-color:var(--accent)}
.player-bar{position:fixed;bottom:0;left:0;right:0;background:rgba(0,0,0,0.3);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border-top:2px solid var(--border-dark);padding:.75rem 2rem;display:none;z-index:200;height:90px;transition:all .3s ease}
.player-bar.active{display:flex}
.player-content{max-width:1600px;margin:0 auto;width:100%;display:grid;grid-template-columns:1fr 2fr 1fr;align-items:center;gap:2rem}
.player-track-info{display:flex;align-items:center;gap:1rem;min-width:0}
.player-track-art{width:56px;height:56px;background:rgba(255,255,255,.08);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:1rem;flex-shrink:0;background-size:cover;background-position:center;color:var(--text-secondary);font-weight:600}
.player-text{min-width:0}
.player-title{font-weight:600;font-size:.95rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 15px var(--accent)}
.player-artist{color:var(--text-secondary);font-size:.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 0 8px var(--accent)}
.player-center{display:flex;flex-direction:column;gap:.5rem}
.player-controls{display:flex;align-items:center;justify-content:center;gap:1rem}
.player-btn{background:rgba(255,255,255,.08);border:1px solid var(--border-color);width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:background .2s,border-color .2s;color:var(--text-primary);font-size:.85rem}
.player-btn:hover{background:rgba(255,255,255,.15);border-color:var(--accent)}
.player-btn.repeat.active{background:var(--accent);color:#fff;border-color:rgba(0,0,0,0.3)}
.player-btn-main{width:40px;height:40px;background:var(--accent);color:#fff;font-size:1rem;border:2px solid rgba(0,0,0,0.4);box-shadow:0 2px 8px rgba(0,0,0,0.3)}
.player-btn-main:hover{filter:brightness(1.1);box-shadow:0 4px 12px rgba(0,0,0,0.4),0 0 20px var(--accent);border-color:rgba(0,0,0,0.6)}
.player-btn-main span{display:flex;align-items:center;justify-content:center;width:100%;height:100%;padding-left:2px}
.progress-container{display:flex;align-items:center;gap:.75rem}
.progress-time{font-size:.75rem;color:var(--text-secondary);font-family:'Space Mono',monospace;min-width:40px}
.progress-bar{flex:1;height:6px;background:rgba(255,255,255,.1);border-radius:3px;cursor:pointer;position:relative}
.progress-bar:hover .progress-fill::after{opacity:1}
.progress-fill{height:100%;background:var(--accent);border-radius:3px;position:relative;transition:width .1s linear}
.progress-fill::after{content:'';position:absolute;right:-6px;top:50%;transform:translateY(-50%);width:12px;height:12px;background:#fff;border-radius:50%;opacity:0;transition:opacity .2s}
.player-right{display:flex;align-items:center;justify-content:flex-end;gap:1rem}
.volume-control{display:flex;align-items:center;gap:.75rem}
.volume-icon{font-size:.85rem;cursor:pointer;color:var(--text-secondary);font-weight:600;transition:color .2s}
.volume-icon:hover{color:var(--text-primary)}
.volume-slider{-webkit-appearance:none;appearance:none;width:100px;height:4px;background:rgba(255,255,255,.1);outline:0;cursor:pointer;border-radius:2px}
.volume-slider::-webkit-slider-thumb{-webkit-appearance:none;appearance:none;width:12px;height:12px;background:#fff;cursor:pointer;border-radius:50%}
.volume-slider::-moz-range-thumb{width:12px;height:12px;background:#fff;cursor:pointer;border:none;border-radius:50%}
.player-menu{position:relative}
.player-menu-btn{background:0 0;border:none;color:var(--text-secondary);font-size:1.2rem;cursor:pointer;padding:.5rem;transition:color .2s}
.player-menu-btn:hover{color:var(--text-primary)}
.player-menu-dropdown{position:absolute;bottom:100%;right:0;margin-bottom:.5rem;background:hsla(var(--nav-hue, 210),var(--nav-sat, 40%),var(--nav-light, 20%),0.95);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid var(--border-color);border-radius:8px;min-width:200px;display:none;box-shadow:0 8px 24px rgba(0,0,0,.4)}
.player-menu-dropdown.show{display:block}
.player-menu-item{padding:.875rem 1rem;cursor:pointer;transition:background .2s;font-size:.875rem;color:var(--text-secondary);display:flex;align-items:center;gap:.75rem}
.player-menu-item:hover{background:rgba(255,255,255,.08);color:var(--text-primary)}
.player-menu-item:first-child{border-radius:8px 8px 0 0}
.player-menu-item:last-child{border-radius:0 0 8px 8px}
.upload-progress{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:hsla(var(--nav-hue, 210),var(--nav-sat, 40%),var(--nav-light, 20%),0.95);backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid var(--border-color);border-radius:12px;padding:2.5rem;z-index:2000;display:none;text-align:center;min-width:320px}
.upload-progress.show{display:block}
.spinner{border:3px solid rgba(255,255,255,.1);border-top:3px solid var(--accent);border-radius:50%;width:50px;height:50px;animation:spin 1s linear infinite;margin:0 auto 1.5rem}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.playlist-card{background:var(--bg-primary);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:1.5rem;cursor:pointer;transition:all .3s;height:160px;display:flex;flex-direction:column;justify-content:center;box-shadow:0 0 10px rgba(255,255,255,0.04),inset 0 0 20px rgba(255,255,255,0.02)}
.playlist-card:hover{border-color:rgba(255,255,255,0.12);transform:translateY(-6px);box-shadow:0 0 20px var(--accent),0 12px 30px rgba(0,0,0,.5)}
.playlist-icon{font-size:2rem;margin-bottom:1rem;color:var(--text-secondary);font-weight:600;text-shadow:0 0 15px var(--accent),0 0 30px var(--accent)}
.playlist-name{font-weight:700;font-size:1.1rem;margin-bottom:.5rem;text-shadow:0 0 12px var(--accent),0 0 24px var(--accent)}
.playlist-count{color:var(--text-secondary);font-size:.875rem;text-shadow:0 0 8px var(--accent)}
.color-input-group{display:flex;gap:1rem;align-items:center;margin-top:1rem}
.color-picker-input{width:60px;height:60px;border:2px solid var(--border-color);border-radius:8px;cursor:pointer;background:0 0}
.color-picker-input::-webkit-color-swatch-wrapper{padding:0}
.color-picker-input::-webkit-color-swatch{border:none;border-radius:6px}
.auth-tab{background:transparent;border:none;color:var(--text-secondary);padding:.75rem 1.5rem;cursor:pointer;font-size:.95rem;font-weight:600;border-bottom:2px solid transparent;transition:all .2s}
.auth-tab.active{color:var(--accent);border-bottom-color:var(--accent)}
.auth-tab:hover{color:var(--text-primary)}
.input{width:100%;padding:.75rem 1rem;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:8px;color:var(--text-primary);font-size:.95rem;transition:all .2s}
.input:focus{outline:none;border-color:var(--accent);background:var(--bg-tertiary)}
.input::placeholder{color:var(--text-secondary);opacity:.6}
.modal.show{display:flex !important}

/* Mobile Responsive Styles */
@media (max-width: 768px) {
  /* Typography - smaller, cleaner */
  .section-title{font-size:1.3rem}
  .page-header h1{font-size:2rem}
  .stat-number{font-size:2rem}
  
  /* Container - tighter padding */
  .container{padding:1rem}
  
  /* Header - compact, centered */
  .header{padding:1rem;flex-direction:column;gap:1rem}
  .logo{font-size:1.3rem}
  .nav-links{gap:1rem;width:100%;justify-content:space-around}
  .nav-link{font-size:.85rem}
  .search-container{width:100%;order:3}
  .profile-menu{position:absolute;top:1rem;right:1rem}
  
  /* Stats grid - 2 columns, symmetrical */
  .stats-grid{grid-template-columns:1fr 1fr;gap:.75rem}
  .stat-card{padding:1.25rem}
  
  /* Track list - streamlined */
  .track{padding:.5rem}
  .track-content{gap:.5rem}
  .track-number{min-width:24px;font-size:.8rem}
  .track-art{width:40px;height:40px;font-size:.8rem}
  .play-btn{width:32px;height:32px;font-size:.7rem}
  .track-info{flex:1;min-width:0}
  .track-title{font-size:.85rem}
  .track-artist{font-size:.75rem}
  .track-duration{font-size:.7rem}
  .track-actions{flex-direction:column;gap:.25rem;width:auto}
  .btn-small{padding:.4rem .6rem;font-size:.7rem;white-space:nowrap}
  
  /* Albums - 2 columns, symmetrical */
  .albums-scroll{gap:.75rem;padding:.5rem 0}
  .album-card{min-width:calc(50% - .375rem);max-width:calc(50% - .375rem)}
  .album-art-large{height:120px}
  
  /* Player bar - compact, stacked */
  .player-bar{padding:.75rem 1rem;height:auto}
  .player-content{grid-template-columns:1fr;gap:1rem}
  .player-track-info{order:1}
  .player-track-art{width:48px;height:48px}
  .player-title{font-size:.85rem}
  .player-artist{font-size:.75rem}
  .player-center{order:2}
  .player-controls{gap:.75rem;justify-content:center}
  .player-btn{width:36px;height:36px;font-size:.9rem}
  .player-btn-main{width:44px;height:44px;font-size:1.1rem}
  .progress-container{order:3}
  .player-right{display:none}
  
  /* Modals - full screen on mobile */
  .modal-content{width:100%;height:100vh;max-width:100%;margin:0;border-radius:0;padding:1.5rem}
  
  /* Settings - single column */
  .settings-section{padding:1.25rem}
  .setting-item{flex-direction:column;align-items:flex-start;gap:.5rem}
  .color-picker-group{gap:.5rem}
  .color-option{width:48px;height:48px}
  
  /* Profile - streamlined */
  .profile-banner{height:120px}
  .profile-header{padding:1rem;margin-top:-40px}
  .profile-avatar{width:80px;height:80px;font-size:1.8rem}
  .profile-stats{flex-direction:column;gap:.75rem;width:100%}
  .profile-stat{text-align:center;padding:.75rem}
  
  /* Playlists - 2 columns symmetrical */
  .playlists-grid{grid-template-columns:1fr 1fr;gap:.75rem}
  .playlist-card{padding:1rem;height:140px}
  .playlist-icon{font-size:1.5rem;margin-bottom:.5rem}
  .playlist-name{font-size:.95rem}
  
  /* Hide unnecessary elements */
  .empty-state{padding:3rem 1rem}
  .empty-state-icon{font-size:2rem}
  
  /* Upload area - compact */
  .upload-area{padding:2rem 1rem}
  .upload-icon{font-size:2.5rem}
}

/* Extra small devices */
@media (max-width: 480px) {
  .stats-grid{grid-template-columns:1fr;gap:.5rem}
  .albums-scroll{overflow-x:auto;-webkit-overflow-scrolling:touch;display:flex;flex-wrap:nowrap}
  .album-card{min-width:140px;max-width:140px}
  .playlists-grid{grid-template-columns:1fr;gap:.5rem}
  .track-actions{position:static;margin-top:.5rem;flex-direction:row;justify-content:flex-start}
}
</style>
</head>
<body>

<!-- Auth Modal -->
<div id="authModal" class="modal-overlay" style="display:none">
<div class="modal" style="max-width:400px;position:relative">
<button id="authModalCloseBtn" style="position:absolute;top:1rem;right:1rem;background:transparent;border:none;color:var(--text-secondary);font-size:1.5rem;cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all .2s" onmouseover="this.style.background='rgba(255,255,255,0.1)'" onmouseout="this.style.background='transparent'">√ó</button>
<h3 style="margin-bottom:2rem;text-align:center">welcome to basspace</h3>
<div id="authMessage" style="display:none;padding:1rem;border-radius:8px;margin-bottom:1.5rem;text-align:center;font-size:.95rem"></div>
<div id="authTabs" style="display:flex;gap:1rem;margin-bottom:2rem;border-bottom:2px solid var(--border-color)">
<button class="auth-tab active" data-tab="login">Login</button>
<button class="auth-tab" data-tab="signup">Sign Up</button>
</div>
<div id="loginForm">
<div class="input-group" style="margin-bottom:1rem">
<label>Email</label>
<input type="email" id="loginEmail" class="input" placeholder="your@email.com" onkeypress="if(event.key==='Enter')handleLogin()">
</div>
<div class="input-group" style="margin-bottom:1.5rem">
<label>Password</label>
<input type="password" id="loginPassword" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key==='Enter')handleLogin()">
</div>
<button type="button" class="btn btn-primary" id="loginSubmitBtn" style="width:100%">Login</button>
</div>
<div id="signupForm" style="display:none">
<div class="input-group" style="margin-bottom:1rem">
<label>Username</label>
<input type="text" id="signupUsername" class="input" placeholder="username" onkeypress="if(event.key==='Enter')handleSignup()" onblur="checkUsernameAvailability()">
<div id="usernameAvailability" style="font-size:0.85rem;margin-top:0.5rem;display:none"></div>
</div>
<div class="input-group" style="margin-bottom:1rem">
<label>Email</label>
<input type="email" id="signupEmail" class="input" placeholder="your@email.com" onkeypress="if(event.key==='Enter')handleSignup()">
</div>
<div class="input-group" style="margin-bottom:1rem">
<label>Password</label>
<input type="password" id="signupPassword" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key==='Enter')handleSignup()">
</div>
<div class="input-group" style="margin-bottom:1.5rem">
<label>Confirm Password</label>
<input type="password" id="signupPasswordConfirm" class="input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeypress="if(event.key==='Enter')handleSignup()">
</div>
<button type="button" class="btn btn-primary" id="signupSubmitBtn" style="width:100%">Create Account</button>
</div>
<p style="color:var(--text-secondary);font-size:.875rem;text-align:center;margin-top:1rem">Your music will be saved to the cloud and accessible from any device</p>
</div>
</div>

<div class="top-nav">
<div class="logo" onclick="showScreen('home')">basspace</div>
<div class="nav-center">
<div class="search-bar"><span class="search-icon">üîç</span>
<input type="text" id="searchInput" class="search-input" placeholder="Search songs, artists, albums">
</div>
</div>
<div style="display:flex;align-items:center;gap:2rem">
<div class="nav-links">
<div class="nav-link active" onclick="showScreen('home')">Home</div>
<div class="nav-link" onclick="showScreen('library')">Library</div>
<div class="nav-link" onclick="showScreen('upload')">Upload</div>
</div>
<button id="loginBtn" class="btn btn-primary" style="padding:.5rem 1.5rem;display:block" onclick="if(typeof openAuthModal === 'function') openAuthModal();">Login / Sign Up</button>
<div class="profile-menu" id="profileMenuContainer" style="display:none">
<div class="profile-btn" id="profileBtn">ML</div>
<div id="dropdown" class="dropdown">
<div class="dropdown-item" onclick="showScreen('profile')">Profile</div>
<div class="dropdown-item" onclick="showScreen('upload')">Upload</div>
<div class="dropdown-item" onclick="showScreen('settings')">Settings</div>
<div class="dropdown-item" onclick="handleLogout()" style="color:#ff6b6b;border-top:1px solid var(--border-color);margin-top:.5rem;padding-top:.75rem">Logout</div>
</div>
</div>
</div>
</div>

<div class="container">
<div id="homeScreen" class="screen active">
<div class="recently-played" id="recentlyPlayedSection" style="display:none">
<div class="section-header"><h2 class="section-title">Recently Played</h2></div>
<div class="horizontal-scroll" id="recentlyPlayedList"></div>
</div>

<div style="margin-bottom:3rem">
<div class="section-header"><h2 class="section-title">Trending Tracks</h2></div>
<div id="popularTracks" class="track-list"></div>
<div id="noResults" class="empty-state" style="display:none">
<div class="empty-state-icon">‚àÖ</div><h2>No results found</h2><p>Try searching for something else</p>
</div>
<div id="noMusic" class="empty-state">
<div class="empty-state-icon">‚ô™</div><h2>welcome to basspace</h2><p>Upload your first track or create a playlist to get started</p>
</div>
</div>

<div class="stats">
<div class="stat-card"><div class="stat-number" id="totalTracks">0</div><div class="stat-label">Tracks</div></div>
<div class="stat-card"><div class="stat-number" id="totalArtists">0</div><div class="stat-label">Artists</div></div>
<div class="stat-card"><div class="stat-number" id="totalPlays">0</div><div class="stat-label">Plays</div></div>
</div>
</div>

<div id="profileScreen" class="screen profile-page">
<div class="profile-header">
<!-- Banner with content overlaid -->
<div class="profile-banner" id="profileBannerEl">
  <!-- Profile Song Indicator -->
  <div id="profileSongIndicator" style="position:absolute;top:1rem;right:1rem;background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);padding:0.75rem 1rem;border-radius:8px;display:none;align-items:center;gap:0.75rem;z-index:10">
    <div style="font-size:1.2rem;animation:pulse 2s infinite">‚ô™</div>
    <div style="font-size:0.875rem">
      <div style="font-weight:600" id="profileSongTitle">Profile Song</div>
      <div style="color:var(--text-secondary);font-size:0.75rem" id="profileSongArtist">Playing...</div>
    </div>
    <button onclick="toggleProfileSongMute()" id="profileSongMuteBtn" style="background:none;border:none;font-size:1.2rem;cursor:pointer;color:var(--text-primary)">‚ô™</button>
  </div>
  
  <!-- Profile content directly on banner -->
  <div style="position:absolute;bottom:0;left:0;right:0;padding:2rem;display:flex;align-items:flex-end;gap:1.5rem;background:linear-gradient(to top, rgba(0,0,0,0.8), transparent)">
    <div class="profile-avatar-large" id="profileAvatarEl">ML</div>
    <div style="flex:1;padding-bottom:0.5rem">
      <div style="display:flex;align-items:center;gap:1rem;flex-wrap:wrap;margin-bottom:0.5rem">
        <h1 id="profileUsername" style="margin:0;font-size:2rem;text-shadow:0 2px 8px rgba(0,0,0,0.8)">Music Lover</h1>
        <button class="btn btn-secondary" onclick="openEditProfileModal()" style="padding:0.4rem 1.2rem;font-size:0.8rem">Edit Profile</button>
      </div>
      <p class="profile-username" style="margin:0.25rem 0;text-shadow:0 1px 4px rgba(0,0,0,0.8)">@musiclover</p>
      <p class="profile-bio" id="profileBio" style="margin:0.5rem 0 1rem 0;text-shadow:0 1px 4px rgba(0,0,0,0.8)">Music enthusiast and creator</p>
      <div style="display:flex;gap:1rem;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="showScreen('upload')" style="padding:0.6rem 1.5rem;font-size:0.9rem">Upload Track</button>
        <button class="btn btn-secondary" onclick="openCreatePlaylist()" style="padding:0.6rem 1.5rem;font-size:0.9rem">Create Playlist</button>
      </div>
    </div>
  </div>
</div>

<style>
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}
</style>
</div>

<!-- Tabs directly after header -->
<div class="profile-tabs">
<button class="profile-tab active" onclick="showProfileTab('tracks')">
<span>Tracks</span>
</button>
<button class="profile-tab" onclick="showProfileTab('playlists')" id="playlistTabBtn">
<span>Playlists</span>
</button>
<button class="profile-tab" onclick="showProfileTab('stats')" id="statsTabBtn">
<span>Stats</span>
</button>
</div>

<div id="profileTracksSection" style="display:none">
<div id="profileTrackList" class="track-list"></div>
<div id="profileEmptyTracks" class="empty-state">
<div class="empty-state-icon">‚ô™</div><h2>No tracks uploaded</h2><p>Share your music with the world</p>
</div>
</div>

<div id="profilePlaylistsSection" style="display:none">
<div id="profilePlaylistList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:1rem"></div>
<div id="profileEmptyPlaylists" class="empty-state">
<div class="empty-state-icon">‚ô™</div><h2>No playlists created</h2><p>Organize your favorite tracks</p>
</div>
</div>

<div id="profileStatsSection" style="display:none">
<div class="stats-detailed-grid">
<div class="settings-section">
<h3>Listening Stats</h3>
<div class="stat-row">
<span class="stat-row-label">Total Plays</span>
<span class="stat-row-value" id="statsTotalPlays">0</span>
</div>
<div class="stat-row">
<span class="stat-row-label">Total Listening Time</span>
<span class="stat-row-value" id="statsTotalTime">0h 0m</span>
</div>
<div class="stat-row">
<span class="stat-row-label">Average Track Length</span>
<span class="stat-row-value" id="statsAvgDuration">0:00</span>
</div>
</div>

<div class="settings-section">
<h3>Library Stats</h3>
<div class="stat-row">
<span class="stat-row-label">Total Tracks</span>
<span class="stat-row-value" id="statsTotalTracks">0</span>
</div>
<div class="stat-row">
<span class="stat-row-label">Total Playlists</span>
<span class="stat-row-value" id="statsTotalPlaylists">0</span>
</div>
<div class="stat-row">
<span class="stat-row-label">Unique Artists</span>
<span class="stat-row-value" id="statsUniqueArtists">0</span>
</div>
<div class="stat-row">
<span class="stat-row-label">Unique Albums</span>
<span class="stat-row-value" id="statsUniqueAlbums">0</span>
</div>
</div>

<div class="settings-section">
<h3>Top Artists</h3>
<div id="statsTopArtists" class="top-list">
<div style="color:var(--text-secondary);text-align:center;padding:2rem">No data yet</div>
</div>
</div>

<div class="settings-section">
<h3>Top Albums</h3>
<div id="statsTopAlbums" class="top-list">
<div style="color:var(--text-secondary);text-align:center;padding:2rem">No data yet</div>
</div>
</div>
</div>
</div>
</div>

<div id="settingsScreen" class="screen">
<div class="section-header"><h2 class="section-title">Settings</h2></div>

<div class="settings-section">
<h3>Account Information</h3>
<div class="input-group"><label>Display Name</label><input type="text" class="input" id="displayName" value="Music Lover"></div>
<div class="input-group"><label>Email</label><input type="email" class="input" id="emailInput" value="user@basspace.com"></div>
<div class="input-group"><label>Bio</label><textarea class="input" id="bioInput" rows="3">Music enthusiast and creator</textarea></div>
<button class="btn btn-primary" onclick="saveAccountInfo()">Save Changes</button>
</div>

<div class="settings-section">
<h3>Site Theme</h3>
<div class="input-group">
<label>Site Background Color</label>
<p style="color:var(--text-secondary);font-size:.875rem;margin-bottom:1rem">Choose a color for the overall site background (not your profile)</p>
<div class="color-input-group">
<input type="color" id="customColorPicker" class="color-picker-input" value="#050d1a">
<button class="btn" onclick="changeBackground(document.getElementById('customColorPicker').value)" style="margin-top:.5rem">Apply Color</button>
</div>
<div class="color-picker-group" style="margin-top:1rem">
<div class="color-option" style="background:#050d1a" onclick="changeBackground('#050d1a')" data-color="#050d1a"></div>
<div class="color-option" style="background:#1a0a29" onclick="changeBackground('#1a0a29')" data-color="#1a0a29"></div>
<div class="color-option" style="background:#0a2914" onclick="changeBackground('#0a2914')" data-color="#0a2914"></div>
<div class="color-option" style="background:#290a0a" onclick="changeBackground('#290a0a')" data-color="#290a0a"></div>
<div class="color-option" style="background:#000000" onclick="changeBackground('#000000')" data-color="#000000"></div>
<div class="color-option" style="background:#1c1c1c" onclick="changeBackground('#1c1c1c')" data-color="#1c1c1c"></div>
</div>
</div>

<div class="input-group" style="margin-top:2rem">
<label>Custom Glow Color (Optional)</label>
<p style="color:var(--text-secondary);font-size:.875rem;margin-bottom:1rem">Override the auto-generated glow color with your own choice</p>
<div class="color-input-group">
<input type="color" id="customGlowPicker" class="color-picker-input" value="">
<button class="btn" onclick="changeSiteGlowColor(document.getElementById('customGlowPicker').value)" style="margin-top:.5rem">Set Glow Color</button>
<button class="btn btn-secondary" onclick="resetSiteGlowColor()" style="margin-top:.5rem">Reset to Auto</button>
<p style="color:var(--text-secondary);font-size:.875rem;margin-top:.5rem">Leave empty to use auto-generated glow based on background color</p>
</div>
</div>
</div>

<div class="settings-section">
<h3>Playback Settings</h3>
<div class="setting-item">
<div class="setting-label"><h4>Autoplay</h4><p>Automatically play next track when current ends</p></div>
<div class="toggle" id="autoplayToggle" onclick="toggleSetting('autoplay')"><div class="toggle-slider"></div></div>
</div>
<div class="setting-item">
<div class="setting-label"><h4>Crossfade</h4><p>Smooth transition between tracks</p></div>
<div class="toggle" id="crossfadeToggle" onclick="toggleSetting('crossfade')"><div class="toggle-slider"></div></div>
</div>
<div class="setting-item">
<div class="setting-label"><h4>High Quality Audio</h4><p>Use higher bitrate for better sound</p></div>
<div class="toggle active" id="hqToggle" onclick="toggleSetting('highQuality')"><div class="toggle-slider"></div></div>
</div>
</div>

<div class="settings-section">
<h3>Notifications</h3>
<div class="setting-item">
<div class="setting-label"><h4>New Followers</h4><p>Get notified when someone follows you</p></div>
<div class="toggle active" id="followersToggle" onclick="toggleSetting('followers')"><div class="toggle-slider"></div></div>
</div>
<div class="setting-item">
<div class="setting-label"><h4>Comments</h4><p>Get notified about comments on your tracks</p></div>
<div class="toggle active" id="commentsToggle" onclick="toggleSetting('comments')"><div class="toggle-slider"></div></div>
</div>
<div class="setting-item">
<div class="setting-label"><h4>Likes</h4><p>Get notified when someone likes your music</p></div>
<div class="toggle active" id="likesToggle" onclick="toggleSetting('likes')"><div class="toggle-slider"></div></div>
</div>
</div>

<div class="settings-section">
<h3>Privacy</h3>
<div class="setting-item">
<div class="setting-label"><h4>Public Profile</h4><p>Allow others to view your profile</p></div>
<div class="toggle active" id="publicToggle" onclick="toggleSetting('public')"><div class="toggle-slider"></div></div>
</div>
<div class="setting-item">
<div class="setting-label"><h4>Show Listening History</h4><p>Display recently played tracks on your profile</p></div>
<div class="toggle active" id="historyToggle" onclick="toggleSetting('history')"><div class="toggle-slider"></div></div>
</div>
<div class="setting-item">
<div class="setting-label"><h4>Show Stats</h4><p>Display play counts and statistics</p></div>
<div class="toggle active" id="statsToggle" onclick="toggleSetting('stats')"><div class="toggle-slider"></div></div>
</div>
</div>

<div class="settings-section">
<h3>Storage & Data</h3>
<div class="setting-item">
<div class="setting-label"><h4>Download Quality</h4><p>Quality for downloaded tracks</p></div>
<select class="input" style="max-width:200px">
<option>High (320kbps)</option>
<option>Medium (192kbps)</option>
<option>Low (128kbps)</option>
</select>
</div>
<div class="setting-item">
<div class="setting-label"><h4>Cache Size</h4><p>Currently using 0 MB</p></div>
<button class="btn btn-secondary">Clear Cache</button>
</div>
</div>

<div class="settings-section">
<h3>Danger Zone</h3>
<button class="btn btn-secondary" style="background:rgba(255,59,48,0.1);border-color:rgba(255,59,48,0.3);color:#ff3b30">Delete Account</button>
<p style="color:var(--text-secondary);font-size:.85rem;margin-top:.5rem">This action cannot be undone</p>
</div>

</div>

<div id="uploadScreen" class="screen">
<div class="section-header"><h2 class="section-title">Upload Music</h2></div>
<div id="uploadArea" class="upload-area">
<input id="fileInput" type="file" multiple accept="audio/*,.mp3,.m4a" style="display:none">
<div class="upload-icon">‚ô™</div>
<h2>Drop your audio files here</h2>
<p>or click to browse your files</p>
</div>
<div id="uploadedTracks" style="display:none">
<div class="section-header"><h2 class="section-title">Recently Uploaded</h2></div>
<div id="recentTrackList" class="track-list"></div>
</div>
</div>

<div id="libraryScreen" class="screen">
<div class="section-header"><h2 class="section-title">Your Library</h2></div>
<div id="trackList" class="track-list"></div>
<div id="emptyState" class="empty-state">
<div class="empty-state-icon">‚ô™</div><h2>Your library is empty</h2><p>Upload some tracks to get started</p>
</div>
</div>
</div>

<div id="createPlaylistModal" class="modal-overlay">
<div class="modal">
<h3>Create Playlist</h3>
<input id="playlistNameInput" type="text" class="input" placeholder="My Playlist">
<div class="modal-buttons">
<button class="btn btn-primary" onclick="confirmCreatePlaylist()">Create</button>
<button class="btn btn-secondary" onclick="closeCreatePlaylist()">Cancel</button>
</div>
</div>
</div>

<!-- View Playlist Modal -->
<div id="playlistViewModal" class="modal-overlay">
<div class="modal" style="max-width:800px;max-height:90vh;overflow-y:auto">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem">
<h3 id="playlistViewTitle">Playlist</h3>
<button onclick="closePlaylistView()" style="background:none;border:none;font-size:1.5rem;cursor:pointer;color:var(--text-primary)">√ó</button>
</div>
<div id="playlistTrackList" class="track-list"></div>
<div id="playlistEmpty" class="empty-state" style="display:none;padding:3rem 1rem">
<div class="empty-state-icon">‚ô™</div>
<h2>No tracks in this playlist</h2>
<p>Add some tracks to get started</p>
</div>
</div>
</div>

<!-- Add to Playlist Modal -->
<div id="editProfileModal" class="modal-overlay">
<div class="modal" style="max-width:700px;max-height:90vh;overflow-y:auto">
<h3>Edit Profile Appearance</h3>

<!-- Profile Song -->
<div class="input-group">
<label>Profile Song</label>
<p style="color:var(--text-secondary);font-size:.85rem;margin-bottom:0.5rem">Choose a song that auto-plays when people visit your profile</p>
<input type="file" id="profileSongInput" accept="audio/*,.mp3,.m4a" style="display:none" onchange="uploadProfileSong(this)">
<div id="profileSongDisplay" style="background:rgba(255,255,255,0.05);border:1px solid var(--border-color);border-radius:8px;padding:1rem;margin-bottom:0.5rem">
<div id="profileSongInfo" style="color:var(--text-secondary);text-align:center">No profile song selected</div>
</div>
<div style="display:flex;gap:0.5rem">
<button class="btn" onclick="document.getElementById('profileSongInput').click()" style="flex:1">Upload Song</button>
<button class="btn btn-secondary" onclick="removeProfileSong()" style="flex:1">Remove Song</button>
</div>
</div>

<!-- Profile Picture -->
<div class="input-group">
<label>Profile Picture</label>
<input type="file" id="profilePicInput" accept="image/*" style="display:none" onchange="uploadProfilePic(this)">
<div class="image-upload-box" id="profilePicPreview" onclick="document.getElementById('profilePicInput').click()" style="height:120px">
<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600">PROFILE IMAGE</div>
<p style="color:var(--text-secondary);font-size:.875rem">Click to upload</p>
</div>
</div>

<!-- Profile Banner -->
<div class="input-group">
<label>Profile Banner</label>
<input type="file" id="bannerInput" accept="image/*" style="display:none" onchange="uploadBanner(this)">
<div class="image-upload-box" id="bannerPreview" onclick="document.getElementById('bannerInput').click()" style="height:100px">
<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600">BANNER IMAGE</div>
<p style="color:var(--text-secondary);font-size:.875rem">Click to upload</p>
</div>
</div>

<!-- Profile Background -->
<div class="input-group">
<label>Profile Background Image</label>
<input type="file" id="profileBackgroundInput" accept="image/*" style="display:none" onchange="uploadProfileBackground(this)">
<div class="image-upload-box" id="profileBackgroundPreview" onclick="document.getElementById('profileBackgroundInput').click()" style="height:100px">
<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600">BACKGROUND IMAGE</div>
<p style="color:var(--text-secondary);font-size:.875rem">Click to upload</p>
</div>
<button class="btn btn-secondary" onclick="removeProfileBackground()" style="margin-top:0.5rem">Remove Background</button>
</div>

<!-- Panel Style -->
<div class="input-group">
<label>Panel Style</label>
<div style="display:flex;gap:1rem;margin-top:0.5rem">
<button class="btn" onclick="setPanelStyle('glass')" id="glassStyleBtn" style="flex:1;background:rgba(255,255,255,0.1)">Frosted Glass</button>
<button class="btn" onclick="setPanelStyle('solid')" id="solidStyleBtn" style="flex:1">Solid Color</button>
</div>
<p style="color:var(--text-secondary);font-size:.85rem;margin-top:0.5rem">Glass style shows background through panels with blur</p>
</div>

<!-- Panel Color (for solid style) -->
<div class="input-group" id="panelColorSection" style="display:none">
<label>Panel Color</label>
<input type="color" id="panelColorPicker" class="color-picker-input" value="#0a0d1a">
<div class="color-picker-group" style="margin-top:1rem">
<div class="color-option" style="background:#0a0d1a" onclick="setPanelColor('#0a0d1a')"></div>
<div class="color-option" style="background:#1a1229" onclick="setPanelColor('#1a1229')"></div>
<div class="color-option" style="background:#0f1f14" onclick="setPanelColor('#0f1f14')"></div>
<div class="color-option" style="background:#1f0f0f" onclick="setPanelColor('#1f0f0f')"></div>
<div class="color-option" style="background:#121212" onclick="setPanelColor('#121212')"></div>
<div class="color-option" style="background:#2a2a2a" onclick="setPanelColor('#2a2a2a')"></div>
</div>
</div>

<!-- Panel Glow -->
<div class="input-group">
<label>Panel Glow Effect</label>
<div style="display:flex;align-items:center;gap:1rem">
<div class="toggle active" id="glowToggle" onclick="togglePanelGlow()"><div class="toggle-slider"></div></div>
<span style="color:var(--text-secondary);font-size:0.875rem">Add subtle glow to panels</span>
</div>
</div>

<!-- Glow Color -->
<div class="input-group" id="glowColorSection">
<label>Glow Color</label>
<input type="color" id="glowColorPicker" class="color-picker-input" value="">
<button class="btn" onclick="setGlowColor()" style="margin-top:0.5rem">Apply Glow Color</button>
<button class="btn btn-secondary" onclick="resetGlowColor()" style="margin-top:0.5rem">Reset to Auto</button>
<p style="color:var(--text-secondary);font-size:.85rem;margin-top:0.5rem">Leave empty for automatic color based on theme</p>
</div>

<!-- Text Color -->
<div class="input-group">
<label>Text Color</label>
<div style="display:flex;gap:1rem">
<button class="btn" onclick="setTextColor('light')" id="lightTextBtn" style="flex:1;background:rgba(255,255,255,0.1)">Light</button>
<button class="btn" onclick="setTextColor('dark')" id="darkTextBtn" style="flex:1">Dark</button>
<button class="btn" onclick="setTextColor('custom')" id="customTextBtn" style="flex:1">Custom</button>
</div>
<input type="color" id="textColorPicker" class="color-picker-input" value="#ffffff" style="margin-top:0.5rem;display:none">
</div>

<!-- Accent Color -->
<div class="input-group">
<label>Accent Color</label>
<input type="color" id="accentColorPicker" class="color-picker-input" value="">
<button class="btn" onclick="setAccentColor()" style="margin-top:0.5rem">Apply Accent Color</button>
<p style="color:var(--text-secondary);font-size:.85rem;margin-top:0.5rem">Used for buttons, highlights, and interactive elements</p>
</div>

<div class="modal-buttons">
<button class="btn btn-primary" onclick="saveProfileCustomization()">Save Changes</button>
<button class="btn btn-secondary" onclick="resetProfileCustomization()">Reset to Default</button>
<button class="btn btn-secondary" onclick="closeEditProfileModal()">Close</button>
</div>
</div>
</div>

<div id="editTrackModal" class="modal-overlay">
<div class="modal">
<h3>Edit Track</h3>
<input type="file" id="albumArtInput" accept="image/*" style="display:none">
<div class="album-art-upload" id="albumArtPreview" onclick="document.getElementById('albumArtInput').click()">
<div>‚ô™</div>
</div>
<p style="text-align:center;color:var(--text-secondary);font-size:.875rem;margin-bottom:1.5rem">Click to add album artwork</p>
<div class="input-group"><label>Track Title</label><input type="text" class="input" id="editTrackTitle" placeholder="Enter track title"></div>
<div class="input-group"><label>Artist</label><input type="text" class="input" id="editTrackArtist" placeholder="Enter artist name"></div>
<div class="input-group"><label>Album</label><input type="text" class="input" id="editTrackAlbum" placeholder="Enter album name"></div>
<div class="modal-buttons">
<button class="btn btn-primary" onclick="saveTrackEdit()">Save Changes</button>
<button class="btn btn-secondary" onclick="closeEditTrack()">Cancel</button>
</div>
</div>
</div>

<div class="upload-progress" id="uploadProgress">
<div class="spinner"></div>
<h3 style="margin-bottom:.5rem;font-weight:700">Processing Audio</h3>
<p style="color:var(--text-secondary);font-size:.875rem">This may take a moment...</p>
</div>

<div class="player-bar" id="playerBar">
<div class="player-content">
<div class="player-track-info">
<div class="player-track-art" id="playerArt">‚ô™</div>
<div class="player-text">
<div class="player-title" id="playerTitle">No track playing</div>
<div class="player-artist" id="playerArtist">Select a track to begin</div>
</div>
</div>

<div class="player-center">
<div class="player-controls">
<button class="player-btn" id="repeatBtn" onclick="toggleRepeat()">‚Üª</button>
<button class="player-btn" id="prevBtn" onclick="playPrevious()">‚èÆ</button>
<button class="player-btn player-btn-main" id="playPauseBtn" onclick="togglePlayPause()"><span id="playerPlayIcon">‚ñ∂</span></button>
<button class="player-btn" id="nextBtn" onclick="playNext()">‚è≠</button>
<button class="player-btn player-menu-btn" id="playerMenuBtn" onclick="togglePlayerMenu()">‚ãÆ</button>
</div>
<div class="progress-container">
<div class="progress-time" id="currentTime">0:00</div>
<div class="progress-bar" id="progressBar" onclick="seekTrack(event)">
<div class="progress-fill" id="progressFill"></div>
</div>
<div class="progress-time" id="totalTime">0:00</div>
</div>
</div>

<div class="player-right">
<div class="volume-control">
<div class="volume-icon" onclick="toggleMute()">VOL</div>
<input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70">
</div>
<div class="player-menu">
<button class="player-menu-btn" onclick="togglePlayerMenu()">‚ãØ</button>
<div class="player-menu-dropdown" id="playerMenuDropdown">
<div class="player-menu-item" onclick="addToPlaylist()">+ Add to Playlist</div>
<div class="player-menu-item" onclick="addToLibrary()">+ Add to Library</div>
<div class="player-menu-item" onclick="downloadCurrentTrack()">‚Üì Download</div>
</div>
</div>
</div>
</div>
</div>

<!-- Toast Notification Container -->
<div id="toastContainer" style="position:fixed;top:5rem;right:2rem;z-index:10000;display:flex;flex-direction:column;gap:0.75rem;pointer-events:none"></div>

<audio id="audioPlayer" crossorigin="anonymous" style="display:none"></audio>
<script>
let tracks=[],allUserTracks=[],totalPlays=0,currentPlayingId=null,playlists=[],currentProfileTab='tracks',profilePicture='ML',profileBanner='linear-gradient(135deg,#0a1929,#132f4c)',profileBackground='#050d1a',customGlowColor=null,currentEditingTrack=null,currentEditingAlbumArt=null,recentlyPlayed=[],isRepeat=!1,currentTrack=null;const audioPlayer=document.getElementById('audioPlayer'),fileInput=document.getElementById('fileInput'),uploadArea=document.getElementById('uploadArea'),trackList=document.getElementById('trackList'),emptyState=document.getElementById('emptyState'),searchInput=document.getElementById('searchInput'),profileBtn=document.getElementById('profileBtn'),dropdown=document.getElementById('dropdown'),volumeSlider=document.getElementById('volumeSlider'),albumArtInput=document.getElementById('albumArtInput');function generateCompleteTheme(e){const t=hexToRgb(e),baseHsl=rgbToHsl(t.r,t.g,t.b),n=(299*t.r+587*t.g+114*t.b)/1e3<128,r=Math.abs(t.r-t.g)<10&&Math.abs(t.g-t.b)<10&&Math.abs(t.r-t.b)<10;let o,a,c;if(r){const r=Math.round((t.r+t.g+t.b)/3);o=rgbToHex(Math.min(255,Math.round(r*1.4)),Math.min(255,Math.round(r*1.4)),Math.min(255,Math.round(r*1.4))),a=rgbToHex(Math.min(255,Math.round(r*1.8)),Math.min(255,Math.round(r*1.8)),Math.min(255,Math.round(r*1.8))),c=n?"#5090d3":"#2d5a8c"}else{o=hslToHex(baseHsl.h,baseHsl.s,n?Math.min(baseHsl.l*1.4,35):Math.max(baseHsl.l*0.85,5)),a=hslToHex(baseHsl.h,baseHsl.s,n?Math.min(baseHsl.l*1.8,45):Math.max(baseHsl.l*0.7,3)),c=hslToHex(baseHsl.h,Math.min(baseHsl.s*1.1,100),n?Math.min(baseHsl.l*3,65):Math.min(baseHsl.l*1.5,50))}const isVeryLight=baseHsl.l>85;const i="#ffffff",l="#ffffff",s=isVeryLight?"rgba(0, 0, 0, 0.12)":"rgba(255, 255, 255, 0.12)";const navHsl=rgbToHsl(t.r,t.g,t.b);const panelBorder=baseHsl.l>50?"rgba(0,0,0,0.3)":"rgba(255,255,255,0.3)";const lightBorder=hslToHex(baseHsl.h,Math.max(baseHsl.s*0.8,40),75);const lightGlow=hslToHex(baseHsl.h,Math.min(baseHsl.s*1.3,100),Math.min(baseHsl.l*5,90));const finalAccent=customGlowColor||c;document.documentElement.style.setProperty('--bg-primary',e),document.documentElement.style.setProperty('--bg-secondary',o),document.documentElement.style.setProperty('--bg-tertiary',a),document.documentElement.style.setProperty('--accent',finalAccent),document.documentElement.style.setProperty('--border-light',lightBorder),document.documentElement.style.setProperty('--accent-light',lightGlow),document.documentElement.style.setProperty('--text-primary',i),document.documentElement.style.setProperty('--text-secondary',l),document.documentElement.style.setProperty('--border-color',s),document.documentElement.style.setProperty('--border-dark',panelBorder),document.documentElement.style.setProperty('--nav-hue',navHsl.h),document.documentElement.style.setProperty('--nav-sat',navHsl.s+'%'),document.documentElement.style.setProperty('--nav-light',Math.min(navHsl.l*1.3,30)+'%')}function hexToRgb(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:{r:5,g:13,b:26}}function rgbToHex(e,t,n){return"#"+((1<<24)+(e<<16)+(t<<8)+n).toString(16).slice(1)}function rgbToHsl(r,g,b){r/=255,g/=255,b/=255;const max=Math.max(r,g,b),min=Math.min(r,g,b);let h,s,l=(max+min)/2;if(max===min){h=s=0}else{const d=max-min;s=l>.5?d/(2-max-min):d/(max+min);switch(max){case r:h=((g-b)/d+(g<b?6:0))/6;break;case g:h=((b-r)/d+2)/6;break;case b:h=((r-g)/d+4)/6;break}}return{h:Math.round(h*360),s:Math.round(s*100),l:Math.round(l*100)}}function hslToHex(h,s,l){s/=100,l/=100;const c=(1-Math.abs(2*l-1))*s,x=c*(1-Math.abs((h/60)%2-1)),m=l-c/2;let r=0,g=0,b=0;if(h>=0&&h<60){r=c,g=x,b=0}else if(h>=60&&h<120){r=x,g=c,b=0}else if(h>=120&&h<180){r=0,g=c,b=x}else if(h>=180&&h<240){r=0,g=x,b=c}else if(h>=240&&h<300){r=x,g=0,b=c}else if(h>=300&&h<360){r=c,g=0,b=x}r=Math.round((r+m)*255),g=Math.round((g+m)*255),b=Math.round((b+m)*255);return rgbToHex(r,g,b)}function adjustBrightness(e,t){const n=hexToRgb(e);return rgbToHex(Math.min(255,Math.max(0,Math.round(n.r*t))),Math.min(255,Math.max(0,Math.round(n.g*t))),Math.min(255,Math.max(0,Math.round(n.b*t))))}function generateAccentColor(e,t){if(t){const t=Math.max(e.r,e.g,e.b);if(t<80)return rgbToHex(Math.min(255,Math.round(e.r*3.5)),Math.min(255,Math.round(e.g*3.5)),Math.min(255,Math.round(e.b*3.5)));const n=t<150?300/t:2.2;return rgbToHex(Math.min(255,Math.round(e.r*n)),Math.min(255,Math.round(e.g*n)),Math.min(255,Math.round(e.b*n)))}const n=Math.max(e.r,e.g,e.b);return n>200?rgbToHex(Math.round(.4*e.r),Math.round(.4*e.g),Math.round(.4*e.b)):rgbToHex(Math.round(.6*e.r),Math.round(.6*e.g),Math.round(.6*e.b))}function formatTime(e){if(isNaN(e))return'0:00';const t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n.toString().padStart(2,'0')}`}function seekTrack(e){const t=document.getElementById('progressBar');audioPlayer.currentTime=(e.clientX-t.getBoundingClientRect().left)/t.offsetWidth*audioPlayer.duration}function toggleRepeat(){isRepeat=!isRepeat,document.getElementById('repeatBtn').classList.toggle('active',isRepeat)}function toggleMute(){audioPlayer.volume>0?(audioPlayer.volume=0,volumeSlider.value=0):(audioPlayer.volume=.7,volumeSlider.value=70)}function togglePlayPause(){currentPlayingId&&(audioPlayer.paused?(audioPlayer.play(),document.getElementById('playerPlayIcon').textContent='‚è∏'):(audioPlayer.pause(),document.getElementById('playerPlayIcon').textContent='‚ñ∂'))}function togglePlayerMenu(){document.getElementById('playerMenuDropdown').classList.toggle('show')}
function playPrevious(){if(!currentPlayingId||allUserTracks.length===0)return;const currentIndex=allUserTracks.findIndex(t=>t.id===currentPlayingId);if(currentIndex===-1)return;const prevIndex=currentIndex===0?allUserTracks.length-1:currentIndex-1;const prevTrack=allUserTracks[prevIndex];togglePlay(prevTrack.id)}
function playNext(){if(!currentPlayingId||allUserTracks.length===0)return;const currentIndex=allUserTracks.findIndex(t=>t.id===currentPlayingId);if(currentIndex===-1)return;const nextIndex=currentIndex===allUserTracks.length-1?0:currentIndex+1;const nextTrack=allUserTracks[nextIndex];togglePlay(nextTrack.id)}
function addToPlaylist(){togglePlayerMenu(),currentTrack&&playlists.length>0?alert('Select a playlist (feature in progress)'):alert('Create a playlist first!')}function addToLibrary(){togglePlayerMenu(),currentTrack&&!tracks.find(e=>e.id===currentTrack.id)&&(tracks.push(currentTrack),saveData(),renderLibrary(),alert('Added to your library!'))}function downloadCurrentTrack(){togglePlayerMenu(),currentTrack&&downloadTrack(currentTrack.id)}function updatePlayerBar(e){currentTrack=e;const t=document.getElementById('playerBar'),n=document.getElementById('playerArt');document.getElementById('playerTitle').textContent=e.title,document.getElementById('playerArtist').textContent=`${e.artist} ‚Ä¢ ${e.album}`,t.classList.add('active'),e.albumArt?(n.style.backgroundImage=`url(${e.albumArt})`,n.textContent=''):(n.style.backgroundImage='',n.textContent='‚ô™'),document.getElementById('playerPlayIcon').textContent='‚è∏',recentlyPlayed.find(t=>t.id===e.id)||(recentlyPlayed.unshift(e),recentlyPlayed.length>10&&recentlyPlayed.pop(),renderRecentlyPlayed(),saveData())}function renderRecentlyPlayed(){const e=document.getElementById('recentlyPlayedSection'),t=document.getElementById('recentlyPlayedList');recentlyPlayed.length>0?(e.style.display='block',t.innerHTML=recentlyPlayed.map(e=>`<div class="album-card" onclick="togglePlay('${e.id}')"><div class="album-art-large" style="${e.albumArt?`background-image:url(${e.albumArt})`:''}"> ${e.albumArt?'':'‚ô™'}<div class="play-overlay"><button class="play-overlay-btn">‚ñ∂</button></div></div><div class="album-title">${e.title}</div><div class="album-artist">${e.artist}</div></div>`).join('')):e.style.display='none'}function openEditTrack(e){const t=tracks.find(t=>t.id===e)||allUserTracks.find(t=>t.id===e);if(!t)return;currentEditingTrack=t,currentEditingAlbumArt=t.albumArt||null,document.getElementById('editTrackTitle').value=t.title,document.getElementById('editTrackArtist').value=t.artist,document.getElementById('editTrackAlbum').value=t.album;const n=document.getElementById('albumArtPreview');t.albumArt?(n.style.backgroundImage=`url(${t.albumArt})`,n.style.backgroundSize='cover',n.style.backgroundPosition='center',n.textContent='',n.classList.add('has-image')):(n.style.backgroundImage='',n.style.backgroundSize='',n.style.backgroundPosition='',n.innerHTML='<div>‚ô™</div>',n.classList.remove('has-image')),document.getElementById('editTrackModal').classList.add('show')}function closeEditTrack(){document.getElementById('editTrackModal').classList.remove('show'),currentEditingTrack=null,currentEditingAlbumArt=null}function saveTrackEdit(){currentEditingTrack&&(currentEditingTrack.title=document.getElementById('editTrackTitle').value||currentEditingTrack.title,currentEditingTrack.artist=document.getElementById('editTrackArtist').value||'Unknown Artist',currentEditingTrack.album=document.getElementById('editTrackAlbum').value||'Unknown Album',currentEditingTrack.albumArt=currentEditingAlbumArt,closeEditTrack(),saveData(),updateStats(),renderLibrary(),renderPopularTracks(),renderProfile(),renderRecentUploads(),renderRecentlyPlayed())}function loadData(){const e=localStorage.getItem('basspace_data');if(e)try{const e=JSON.parse(localStorage.getItem('basspace_data'));tracks=e.tracks||[],allUserTracks=e.allUserTracks||[],playlists=e.playlists||[],totalPlays=e.totalPlays||0,recentlyPlayed=e.recentlyPlayed||[],profilePicture=e.profilePicture||'ML',profileBanner=e.profileBanner||'linear-gradient(135deg,#0a1929,#132f4c)',profileBackground=e.profileBackground||'#050d1a',customGlowColor=e.customGlowColor||null,document.body.style.background=profileBackground,generateCompleteTheme(profileBackground),tracks.forEach(e=>{e.isPlaying=!1,e.audioData&&(e.dataUrl=e.audioData)}),allUserTracks.forEach(e=>{e.isPlaying=!1,e.audioData&&(e.dataUrl=e.audioData)}),updateStats(),renderLibrary(),renderPopularTracks(),renderProfile(),renderRecentlyPlayed(),updateBackgroundPreview(),updateColorSelection()}catch(e){console.error('Error loading data:',e)}}function saveData(){const e={tracks:tracks.map(e=>({id:e.id,title:e.title,artist:e.artist,album:e.album,albumArt:e.albumArt,audioData:e.audioData,duration:e.duration,filename:e.filename})),allUserTracks:allUserTracks.map(e=>({id:e.id,title:e.title,artist:e.artist,album:e.album,albumArt:e.albumArt,audioData:e.audioData,duration:e.duration,filename:e.filename})),playlists:playlists,totalPlays:totalPlays,recentlyPlayed:recentlyPlayed.map(e=>({id:e.id,title:e.title,artist:e.artist,album:e.album,albumArt:e.albumArt})),profilePicture:profilePicture,profileBanner:profileBanner,profileBackground:profileBackground,customGlowColor:customGlowColor};try{localStorage.setItem('basspace_data',JSON.stringify(e))}catch(e){'QuotaExceededError'===e.name&&alert('Storage limit exceeded! Try uploading smaller or fewer audio files.')}}function showScreen(e){document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active')),document.getElementById(e+'Screen').classList.add('active'),dropdown.classList.remove('show'),document.querySelectorAll('.nav-link').forEach(e=>{e.classList.remove('active')}),'home'===e&&(document.querySelector('.nav-link').classList.add('active'),renderPopularTracks()),'library'===e&&document.querySelectorAll('.nav-link')[1].classList.add('active'),'upload'===e&&document.querySelectorAll('.nav-link')[2].classList.add('active'),'profile'===e&&(renderProfile(),applyProfileStyles()),'settings'===e&&(updateProfilePicPreview(),updateBannerPreview(),updateBackgroundPreview(),updateColorSelection()),updateStats()}function saveProfile(){const e=document.getElementById('displayName').value;document.getElementById('bioInput').value;document.getElementById('profileUsername').textContent=e,document.getElementById('profileBio').textContent=document.getElementById('bioInput').value,saveData(),alert('Profile updated successfully!')}function uploadProfilePic(e){if(e.files&&e.files[0]){const t=new FileReader;t.onload=e=>{profilePicture=e.target.result,updateProfilePicPreview(),applyProfileStyles(),saveData()},t.readAsDataURL(e.files[0])}}
function uploadBanner(e){if(e.files&&e.files[0]){const t=new FileReader;t.onload=e=>{profileBanner=`url(${e.target.result})`,updateBannerPreview(),applyProfileStyles(),saveData()},t.readAsDataURL(e.files[0])}}

function uploadProfileBackground(input) {
  if (input.files && input.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      profileBackground = `url(${e.target.result})`;
      updateProfileBackgroundPreview();
      applyProfileStyles();
      saveData();
    };
    reader.readAsDataURL(input.files[0]);
  }
}

function removeProfileBackground() {
  profileBackground = null;
  updateProfileBackgroundPreview();
  applyProfileStyles();
  saveData();
}

function updateProfileBackgroundPreview() {
  const preview = document.getElementById('profileBackgroundPreview');
  if (profileBackground && profileBackground.startsWith('url')) {
    const url = profileBackground.match(/url\(([^)]+)\)/)[1];
    preview.innerHTML = `<img src="${url}" class="image-preview" alt="Profile Background">`;
    preview.classList.add('has-image');
  } else {
    preview.innerHTML = '<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600">PROFILE BACKGROUND</div><p style="color:var(--text-secondary);font-size:.875rem">Click to upload background image</p>';
    preview.classList.remove('has-image');
  }
}

function uploadBackground(e){if(e.files&&e.files[0]){const t=new FileReader;t.onload=e=>{profileBackground=`url(${e.target.result})`,document.body.style.background=profileBackground,document.body.style.backgroundSize='cover',document.body.style.backgroundPosition='center',document.body.style.backgroundAttachment='fixed',updateBackgroundPreview(),updateColorSelection(),saveData()},t.readAsDataURL(e.files[0])}}function changeBackground(e){profileBackground=e,document.body.style.background=e,document.body.style.backgroundSize='',document.body.style.backgroundPosition='',document.body.style.backgroundAttachment='',generateCompleteTheme(e),updateColorSelection(),updateBackgroundPreview(),document.getElementById('customColorPicker').value=e,saveData()}
function changeGlowColor(color){customGlowColor=color;generateCompleteTheme(profileBackground);document.getElementById('customGlowPicker').value=color;saveData();alert('Custom glow color set!')}
function resetGlowColor(){customGlowColor=null;generateCompleteTheme(profileBackground);document.getElementById('customGlowPicker').value='';saveData();alert('Glow color reset to auto!')}
function updateProfilePicPreview(){const e=document.getElementById('profilePicPreview');profilePicture&&'ML'!==profilePicture&&!profilePicture.startsWith('data:')?(e.innerHTML='<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600;">PROFILE IMAGE</div><p style="color:var(--text-secondary);font-size:.875rem;">Click to upload</p>',e.classList.remove('has-image')):profilePicture.startsWith('data:')?(e.innerHTML=`<img src="${profilePicture}" class="image-preview" alt="Profile Picture">`,e.classList.add('has-image')):(e.innerHTML='<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600;">PROFILE IMAGE</div><p style="color:var(--text-secondary);font-size:.875rem;">Click to upload</p>',e.classList.remove('has-image'))}function updateBannerPreview(){const e=document.getElementById('bannerPreview');if(profileBanner.startsWith('url')){const t=profileBanner.match(/url\(([^)]+)\)/)[1];e.innerHTML=`<img src="${t}" class="image-preview" alt="Banner">`,e.classList.add('has-image')}else e.innerHTML='<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600;">BANNER IMAGE</div><p style="color:var(--text-secondary);font-size:.875rem;">Click to upload</p>',e.classList.remove('has-image')}function updateBackgroundPreview(){const e=document.getElementById('backgroundPreview');if(profileBackground.startsWith('url')){const t=profileBackground.match(/url\(([^)]+)\)/)[1];e.innerHTML=`<img src="${t}" class="image-preview" alt="Background">`,e.classList.add('has-image')}else e.innerHTML='<div style="font-size:1.5rem;margin-bottom:.5rem;color:var(--text-secondary);font-weight:600;">BACKGROUND IMAGE</div><p style="color:var(--text-secondary);font-size:.875rem;">Click to upload</p>',e.classList.remove('has-image')}function updateColorSelection(){document.querySelectorAll('.color-option').forEach(e=>{e.classList.remove('selected'),e.dataset.color===profileBackground&&e.classList.add('selected')})}function resetCustomization(){confirm('Reset all customization to defaults?')&&(profilePicture='ML',profileBanner='linear-gradient(135deg,#0a1929,#132f4c)',profileBackground='#050d1a',document.body.style.background=profileBackground,document.body.style.backgroundSize='',document.body.style.backgroundPosition='',document.body.style.backgroundAttachment='',generateCompleteTheme(profileBackground),updateProfilePicPreview(),updateBannerPreview(),updateBackgroundPreview(),updateColorSelection(),applyProfileStyles(),saveData(),alert('Customization reset to defaults!'))}function applyProfileStyles(){const e=document.getElementById('profileAvatarEl');profilePicture&&'ML'!==profilePicture&&profilePicture.startsWith('data:')?(e.style.backgroundImage=`url(${profilePicture})`,e.style.backgroundSize='cover',e.style.backgroundPosition='center',e.textContent=''):(e.style.backgroundImage='',e.textContent='ML'),profileBanner.startsWith('url')?(document.getElementById('profileBannerEl').style.background=profileBanner,document.getElementById('profileBannerEl').style.backgroundSize='cover',document.getElementById('profileBannerEl').style.backgroundPosition='center'):(document.getElementById('profileBannerEl').style.background=profileBanner,document.getElementById('profileBannerEl').style.backgroundSize='',document.getElementById('profileBannerEl').style.backgroundPosition=''),profileBackground.startsWith('url')?(document.body.style.background=profileBackground,document.body.style.backgroundSize='cover',document.body.style.backgroundPosition='center',document.body.style.backgroundAttachment='fixed'):(document.body.style.background=profileBackground,document.body.style.backgroundSize='',document.body.style.backgroundPosition='',document.body.style.backgroundAttachment='')}function showProfileTab(e){currentProfileTab=e;const t=document.querySelector("[onclick=\"showProfileTab('tracks')\"]");document.getElementById('playlistTabBtn');t.classList.toggle('active','tracks'===e),document.getElementById('playlistTabBtn').classList.toggle('active','playlists'===e),document.getElementById('profileTracksSection').style.display='tracks'===e?'block':'none',document.getElementById('profilePlaylistsSection').style.display='playlists'===e?'block':'none',renderProfile()}function renderProfile(){if(document.getElementById('profileTrackCount').textContent=tracks.length,document.getElementById('profilePlaylistCount').textContent=playlists.length,'tracks'===currentProfileTab){const e=document.getElementById('profileTrackList'),t=document.getElementById('profileEmptyTracks');0===tracks.length?(e.innerHTML='',t.style.display='block'):(t.style.display='none',e.innerHTML=tracks.map((e,t)=>`<div class="track"><div class="track-content"><div class="track-number">${e.isPlaying?'‚ô™':t+1}</div>${e.albumArt?`<div class="track-art" style="background-image:url(${e.albumArt})"></div>`:'<div class="track-art">‚ô™</div>'}<button class="play-btn" onclick="togglePlay('${e.id}')">${e.isPlaying?'‚è∏':'‚ñ∂'}</button><div class="track-info"><div class="track-title">${e.title}</div><div class="track-artist">${e.artist} ‚Ä¢ ${e.album}</div><div class="track-duration">${formatDuration(e.duration)}</div></div><div class="track-actions"><button class="btn-small" onclick="openEditTrack('${e.id}')">Edit</button><button class="btn-small" onclick="downloadTrack('${e.id}')">Download</button></div></div></div>`).join(''))}else{const e=document.getElementById('profilePlaylistList'),t=document.getElementById('profileEmptyPlaylists');0===playlists.length?(e.innerHTML='',t.style.display='block'):(t.style.display='none',e.innerHTML=playlists.map(e=>`<div class="playlist-card"><div class="playlist-icon">‚ô™</div><h3 class="playlist-name">${e.name}</h3><p class="playlist-count">${e.trackIds.length} tracks</p></div>`).join(''))}}function OLD_handleFiles_DISABLED(e){const t=Array.from(e).filter(e=>/audio\//.test(e.type)||/\.(mp3|m4a)$/i.test(e.name));if(0===t.length)return;document.getElementById('uploadProgress').classList.add('show');let n=0;t.forEach(e=>{const r=new FileReader;r.onload=function(r){const o=r.target.result,a={id:Math.random().toString(36).slice(2),audioData:o,dataUrl:o,title:e.name.replace(/\.(mp3|m4a|mp4)$/i,''),artist:'Unknown Artist',album:'Unknown Album',albumArt:null,duration:null,isPlaying:!1,filename:e.name},c=new Audio;c.src=o,c.onloadedmetadata=function(){a.duration=c.duration,tracks.push(a),allUserTracks.push(a),++n===t.length&&(document.getElementById('uploadProgress').classList.remove('show'),1===t.length&&openEditTrack(a.id),updateStats(),renderLibrary(),renderPopularTracks(),renderRecentUploads(),saveData())}},r.readAsDataURL(e)})}function renderRecentUploads(){const e=document.getElementById('uploadedTracks'),t=document.getElementById('recentTrackList');if(allUserTracks.length>0){e.style.display='block';const n=allUserTracks.slice(-10).reverse();t.innerHTML=n.map((e,t)=>`<div class="track"><div class="track-content"><div class="track-number">${e.isPlaying?'‚ô™':t+1}</div>${e.albumArt?`<div class="track-art" style="background-image:url(${e.albumArt})"></div>`:'<div class="track-art">‚ô™</div>'}<button class="play-btn" onclick="togglePlay('${e.id}')">${e.isPlaying?'‚è∏':'‚ñ∂'}</button><div class="track-info"><div class="track-title">${e.title}</div><div class="track-artist">${e.artist} ‚Ä¢ ${e.album}</div><div class="track-duration">${formatDuration(e.duration)}</div></div><div class="track-actions"><button class="btn-small" onclick="openEditTrack('${e.id}')">Edit</button><button class="btn-small" onclick="downloadTrack('${e.id}')">Download</button></div></div></div>`).join('')}else e.style.display='none'}function openCreatePlaylist(){document.getElementById('createPlaylistModal').classList.add('show'),dropdown.classList.remove('show')}function closeCreatePlaylist(){document.getElementById('createPlaylistModal').classList.remove('show'),document.getElementById('playlistNameInput').value=''}function confirmCreatePlaylist(){const e=document.getElementById('playlistNameInput').value.trim();e&&(playlists.push({id:Math.random().toString(36).slice(2),name:e,trackIds:[]}),closeCreatePlaylist(),updateStats(),renderProfile(),saveData())}function renderPopularTracks(e){const t=document.getElementById('popularTracks'),n=document.getElementById('noMusic'),r=document.getElementById('noResults'),o=e||allUserTracks;r.style.display='none',n.style.display='none',0===o.length?(t.innerHTML='',(e?r:n).style.display='block'):t.innerHTML=o.slice(0,20).map((e,t)=>`<div class="track"><div class="track-content"><div class="track-number">${e.isPlaying?'‚ô™':t+1}</div>${e.albumArt?`<div class="track-art" style="background-image:url(${e.albumArt})"></div>`:'<div class="track-art">‚ô™</div>'}<button class="play-btn" onclick="togglePlay('${e.id}')">${e.isPlaying?'‚è∏':'‚ñ∂'}</button><div class="track-info"><div class="track-title">${e.title}</div><div class="track-artist">${e.artist} ‚Ä¢ ${e.album}</div><div class="track-duration">${formatDuration(e.duration)}</div></div><div class="track-actions"><button class="btn-small" onclick="downloadTrack('${e.id}')">Download</button></div></div></div>`).join('')}function togglePlay(e){const t=tracks.find(t=>t.id===e)||allUserTracks.find(t=>t.id===e);if(!t)return;if(currentPlayingId!==e||audioPlayer.paused){if(currentPlayingId===e&&audioPlayer.paused)audioPlayer.play(),t.isPlaying=!0,document.getElementById('playerPlayIcon').textContent='‚è∏';else{tracks.forEach(e=>e.isPlaying=!1),allUserTracks.forEach(e=>e.isPlaying=!1);const n=t.dataUrl||t.audioData;audioPlayer.src=n,audioPlayer.load(),audioPlayer.play().then(()=>{currentPlayingId=e,t.isPlaying=!0,totalPlays++,updatePlayerBar(t),updateStats(),renderLibrary(),renderPopularTracks(),renderProfile()}).catch(e=>{console.error('Error playing audio:',e),alert('Error playing this track. The audio data may be corrupted.')})}}else audioPlayer.pause(),t.isPlaying=!1,document.getElementById('playerPlayIcon').textContent='‚ñ∂';renderLibrary(),renderPopularTracks(),renderProfile()}function downloadTrack(e){const t=tracks.find(t=>t.id===e)||allUserTracks.find(t=>t.id===e);if(!t)return;const n=document.createElement('a');n.href=t.dataUrl||t.audioData,n.download=t.filename||'track.mp3',n.click()}function deleteTrack(e){tracks=tracks.filter(t=>t.id!==e),allUserTracks=allUserTracks.filter(t=>t.id!==e),currentPlayingId===e&&(audioPlayer.pause(),currentPlayingId=null,document.getElementById('playerBar').classList.remove('active')),updateStats(),renderLibrary(),renderPopularTracks(),saveData()}function formatDuration(e){if(!e||isNaN(e))return'--:--';const t=Math.floor(e/60),n=Math.floor(e%60);return`${t}:${n.toString().padStart(2,'0')}`}function updateStats(){document.getElementById('totalTracks').textContent=allUserTracks.length,document.getElementById('trackCount').textContent=tracks.length,document.getElementById('totalArtists').textContent=new Set(allUserTracks.map(e=>e.artist)).size,document.getElementById('totalPlays').textContent=totalPlays}function renderLibrary(){0===tracks.length?(trackList.innerHTML='',emptyState.style.display='block'):(emptyState.style.display='none',trackList.innerHTML=tracks.map((e,t)=>`<div class="track"><div class="track-content"><div class="track-number">${e.isPlaying?'‚ô™':t+1}</div>${e.albumArt?`<div class="track-art" style="background-image:url(${e.albumArt})"></div>`:'<div class="track-art">‚ô™</div>'}<button class="play-btn" onclick="togglePlay('${e.id}')">${e.isPlaying?'‚è∏':'‚ñ∂'}</button><div class="track-info"><div class="track-title">${e.title}</div><div class="track-artist">${e.artist} ‚Ä¢ ${e.album}</div><div class="track-duration">${formatDuration(e.duration)}</div></div><div class="track-actions"><button class="btn-small" onclick="openEditTrack('${e.id}')">Edit</button><button class="btn-small" onclick="downloadTrack('${e.id}')">Download</button><button class="btn-small" onclick="deleteTrack('${e.id}')">Delete</button></div></div></div>`).join(''))}audioPlayer.volume=.7,volumeSlider.value=70,volumeSlider.oninput=function(){audioPlayer.volume=this.value/100},albumArtInput.onchange=function(e){if(e.target.files&&e.target.files[0]){const t=new FileReader;t.onload=function(e){currentEditingAlbumArt=e.target.result;const t=document.getElementById('albumArtPreview');t.style.backgroundImage=`url(${currentEditingAlbumArt})`,t.style.backgroundSize='cover',t.style.backgroundPosition='center',t.textContent='',t.classList.add('has-image')},t.readAsDataURL(e.target.files[0])}},//loadData() DISABLED - using cloud storage now,profileBtn.onclick=e=>{e.stopPropagation(),dropdown.classList.toggle('show')},document.onclick=e=>{e.target.closest('.profile-menu')||dropdown.classList.remove('show'),e.target.closest('.player-menu')||document.getElementById('playerMenuDropdown').classList.remove('show')},uploadArea.onclick=()=>fileInput.click(),uploadArea.ondragover=e=>{e.preventDefault(),uploadArea.classList.add('drag-active')},uploadArea.ondragleave=()=>uploadArea.classList.remove('drag-active'),uploadArea.ondrop=e=>{e.preventDefault(),uploadArea.classList.remove('drag-active'),handleFiles(e.dataTransfer.files)},fileInput.onchange=e=>handleFiles(e.target.files),searchInput&&(searchInput.oninput=()=>{const e=searchInput.value.toLowerCase().trim();renderPopularTracks(e?allUserTracks.filter(t=>t.title.toLowerCase().includes(e)||t.artist.toLowerCase().includes(e)||t.album.toLowerCase().includes(e)):null)}),audioPlayer.ontimeupdate=function(){isNaN(audioPlayer.duration)||(document.getElementById('progressFill').style.width=audioPlayer.currentTime/audioPlayer.duration*100+'%',document.getElementById('currentTime').textContent=formatTime(audioPlayer.currentTime),document.getElementById('totalTime').textContent=formatTime(audioPlayer.duration))},audioPlayer.onended=()=>{isRepeat&&currentPlayingId?(audioPlayer.currentTime=0,audioPlayer.play()):(tracks.forEach(e=>e.isPlaying=!1),allUserTracks.forEach(e=>e.isPlaying=!1),currentPlayingId=null,document.getElementById('playerPlayIcon').textContent='‚ñ∂',renderLibrary(),renderPopularTracks(),renderProfile())},updateStats(),renderLibrary(),renderPopularTracks(),applyProfileStyles(),renderRecentlyPlayed();

// Initialize theme on page load
generateCompleteTheme(profileBackground);

// Load customization data from localStorage
function loadCustomizationData() {
  try {
    const savedData = localStorage.getItem('basspace_data');
    if (savedData) {
      const data = JSON.parse(savedData);
      
      // Load site background color (for whole site, not profile)
      if (data.siteBackgroundColor) {
        document.body.style.background = data.siteBackgroundColor;
        generateCompleteTheme(data.siteBackgroundColor);
      }
      
      // Load playlists
      if (data.playlists) {
        playlists = data.playlists;
      }
      
      // Load profile images
      if (data.profilePicture) {
        profilePicture = data.profilePicture;
      }
      if (data.profileBanner) {
        profileBanner = data.profileBanner;
      }
      if (data.profileBackground) {
        profileBackground = data.profileBackground;
      }
      if (data.customGlowColor) {
        customGlowColor = data.customGlowColor;
      }
      
      // Load profile customization
      if (data.profileCustomization) {
        profileCustomization = data.profileCustomization;
      }
      
      // Load profile song
      if (data.profileSong) {
        profileSong = data.profileSong;
      }
      
      // Apply customization
      applyProfileStyles();
      applyProfileCustomization();
      
      console.log('‚úÖ Customization data loaded from localStorage');
    }
  } catch (error) {
    console.error('Error loading customization data:', error);
  }
}

// Call on page load
loadCustomizationData();

// CRITICAL: Re-apply site background after applyProfileStyles runs
// This ensures siteBackgroundColor is not overwritten by profileBackground
setTimeout(() => {
  const savedData = localStorage.getItem('basspace_data');
  if (savedData) {
    const data = JSON.parse(savedData);
    if (data.siteBackgroundColor) {
      document.body.style.background = data.siteBackgroundColor;
      document.body.style.backgroundSize = '';
      document.body.style.backgroundPosition = '';
      document.body.style.backgroundAttachment = '';
      generateCompleteTheme(data.siteBackgroundColor);
    }
  }
}, 100);

// Profile customization settings
let profileCustomization = {
  panelStyle: 'glass', // 'glass' or 'solid'
  panelColor: '#0a0d1a',
  glowEnabled: true,
  glowColor: null,
  textColor: 'light', // 'light', 'dark', or 'custom'
  customTextColor: '#ffffff',
  accentColor: null
};

// Profile song
let profileSong = {
  audioData: null,
  title: null,
  artist: null,
  filename: null
};

// Create separate audio player for profile song
const profileSongPlayer = new Audio();
profileSongPlayer.loop = true;
profileSongPlayer.volume = 0.5;

// Open/Close Edit Profile Modal
function openEditProfileModal() {
  document.getElementById('editProfileModal').classList.add('show');
  updateProfilePicPreview();
  updateBannerPreview();
  updateProfileBackgroundPreview();
  updateProfileSongDisplay();
  
  // Update button states
  document.getElementById('glassStyleBtn').style.background = profileCustomization.panelStyle === 'glass' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  document.getElementById('solidStyleBtn').style.background = profileCustomization.panelStyle === 'solid' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  
  document.getElementById('panelColorSection').style.display = profileCustomization.panelStyle === 'solid' ? 'block' : 'none';
  
  if (profileCustomization.glowEnabled) {
    document.getElementById('glowToggle').classList.add('active');
  } else {
    document.getElementById('glowToggle').classList.remove('active');
  }
  
  document.getElementById('lightTextBtn').style.background = profileCustomization.textColor === 'light' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  document.getElementById('darkTextBtn').style.background = profileCustomization.textColor === 'dark' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  document.getElementById('customTextBtn').style.background = profileCustomization.textColor === 'custom' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  
  document.getElementById('textColorPicker').style.display = profileCustomization.textColor === 'custom' ? 'block' : 'none';
}

function closeEditProfileModal() {
  document.getElementById('editProfileModal').classList.remove('show');
}

// Profile Song Functions
function uploadProfileSong(input) {
  if (input.files && input.files[0]) {
    const file = input.files[0];
    const reader = new FileReader();
    
    reader.onload = function(e) {
      profileSong.audioData = e.target.result;
      profileSong.filename = file.name;
      profileSong.title = file.name.replace(/\.(mp3|m4a|mp4)$/i, '');
      profileSong.artist = 'Unknown Artist';
      
      // Get duration
      const tempAudio = new Audio();
      tempAudio.src = e.target.result;
      tempAudio.onloadedmetadata = function() {
        updateProfileSongDisplay();
        saveData();
      };
    };
    
    reader.readAsDataURL(file);
  }
}

function removeProfileSong() {
  profileSong = {
    audioData: null,
    title: null,
    artist: null,
    filename: null
  };
  
  // Stop playing if currently playing
  profileSongPlayer.pause();
  profileSongPlayer.src = '';
  
  updateProfileSongDisplay();
  saveData();
}

function updateProfileSongDisplay() {
  const display = document.getElementById('profileSongInfo');
  
  if (!display) return; // Modal not open yet
  
  if (profileSong && profileSong.audioData) {
    display.innerHTML = `
      <div style="display:flex;align-items:center;gap:1rem">
        <div style="font-size:2rem">‚ô™</div>
        <div style="text-align:left;flex:1">
          <div style="font-weight:600;color:var(--text-primary)">${profileSong.title || profileSong.filename || 'Untitled'}</div>
          <div style="font-size:0.875rem;color:var(--text-secondary)">${profileSong.artist || 'Unknown Artist'}</div>
        </div>
        <button class="btn btn-secondary" onclick="testPlayProfileSong()" style="padding:0.5rem 1rem">Test Play</button>
      </div>
    `;
  } else {
    display.innerHTML = '<div style="color:var(--text-secondary);text-align:center">No profile song selected</div>';
  }
}

function testPlayProfileSong() {
  if (profileSong && profileSong.audioData) {
    if (profileSongPlayer.paused) {
      profileSongPlayer.src = profileSong.audioData;
      profileSongPlayer.volume = 0.5;
      profileSongPlayer.play();
      
      // Auto-stop after 10 seconds for testing
      setTimeout(() => {
        profileSongPlayer.pause();
        profileSongPlayer.currentTime = 0;
      }, 10000);
    } else {
      profileSongPlayer.pause();
      profileSongPlayer.currentTime = 0;
    }
  }
}

// Start profile song when visiting profile page
function startProfileSong() {
  if (!profileSong || !profileSong.audioData) {
    console.log('No profile song to play');
    return;
  }
  
  console.log('Starting profile song:', profileSong.title);
  
  profileSongPlayer.src = profileSong.audioData;
  profileSongPlayer.volume = 0.5;
  profileSongPlayer.loop = true;
  
  // Show indicator
  const indicator = document.getElementById('profileSongIndicator');
  if (indicator) {
    indicator.style.display = 'flex';
    
    const titleEl = document.getElementById('profileSongTitle');
    const artistEl = document.getElementById('profileSongArtist');
    
    if (titleEl) titleEl.textContent = profileSong.title || profileSong.filename || 'Profile Song';
    if (artistEl) artistEl.textContent = profileSong.artist || 'Unknown Artist';
  }
  
  // Auto-play with user interaction handling
  const playPromise = profileSongPlayer.play();
  if (playPromise !== undefined) {
    playPromise
      .then(() => {
        console.log('‚úÖ Profile song playing');
      })
      .catch(error => {
        console.log('‚ö†Ô∏è Profile song autoplay prevented by browser - click anywhere to start');
        // Add click listener to start on first interaction
        const startOnClick = () => {
          profileSongPlayer.play()
            .then(() => console.log('‚úÖ Profile song started after user interaction'))
            .catch(e => console.error('Failed to play:', e));
          document.removeEventListener('click', startOnClick);
        };
        document.addEventListener('click', startOnClick, { once: true });
      });
  }
}

function stopProfileSong() {
  profileSongPlayer.pause();
  profileSongPlayer.currentTime = 0;
  
  // Hide indicator
  const indicator = document.getElementById('profileSongIndicator');
  if (indicator) {
    indicator.style.display = 'none';
  }
}

function toggleProfileSongMute() {
  if (profileSongPlayer.volume > 0) {
    profileSongPlayer.volume = 0;
    document.getElementById('profileSongMuteBtn').textContent = 'Unmute';
  } else {
    profileSongPlayer.volume = 0.5;
    document.getElementById('profileSongMuteBtn').textContent = 'Mute';
  }
}

// Panel Style
function setPanelStyle(style) {
  profileCustomization.panelStyle = style;
  document.getElementById('glassStyleBtn').style.background = style === 'glass' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  document.getElementById('solidStyleBtn').style.background = style === 'solid' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  document.getElementById('panelColorSection').style.display = style === 'solid' ? 'block' : 'none';
  applyProfileCustomization();
}

function setPanelColor(color) {
  profileCustomization.panelColor = color;
  document.getElementById('panelColorPicker').value = color;
  applyProfileCustomization();
}

function togglePanelGlow() {
  profileCustomization.glowEnabled = !profileCustomization.glowEnabled;
  document.getElementById('glowToggle').classList.toggle('active');
  applyProfileCustomization();
}

function setGlowColor() {
  const color = document.getElementById('glowColorPicker').value;
  profileCustomization.glowColor = color;
  customGlowColor = color;
  generateCompleteTheme(profileBackground);
  applyProfileCustomization();
}

function resetGlowColor() {
  profileCustomization.glowColor = null;
  customGlowColor = null;
  document.getElementById('glowColorPicker').value = '';
  generateCompleteTheme(profileBackground);
  applyProfileCustomization();
}

function setTextColor(type) {
  profileCustomization.textColor = type;
  document.getElementById('lightTextBtn').style.background = type === 'light' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  document.getElementById('darkTextBtn').style.background = type === 'dark' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  document.getElementById('customTextBtn').style.background = type === 'custom' ? 'var(--accent)' : 'rgba(255,255,255,0.1)';
  document.getElementById('textColorPicker').style.display = type === 'custom' ? 'block' : 'none';
  applyProfileCustomization();
}

function setAccentColor() {
  const color = document.getElementById('accentColorPicker').value;
  profileCustomization.accentColor = color;
  applyProfileCustomization();
}

function applyProfileCustomization() {
  const profileScreen = document.getElementById('profileScreen');
  
  // Apply panel style
  if (profileCustomization.panelStyle === 'solid') {
    profileScreen.classList.remove('has-background');
    profileScreen.classList.add('solid-panels');
    profileScreen.style.setProperty('--panel-bg', profileCustomization.panelColor);
  } else {
    profileScreen.classList.remove('solid-panels');
    if (profileBackground && profileBackground.startsWith('url')) {
      profileScreen.classList.add('has-background');
    }
  }
  
  // Apply glow
  if (!profileCustomization.glowEnabled) {
    profileScreen.classList.add('no-glow');
  } else {
    profileScreen.classList.remove('no-glow');
  }
  
  // Apply text color
  if (profileCustomization.textColor === 'dark') {
    profileScreen.style.setProperty('--text-primary', '#1a1a1a');
    profileScreen.style.setProperty('--text-secondary', '#666666');
  } else if (profileCustomization.textColor === 'custom') {
    const customColor = document.getElementById('textColorPicker').value;
    profileCustomization.customTextColor = customColor;
    profileScreen.style.setProperty('--text-primary', customColor);
  } else {
    profileScreen.style.setProperty('--text-primary', '#ffffff');
    profileScreen.style.setProperty('--text-secondary', 'rgba(255,255,255,0.7)');
  }
  
  // Apply accent color
  if (profileCustomization.accentColor) {
    profileScreen.style.setProperty('--accent', profileCustomization.accentColor);
  }
}

function saveProfileCustomization() {
  saveData();
  closeEditProfileModal();
  showSuccessToast(); // Just checkmark
}

function resetProfileCustomization() {
  profileCustomization = {
    panelStyle: 'glass',
    panelColor: '#0a0d1a',
    glowEnabled: true,
    glowColor: null,
    textColor: 'light',
    customTextColor: '#ffffff',
    accentColor: null
  };
  
  profilePicture = 'ML';
  profileBanner = 'linear-gradient(135deg,#0a1929,#132f4c)';
  profileBackground = null;
  
  applyProfileCustomization();
  applyProfileStyles();
  updateProfilePicPreview();
  updateBannerPreview();
  updateProfileBackgroundPreview();
  saveData();
  showSuccessToast(); // Just checkmark
}

// Settings toggle function
function toggleSetting(setting) {
  const toggle = document.getElementById(setting + 'Toggle');
  if (toggle) {
    toggle.classList.toggle('active');
  }
}

// Override changeBackground to apply site-wide color (not profile-specific)
function changeBackground(color) {
  // This is for site-wide background color
  document.body.style.background = color;
  document.body.style.backgroundSize = '';
  document.body.style.backgroundPosition = '';
  document.body.style.backgroundAttachment = '';
  
  // Update color picker
  const picker = document.getElementById('customColorPicker');
  if (picker) {
    picker.value = color;
  }
  
  // Update color selection UI
  document.querySelectorAll('.color-option').forEach(option => {
    option.classList.remove('selected');
    if (option.dataset.color === color) {
      option.classList.add('selected');
    }
  });
  
  // Generate theme based on color
  generateCompleteTheme(color);
  
  // Save to localStorage
  const savedData = localStorage.getItem('basspace_data');
  if (savedData) {
    const data = JSON.parse(savedData);
    data.siteBackgroundColor = color;
    localStorage.setItem('basspace_data', JSON.stringify(data));
  }
}

// Change site-wide glow color
function changeSiteGlowColor(color) {
  customGlowColor = color;
  const currentBg = document.body.style.background || '#050d1a';
  generateCompleteTheme(currentBg);
  document.getElementById('customGlowPicker').value = color;
  saveData();
}

// Reset site-wide glow color to auto
function resetSiteGlowColor() {
  customGlowColor = null;
  const currentBg = document.body.style.background || '#050d1a';
  generateCompleteTheme(currentBg);
  document.getElementById('customGlowPicker').value = '';
  saveData();
}

// Save account info
function saveAccountInfo() {
  const displayName = document.getElementById('displayName').value;
  const bio = document.getElementById('bioInput').value;
  document.getElementById('profileUsername').textContent = displayName;
  document.getElementById('profileBio').textContent = bio;
  saveData();
}

// Override applyProfileStyles to apply background only to profile page with frosted glass
function applyProfileStyles() {
  const profileAvatarEl = document.getElementById('profileAvatarEl');
  const profileBannerEl = document.getElementById('profileBannerEl');
  const profileScreen = document.getElementById('profileScreen');
  
  // Apply profile picture
  if (profilePicture && profilePicture !== 'ML' && profilePicture.startsWith('data:')) {
    profileAvatarEl.style.backgroundImage = `url(${profilePicture})`;
    profileAvatarEl.style.backgroundSize = 'cover';
    profileAvatarEl.style.backgroundPosition = 'center';
    profileAvatarEl.textContent = '';
  } else {
    profileAvatarEl.style.backgroundImage = '';
    profileAvatarEl.textContent = 'ML';
  }
  
  // Apply profile banner
  if (profileBanner && profileBanner.startsWith('url')) {
    profileBannerEl.style.background = profileBanner;
    profileBannerEl.style.backgroundSize = 'cover';
    profileBannerEl.style.backgroundPosition = 'center';
  } else {
    profileBannerEl.style.background = profileBanner;
    profileBannerEl.style.backgroundSize = '';
    profileBannerEl.style.backgroundPosition = '';
  }
  
  // Apply profile background ONLY to profile page with frosted glass
  if (profileBackground && profileBackground.startsWith('url')) {
    profileScreen.style.background = profileBackground;
    profileScreen.classList.add('has-background');
    updateProfileBackgroundPreview();
  } else {
    profileScreen.style.background = '';
    profileScreen.classList.remove('has-background');
    updateProfileBackgroundPreview();
  }
}

// OVERRIDE functions from minified code to remove all alerts/confirms
function addToPlaylist() {
  togglePlayerMenu();
  // Silent - just close menu
}

function addToLibrary() {
  togglePlayerMenu();
  if (currentTrack && !tracks.find(t => t.id === currentTrack.id)) {
    tracks.push(currentTrack);
    saveData();
    renderLibrary();
    // Silent - no alert
  }
}

function saveProfile() {
  const displayName = document.getElementById('displayName').value;
  const bio = document.getElementById('bioInput').value;
  document.getElementById('profileUsername').textContent = displayName;
  document.getElementById('profileBio').textContent = bio;
  saveData();
  // Silent - no alert
}

function changeGlowColor(color) {
  customGlowColor = color;
  generateCompleteTheme(profileBackground);
  document.getElementById('customGlowPicker').value = color;
  saveData();
  // Silent - no alert
}

function resetGlowColor() {
  customGlowColor = null;
  generateCompleteTheme(profileBackground);
  document.getElementById('customGlowPicker').value = '';
  saveData();
  // Silent - no alert
}

function resetCustomization() {
  // Silent - no confirm, just reset
  profilePicture = 'ML';
  profileBanner = 'linear-gradient(135deg,#0a1929,#132f4c)';
  profileBackground = '#050d1a';
  document.body.style.background = profileBackground;
  document.body.style.backgroundSize = '';
  document.body.style.backgroundPosition = '';
  document.body.style.backgroundAttachment = '';
  generateCompleteTheme(profileBackground);
  updateProfilePicPreview();
  updateBannerPreview();
  updateBackgroundPreview();
  updateColorSelection();
  applyProfileStyles();
  saveData();
  // Silent - no alert
}

function saveData() {
  const data = {
    tracks: tracks.map(t => ({
      id: t.id,
      title: t.title,
      artist: t.artist,
      album: t.album,
      albumArt: t.albumArt,
      audioData: t.audioData,
      duration: t.duration,
      filename: t.filename
    })),
    allUserTracks: allUserTracks.map(t => ({
      id: t.id,
      title: t.title,
      artist: t.artist,
      album: t.album,
      albumArt: t.albumArt,
      audioData: t.audioData,
      duration: t.duration,
      filename: t.filename
    })),
    playlists: playlists,
    totalPlays: totalPlays,
    recentlyPlayed: recentlyPlayed.map(t => ({
      id: t.id,
      title: t.title,
      artist: t.artist,
      album: t.album,
      albumArt: t.albumArt
    })),
    profilePicture: profilePicture,
    profileBanner: profileBanner,
    profileBackground: profileBackground,
    customGlowColor: customGlowColor,
    profileCustomization: profileCustomization,
    profileSong: profileSong,
    siteBackgroundColor: document.body.style.background || '#050d1a'
  };
  
  try {
    localStorage.setItem('basspace_data', JSON.stringify(data));
  } catch (e) {
    // Silent fail - just log to console
    if (e.name === 'QuotaExceededError') {
      console.error('Storage limit exceeded');
    }
  }
}

// Helper function to toggle track menu
function toggleTrackMenu(trackId, event) {
  event.stopPropagation();
  const dropdown = document.getElementById(`track-menu-${trackId}`);
  const button = event.currentTarget;
  const track = button.closest('.track');
  
  // Reset all tracks to normal z-index and re-enable pointer events
  document.querySelectorAll('.track').forEach(t => {
    t.style.zIndex = '';
    t.style.position = 'relative';
  });
  
  // Close all other menus and their submenus
  document.querySelectorAll('.track-dropdown').forEach(menu => {
    if (menu.id !== `track-menu-${trackId}`) {
      menu.classList.remove('show');
    }
  });
  
  // Close all submenus
  document.querySelectorAll('.track-submenu').forEach(submenu => {
    submenu.classList.remove('show');
  });
  
  // Toggle this menu
  const isShowing = dropdown.classList.toggle('show');
  
  // If showing, elevate this track's z-index way above everything
  if (isShowing && track) {
    track.style.zIndex = '999999999';
    track.style.position = 'relative';
  }
}

// Close menus when clicking outside
document.addEventListener('click', function(e) {
  if (!e.target.closest('.track-menu-btn') && !e.target.closest('.track-dropdown') && !e.target.closest('.track-submenu')) {
    // Close all menus
    document.querySelectorAll('.track-dropdown').forEach(menu => {
      menu.classList.remove('show');
    });
    document.querySelectorAll('.track-submenu').forEach(submenu => {
      submenu.classList.remove('show');
    });
    
    // Reset all track z-indexes
    document.querySelectorAll('.track').forEach(t => {
      t.style.zIndex = '';
    });
  }
});

// Fixed downloadTrack to not open new tab
function downloadTrack(trackId) {
  const track = tracks.find(t => t.id === trackId) || allUserTracks.find(t => t.id === trackId);
  if (!track) return;
  
  const url = track.dataUrl || track.audioData;
  const filename = track.filename || `${track.title}.mp3`;
  
  // Use fetch to download without opening new tab
  fetch(url)
    .then(response => response.blob())
    .then(blob => {
      const blobUrl = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = blobUrl;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(blobUrl);
    })
    .catch(error => {
      console.error('Download error:', error);
      // Silent fail - just log to console
    });
}

// Delete track with cloud sync
async function deleteTrack(trackId) {
  // Close all menus first
  document.querySelectorAll('.track-dropdown, .track-submenu').forEach(menu => {
    menu.classList.remove('show');
  });
  
  // Reset track z-indexes
  document.querySelectorAll('.track').forEach(t => {
    t.style.zIndex = '';
  });
  
  // Delete from local arrays FIRST (immediate UI update)
  tracks = tracks.filter(t => t.id !== trackId);
  allUserTracks = allUserTracks.filter(t => t.id !== trackId);
  
  // Also remove from public tracks if present
  if (window.publicTracks) {
    window.publicTracks = window.publicTracks.filter(t => t.id !== trackId);
  }
  
  // Stop playback if this track is playing
  if (currentPlayingId === trackId) {
    audioPlayer.pause();
    currentPlayingId = null;
    document.getElementById('playerBar').classList.remove('active');
  }
  
  // UPDATE UI IMMEDIATELY
  updateStats();
  renderLibrary();
  renderPopularTracks();
  renderRecentUploads();
  renderProfile();
  
  // Delete from cloud in background (after UI updates)
  if (currentUser) {
    deleteTrackFromCloud(trackId).catch(err => {
      console.error('Background delete error:', err);
    });
  }
  
  // Reload public tracks in background
  if (typeof loadPublicTracks === 'function') {
    loadPublicTracks().catch(err => {
      console.error('Background reload error:', err);
    });
  }
}

// Add track to playlist
// Track currently being added to playlist
let currentTrackToAdd = null;

// Helper to generate playlist submenu HTML
function getPlaylistSubmenu(trackId, menuPrefix = '') {
  if (playlists.length === 0) {
    return '';
  }
  
  const submenuItems = playlists.map(playlist => {
    const isAdded = playlist.trackIds.includes(trackId);
    return `
      <div class="track-submenu-item ${isAdded ? 'added' : ''}" ${!isAdded ? `onclick="addToPlaylistFromMenu('${trackId}', '${playlist.id}', event)"` : ''}>
        <span>${playlist.name}</span>
        ${isAdded ? '<span class="checkmark">‚úì</span>' : ''}
      </div>
    `;
  }).join('');
  
  return `<div id="playlist-submenu-${menuPrefix}${trackId}" class="track-submenu">${submenuItems}</div>`;
}

// Add track to playlist from dropdown menu
function addToPlaylistFromMenu(trackId, playlistId, event) {
  event.stopPropagation();
  
  const playlist = playlists.find(p => p.id === playlistId);
  if (!playlist || playlist.trackIds.includes(trackId)) return;
  
  // Add track
  playlist.trackIds.push(trackId);
  saveData();
  
  // Show checkmark and play sound
  showSuccessToast(true);
  
  // Close all menus
  document.querySelectorAll('.track-dropdown, .track-submenu').forEach(m => m.classList.remove('show'));
  
  // Re-render to update UI
  renderLibrary();
  renderPopularTracks();
  renderProfile();
  renderRecentUploads();
}

// Show playlist submenu on click
function showPlaylistSubmenu(trackId, event) {
  event.stopPropagation();
  
  // Hide all other submenus
  document.querySelectorAll('.track-submenu').forEach(s => s.classList.remove('show'));
  
  // Find and show this submenu
  const menuItem = event.currentTarget;
  const parentMenu = menuItem.closest('.track-dropdown');
  const submenu = parentMenu.querySelector('.track-submenu');
  
  if (submenu) {
    submenu.classList.add('show');
  }
}

// Toast notification functions
function showSuccessToast(playSound = false) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  
  toast.style.cssText = `
    width: 48px;
    height: 48px;
    background: linear-gradient(135deg, #22c55e, #16a34a);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4), 0 0 0 3px rgba(34, 197, 94, 0.2);
    pointer-events: auto;
    animation: successPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    backdrop-filter: blur(10px);
  `;
  
  toast.innerHTML = `
    <div style="
      color: white;
      font-size: 24px;
      font-weight: bold;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    ">‚úì</div>
  `;
  
  container.appendChild(toast);
  
  // Only play sound if requested (for playlist add)
  if (playSound) {
    playSuccessSound();
  }
  
  // Auto remove after 1.5 seconds
  setTimeout(() => {
    toast.style.animation = 'successFade 0.3s ease-out';
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }, 1500);
}

function showErrorToast(message) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  
  toast.style.cssText = `
    display: flex;
    align-items: center;
    gap: 0.75rem;
    background: rgba(239, 68, 68, 0.95);
    padding: 0.75rem 1.25rem;
    border-radius: 50px;
    box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
    pointer-events: auto;
    animation: slideIn 0.3s ease-out;
    backdrop-filter: blur(10px);
  `;
  
  toast.innerHTML = `
    <div style="
      width: 24px;
      height: 24px;
      background: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: #ef4444;
      flex-shrink: 0;
    ">‚úï</div>
    <div style="
      color: white;
      font-weight: 600;
      font-size: 0.9rem;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    ">${message}</div>
  `;
  
  container.appendChild(toast);
  
  // Auto remove after 2.5 seconds
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-in';
    setTimeout(() => {
      if (toast.parentNode) {
        toast.parentNode.removeChild(toast);
      }
    }, 300);
  }, 2500);
}

// Success sound using Web Audio API
function playSuccessSound() {
  try {
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    
    // Create a short, pleasant "pop" sound
    const oscillator = audioContext.createOscillator();
    const gainNode = audioContext.createGain();
    
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    // Bubble pop frequency sweep
    oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
    oscillator.frequency.exponentialRampToValueAtTime(400, audioContext.currentTime + 0.1);
    
    // Quick fade out
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
    
    oscillator.type = 'sine';
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.1);
  } catch (e) {
    // Silent fail if audio context not supported
    console.log('Audio not supported');
  }
}

// Add CSS animations for toast
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from {
      opacity: 0;
      transform: translateX(100px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
  
  @keyframes slideOut {
    from {
      opacity: 1;
      transform: translateX(0);
    }
    to {
      opacity: 0;
      transform: translateX(100px);
    }
  }
  
  @keyframes successPop {
    0% {
      opacity: 0;
      transform: scale(0);
    }
    50% {
      transform: scale(1.2);
    }
    100% {
      opacity: 1;
      transform: scale(1);
    }
  }
  
  @keyframes successFade {
    to {
      opacity: 0;
      transform: scale(0.8);
    }
  }
`;
document.head.appendChild(style);

// Playlist view functions
let currentViewingPlaylist = null;

function openPlaylist(playlistId) {
  const playlist = playlists.find(p => p.id === playlistId);
  if (!playlist) return;
  
  currentViewingPlaylist = playlist;
  
  // Set title
  document.getElementById('playlistViewTitle').textContent = playlist.name;
  
  // Get tracks in this playlist - search in all available track sources
  const playlistTracks = playlist.trackIds
    .map(id => {
      // Search in user's tracks first, then all tracks, then public tracks
      return tracks.find(t => t.id === id) || 
             allUserTracks.find(t => t.id === id) ||
             (window.publicTracks && window.publicTracks.find(t => t.id === id));
    })
    .filter(t => t); // Remove any null/undefined
  
  const trackListEl = document.getElementById('playlistTrackList');
  const emptyEl = document.getElementById('playlistEmpty');
  
  if (playlistTracks.length === 0) {
    trackListEl.innerHTML = '';
    emptyEl.style.display = 'block';
  } else {
    emptyEl.style.display = 'none';
    trackListEl.innerHTML = playlistTracks.map((track, index) => `
      <div class="track">
        <div class="track-content">
          <div class="track-number">${track.isPlaying ? '‚ô™' : index + 1}</div>
          ${track.albumArt 
            ? `<div class="track-art" style="background-image:url(${track.albumArt})"></div>`
            : '<div class="track-art">‚ô™</div>'
          }
          <button class="play-btn" onclick="togglePlay('${track.id}')">${track.isPlaying ? '‚è∏' : '‚ñ∂'}</button>
          <div class="track-info">
            <div class="track-title">${track.title}</div>
            <div class="track-artist">${track.artist} ‚Ä¢ ${track.album}</div>
            <div class="track-duration">${formatDuration(track.duration)}</div>
          </div>
          <div class="track-actions">
            <button class="track-menu-btn" onclick="toggleTrackMenu('playlist-${track.id}', event)">‚ãØ</button>
            <div id="track-menu-playlist-${track.id}" class="track-dropdown">
              <div class="track-dropdown-item" onclick="togglePlay('${track.id}')">Play</div>
              <div class="track-dropdown-item" onclick="downloadTrack('${track.id}')">Download</div>
              <div class="track-dropdown-item delete" onclick="removeFromPlaylist('${playlist.id}', '${track.id}')">Remove from Playlist</div>
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }
  
  // Show modal
  document.getElementById('playlistViewModal').classList.add('show');
}

function closePlaylistView() {
  document.getElementById('playlistViewModal').classList.remove('show');
  currentViewingPlaylist = null;
}

function removeFromPlaylist(playlistId, trackId) {
  const playlist = playlists.find(p => p.id === playlistId);
  if (!playlist) return;
  
  // Close menus
  document.querySelectorAll('.track-dropdown, .track-submenu').forEach(menu => {
    menu.classList.remove('show');
  });
  
  // Remove track from playlist
  playlist.trackIds = playlist.trackIds.filter(id => id !== trackId);
  
  saveData();
  
  // Update profile immediately (which will re-render the expanded playlist)
  renderProfile();
}

// Override confirmCreatePlaylist
function confirmCreatePlaylist() {
  const name = document.getElementById('playlistNameInput').value.trim();
  if (name) {
    playlists.push({
      id: Math.random().toString(36).slice(2),
      name: name,
      trackIds: []
    });
    closeCreatePlaylist();
    updateStats();
    renderProfile();
    saveData();
    showSuccessToast(); // Just checkmark, no text
  }
}

function addTrackToPlaylist(trackId) {
  if (playlists.length === 0) {
    showErrorToast('Create a playlist first!');
    return;
  }
  
  currentTrackToAdd = trackId;
  
  // Populate playlist selection
  const playlistList = document.getElementById('playlistSelectionList');
  playlistList.innerHTML = playlists.map(playlist => {
    const alreadyInPlaylist = playlist.trackIds.includes(trackId);
    return `
      <div class="playlist-selection-item ${alreadyInPlaylist ? 'disabled' : ''}" onclick="${alreadyInPlaylist ? '' : `addToPlaylistConfirm('${playlist.id}')`}">
        <div style="flex:1">
          <div style="font-weight:600;margin-bottom:0.25rem">${playlist.name}</div>
          <div style="font-size:0.85rem;color:var(--text-secondary)">${playlist.trackIds.length} tracks</div>
        </div>
        ${alreadyInPlaylist ? '<div style="color:var(--text-secondary);font-size:0.85rem">Already added</div>' : '<div style="color:var(--accent);font-size:0.85rem">Add ‚Üí</div>'}
      </div>
    `;
  }).join('');
  
  // Show modal
  document.getElementById('addToPlaylistModal').classList.add('show');
}

function closeAddToPlaylist() {
  document.getElementById('addToPlaylistModal').classList.remove('show');
  currentTrackToAdd = null;
}

function addToPlaylistConfirm(playlistId) {
  const playlist = playlists.find(p => p.id === playlistId);
  if (!playlist) return;
  
  // Add track to playlist if not already there
  if (!playlist.trackIds.includes(currentTrackToAdd)) {
    playlist.trackIds.push(currentTrackToAdd);
    
    // Show checkmark on the playlist item
    const playlistItem = event.target.closest('.playlist-selection-item');
    if (playlistItem) {
      const originalHTML = playlistItem.innerHTML;
      playlistItem.style.background = 'rgba(34, 197, 94, 0.2)';
      playlistItem.style.borderColor = '#22c55e';
      playlistItem.innerHTML = `
        <div style="flex:1">
          <div style="font-weight:600;margin-bottom:0.25rem">${playlist.name}</div>
          <div style="font-size:0.85rem;color:var(--text-secondary)">${playlist.trackIds.length} tracks</div>
        </div>
        <div style="color:#22c55e;font-size:1.5rem;font-weight:bold">‚úì</div>
      `;
      
      // Wait a moment then close
      setTimeout(() => {
        saveData();
        showSuccessToast(true); // Play sound for playlist add!
        renderProfile();
        closeAddToPlaylist();
      }, 600);
    } else {
      saveData();
      showSuccessToast(true); // Play sound for playlist add!
      renderProfile();
    }
  }
}

// Toggle playlist expansion inline (Spotify/SoundCloud style)
function togglePlaylistExpansion(playlistId) {
  if (window.currentExpandedPlaylist === playlistId) {
    // Collapse if already expanded
    window.currentExpandedPlaylist = null;
  } else {
    // Expand this playlist
    window.currentExpandedPlaylist = playlistId;
  }
  renderProfile(); // Re-render to show/hide tracks
}

// Override showProfileTab to handle stats tab
function showProfileTab(tab) {
  currentProfileTab = tab;
  
  // Update tab buttons
  document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
  if (tab === 'tracks') {
    document.querySelector("[onclick=\"showProfileTab('tracks')\"]").classList.add('active');
  } else if (tab === 'playlists') {
    document.getElementById('playlistTabBtn').classList.add('active');
  } else if (tab === 'stats') {
    document.getElementById('statsTabBtn').classList.add('active');
  }
  
  // Show/hide sections
  document.getElementById('profileTracksSection').style.display = tab === 'tracks' ? 'block' : 'none';
  document.getElementById('profilePlaylistsSection').style.display = tab === 'playlists' ? 'block' : 'none';
  document.getElementById('profileStatsSection').style.display = tab === 'stats' ? 'block' : 'none';
  
  renderProfile();
}

// Override renderProfile to update stat cards
function renderProfile() {
  // Note: Stat cards removed from profile - stats now only in Stats tab
  
  // If on stats tab, calculate detailed stats
  if (currentProfileTab === 'stats') {
    // Calculate total listening time
    const totalSeconds = allUserTracks.reduce((sum, t) => sum + (t.duration || 0), 0);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    document.getElementById('statsTotalTime').textContent = `${hours}h ${minutes}m`;
    
    // Calculate average duration
    const avgDuration = allUserTracks.length > 0 ? totalSeconds / allUserTracks.length : 0;
    document.getElementById('statsAvgDuration').textContent = formatDuration(avgDuration);
    
    // Update stats
    document.getElementById('statsTotalPlays').textContent = totalPlays;
    document.getElementById('statsTotalTracks').textContent = allUserTracks.length;
    document.getElementById('statsTotalPlaylists').textContent = playlists.length;
    document.getElementById('statsUniqueArtists').textContent = new Set(allUserTracks.map(t => t.artist)).size;
    document.getElementById('statsUniqueAlbums').textContent = new Set(allUserTracks.map(t => t.album)).size;
    
    // Top Artists
    const artistCounts = {};
    allUserTracks.forEach(t => {
      artistCounts[t.artist] = (artistCounts[t.artist] || 0) + 1;
    });
    const topArtists = Object.entries(artistCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);
    
    const topArtistsEl = document.getElementById('statsTopArtists');
    if (topArtists.length > 0) {
      topArtistsEl.innerHTML = topArtists.map(([ artist, count], index) => `
        <div class="top-list-item">
          <div class="top-list-rank">${index + 1}</div>
          <div class="top-list-info">
            <div class="top-list-name">${artist}</div>
            <div class="top-list-count">${count} track${count !== 1 ? 's' : ''}</div>
          </div>
        </div>
      `).join('');
    } else {
      topArtistsEl.innerHTML = '<div style="color:var(--text-secondary);text-align:center;padding:2rem">No data yet</div>';
    }
    
    // Top Albums
    const albumCounts = {};
    allUserTracks.forEach(t => {
      const key = `${t.album}|${t.artist}`;
      albumCounts[key] = (albumCounts[key] || 0) + 1;
    });
    const topAlbums = Object.entries(albumCounts)
      .sort((a, b) => b[1] - a[1])
      .slice(0, 5);
    
    const topAlbumsEl = document.getElementById('statsTopAlbums');
    if (topAlbums.length > 0) {
      topAlbumsEl.innerHTML = topAlbums.map(([key, count], index) => {
        const [album, artist] = key.split('|');
        return `
          <div class="top-list-item">
            <div class="top-list-rank">${index + 1}</div>
            <div class="top-list-info">
              <div class="top-list-name">${album}</div>
              <div class="top-list-count">${artist} ‚Ä¢ ${count} track${count !== 1 ? 's' : ''}</div>
            </div>
          </div>
        `;
      }).join('');
    } else {
      topAlbumsEl.innerHTML = '<div style="color:var(--text-secondary);text-align:center;padding:2rem">No data yet</div>';
    }
  }
  
  // Show/hide appropriate section
  if (currentProfileTab === 'tracks') {
    const trackList = document.getElementById('profileTrackList');
    const emptyTracks = document.getElementById('profileEmptyTracks');
    
    if (tracks.length === 0) {
      trackList.innerHTML = '';
      emptyTracks.style.display = 'block';
    } else {
      emptyTracks.style.display = 'none';
      trackList.innerHTML = tracks.map((track, index) => `
        <div class="track">
          <div class="track-content">
            <div class="track-number">${track.isPlaying ? '‚ô™' : index + 1}</div>
            ${track.albumArt 
              ? `<div class="track-art" style="background-image:url(${track.albumArt})"></div>`
              : '<div class="track-art">‚ô™</div>'
            }
            <button class="play-btn" onclick="togglePlay('${track.id}')">${track.isPlaying ? '‚è∏' : '‚ñ∂'}</button>
            <div class="track-info">
              <div class="track-title">${track.title}</div>
              <div class="track-artist">${track.artist} ‚Ä¢ ${track.album}</div>
              <div class="track-duration">${formatDuration(track.duration)}</div>
            </div>
            <div class="track-actions">
              <button class="track-menu-btn" onclick="toggleTrackMenu('profile-${track.id}', event)">‚ãØ</button>
              <div id="track-menu-profile-${track.id}" class="track-dropdown">
                <div class="track-dropdown-item" onclick="togglePlay('${track.id}')">Play</div>
                ${track.userId === currentUser?.id ? `<div class="track-dropdown-item" onclick="openEditTrack('${track.id}')">Edit</div>` : ''}
                <div class="track-dropdown-item" onclick="downloadTrack('${track.id}')">Download</div>
                <div class="track-dropdown-item has-submenu" onclick="showPlaylistSubmenu('${track.id}', event)">
                  Add to Playlist
                  ${getPlaylistSubmenu(track.id, 'profile-')}
                </div>
                ${track.userId === currentUser?.id ? `<div class="track-dropdown-item delete" onclick="deleteTrack('${track.id}')">Delete</div>` : ''}
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }
  } else if (currentProfileTab === 'playlists') {
    const playlistList = document.getElementById('profilePlaylistList');
    const emptyPlaylists = document.getElementById('profileEmptyPlaylists');
    
    if (playlists.length === 0) {
      playlistList.innerHTML = '';
      emptyPlaylists.style.display = 'block';
    } else {
      emptyPlaylists.style.display = 'none';
      playlistList.innerHTML = playlists.map(playlist => {
        const isExpanded = window.currentExpandedPlaylist === playlist.id;
        
        // Get tracks for this playlist
        const playlistTracks = playlist.trackIds
          .map(id => {
            return tracks.find(t => t.id === id) || 
                   allUserTracks.find(t => t.id === id) ||
                   (window.publicTracks && window.publicTracks.find(t => t.id === id));
          })
          .filter(t => t);
        
        return `
          <div class="playlist-container" style="margin-bottom:1rem">
            <div class="playlist-card" onclick="togglePlaylistExpansion('${playlist.id}')" style="cursor:pointer">
              <div class="playlist-icon">‚ô™</div>
              <div style="flex:1">
                <h3 class="playlist-name">${playlist.name}</h3>
                <p class="playlist-count">${playlist.trackIds.length} tracks</p>
              </div>
              <div style="font-size:1.5rem;color:var(--text-secondary);transition:transform 0.3s;transform:rotate(${isExpanded ? '180deg' : '0deg'})">‚ñº</div>
            </div>
            ${isExpanded ? `
              <div class="playlist-expanded" style="margin-top:1rem;padding:1rem;background:rgba(255,255,255,0.03);border-radius:8px;border:1px solid var(--border-color)">
                ${playlistTracks.length === 0 ? `
                  <div style="text-align:center;color:var(--text-secondary);padding:2rem">
                    <div style="font-size:2rem;margin-bottom:1rem">‚ô™</div>
                    <p>No tracks in this playlist</p>
                    <p style="font-size:0.85rem;margin-top:0.5rem">Add tracks from the home page or library</p>
                  </div>
                ` : playlistTracks.map((track, index) => `
                  <div class="track">
                    <div class="track-content">
                      <div class="track-number">${track.isPlaying ? '‚ô™' : index + 1}</div>
                      ${track.albumArt 
                        ? `<div class="track-art" style="background-image:url(${track.albumArt})"></div>`
                        : '<div class="track-art">‚ô™</div>'
                      }
                      <button class="play-btn" onclick="togglePlay('${track.id}')">${track.isPlaying ? '‚è∏' : '‚ñ∂'}</button>
                      <div class="track-info">
                        <div class="track-title">${track.title}</div>
                        <div class="track-artist">${track.artist} ‚Ä¢ ${track.album}</div>
                        <div class="track-duration">${formatDuration(track.duration)}</div>
                      </div>
                      <div class="track-actions">
                        <button class="track-menu-btn" onclick="toggleTrackMenu('playlist-inline-${track.id}', event)">‚ãØ</button>
                        <div id="track-menu-playlist-inline-${track.id}" class="track-dropdown">
                          <div class="track-dropdown-item" onclick="togglePlay('${track.id}')">Play</div>
                          <div class="track-dropdown-item" onclick="downloadTrack('${track.id}')">Download</div>
                          <div class="track-dropdown-item delete" onclick="removeFromPlaylist('${playlist.id}', '${track.id}')">Remove from Playlist</div>
                        </div>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
  }
}

// OVERRIDE render functions with three-dot menu
function renderLibrary() {
  if (tracks.length === 0) {
    trackList.innerHTML = '';
    emptyState.style.display = 'block';
  } else {
    emptyState.style.display = 'none';
    trackList.innerHTML = tracks.map((track, index) => `
      <div class="track">
        <div class="track-content">
          <div class="track-number">${track.isPlaying ? '‚ô™' : index + 1}</div>
          ${track.albumArt 
            ? `<div class="track-art" style="background-image:url(${track.albumArt})"></div>`
            : '<div class="track-art">‚ô™</div>'
          }
          <button class="play-btn" onclick="togglePlay('${track.id}')">${track.isPlaying ? '‚è∏' : '‚ñ∂'}</button>
          <div class="track-info">
            <div class="track-title">${track.title}</div>
            <div class="track-artist">${track.artist} ‚Ä¢ ${track.album}</div>
            <div class="track-duration">${formatDuration(track.duration)}</div>
          </div>
          <div class="track-actions">
            <button class="track-menu-btn" onclick="toggleTrackMenu('${track.id}', event)">‚ãØ</button>
            <div id="track-menu-${track.id}" class="track-dropdown">
              <div class="track-dropdown-item" onclick="togglePlay('${track.id}')">Play</div>
              ${track.userId === currentUser?.id ? `<div class="track-dropdown-item" onclick="openEditTrack('${track.id}')">Edit</div>` : ''}
              <div class="track-dropdown-item" onclick="downloadTrack('${track.id}')">Download</div>
              <div class="track-dropdown-item has-submenu" onclick="showPlaylistSubmenu('${track.id}', event)">
                Add to Playlist
                ${getPlaylistSubmenu(track.id)}
              </div>
              ${track.userId === currentUser?.id ? `<div class="track-dropdown-item delete" onclick="deleteTrack('${track.id}')">Delete</div>` : ''}
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }
}

function renderRecentUploads() {
  const uploadedTracks = document.getElementById('uploadedTracks');
  const recentTrackList = document.getElementById('recentTrackList');
  
  if (allUserTracks.length > 0) {
    uploadedTracks.style.display = 'block';
    const recent = allUserTracks.slice(-10).reverse();
    
    recentTrackList.innerHTML = recent.map((track, index) => `
      <div class="track">
        <div class="track-content">
          <div class="track-number">${track.isPlaying ? '‚ô™' : index + 1}</div>
          ${track.albumArt 
            ? `<div class="track-art" style="background-image:url(${track.albumArt})"></div>`
            : '<div class="track-art">‚ô™</div>'
          }
          <button class="play-btn" onclick="togglePlay('${track.id}')">${track.isPlaying ? '‚è∏' : '‚ñ∂'}</button>
          <div class="track-info">
            <div class="track-title">${track.title}</div>
            <div class="track-artist">${track.artist} ‚Ä¢ ${track.album}</div>
            <div class="track-duration">${formatDuration(track.duration)}</div>
          </div>
          <div class="track-actions">
            <button class="track-menu-btn" onclick="toggleTrackMenu('recent-${track.id}', event)">‚ãØ</button>
            <div id="track-menu-recent-${track.id}" class="track-dropdown">
              <div class="track-dropdown-item" onclick="togglePlay('${track.id}')">Play</div>
              ${track.userId === currentUser?.id ? `<div class="track-dropdown-item" onclick="openEditTrack('${track.id}')">Edit</div>` : ''}
              <div class="track-dropdown-item" onclick="downloadTrack('${track.id}')">Download</div>
              <div class="track-dropdown-item has-submenu" onclick="showPlaylistSubmenu('${track.id}', event)">
                Add to Playlist
                ${getPlaylistSubmenu(track.id, 'recent-')}
              </div>
              ${track.userId === currentUser?.id ? `<div class="track-dropdown-item delete" onclick="deleteTrack('${track.id}')">Delete</div>` : ''}
            </div>
          </div>
        </div>
      </div>
    `).join('');
  } else {
    uploadedTracks.style.display = 'none';
  }
}

function renderPopularTracks(filtered) {
  const popularTracks = document.getElementById('popularTracks');
  const noMusic = document.getElementById('noMusic');
  const noResults = document.getElementById('noResults');
  
  // Use public tracks if available, otherwise fall back to user's tracks
  const allTracks = window.publicTracks || allUserTracks;
  const tracksToShow = filtered || allTracks;
  
  noResults.style.display = 'none';
  noMusic.style.display = 'none';
  
  if (tracksToShow.length === 0) {
    popularTracks.innerHTML = '';
    (filtered ? noResults : noMusic).style.display = 'block';
  } else {
    popularTracks.innerHTML = tracksToShow.slice(0, 20).map((track, index) => `
      <div class="track">
        <div class="track-content">
          <div class="track-number">${track.isPlaying ? '‚ô™' : index + 1}</div>
          ${track.albumArt 
            ? `<div class="track-art" style="background-image:url(${track.albumArt})"></div>`
            : '<div class="track-art">‚ô™</div>'
          }
          <button class="play-btn" onclick="togglePlay('${track.id}')">${track.isPlaying ? '‚è∏' : '‚ñ∂'}</button>
          <div class="track-info">
            <div class="track-title">${track.title}</div>
            <div class="track-artist">${track.artist} ‚Ä¢ ${track.album}</div>
            <div class="track-duration">${formatDuration(track.duration)}</div>
          </div>
          <div class="track-actions">
            <button class="track-menu-btn" onclick="toggleTrackMenu('home-${track.id}', event)">‚ãØ</button>
            <div id="track-menu-home-${track.id}" class="track-dropdown">
              <div class="track-dropdown-item" onclick="togglePlay('${track.id}')">Play</div>
              <div class="track-dropdown-item" onclick="downloadTrack('${track.id}')">Download</div>
              <div class="track-dropdown-item has-submenu" onclick="showPlaylistSubmenu('${track.id}', event)">
                Add to Playlist
                ${getPlaylistSubmenu(track.id, 'home-')}
              </div>
            </div>
          </div>
        </div>
      </div>
    `).join('');
  }
}

// OVERRIDE togglePlay with signed URL support
async function togglePlay(trackId) {
  // Search in user's tracks first, then all public tracks
  const track = tracks.find(t => t.id === trackId) || 
                allUserTracks.find(t => t.id === trackId) ||
                (window.publicTracks && window.publicTracks.find(t => t.id === trackId));
  
  if (!track) return;
  
  let audioUrl = track.dataUrl || track.audioData || track.audio_url;
  
  if (!audioUrl) {
    showErrorToast('Track has no audio URL');
    return;
  }
  
  // If URL is a Supabase storage URL, get a signed URL that will work even if bucket is private
  if (audioUrl.includes('supabase') && audioUrl.includes('audio-files') && currentUser) {
    try {
      // Extract the file path from the URL
      const urlParts = audioUrl.split('/storage/v1/object/public/audio-files/');
      if (urlParts.length > 1) {
        const filePath = urlParts[1];
        
        // Get a signed URL that works for 1 hour
        const { data, error } = await supabase.storage
          .from('audio-files')
          .createSignedUrl(filePath, 3600); // 1 hour expiry
        
        if (!error && data && data.signedUrl) {
          audioUrl = data.signedUrl;
          console.log('‚úÖ Using signed URL for playback');
        }
      }
    } catch (e) {
      console.warn('Could not get signed URL, using original:', e);
    }
  }
  
  if (currentPlayingId !== trackId || audioPlayer.paused) {
    if (currentPlayingId === trackId && audioPlayer.paused) {
      // Resume paused track
      const playPromise = audioPlayer.play();
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            track.isPlaying = true;
            document.getElementById('playerPlayIcon').textContent = '‚è∏';
          })
          .catch(error => {
            showErrorToast('Could not resume playback');
          });
      }
    } else {
      // Play new track
      // Reset all tracks
      tracks.forEach(t => t.isPlaying = false);
      allUserTracks.forEach(t => t.isPlaying = false);
      
      // Set audio source
      audioPlayer.src = audioUrl;
      audioPlayer.load();
      
      // Try to play
      const playPromise = audioPlayer.play();
      
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            currentPlayingId = trackId;
            track.isPlaying = true;
            totalPlays++;
            updatePlayerBar(track);
            updateStats();
            renderLibrary();
            renderPopularTracks();
            renderProfile();
          })
          .catch(error => {
            console.warn('Playback error (might still play):', error);
          });
      }
    }
  } else {
    // Pause
    audioPlayer.pause();
    track.isPlaying = false;
    document.getElementById('playerPlayIcon').textContent = '‚ñ∂';
  }
  
  renderLibrary();
  renderPopularTracks();
  renderProfile();
}

// Show error toast notification
function showErrorToast(message) {
  const existingToast = document.querySelector('.error-toast');
  if (existingToast) existingToast.remove();
  
  const toast = document.createElement('div');
  toast.className = 'error-toast';
  toast.style.cssText = 'position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:rgba(255,107,107,0.95);color:white;padding:1rem 2rem;border-radius:8px;font-size:0.95rem;font-weight:600;z-index:10000;box-shadow:0 8px 24px rgba(0,0,0,0.4);backdrop-filter:blur(10px);animation:slideUp 0.3s ease;';
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.opacity = '0';
    toast.style.transform = 'translateX(-50%) translateY(20px)';
    toast.style.transition = 'all 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
}

// Re-attach critical event handlers after everything loads
window.addEventListener('DOMContentLoaded', function() {
  console.log('Re-attaching event handlers');
  
  // Fix player bar time updates
  audioPlayer.addEventListener('timeupdate', function() {
    if (!isNaN(audioPlayer.duration) && audioPlayer.duration > 0) {
      const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
      const progressFill = document.getElementById('progressFill');
      const currentTimeEl = document.getElementById('currentTime');
      const totalTimeEl = document.getElementById('totalTime');
      
      if (progressFill) {
        progressFill.style.width = progressPercent + '%';
      }
      if (currentTimeEl) {
        currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
      }
      if (totalTimeEl) {
        totalTimeEl.textContent = formatTime(audioPlayer.duration);
      }
    }
  });
  
  console.log('‚úÖ Player bar time update handler attached');
  
  // Add audio error handler
  audioPlayer.addEventListener('error', function(e) {
    console.error('üî¥ Audio player error:', e);
    console.error('Error code:', audioPlayer.error?.code);
    console.error('Error message:', audioPlayer.error?.message);
    console.error('Current src:', audioPlayer.src);
    
    let errorMsg = 'Audio playback error: ';
    if (audioPlayer.error) {
      switch(audioPlayer.error.code) {
        case 1:
          errorMsg += 'MEDIA_ERR_ABORTED - Playback aborted';
          break;
        case 2:
          errorMsg += 'MEDIA_ERR_NETWORK - Network error loading audio';
          break;
        case 3:
          errorMsg += 'MEDIA_ERR_DECODE - Audio decoding failed';
          break;
        case 4:
          errorMsg += 'MEDIA_ERR_SRC_NOT_SUPPORTED - Audio format not supported or file not accessible';
          break;
        default:
          errorMsg += 'Unknown error';
      }
    }
    // Silent error - already logged to console
  });
  
  console.log('Audio error handler attached');
  
  // Profile dropdown
  const profileBtnEl = document.getElementById('profileBtn');
  if (profileBtnEl) {
    profileBtnEl.onclick = function(e) {
      e.stopPropagation();
      const dropdownEl = document.getElementById('dropdown');
      if (dropdownEl) {
        dropdownEl.classList.toggle('show');
      }
    };
    console.log('Profile button handler attached');
  }
  
  // Upload area click
  const uploadAreaEl = document.getElementById('uploadArea');
  const fileInputEl = document.getElementById('fileInput');
  if (uploadAreaEl && fileInputEl) {
    uploadAreaEl.onclick = function() {
      fileInputEl.click();
    };
    console.log('Upload area click handler attached');
  }
  
  // File input change
  if (fileInputEl) {
    fileInputEl.onchange = function(e) {
      handleFiles(e.target.files);
    };
    console.log('File input change handler attached');
  }
  
  // Upload area drag and drop
  if (uploadAreaEl) {
    uploadAreaEl.ondragover = function(e) {
      e.preventDefault();
      uploadAreaEl.classList.add('drag-active');
    };
    
    uploadAreaEl.ondragleave = function() {
      uploadAreaEl.classList.remove('drag-active');
    };
    
    uploadAreaEl.ondrop = function(e) {
      e.preventDefault();
      uploadAreaEl.classList.remove('drag-active');
      handleFiles(e.dataTransfer.files);
    };
    console.log('Upload area drag handlers attached');
  }
});

// Bass-reactive player bar glow
var audioContext, analyser, dataArray, bufferLength, bassReactiveInterval;

function initAudioAnalyzer() {
  if (!audioContext) {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    analyser = audioContext.createAnalyser();
    const source = audioContext.createMediaElementSource(audioPlayer);
    source.connect(analyser);
    analyser.connect(audioContext.destination);
    analyser.fftSize = 256;
    bufferLength = analyser.frequencyBinCount;
    dataArray = new Uint8Array(bufferLength);
  }
}

function startBassReaction() {
  const playBtn = document.getElementById('playPauseBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const repeatBtn = document.getElementById('repeatBtn');
  const menuBtn = document.getElementById('playerMenuBtn');
  
  if (!playBtn) return;
  
  if (bassReactiveInterval) clearInterval(bassReactiveInterval);
  
  bassReactiveInterval = setInterval(() => {
    if (!audioPlayer.paused && currentPlayingId) {
      analyser.getByteFrequencyData(dataArray);
      
      // Get bass frequencies (roughly 60-250 Hz, which is bins 0-10 for better coverage)
      let bassSum = 0;
      for (let i = 0; i < 10; i++) {
        bassSum += dataArray[i];
      }
      const bassAverage = bassSum / 10;
      
      // Normalize bass intensity (0-255 range to 0-1)
      const rawIntensity = bassAverage / 255;
      
      // Apply EXTREME exponential curve and threshold
      // Cube it for even more dramatic response, then amplify
      const bassIntensity = Math.pow(rawIntensity, 3) * 3; // Cube and 3x amplify
      
      // Only show glow if intensity is above threshold (removes constant glow)
      const threshold = 0.05;
      const finalIntensity = bassIntensity > threshold ? bassIntensity : 0;
      
      // Create pulsating glow based on bass - NO SCALE, only glow
      const glowSize = finalIntensity * 50; // 0-50px on strong bass hits
      
      const buttonGlow = glowSize > 0 ? `0 0 ${glowSize}px var(--accent), 0 0 ${glowSize * 1.5}px var(--accent)` : 'none';
      
      // Apply to all buttons - NO TRANSFORM
      playBtn.style.boxShadow = buttonGlow;
      if (prevBtn) prevBtn.style.boxShadow = buttonGlow;
      if (nextBtn) nextBtn.style.boxShadow = buttonGlow;
      if (repeatBtn) repeatBtn.style.boxShadow = buttonGlow;
      if (menuBtn) menuBtn.style.boxShadow = buttonGlow;
    }
  }, 30); // Faster update (30ms) for more responsive feel
}

function stopBassReaction() {
  if (bassReactiveInterval) {
    clearInterval(bassReactiveInterval);
    bassReactiveInterval = null;
  }
  
  // Reset button styles
  const playBtn = document.getElementById('playPauseBtn');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const repeatBtn = document.getElementById('repeatBtn');
  const menuBtn = document.getElementById('playerMenuBtn');
  
  if (playBtn) playBtn.style.boxShadow = '';
  if (prevBtn) prevBtn.style.boxShadow = '';
  if (nextBtn) nextBtn.style.boxShadow = '';
  if (repeatBtn) repeatBtn.style.boxShadow = '';
  if (menuBtn) menuBtn.style.boxShadow = '';
}

// Hook into audio player events
audioPlayer.addEventListener('play', () => {
  if (!audioContext) initAudioAnalyzer();
  if (audioContext.state === 'suspended') audioContext.resume();
  startBassReaction();
});

audioPlayer.addEventListener('pause', stopBassReaction);
audioPlayer.addEventListener('ended', stopBassReaction);

// ========== SUPABASE AUTH FUNCTIONS ==========

// Check if user is logged in
async function checkAuth() {
  const { data: { session } } = await supabase.auth.getSession();
  if (session) {
    currentUser = session.user;
    
    // Clear old localStorage data
    localStorage.removeItem('basspace_data');
    
    document.getElementById('authModal').style.display = 'none';
    document.getElementById('loginBtn').style.display = 'none';
    document.getElementById('profileMenuContainer').style.display = 'block';
    loadCloudData();
  } else {
    currentUser = null;
    document.getElementById('loginBtn').style.display = 'block';
    document.getElementById('profileMenuContainer').style.display = 'none';
  }
}

// Switch between login and signup tabs
function switchAuthTab(tab) {
  clearAuthMessage();
  
  const loginForm = document.getElementById('loginForm');
  const signupForm = document.getElementById('signupForm');
  const tabs = document.querySelectorAll('.auth-tab');
  
  tabs.forEach(t => t.classList.remove('active'));
  
  if (tab === 'login') {
    loginForm.style.display = 'block';
    signupForm.style.display = 'none';
    tabs[0].classList.add('active');
  } else {
    loginForm.style.display = 'none';
    signupForm.style.display = 'block';
    tabs[1].classList.add('active');
  }
}

// Handle login
async function handleLogin() {
  console.log('handleLogin called');
  clearAuthMessage();
  
  const email = document.getElementById('loginEmail').value;
  const password = document.getElementById('loginPassword').value;
  
  console.log('Email:', email);
  
  if (!email || !password) {
    showAuthMessage('Please fill in all fields', 'error');
    return;
  }
  
  try {
    console.log('Attempting Supabase login...');
    const { data, error } = await supabase.auth.signInWithPassword({
      email: email,
      password: password
    });
    
    console.log('Login response:', { data, error });
    
    if (error) {
      // Better error messages
      if (error.message.includes('Email not confirmed')) {
        showAuthMessage('Please verify your email address before logging in. Check your inbox for the verification link.', 'error');
      } else if (error.message.includes('Invalid login credentials')) {
        showAuthMessage('Invalid email or password. Please try again.', 'error');
      } else {
        showAuthMessage('Login failed: ' + error.message, 'error');
      }
    } else {
      currentUser = data.user;
      
      console.log('‚úÖ Login successful, user:', currentUser.email);
      
      document.getElementById('authModal').style.display = 'none';
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('profileMenuContainer').style.display = 'block';
      loadCloudData();
    }
  } catch (err) {
    console.error('Login error:', err);
    showAuthMessage('Login error: ' + err.message, 'error');
  }
}

// Handle signup
async function handleSignup() {
  console.log('handleSignup called');
  clearAuthMessage();
  
  const username = document.getElementById('signupUsername').value.trim();
  const email = document.getElementById('signupEmail').value;
  const password = document.getElementById('signupPassword').value;
  const confirmPassword = document.getElementById('signupPasswordConfirm').value;
  
  console.log('Signup email:', email);
  
  if (!username || !email || !password || !confirmPassword) {
    showAuthMessage('Please fill in all fields', 'error');
    return;
  }
  
  // Validate username format
  if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
    showAuthMessage('Username must be 3-20 characters (letters, numbers, and underscores only)', 'error');
    return;
  }
  
  // Check if username is available
  const isAvailable = await checkUsernameAvailability(username);
  if (!isAvailable) {
    showAuthMessage('Username is already taken', 'error');
    return;
  }
  
  if (password !== confirmPassword) {
    showAuthMessage('Passwords do not match', 'error');
    return;
  }
  
  if (password.length < 6) {
    showAuthMessage('Password must be at least 6 characters', 'error');
    return;
  }
  
  try {
    console.log('Attempting Supabase signup...');
    const { data, error } = await supabase.auth.signUp({
      email: email,
      password: password,
      options: {
        data: {
          username: username
        }
      }
    });
    
    console.log('Signup response:', { data, error });
    
    if (error) {
      showAuthMessage('Signup failed: ' + error.message, 'error');
    } else {
      // Save username to profiles table
      if (data.user) {
        await saveUserProfile(data.user.id, username, email);
      }
      
      // Check if user was created but needs email confirmation
      if (data.user && !data.session) {
        showAuthMessage('Account created! Please check your email to verify your account before logging in.', 'success');
        // Switch to login tab after 5 seconds
        setTimeout(() => {
          switchAuthTab('login');
          clearAuthMessage();
        }, 5000);
      } else if (data.session) {
        // Email confirmation disabled - user is auto logged in
        showAuthMessage('Account created and logged in successfully!', 'success');
        currentUser = data.user;
        document.getElementById('authModal').style.display = 'none';
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('profileMenuContainer').style.display = 'block';
        setTimeout(() => {
          loadCloudData();
        }, 1000);
      }
    }
  } catch (err) {
    console.error('Signup error:', err);
    showAuthMessage('Signup error: ' + err.message, 'error');
  }
}

// Check if username is available
async function checkUsernameAvailability(username) {
  if (!username) {
    username = document.getElementById('signupUsername').value.trim();
  }
  
  const availabilityDiv = document.getElementById('usernameAvailability');
  
  if (!username) {
    availabilityDiv.style.display = 'none';
    return false;
  }
  
  // Validate format
  if (!/^[a-zA-Z0-9_]{3,20}$/.test(username)) {
    availabilityDiv.style.display = 'block';
    availabilityDiv.style.color = '#ff6b6b';
    availabilityDiv.textContent = '‚úó Username must be 3-20 characters (letters, numbers, underscores)';
    return false;
  }
  
  try {
    // Check if username exists in profiles table
    const { data, error } = await supabase
      .from('profiles')
      .select('username')
      .eq('username', username.toLowerCase())
      .single();
    
    if (error && error.code !== 'PGRST116') { // PGRST116 = no rows returned
      console.error('Error checking username:', error);
      return false;
    }
    
    if (data) {
      // Username taken
      availabilityDiv.style.display = 'block';
      availabilityDiv.style.color = '#ff6b6b';
      availabilityDiv.textContent = '‚úó Username is already taken';
      return false;
    } else {
      // Username available
      availabilityDiv.style.display = 'block';
      availabilityDiv.style.color = '#22c55e';
      availabilityDiv.textContent = '‚úì Username is available';
      return true;
    }
  } catch (err) {
    console.error('Username check error:', err);
    return false;
  }
}

// Save user profile to database
async function saveUserProfile(userId, username, email) {
  try {
    const { error } = await supabase
      .from('profiles')
      .upsert({
        id: userId,
        username: username.toLowerCase(),
        display_name: username,
        email: email,
        created_at: new Date().toISOString()
      });
    
    if (error) {
      console.error('Error saving profile:', error);
    } else {
      console.log('‚úÖ User profile saved');
    }
  } catch (err) {
    console.error('Profile save error:', err);
  }
}

// Handle logout
async function handleLogout() {
  const { error } = await supabase.auth.signOut();
  if (!error) {
    currentUser = null;
    tracks = [];
    allUserTracks = [];
    playlists = [];
    renderLibrary();
    renderPopularTracks();
    document.getElementById('loginBtn').style.display = 'block';
    document.getElementById('profileMenuContainer').style.display = 'none';
  }
}

// Check for existing session on page load
async function checkSession() {
  console.log('üîç Checking for existing session...');
  
  try {
    const { data: { session }, error } = await supabase.auth.getSession();
    
    if (error) {
      console.error('‚ùå Session check error:', error);
      return;
    }
    
    if (session && session.user) {
      console.log('‚úÖ Found existing session for user:', session.user.email);
      currentUser = session.user;
      
      // Update UI
      document.getElementById('loginBtn').style.display = 'none';
      document.getElementById('profileMenuContainer').style.display = 'block';
      
      // Load user's cloud data
      await loadCloudData();
      
      // Load all public tracks for social feed
      await loadPublicTracks();
    } else {
      console.log('‚ÑπÔ∏è No existing session found');
      
      // Even if not logged in, load public tracks for browsing
      await loadPublicTracks();
      
      // Show login button
      document.getElementById('loginBtn').style.display = 'block';
      document.getElementById('profileMenuContainer').style.display = 'none';
    }
  } catch (err) {
    console.error('‚ùå Error checking session:', err);
  }
}

// Upload track to Supabase Storage
async function uploadToCloud(file, trackData) {
  if (!currentUser) return null;
  
  const fileExt = file.name.split('.').pop();
  const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`;
  
  const { data, error } = await supabase.storage
    .from('audio-files')
    .upload(fileName, file);
  
  if (error) {
    console.error('Upload error:', error);
    return null;
  }
  
  // Get public URL - Fixed syntax
  const { data: urlData } = supabase.storage
    .from('audio-files')
    .getPublicUrl(fileName);
  
  const publicUrl = urlData.publicUrl;
  console.log('‚úÖ File uploaded. Public URL:', publicUrl);
  
  return publicUrl;
}

// Save track metadata to database
async function saveTrackToCloud(trackData) {
  if (!currentUser) return;
  
  const { data, error } = await supabase
    .from('tracks')
    .insert({
      user_id: currentUser.id,
      title: trackData.title,
      artist: trackData.artist,
      album: trackData.album,
      audio_url: trackData.audioUrl,
      album_art: trackData.albumArt,
      duration: trackData.duration,
      filename: trackData.filename
    })
    .select();
  
  if (error) {
    console.error('Save error:', error);
  }
  
  return data;
}

// Load tracks from cloud
async function loadCloudData() {
  if (!currentUser) {
    console.log('‚ùå loadCloudData: No user logged in');
    return;
  }
  
  console.log('üîÑ Loading cloud data for user:', currentUser.id);
  
  // Load user profile first
  try {
    const { data: profileData, error: profileError } = await supabase
      .from('profiles')
      .select('*')
      .eq('id', currentUser.id)
      .single();
    
    if (!profileError && profileData) {
      // Update profile display
      const usernameEl = document.querySelector('.profile-username');
      if (usernameEl) {
        usernameEl.textContent = '@' + profileData.username;
      }
      
      const displayNameEl = document.getElementById('profileUsername');
      if (displayNameEl && profileData.display_name) {
        displayNameEl.textContent = profileData.display_name;
      }
    }
  } catch (err) {
    console.warn('Could not load profile:', err);
  }
  
  // Test: Check if we can access the tracks table
  try {
    const { data, error } = await supabase
      .from('tracks')
      .select('*')
      .eq('user_id', currentUser.id);
    
    console.log('Raw Supabase response:', { data, error });
    
    if (error) {
      console.error('‚ùå Error loading cloud data:', error);
      console.error('Error details:', {
        message: error.message,
        details: error.details,
        hint: error.hint,
        code: error.code
      });
      
      // Log error but don't interrupt user
      console.error('‚ö†Ô∏è Database not set up. Please check Supabase setup.');
      return;
    }
    
    if (data) {
      console.log('‚úÖ Cloud data loaded:', data.length, 'tracks');
      console.log('Raw cloud data:', data);
      
      if (data.length === 0) {
        console.warn('‚ö†Ô∏è No tracks found in database for this user');
      }
      
      // Convert cloud data to local format
      allUserTracks = data.map(track => ({
        id: track.id,
        title: track.title,
        artist: track.artist,
        album: track.album,
        albumArt: track.album_art,
        audioData: track.audio_url,
        dataUrl: track.audio_url,
        duration: track.duration,
        filename: track.filename,
        userId: track.user_id, // Store owner ID
        isPlaying: false
      }));
      
      tracks = [...allUserTracks];
      console.log('‚úÖ Tracks arrays populated. tracks:', tracks.length, 'allUserTracks:', allUserTracks.length);
      
      updateStats();
      renderLibrary();
      renderPopularTracks();
      renderRecentUploads();
      
      console.log('‚úÖ Render functions called after cloud data load');
    }
  } catch (err) {
    console.error('‚ùå Exception in loadCloudData:', err);
    // Silent fail - error logged
  }
}

// Load ALL public tracks for the social feed/trending page
async function loadPublicTracks() {
  console.log('üåç Loading all public tracks...');
  
  try {
    // Fetch ALL tracks from database (not just current user)
    const { data, error } = await supabase
      .from('tracks')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(100); // Load latest 100 tracks
    
    console.log('üì¶ Public tracks response:', { data, error });
    
    if (error) {
      console.error('‚ùå Error loading public tracks:', error);
      console.error('Error details:', {
        message: error.message,
        details: error.details,
        hint: error.hint,
        code: error.code
      });
      
      // If error is RLS related, show helpful message
      if (error.code === '42501' || error.message.includes('policy')) {
        console.error('‚ö†Ô∏è RLS POLICY ERROR: Tracks table needs public read policy!');
        console.error('Run FIX_PUBLIC_TRACKS.sql to enable public viewing');
      }
      
      window.publicTracks = [];
      return;
    }
    
    if (data && data.length > 0) {
      console.log('‚úÖ Loaded', data.length, 'public tracks');
      console.log('Sample track:', data[0]);
      
      // Create a global public tracks array
      window.publicTracks = data.map(track => ({
        id: track.id,
        title: track.title,
        artist: track.artist,
        album: track.album,
        albumArt: track.album_art,
        audioData: track.audio_url,
        dataUrl: track.audio_url,
        duration: track.duration,
        filename: track.filename,
        userId: track.user_id,
        isPlaying: false
      }));
      
      console.log('‚úÖ window.publicTracks populated with', window.publicTracks.length, 'tracks');
      
      // Render public tracks on home page
      renderPopularTracks();
    } else {
      console.log('‚ÑπÔ∏è No public tracks found in database');
      window.publicTracks = [];
    }
  } catch (err) {
    console.error('‚ùå Error loading public tracks:', err);
    window.publicTracks = [];
  }
}

// Delete track from cloud
async function deleteTrackFromCloud(trackId) {
  if (!currentUser) return;
  
  const { error } = await supabase
    .from('tracks')
    .delete()
    .eq('id', trackId)
    .eq('user_id', currentUser.id);
  
  if (error) {
    console.error('Delete error:', error);
  }
}

// Initialize auth check on page load
window.addEventListener('load', () => {
  console.log('=== PAGE LOADED ===');
  
  // Attach login button click handler
  const loginBtn = document.getElementById('loginBtn');
  console.log('Login button found:', loginBtn);
  if (loginBtn) {
    loginBtn.addEventListener('click', () => {
      console.log('LOGIN BUTTON CLICKED!');
      openAuthModal();
    });
    console.log('Login button click listener attached');
  } else {
    console.error('Login button NOT FOUND!');
  }
  
  // Attach modal close button
  const closeBtn = document.getElementById('authModalCloseBtn');
  console.log('Close button found:', closeBtn);
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      console.log('CLOSE BUTTON CLICKED!');
      closeAuthModal();
    });
  }
  
  // Attach tab switching
  const authTabs = document.querySelectorAll('.auth-tab');
  console.log('Auth tabs found:', authTabs.length);
  authTabs.forEach(tab => {
    tab.addEventListener('click', () => {
      console.log('TAB CLICKED:', tab.dataset.tab);
      switchAuthTab(tab.dataset.tab);
    });
  });
  
  // Attach login submit button
  const loginSubmitBtn = document.getElementById('loginSubmitBtn');
  console.log('Login submit button found:', loginSubmitBtn);
  if (loginSubmitBtn) {
    loginSubmitBtn.addEventListener('click', () => {
      console.log('LOGIN SUBMIT CLICKED!');
      handleLogin();
    });
  }
  
  // Attach signup submit button
  const signupSubmitBtn = document.getElementById('signupSubmitBtn');
  console.log('Signup submit button found:', signupSubmitBtn);
  if (signupSubmitBtn) {
    signupSubmitBtn.addEventListener('click', () => {
      console.log('SIGNUP SUBMIT CLICKED!');
      handleSignup();
    });
  }
  
  console.log('=== CHECKING AUTH ===');
  // Check authentication
  checkAuth();
});

// OVERRIDE handleFiles with cloud upload version
async function handleFiles(files) {
  // Check if user is logged in
  if (!currentUser) {
    openAuthModal();
    return;
  }
  
  const audioFiles = Array.from(files).filter(e => /audio\//.test(e.type) || /\.(mp3|m4a)$/i.test(e.name));
  if (audioFiles.length === 0) return;
  
  document.getElementById('uploadProgress').classList.add('show');
  
  for (const file of audioFiles) {
    try {
      console.log('Uploading file:', file.name, 'Size:', file.size);
      
      // Upload to Supabase Storage
      const publicUrl = await uploadToCloud(file, null);
      
      if (publicUrl) {
        // Get audio duration
        const audio = new Audio();
        audio.src = publicUrl;
        
        await new Promise((resolve, reject) => {
          audio.onloadedmetadata = () => resolve();
          audio.onerror = () => reject(new Error('Could not load audio'));
        });
        
        const duration = audio.duration;
        
        // Save to Supabase database
        const trackData = {
          title: file.name.replace(/\.(mp3|m4a|mp4)$/i, ''),
          artist: 'Unknown Artist',
          album: 'Unknown Album',
          audioUrl: publicUrl,
          albumArt: null,
          duration: duration,
          filename: file.name
        };
        
        const savedTrack = await saveTrackToCloud(trackData);
        console.log('üíæ saveTrackToCloud response:', savedTrack);
        
        if (savedTrack && savedTrack[0]) {
          const track = {
            id: savedTrack[0].id,
            title: savedTrack[0].title,
            artist: savedTrack[0].artist,
            album: savedTrack[0].album,
            albumArt: savedTrack[0].album_art,
            audioData: savedTrack[0].audio_url,
            dataUrl: savedTrack[0].audio_url,
            duration: savedTrack[0].duration,
            filename: savedTrack[0].filename,
            userId: currentUser.id, // Store owner ID
            isPlaying: false
          };
          
          tracks.push(track);
          allUserTracks.push(track);
          console.log('‚úÖ Track added to arrays:', track.title);
          console.log('Total tracks now:', tracks.length, 'All user tracks:', allUserTracks.length);
        } else {
          console.error('Failed to save track to cloud:', savedTrack);
        }
      }
    } catch (error) {
      console.error('Upload error:', error);
      // Silent fail - error logged to console
    }
  }
  
  document.getElementById('uploadProgress').classList.remove('show');
  
  console.log('üîÑ Reloading all cloud data after upload...');
  // Reload from cloud to ensure everything is in sync
  await loadCloudData();
  
  // Reload public tracks so new upload appears in everyone's feed
  await loadPublicTracks();
  
  // Show in-page success message instead of browser alert
  if (audioFiles.length > 0) {
    const uploadArea = document.getElementById('uploadArea');
    const successMsg = document.createElement('div');
    successMsg.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(34,197,94,0.95);color:white;padding:2rem 3rem;border-radius:12px;font-size:1.2rem;font-weight:600;z-index:10000;box-shadow:0 10px 40px rgba(0,0,0,0.3);backdrop-filter:blur(10px);';
    successMsg.innerHTML = `‚úÖ Successfully uploaded ${audioFiles.length} song(s)!<br><small style="font-size:0.9rem;opacity:0.9;margin-top:0.5rem;display:block;">Check your Library or scroll down to see them</small>`;
    document.body.appendChild(successMsg);
    
    setTimeout(() => {
      successMsg.remove();
    }, 3000);
  }
  
  if (audioFiles.length === 1 && allUserTracks.length > 0) {
    openEditTrack(allUserTracks[allUserTracks.length - 1].id);
  }
  
  // Scroll to recently uploaded section to show the new tracks
  const uploadedSection = document.getElementById('uploadedTracks');
  if (uploadedSection && uploadedSection.style.display !== 'none') {
    uploadedSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
}

console.log('‚úÖ All scripts loaded successfully');

// FINAL OVERRIDE - Must be at end to override minified code
function showScreen(screen) {
  console.log('üì∫ Showing screen:', screen);
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const targetScreen = document.getElementById(screen + 'Screen');
  if (targetScreen) {
    targetScreen.classList.add('active');
    console.log('‚úÖ Screen activated:', screen);
  } else {
    console.error('‚ùå Screen not found:', screen + 'Screen');
  }
  dropdown.classList.remove('show');
  
  document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
  
  if (screen === 'home') {
    document.querySelector('.nav-link').classList.add('active');
    renderPopularTracks();
    stopProfileSong();
  } else if (screen === 'library') {
    document.querySelectorAll('.nav-link')[1].classList.add('active');
    renderLibrary(); // Ensure library renders
    stopProfileSong();
  } else if (screen === 'upload') {
    document.querySelectorAll('.nav-link')[2].classList.add('active');
    renderRecentUploads(); // Ensure recent uploads render
    stopProfileSong();
  } else if (screen === 'profile') {
    showProfileTab('tracks'); // Show tracks tab by default
    renderProfile();
    applyProfileStyles();
    startProfileSong();
  } else if (screen === 'settings') {
    const colorPicker = document.getElementById('customColorPicker');
    if (colorPicker) {
      const currentBg = document.body.style.background || '#050d1a';
      colorPicker.value = currentBg;
    }
    stopProfileSong();
  }
  
  updateStats();
}

</script>
</body>
</html>
